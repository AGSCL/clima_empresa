---
title: "Explorar Datos Consolidados"
date: "`r withr::with_locale(new = c('LC_TIME' = 'C'), code =format(Sys.time(),'%B %d, %Y'))`"
output:
  distill::distill_article:
    code_folding: true
    fig_height: 6
    fig_width: 8
    theme: spacelab
    toc: yes
    toc_depth: 5
    toc_float: yes
    output_dir: "docs"
  toc_float:
    collapsed: false
    smooth_scroll: true
---

```{css zoom-lib-src, echo = FALSE}
script src = "https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"
```

```{js zoom-jquery, echo = FALSE}
 $(document).ready(function() {
    $('body').prepend('<div class=\"zoomDiv\"><img src=\"\" class=\"zoomImg\"></div>');
    // onClick function for all plots (img's)
    $('img:not(.zoomImg)').click(function() {
      $('.zoomImg').attr('src', $(this).attr('src')).css({width: '100%'});
      $('.zoomDiv').css({opacity: '1', width: 'auto', border: '1px solid white', borderRadius: '5px', position: 'fixed', top: '50%', left: '50%', marginRight: '-50%', transform: 'translate(-50%, -50%)', boxShadow: '0px 0px 50px #888888', zIndex: '50', overflow: 'auto', maxHeight: '100%'});
    });
    // onClick function for zoomImg
    $('img.zoomImg').click(function() {
      $('.zoomDiv').css({opacity: '0', width: '0%'}); 
    });
  });
  
```

```{css hideOutput-lib-src, echo = FALSE}
<script src="hideOutput.js"></script> 
```

```{js hideOutput, echo = FALSE}
$(document).ready(function() {    
	$chunks = $('.fold');    
	$chunks.each(function () {      // add button to source code chunks     
	if ( $(this).hasClass('s') ) {       
		$('pre.r', this).prepend("<div class=\"showopt\">Show Source</div><br style=\"line-height:22px;\"/>");
       		$('pre.r', this).children('code').attr('class', 'folded');     
       		}      // add button to output chunks     
		if ( $(this).hasClass('o') ) {       
			$('pre:not(.r)', this).has('code').prepend("<div class=\"showopt\">Show Output</div><br style=\"line-height:22px;\"/>");       
			$('pre:not(.r)', this).children('code:not(r)').addClass('folded');        // add button to plots       
			$(this).find('img').wrap('<pre class=\"plot\"></pre>');       
			$('pre.plot', this).prepend("<div class=\"showopt\">Show Plot</div><br style=\"line-height:22px;\"/>");       
			$('pre.plot', this).children('img').addClass('folded');      
			}   
});    // hide all chunks when document is loaded   
	$('.folded').css('display', 'none')    // function to toggle the visibility   
	$('.showopt').click(function() {     
			var label = $(this).html();     
			if (label.indexOf("Show") >= 0) {       
				$(this).html(label.replace("Show", "Hide"));     
			} else {
			  $(this).html(label.replace("Hide", "Show"));     
			}     
	$(this).siblings('code, img').slideToggle('fast', 'swing');   
	}); 
}); 

```

```{=html}
<style type="text/css">
.showopt {   
  background-color: #004c93;   color: #FFFFFF;    width: 100px;   height: 20px;   text-align: center;   vertical-align: middle !important;   float: right;   font-family: sans-serif;   border-radius: 8px; 
  }

.showopt:hover {     
        background-color: #dfe4f2;
        color: #004c93; 
        }  
pre.plot {   
        background-color: white !important; 
        } 
.tablelines table, .tablelines td, .tablelines th {
        border: 1px solid black;
        }

.centrado {
    text-align: center;
}

.table.center {
    margin-left:auto; 
    margin-right:auto;
  }

/* https://vivekjaiskumar.medium.com/css-is-and-not-selector-17c942ec83f :is()*/

/* Applies to outputs that are not code other than R*/

pre {
  overflow-x: auto !important;
}
pre code {
  word-wrap: normal !important;
  white-space: pre !important;
}
/*
pre:not(.sourceCode) { 
  white-space: nowrap !important;
}
*/
.sourceCode { /* Important gives precedence  */
  font-size: 10px !important;
  line-height: 50% !important;
}

body{ /* Normal  */
      text-align: justify;
  }

.superbigimage{
    overflow-y:scroll;
    height:350px;
    white-space: nowrap;
    overflow-x: auto; 
    width:100%;
}
.superbigimage img{
    overflow-y: scroll;
    overflow-x: hidden;
}

.message { color:#446C6E; font-family: monospace;font-size: 10px; line-height: 110%; font-weight: bold;}
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 5px; text-align: justify;}
div.red { background-color:#e6bab1; border-radius: 5px; padding: 5px; text-align: justify;}

.pandoc-table { /* Should add !important; but it seems no necessary  */
  margin-left:auto; /* To center */
  margin-right:auto;
  border-collapse: collapse;
  table-layout: auto;
  font-size: 11px;
  overflow-y: auto;
  max-height:450px !important;
  white-space: nowrap;
  overflow-x: auto; 
  width:450px;
}

.pandoc-table th {/* header */
text-align: center !important;
font-size: 10px;
padding: 0px;
}

.pandoc-table td {
text-align: left !important;
font-size: 9px;
padding: 0.5px !important;
}

.pandoc-table caption {
    text-align: left !important;
    font-size: 11px !important;
}

.controlly{
    overflow-y:scroll;
    height:350px;
    overflow-x: scroll; 
}

</style>
```
```{=html}
<!-- We gotta do each function to hide code and outputs per section, by every ID, we gotta create a different function -->
<script>
function myFunction1() {
    var x = document.getElementById("myDIV");
    if (x.style.display === "none") {
        x.style.display = "block";
    } else {
        x.style.display = "none";
    }
}
</script>

<script>
function myFunction2() {
    var x = document.getElementById("myDIV2");
    if (x.style.display === "none") {
        x.style.display = "block";
    } else {
        x.style.display = "none";
    }
}
</script>
```
```{r setup00, include=T}
rm(list=ls());gc()
unlink('*_cache', recursive = TRUE)

if(nchar(Sys.getenv("SUPERSECRET"))<2){
  Sys.setenv("SUPERSECRET"=as.character(read.table("secret_key.txt", quote="\"", comment.char="")))
}
if(nchar(Sys.getenv("SUPERSECRET"))<2){
  try(Sys.setenv("SUPERSECRET"=as.character(read.table(paste0(gsub("/gastos","",dirname(rstudioapi::getActiveDocumentContext()$path)),"/secret_key.txt"), quote="\"", comment.char=""))))
}
if(nchar(Sys.getenv("SUPERSECRETT"))<2){
  Sys.setenv("SUPERSECRETT"=as.character(read.table("secret_key2.txt", quote="\"", comment.char="")))
}
if(nchar(Sys.getenv("SUPERSECRETT"))<2){
  try(Sys.setenv("SUPERSECRETT"=as.character(read.table(paste0(gsub("/gastos","",dirname(rstudioapi::getActiveDocumentContext()$path)),"/secret_key2.txt"), quote="\"", comment.char=""))))
}

path_sec<- paste0("https://docs.google.com/spreadsheets/d/",Sys.getenv("SUPERSECRET"),"/export?format=csv&id=",Sys.getenv("SUPERSECRET"),"&gid=1387050788")
path_sec2<- paste0("https://docs.google.com/spreadsheets/d/",Sys.getenv("SUPERSECRETT"),"/export?format=csv&id=",Sys.getenv("SUPERSECRETT"),"&gid=1921324430")

memory.limit(size=56000)

path<-dirname(rstudioapi::getSourceEditorContext()$path)

options(knitr.kable.NA = '')
```

```{r setup0, include=T}
`%>%` <- magrittr::`%>%`
if(!require(fuzzyjoin)){install.packages("fuzzyjoin")}

INFO <- readxl::read_excel("INFO.xlsx")


invisible("homologar a un sexo los nombres y luego enmascarar")
encuesta_pre <- 
 readr::read_delim(path_sec, 
    delim = ",", escape_double = FALSE, 
    trim_ws = TRUE, skip = 9) 

encuesta<-  
encuesta_pre %>%   
    dplyr::rename(any_of(c(`Ingresa tu correo electrónico Verisure`="\"\"Ingresa tu correo electrónico Verisure\"\""))) %>% 
    #dplyr::rename(`Ingresa tu correo electrónico Verisure` = 5)
  dplyr::left_join(INFO[,c("pmail","sexo")], by=c("correos corregidos 04 08"="pmail")) %>% 
    dplyr::mutate(`correos corregidos 04 08`=ifelse(`correos corregidos 04 08`!="", anonymizer::anonymize(`correos corregidos 04 08`, .algo = "sha256", .seed = 2125),NA_character_))%>% 
    dplyr::mutate(`Ingresa tu correo electrónico Verisure`=ifelse(`Ingresa tu correo electrónico Verisure`!="", anonymizer::anonymize(`Ingresa tu correo electrónico Verisure`, .algo = "sha256", .seed = 2125),NA_character_))

encuesta_pre2 <- 
 readr::read_delim(path_sec2, 
    delim = ",", escape_double = FALSE, 
    trim_ws = TRUE, skip = 3) 

encuesta2<-  
encuesta_pre2 %>%   
  dplyr::rename(any_of(c(`Ingresa tu correo electrónico Verisure`="\"\"Ingresa tu correo electrónico Verisure\"\""))) %>%
  dplyr::rename(any_of(c("Ingresa tu correo electrónico Verisure"="E-mail"))) %>%
  dplyr::left_join(INFO[,c("pmail","fecha_ing","d_unidad","fecha_nac","sexo")], by=c("Ingresa tu correo electrónico Verisure"="pmail")) %>% 
    dplyr::mutate(`Ingresa tu correo electrónico Verisure`=ifelse(`Ingresa tu correo electrónico Verisure`!="", anonymizer::anonymize(`Ingresa tu correo electrónico Verisure`, .algo = "sha256", .seed = 2125),NA_character_))%>% 
    #dplyr::select(-nombre) %>% 
  #agregado 2022-09-04
  dplyr::rename_with(stringr::str_replace, 
              pattern = "A continuación responde las siguientes preguntas indicando el nivel de acuerdo con el enunciado: x ", replacement = "")

#
if(isTRUE(getOption('knitr.in.progress'))==T){
    clus_iter=5000
} else {
  input <- readline('¿Are you gonna run the dataset with the whole iterations? (Si/No): ')
  if(input=="Si"){
    clus_iter=10000
  } else {
    clus_iter=1000
  }
}
library(tm)
if(isTRUE(getOption('knitr.in.progress'))==T){
  input2 <- "todas"
} else {
    input2 <- "todas"
    input2 <- Corpus(VectorSource(input2))
    input2 <- tm_map(input2, tolower)
    input2 <- tm_map(input2,stripWhitespace)
    input2 <- gsub(" ","_",as.character(unlist(input2)[1]))
}
```

```{r setup, include=T, message=T, warning=F, error=T}
#evitar que ocupe curl
#options(renv.download.override = utils::download.file)

#arriba puse algunas opciones para que por defecto escondiera el código
#también cargue algunos estilo .css para que el texto me apareciera justificado, entre otras cosas.
local({r <- getOption("repos")
       r["CRAN"] <- "http://cran.r-project.org" 
       options(repos=r)
})

clipboard <- function(x, sep="\t", row.names=FALSE, col.names=TRUE){
     con <- pipe("xclip -selection clipboard -i", open="w")
     write.table(x, con, sep=sep, row.names=row.names, col.names=col.names)
     close(con)
}

copy_names <- function(x,row.names=FALSE,col.names=TRUE,dec=",",...) {
  library(dplyr)
  if(class(ungroup(x))[1]=="tbl_df"){
    if(options()$OutDec=="."){
      options(OutDec = dec)
      write.table(format(data.frame(x)),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
      options(OutDec = ".")
      return(x)
    } else {
      options(OutDec = ",")
      write.table(format(data.frame(x)),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
      options(OutDec = ",")
      return(x)    
    }
  } else {
    if(options()$OutDec=="."){
      options(OutDec = dec)
      write.table(format(x),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
      options(OutDec = ".")
      return(x)
    } else {
      options(OutDec = ",")
      write.table(format(x),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
      options(OutDec = ",")
      return(x)       
    }
  }
}  

if(!require(pacman)){install.packages("pacman")}

pacman::p_unlock(lib.loc = .libPaths()) #para no tener problemas reinstalando paquetes
knitr::opts_chunk$set(
    echo = TRUE,
    message = T,
    warning = FALSE
)
#dejo los paquetes estadísticos que voy a utilizar

if(!require(plotly)){install.packages("plotly")}
if(!require(lubridate)){install.packages("lubridate")}
if(!require(htmlwidgets)){install.packages("htmlwidgets")}
#if(!require(tidyverse)){install.packages("tidyverse")}
if(!require(gganimate)){install.packages("gganimate")}
if(!require(readr)){install.packages("readr")}
if(!require(stringr)){install.packages("stringr")}
if(!require(data.table)){install.packages("data.table")}
if(!require(DT)){install.packages("DT")}
if(!require(ggplot2)){install.packages("ggplot2")}
if(!require(lattice)){install.packages("lattice")}
if(!require(janitor)){install.packages("janitor")}
if(!require(rjson)){install.packages("rjson")}
if(!require(estimatr)){install.packages("estimatr")} 
if(!require(textreg)){install.packages("textreg")}
if(!require(sjPlot)){install.packages("sjPlot")}
if(!require(foreign)){install.packages("foreign")}
if(!require(tsModel)){install.packages("tsModel")}
if(!require(lmtest)){install.packages("lmtest")}
if(!require(Epi)){install.packages("Epi")}
if(!require(splines)){install.packages("splines")}
if(!require(vcd)){install.packages("vcd")}
if(!require(astsa)){install.packages("astsa")}
if(!require(MASS)){install.packages("MASS")}
if(!require(ggsci)){install.packages("ggsci")}
if(!require(Hmisc)){install.packages("Hmisc")}
if(!require(compareGroups)){install.packages("compareGroups")}
if(!require(dplyr)){install.packages("dplyr")}
if(!require(ggforce)){install.packages("ggforce")}
if(!require(doParallel)){install.packages("doParallel")}
if(!require(SCtools)){install.packages("SCtools")}
if(!require(rio)){install.packages("rio")}
if(!require(rbokeh)){install.packages("rbokeh")}
if(!require(sqldf)){install.packages("sqldf")} 
if(!require(devtools)){install.packages("devtools")}
if(!require(ExPanDaR)){install.packages("ExPanDaR")}
if(!require(skimr)){install.packages("skimr")}
if(!require(tm)){install.packages("tm")} 
if(!require(wordcloud2)){install.packages("wordcloud2")}
if(!require(wordcloud)){install.packages("wordcloud")}
if(!require(RColorBrewer)){install.packages("RColorBrewer")}
if(!require(psych)){install.packages("psych")}
if(!require(ggiraph)){install.packages("ggiraph")}
if(!require(tidyverse)){install.packages("tidyverse")}
if(!require(lubridate)){install.packages("lubridate")}
if(!require(ggfortify)){install.packages("ggfortify")}
if(!require(survminer)){install.packages("survminer")}
if(!require(rpivotTable)){install.packages("rpivotTable")}
if(!require(ggstatsplot)){install.packages("ggstatsplot")}
if(!require(anonymizer)){devtools::install_github("paulhendricks/anonymizer")}
if(!require(finalfit)){install.packages("finalfit")}

# Calculate the number of cores
#no_cores <- detectCores() - 1
##cl<-makeCluster(no_cores)
#registerDoParallel(cl)
# sudo apt -y install libfontconfig1-dev
# sudo apt-get install libxml2-dev
#Sys.setlocale(category = "LC_ALL", locale = "english")
#locale("es", decimal_mark = ",")


find_type <- function(x) {
  case_when(
    is.factor(x) ~ "factor",
    is.character(x) ~ "character",
    is.numeric(x) ~ "numeric",
    TRUE ~ "not sure"
  )
}

permute_icc <- function(x, y, n = 99) {
  actual <- ICCbare(x, y)
  nulls <- vector(length = length(n), mode = "numeric")
  for(i in seq_along(1:n)) {
    scrambled_x <- sample(x, length(x), replace = F)
    nulls[i] <- ICCbare(scrambled_x, y)
  }
  (sum(abs(nulls) > ifelse(actual > 0, actual, -actual)) + 1) / (n+1)
}

permute_tau <- function(x, y, n = 99) {
  actual <- GKtau(x, y)$tauxy
  nulls <- vector(length = length(n), mode = "numeric")
  for(i in seq_along(1:n)) {
    scrambled_x <- sample(x, length(x), replace = F)
    nulls[i] <- GKtau(scrambled_x, y)$tauxy
  }
  (sum(abs(nulls) > ifelse(actual > 0, actual, -actual)) + 1) / (n+1)
}

# to do:
## get p-values

eda <- function(x, plot = FALSE) {
  
  x <- as.data.frame(x)
  
  num_rows <- ncol(x)^2 - ncol(x)
  df <- tibble(var1 = vector(mode = "character", length = 1),
               var2 = vector(mode = "character", length = 1),
               statistic = vector(mode = "character", length = 1),
               value = vector(mode = "double", length = 1),
               p_value = vector(mode = "double", length = 1),
               n = vector(mode = "integer", length = 1))
  
  for(i in seq_along(1:ncol(x)))
    for(j in seq_along(1:ncol(x))) {
      if(i < j){
        # get type of columns i and j
        var_1_type <- find_type(x[,i])
        var_2_type <- find_type(x[,j])
        #print(paste("var1 type: ", var_1_type, "\nvar2 type: ", var_2_type, "\n\n"))
        
        x1 <- x[,i]
        x2 <- x[,j]
        
        # remove NAs for simplicity
        if(any(is.na(x1))){
          # get NA indicies
          ind <- which(is.na(x1))
          x1 <- x1[-ind]
          x2 <- x2[-ind]
        }
        
        if(any(is.na(x2))){
          # get NA indicies
          ind <- which(is.na(x2))
          x1 <- x1[-ind]
          x2 <- x2[-ind]
        }
        
        # make sure x1 and x2 are the same length
        stopifnot(length(x1) == length(x2))
        
        n <- length(x1)
        
        if(var_1_type == "numeric" & var_2_type == "numeric") {
          # run a correlation
          result <- cor.test(x1, x2)
          df <- add_row(df, 
                        var1 = names(x)[i],
                        var2 = names(x)[j],
                        statistic = "r",
                        value = result$estimate,
                        p_value = result$p.value,
                        n = n
          )
        } else if(var_1_type == "factor" & var_2_type == "numeric") {
          # run an ANOVA or t-test, depending on number of levels
          num_levels <- length(levels(x1))
          require(ICC)
          result <- ICCbare(x1, x2)
          p <- permute_icc(x1, x2)
          df <- add_row(df, 
                        var1 = names(x)[i],
                        var2 = names(x)[j],
                        statistic = "ICC",
                        value = result,
                        p_value = p,
                        n = n
          )
        } else if(var_1_type == "numeric" & var_2_type == "factor") {
          # run an ANOVA or t-test, depending on number of levels
          num_levels <- length(levels(x2))
          require(ICC)
          result <- ICCbare(x2, x1)
          p <- permute_icc(x2, x1)
          df <- add_row(df, 
                        var1 = names(x)[i],
                        var2 = names(x)[j],
                        statistic = "ICC",
                        value = result,
                        p_value = p,
                        n = n
          )
        } else if(var_1_type == "factor" & var_2_type == "factor") {
          require("GoodmanKruskal")
          # compute the GKtau statistic
          stat1 <- GKtau(x1, x2)$tauxy
          stat2 <- GKtau(x1, x2)$tauyx
          p1 <- permute_tau(x1, x2)
          p2 <- permute_tau(x2, x1)
          df <- add_row(df, 
                        var1 = names(x)[i],
                        var2 = names(x)[j],
                        statistic = "tau",
                        value = stat1,
                        p_value = p1,
                        n = n
          )
          df <- add_row(df, 
                        var1 = names(x)[j],
                        var2 = names(x)[i],
                        statistic = "tau",
                        value = stat2,
                        p_value = p2,
                        n = n
          )
        } else{
          # return an empty row
          df <- add_row(df, 
                        var1 = names(x)[i],
                        var2 = names(x)[j],
                        statistic = NA_character_,
                        value = NA_integer_,
                        p_value = NA_real_,
                        n = n
          )
        }
      }
    }
  if(plot == TRUE) {
    df[-1,] %>%
      filter(!is.na(value)) %>%
      unite(variables, var1, var2, sep = " by ") %>%
      mutate(`possibly significant` = if_else(p_value < 0.05, "significant", "NS")) %>%
      ggplot(aes(y = value, x = reorder(variables, value), color = `possibly significant`)) +
      geom_point() +
      coord_flip() +
      facet_wrap(~statistic, scales = "free") +
      theme_minimal() +
      scale_color_manual(values = c("#37454B", "#E84F22"))
  } else{
    df[-1,]
  }
  
}
  m <- list(
    l = 100,
    r = 50,
    b = 0,
    t = 0,
    pad = 4
  )
check_code <- function(expr, available){
  if(available){
    eval(parse(text = expr))
  } else {
    expr
  }
}
```

```{r datasets-cons-spss2, echo=T, cache= T, paged.print=TRUE, warning=F, eval=T}

invisible(c("Compromiso Sostenible", "Desarrollo Profesional", "Liderazgo",	"Entorno de Trabajo", "Covid", "Intención de permanecer en la Compañía",	"Comunicación",	"Gestión del Desempeño",	"Compensación y Beneficios",	"Supervisor Inmediato"))
#`

names_df_ori<-encuesta %>%  names()
names_df_proc<-encuesta %>% janitor::clean_names() %>% names()


names_df2_ori<-encuesta2 %>%  names()
names_df2_proc<-encuesta2 %>% janitor::clean_names() %>% names()
```

<br>

## Fecha: `r format(Sys.time(), '%d %B, %Y')`

# Obtención de Base de Datos

En primer lugar, bajamos los datos y utilizamos un nombre para las columnas más facil de procesar por los distintos programas informáticos de análisis estadístico.

<br>

```{r datasets-cons1a, echo=T, cache= T, paged.print=TRUE, warning=F, error=T}
#Ver las etiquetas y las variables
#Ver als etiquetas y las variables
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#
#fecha de respuesta
names_df_proc[7]<-names_df_proc[8]
names_df_ori[7]<-names_df_ori[8]

names_df_proc[8]<-"Función"
names_df_ori[8]<-"Función"

for (i in 1:length(names_df_ori)){
     attr(encuesta[[i]], "label")<- names_df_ori[[i]]
}

for (i in 1:length(names_df2_ori)){
     attr(encuesta2[[i]], "label")<- names_df2_ori[[i]]
}

for (i in 1:length(names_df_ori)){
     colnames(encuesta)[[i]]<- names_df_proc[[i]]
}

for (i in 1:length(names_df2_ori)){
     colnames(encuesta2)[[i]]<- names_df2_proc[[i]]
}


# for (i in 1:length(names_df_ori)){
# if(attributes(names_df_ori)$name[i]=="proporcion") 
# attributes(encuesta)$variable.labels[i]<-"Proporción de guaguas en el determinado sexo"
# if(attributes(names_df_ori)$name[i]=="sexo") 
# attributes(encuesta)$variable.labels[i]<-"Sexo"
# }
# 

colnames_encuesta<- c("cor_ele","nombre","tel","fecha","correo_val","correo_val_cor","fecha_resp","funcion","a_dir","b_ger", "c_area", paste0("comp_sos_",1:9), paste0("dllo_prof_",1:3), paste0("lid_",1:2), paste0("ent_trab_",1:2),paste0("covid_",1:4), paste0("intencion_",1), paste0("com_",1:2), paste0("ges_des_",1:2), paste0("comp_ben_",1:2), paste0("superv_",1:3), "enps_lugar_trab","enps_prod_serv","obs_gen","sexo")

dt_names<-
dplyr::bind_cols(original=names_df_ori,limpiada=names_df_proc,etiqueta=colnames_encuesta)

dt_names2<-
dplyr::bind_cols(original=names_df2_ori,limpiada=names_df2_proc) %>% 
  dplyr::left_join(dt_names, by=c("limpiada")) %>% 
  dplyr::mutate(etiqueta= dplyr::case_when(
    limpiada=="ingresa_tu_correo_electronico_verisure"~"correo_val_cor",
    limpiada=="indica_el_area_a_la_que_perteneces"~"c_area",
    limpiada=="indica_la_direccion_a_la_que_perteneces"~"a_dir",
    limpiada=="indica_a_que_categoria_de_funciones_perteneces"~"funcion",
    limpiada=="indica_tu_antiguedad_trabajando_dentro_de_verisure"~"antiguedad",
    limpiada=="que_aspectos_crees_que_la_empresa_deberia_cambiar_opcional"~"obs_gen",
    limpiada=="recibo_feedback_de_manera_constante_que_me_ayuda_a_mejorar_y_a_crecer_en_la_organizacion"~"ges_des_1",
    nchar(etiqueta)<2~ limpiada,
    is.na(etiqueta)~ limpiada,
    T~etiqueta
  ))
# fecha
# hora
# completada_en
# fuente

colnames(encuesta)<-colnames_encuesta
colnames(encuesta2)<-dt_names2$etiqueta

#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#


```

<br>

Posteriormente, le añadimos los nombres de las variables a la base de datos.

<br>

```{r datasets-cons-attr-names, echo=T, cache= T, paged.print=TRUE, warning=F, eval=T, error=T}
  for (i in 1:length(names_df_proc)){
          attributes(encuesta)$"variable.labels"[i]<- names_df_ori[i] 
  }

  for (i in 1:length(names(encuesta2))){
          attributes(encuesta2)$"variable.labels"[i]<- names_df2_ori[i] 
  }
```

<br>

Las variables fueron recodificadas y estandarizadas de acuerdo a cómo se exhiben en el cuestionario, incluyendo las etiquetas que no se encuentran presentes debido a que nadie ha contestado en alguna de esas categorías.

<br>

```{r format-variables, echo=T, cache= T, paged.print=TRUE, warning=T, error=T}
#funcion  a_dir b_ger c_area
encuesta %>%
  dplyr::mutate(across(c("funcion","a_dir", "b_ger","c_area"), ~dplyr::case_when(as.character(.)=="#ERROR!"~NA_character_,as.character(.)=="#N/A"~NA_character_,as.character(.)=="#REF!"~NA_character_,as.character(.)=="NA"~NA_character_,T~as.character(.)))) %>% 
  #dplyr::mutate(cons_inf=ifelse(grepl("acepto participar",as.character(cons_inf)),"Sí","No")) %>% 
  dplyr::mutate(across(c(paste0("comp_sos_",1:9), paste0("dllo_prof_",1:3), paste0("lid_",1:2), paste0("ent_trab_",1:2),paste0("covid_",1:4), paste0("intencion_",1), paste0("com_",1:2), paste0("ges_des_",1:2), paste0("comp_ben_",1:2), paste0("superv_",1:3)), ~stringr::str_remove(stringr::str_trim(.), "\\.$"))) %>% 
  dplyr::mutate(across(c(paste0("comp_sos_",1:9), paste0("dllo_prof_",1:3), paste0("lid_",1:2), paste0("ent_trab_",1:2),paste0("covid_",1:4), paste0("intencion_",1), paste0("com_",1:2), paste0("ges_des_",1:2), paste0("comp_ben_",1:2), paste0("superv_",1:3)), ~stringr::str_remove(stringr::str_trim(as.character(.)), "\\.$"))) %>% 
    dplyr::mutate(across(c(paste0("comp_sos_",1:9), paste0("dllo_prof_",1:3), paste0("lid_",1:2), paste0("ent_trab_",1:2),paste0("covid_",1:4), paste0("intencion_",1), paste0("com_",1:2), paste0("ges_des_",1:2), paste0("comp_ben_",1:2), paste0("superv_",1:3)), ~factor(parse_factor(as.character(.), levels=c("1","2","3","4","5"), trim_ws=T, include_na =F), labels=c("Muy en desacuerdo","En desacuerdo","Ni de acuerdo ni en desacuerdo", "De acuerdo", "Muy de acuerdo"), ordered=T))) %>% 
  dplyr::mutate(sexo=factor(sexo)) %>% 
    assign("encuesta_rec",.,envir=.GlobalEnv)

#En esta empresa no se tolera el bajo desempeño ---> No está

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

encuesta2 %>%
  dplyr::mutate(across(c("funcion","a_dir", "c_area"), ~dplyr::case_when(as.character(.)=="#ERROR!"~NA_character_,as.character(.)=="#N/A"~NA_character_,as.character(.)=="#REF!"~NA_character_,as.character(.)=="NA"~NA_character_,T~as.character(.)))) %>% 
  #dplyr::mutate(cons_inf=ifelse(grepl("acepto participar",as.character(cons_inf)),"Sí","No")) %>% 
  dplyr::mutate(across(c(paste0("comp_sos_",1:9), paste0("ges_des_",1)), ~stringr::str_remove(stringr::str_trim(.), "\\.$"))) %>% 
  dplyr::mutate(across(c(paste0("comp_sos_",1:9), paste0("ges_des_",1)), ~stringr::str_remove(stringr::str_trim(as.character(.)), "\\.$"))) %>% 
    dplyr::mutate(across(c(paste0("comp_sos_",1:9), paste0("ges_des_",1)), ~factor(parse_factor(as.character(.), trim_ws=T, include_na =F), levels=c("En desacuerdo", "Tiendo a estar en desacuerdo","Neutral", "Tiendo a estar de acuerdo", "De Acuerdo"), ordered=T))) %>% 
  #labels=c("Muy en desacuerdo","En desacuerdo","Ni de acuerdo ni en desacuerdo", "De acuerdo", "Muy de acuerdo"), ordered=T))) %>%
    dplyr::mutate(fecha_nac= as.Date(as.character(fecha_nac)),fecha_ing= as.Date(as.character(fecha_ing)), edad=round(as.numeric(fecha-fecha_nac)/365.25,0)) %>% 
    dplyr::mutate(sexo=factor(sexo)) %>%
    dplyr::mutate(antiguedad=factor(antiguedad, levels=c("Menos de 3 meses", "Entre 3 meses y 1 año", "Entre 1 y 2 años", "Entre 2 y 5 años", "Entre 5 y 10 años", "Más de 10 años"))) %>% 
    dplyr::mutate(dias_despues=as.numeric(fecha-as.Date("2022-07-25")),) %>% 
  #recodificar
  dplyr::mutate(across(c(paste0("comp_sos_",1:9)), ~dplyr::case_when(.=="Tiendo a estar de acuerdo"~1, .=="De Acuerdo"~1, T~ 0),.names = "{col}_rec1"))%>%
  dplyr::mutate(compromiso_sostenible_ags= base::rowSums(dplyr::select(.,ends_with("_rec1"))))%>%  
      assign("encuesta2_rec",.,envir=.GlobalEnv)

         #dplyr::mutate(dg_total_cie_10 = base::rowSums(dplyr::select(., dg_diagnostico_trs_psiquiatrico_cie_10, dg_x2_diagnostico_trs_psiquiatrico_cie_10, dg_x3_diagnostico_trs_psiquiatrico_cie_10)))%>%
```

<br>

# Exploración de Datos

```{r exp1a, echo=T, cache= T, paged.print=TRUE, warning=F, error=T}
options(knitr.kable.NA = '')

var_lbls_no_char<-
    data.frame(nam=attributes(encuesta_rec)$"names",
               var_lab=attributes(encuesta_rec)$"variable.labels") %>% 
      dplyr::right_join(encuesta_rec%>% dplyr::select(-(cor_ele:fecha_resp))%>%
       dplyr::select(-where(is.character)) %>% names() %>% data.frame(), by=c("nam"="."))

skimr_encuesta_rec<-
encuesta_rec%>% dplyr::select(-(cor_ele:fecha_resp))%>%
   dplyr::select(-where(is.character)) %>%
  skimr::skim() %>% 
  tibble::as_tibble() %>%
  dplyr::mutate(complete_rate=scales::percent(complete_rate)) %>% 
  dplyr::select(-numeric.hist)

skimr_encuesta_rec %>% 
  dplyr::left_join(var_lbls_no_char, by=c("skim_variable"="nam")) %>% 
  dplyr::select(skim_type,skim_variable,var_lab, everything()) %>% 
  knitr::kable(.,format = "html", digits=2, format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Resumen de Variables"),#,
               col.names = c("Tipo","Variable","Etiqueta","Perdidos","% Completos",
                            "Ordenado","Valores únicos","Más frecuentes","Media", "Desv.Est.","Min","Perc. 25", "Mediana", "Perc. 75", "Max"),
align =c("c","l",rep('c', 101))) %>%
  kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 9) %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
```


```{r exp1b, echo=T, cache= T, paged.print=TRUE, warning=F, error=T}
options(knitr.kable.NA = '')

for (i in 1:length(names(encuesta2_rec))){
if(attributes(encuesta2_rec)$name[i]=="edad")
attributes(encuesta2_rec)$variable.labels[i]<-"Edad"
if(attributes(encuesta2_rec)$name[i]=="sexo")
attributes(encuesta2_rec)$variable.labels[i]<-"Sexo"
if(attributes(encuesta2_rec)$name[i]=="dias_despues")
attributes(encuesta2_rec)$variable.labels[i]<-"Días en que contesta desde después del 07-25"
if(attributes(encuesta2_rec)$name[i]=="compromiso_sostenible_ags")
attributes(encuesta2_rec)$variable.labels[i]<-"Suma de recodificados de Compromiso Sostenible (ags)"
}

var_lbls_no_char2<-
    data.frame(nam=attributes(encuesta2_rec)$"names",
               var_lab=attributes(encuesta2_rec)$"variable.labels") %>% 
      dplyr::right_join(encuesta2_rec%>% dplyr::select(-(hora:correo_val_cor))%>%
       dplyr::select(-where(is.character)) %>% names() %>% data.frame(), by=c("nam"="."))

skimr_encuesta2_rec<-
encuesta2_rec%>% dplyr::select(-(hora:correo_val_cor))%>%
   dplyr::select(-where(is.character)) %>%
  skimr::skim() %>% 
  tibble::as_tibble() %>%
  dplyr::mutate(complete_rate=scales::percent(complete_rate)) %>% 
  dplyr::select(-numeric.hist)

skimr_encuesta2_rec %>% 
  dplyr::left_join(var_lbls_no_char2, by=c("skim_variable"="nam")) %>% 
  dplyr::select(skim_type,skim_variable,var_lab, everything()) %>% 
  knitr::kable(.,format = "html", digits=2, format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Resumen de Variables"),#,
               col.names = c("Tipo","Variable","Etiqueta","Perdidos","% Completos",
                             "Fecha (min)", "Fecha (max)", "Fecha (mediana)", "Fecha (únicos)",
                            "Ordenado","Valores únicos","Más frecuentes","Lógica (Promedio)","Lógica (Recuento)","Promedio", "Desv.Est.","Min","Perc. 25", "Mediana", "Perc. 75", "Max"),
align =c("c","l",rep('c', 101))) %>%
  kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 9) %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
```

```{r tab3,dpi = 96, message=F, error=T,eval=T, warnings=F}
rbind(
cbind(cat="Fecha de respuesta (2022)",
encuesta2_rec %>% 
  dplyr::summarise(min = min(fecha, na.rm=T),
                   p025=as.Date(quantile(as.numeric(fecha), .025, na.rm=T),origin="1970-01-01"),
                   p25=as.Date(quantile(as.numeric(fecha), .25, na.rm=T),origin="1970-01-01"),
                   p50=as.Date(quantile(as.numeric(fecha), .5, na.rm=T),origin="1970-01-01"),
                   p75=as.Date(quantile(as.numeric(fecha), .75, na.rm=T),origin="1970-01-01"),
                   p975=as.Date(quantile(as.numeric(fecha), .975, na.rm=T),origin="1970-01-01"),
            max = max(fecha, na.rm=T))),
cbind(cat="Fecha de ingreso a la empresa (2022)",
encuesta2_rec %>% 
  dplyr::summarise(min = min(fecha_ing, na.rm=T),
                   p025=as.Date(quantile(as.numeric(fecha_ing), .025, na.rm=T),origin="1970-01-01"),
                   p25=as.Date(quantile(as.numeric(fecha_ing), .25, na.rm=T),origin="1970-01-01"),
                   p50=as.Date(quantile(as.numeric(fecha_ing), .5, na.rm=T),origin="1970-01-01"),
                   p75=as.Date(quantile(as.numeric(fecha_ing), .75, na.rm=T),origin="1970-01-01"),
                   p975=as.Date(quantile(as.numeric(fecha_ing), .975, na.rm=T),origin="1970-01-01"),
            max = max(fecha_ing, na.rm=T))),
cbind(cat="Fecha de entrega",
encuesta_rec %>% 
  dplyr::summarise(min = as.Date(min(unclass(as.Date.POSIXct(fecha)), na.rm=T), origin = "1970-01-01"),
                   p025=as.Date(quantile(unclass(as.Date.POSIXct(fecha)), .025, na.rm=T), origin = "1970-01-01"),
                   p25=as.Date(quantile(unclass(as.Date.POSIXct(fecha)), .25, na.rm=T), origin = "1970-01-01"),
                   p50=as.Date(quantile(unclass(as.Date.POSIXct(fecha)), .5, na.rm=T), origin = "1970-01-01"),
                   p75=as.Date(quantile(unclass(as.Date.POSIXct(fecha)), .75, na.rm=T), origin = "1970-01-01"),
                   p975=as.Date(quantile(unclass(as.Date.POSIXct(fecha)), .975, na.rm=T), origin = "1970-01-01"),
            max =  as.Date(max(unclass(as.Date.POSIXct(fecha)), na.rm=T), origin = "1970-01-01")))
) %>% 
knitr::kable(format="markdown",caption= "Resumen de fechas")
```


<br>

```{r hist-comp-sos, echo=T, cache= T, paged.print=TRUE, warning=F, fig.cap="Histograma de Frecuencias, Puntajes Ítems de Compromiso Sostenible", fig.align="center",error=T}
# paste0("comp_sos_",1:9), paste0("dllo_prof_",1:3), paste0("lid_",1:2), paste0("ent_trab_",1:2),paste0("covid_",1:4), paste0("intencion_",1), paste0("com_",1:2), paste0("ges_des_",1:2), paste0("comp_ben_",1:2), paste0("superv_",1:3)

p<-
  encuesta_rec %>% 
  dplyr::mutate(across(paste0("comp_sos_",1:9),~as.numeric(.),.names="num_{col}")) %>% 
  dplyr::mutate(ptjes_comp_sos= base::rowSums(dplyr::select(.,paste0("num_","comp_sos_",1:9)),na.rm=T)) %>% 
  ggplot(aes(x=ptjes_comp_sos), alpha=.7)+
  sjPlot::theme_sjplot2() +
labs(y = "Frecuencia",x="Suma de Puntajes",caption="Nota. Puntajes cero se deben a valores perdidos")+
  geom_histogram(bins=10)
#  scale_y_continuous(breaks=seq(0,200,25))+
#  scale_x_continuous(breaks=seq(0,60,10))+
tooltip_css <- "background-color:gray;color:white;font-style:italic;padding:10px;border-radius:10px 20px 10px 20px;"
ggiraph(code = {print(p)}, tooltip_extra_css = tooltip_css, tooltip_opacity = .75)
```

```{r hist-comp-sos2, echo=T, cache= T, paged.print=TRUE, warning=F, fig.cap="Histograma de Frecuencias, Puntajes Ítems de Compromiso Sostenible (2022)", fig.align="center",error=T}
# paste0("comp_sos_",1:9), paste0("dllo_prof_",1:3), paste0("lid_",1:2), paste0("ent_trab_",1:2),paste0("covid_",1:4), paste0("intencion_",1), paste0("com_",1:2), paste0("ges_des_",1:2), paste0("comp_ben_",1:2), paste0("superv_",1:3)

p2022<-
  encuesta2_rec %>% 
  dplyr::mutate(across(paste0("comp_sos_",1:9),~as.numeric(.),.names="num_{col}")) %>% 
  dplyr::mutate(ptjes_comp_sos= base::rowSums(dplyr::select(.,paste0("num_","comp_sos_",1:9)),na.rm=T)) %>% 
  ggplot(aes(x=ptjes_comp_sos), alpha=.7)+
  sjPlot::theme_sjplot2() +
labs(y = "Frecuencia",x="Suma de Puntajes",caption="Nota. Puntajes cero se deben a valores perdidos")+
  geom_histogram(bins=10)
#  scale_y_continuous(breaks=seq(0,200,25))+
#  scale_x_continuous(breaks=seq(0,60,10))+
tooltip_css <- "background-color:gray;color:white;font-style:italic;padding:10px;border-radius:10px 20px 10px 20px;"
ggiraph(code = {print(p2022)}, tooltip_extra_css = tooltip_css, tooltip_opacity = .75)
```

```{r hist-dllo-prof, echo=T, cache= T, paged.print=TRUE, warning=F, fig.cap="Histograma de Frecuencias, Puntajes Ítems de Desarrollo Profesional", fig.align="center",error=T}
p2<-
  encuesta_rec %>% 
  dplyr::mutate(across(paste0("dllo_prof_",1:3),~as.numeric(.),.names="num_{col}")) %>% 
  dplyr::mutate(ptjes_dllo_prof= base::rowSums(dplyr::select(.,paste0("num_","dllo_prof_",1:3)),na.rm=T)) %>% 
  ggplot(aes(x=ptjes_dllo_prof), alpha=.7)+
  sjPlot::theme_sjplot2() +
labs(y = "Frecuencia",x="Suma de Puntajes",caption="Nota. Puntajes cero se deben a valores perdidos")+
  geom_histogram(bins=10)
#  scale_y_continuous(breaks=seq(0,200,25))+
#  scale_x_continuous(breaks=seq(0,60,10))+
tooltip_css <- "background-color:gray;color:white;font-style:italic;padding:10px;border-radius:10px 20px 10px 20px;"
ggiraph(code = {print(p2)}, tooltip_extra_css = tooltip_css, tooltip_opacity = .75)
```

```{r hist-covid, echo=T, cache= T, paged.print=TRUE, warning=F, fig.cap="Histograma de Frecuencias, Puntajes Ítems de COVID-19", fig.align="center",error=T}
p3<-
    encuesta_rec %>% 
  dplyr::mutate(across(paste0("covid_",1:4),~as.numeric(.),.names="num_{col}")) %>% 
  dplyr::mutate(ptjes_covid= base::rowSums(dplyr::select(.,paste0("num_","covid_",1:4)),na.rm=T)) %>% 
  ggplot(aes(x=ptjes_covid), alpha=.7)+
  sjPlot::theme_sjplot2() +
labs(y = "Frecuencia",x="Suma de Puntajes",caption="Nota. Puntajes cero se deben a valores perdidos")+
  geom_histogram(bins=10)
  #scale_y_continuous(breaks=seq(0,100,5))+
  #scale_x_continuous(breaks=seq(0,60,10))
tooltip_css <- "background-color:gray;color:white;font-style:italic;padding:10px;border-radius:10px 20px 10px 20px;"
ggiraph(code = {print(p3)}, tooltip_extra_css = tooltip_css, tooltip_opacity = .75)
```


```{r hist-superv, echo=T, cache= T, paged.print=TRUE, warning=F, fig.cap="Histograma de Frecuencias, Puntajes Ítems de Supervisor Inmediato", fig.align="center",error=T}
p4<-
    encuesta_rec %>% 
  dplyr::mutate(across(paste0("superv_",1:3),~as.numeric(.),.names="num_{col}")) %>% 
  dplyr::mutate(ptjes_covid= base::rowSums(dplyr::select(.,paste0("num_","superv_",1:3)),na.rm=T)) %>% 
  ggplot(aes(x=ptjes_covid), alpha=.7)+
  sjPlot::theme_sjplot2() +
labs(y = "Frecuencia",x="Suma de Puntajes",caption="Nota. Puntajes cero se deben a valores perdidos")+
  geom_histogram(bins=10)
  #scale_y_continuous(breaks=seq(0,100,5))+
  #scale_x_continuous(breaks=seq(0,60,10))
tooltip_css <- "background-color:gray;color:white;font-style:italic;padding:10px;border-radius:10px 20px 10px 20px;"
ggiraph(code = {print(p4)}, tooltip_extra_css = tooltip_css, tooltip_opacity = .75)
```

<br>

## Perdidas

Contamos los datos perdidos por cada usuario en cada variable.

<br>

```{r datos-perdidos, echo=T, cache= T, paged.print=TRUE, warning=F, error=T}
encuesta_rec_miss<-
encuesta_rec %>%
  rowwise %>%
  dplyr::mutate_at(.vars = vars(comp_sos_1:enps_prod_serv), # si fuera de SPSS, debiese ser p47_demo_medio_transp_otr
                   .funs = list(`nas`=~ifelse(is.na(.), 1, 0))) %>% 
  dplyr::ungroup() %>% 
  rowwise %>%
  dplyr::mutate(suma_parcial = sum(c_across(comp_sos_1_nas:enps_prod_serv_nas))) %>% #si fuera SPSS, debiese ser p47_demo_medio_transp_otr_nas
  dplyr::select(-ends_with("_nas")) %>% 
  dplyr::ungroup()

encuesta_rec$suma_parcial<-encuesta_rec_miss$suma_parcial


#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#Agregar etiquetas
for (i in 1:length(encuesta_rec_miss)){
if(attributes(encuesta_rec_miss)$name[i]=="suma_parcial") {
attributes(encuesta_rec)$variable.labels[i]<-"Suma de Valores Perdidos en Variables de Interés"
}
#attr()
}

encuesta2_rec_miss<-
encuesta2_rec %>%
  rowwise %>%
  dplyr::mutate_at(.vars = vars(comp_sos_1:enps_lugar_trab), # si fuera de SPSS, debiese ser p47_demo_medio_transp_otr
                   .funs = list(`nas`=~ifelse(is.na(.), 1, 0))) %>% 
  dplyr::ungroup() %>% 
  rowwise %>%
  dplyr::mutate(suma_parcial = sum(c_across(comp_sos_1_nas:enps_lugar_trab_nas))) %>% #si fuera SPSS, debiese ser p47_demo_medio_transp_otr_nas
  dplyr::select(-ends_with("_nas")) %>% 
  dplyr::ungroup()

encuesta2_rec$suma_parcial<-encuesta2_rec_miss$suma_parcial


#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#Agregar etiquetas
for (i in 1:length(encuesta2_rec_miss)){
if(attributes(encuesta2_rec_miss)$name[i]=="suma_parcial") {
attributes(encuesta2_rec)$variable.labels[i]<-"Suma de Valores Perdidos en Variables de Interés"
}
#attr()
}
```

<br>

Vemos un histograma de frecuencia de datos perdidos por usuario.

<br>

```{r hist-perdidos, echo=T, cache= T, paged.print=TRUE, warning=F, fig.cap="Histograma de Frecuencias, Valores perdidos en variables de interés", fig.align="center",error=T}
p4<-ggplot(encuesta_rec_miss,aes(x=suma_parcial), alpha=.7)+
  geom_histogram_interactive(bins=10)+
  #   geom_vline(aes(xintercept=30), color="darkred", linetype="dashed")+
  #   geom_vline(aes(xintercept=45), color="darkmagenta", linetype="solid")+
  #   geom_vline(aes(xintercept=60), color="darkblue", linetype="dotted")+
  sjPlot::theme_sjplot2() +
  #facet_wrap(~motivodeegreso_mod_imp)+
labs(y = "Frecuencia",x="Suma de Puntajes",caption="Línea vertical= Máximo de 3 valores perdidos atribuibles a combinaciones de respuesta por defecto")+
  scale_y_continuous(breaks=seq(0,nrow(encuesta_rec_miss),25))+
  scale_x_continuous(breaks=seq(0,160,10))+
  geom_vline(xintercept = 9, col = 2, lty = 2)
# xlim(c(-1,2000))
tooltip_css <- "background-color:gray;color:white;font-style:italic;padding:10px;border-radius:10px 20px 10px 20px;"
ggiraph(code = {print(p4)}, tooltip_extra_css = tooltip_css, tooltip_opacity = .75)
```

<br>


<br>

```{r hist-perdidos-2022, echo=T, cache= T, paged.print=TRUE, warning=F, fig.cap="Histograma de Frecuencias, Valores perdidos en variables de interés (2022)", fig.align="center",error=T}
p4_2022<-ggplot(encuesta2_rec_miss,aes(x=suma_parcial), alpha=.7)+
  geom_histogram_interactive(bins=10)+
  #   geom_vline(aes(xintercept=30), color="darkred", linetype="dashed")+
  #   geom_vline(aes(xintercept=45), color="darkmagenta", linetype="solid")+
  #   geom_vline(aes(xintercept=60), color="darkblue", linetype="dotted")+
  sjPlot::theme_sjplot2() +
  #facet_wrap(~motivodeegreso_mod_imp)+
labs(y = "Frecuencia",x="Suma de Puntajes",caption="Línea vertical= Máximo de 3 valores perdidos atribuibles a combinaciones de respuesta por defecto")+
  scale_y_continuous(breaks=seq(0,nrow(encuesta2_rec_miss),25))+
  scale_x_continuous(breaks=seq(0,160,10))+
  geom_vline(xintercept = 9, col = 2, lty = 2)
# xlim(c(-1,2000))
tooltip_css <- "background-color:gray;color:white;font-style:italic;padding:10px;border-radius:10px 20px 10px 20px;"
ggiraph(code = {print(p4_2022)}, tooltip_extra_css = tooltip_css, tooltip_opacity = .75)
```

<br>

Generamos una medida `suma_parcial` que tiene la cantidad de datos perdidos por usuario (aunque ecluyendo los casos con mes de 9 puntos, los que serían similares a las preguntas que por diseño no van a contestar los participantes, porque no corresponden a esas categorías de respuesta, etc.).

<br>

## Descriptivo

El número de diferencias en puntajes con lo obtenido por felipe es  `r dplyr::mutate(encuesta2_rec,diff=compromiso_sostenible_ags-compromiso_sostenible)%>% dplyr::filter(diff>0) %>%  nrow()`.


```{r 2022-corr-felipe,dpi = 320, message=F, error=T, eval=T, warnings=F}
p_corr<-ggplot(encuesta2_rec,aes(x=dias_despues, y=compromiso_sostenible_ags), alpha=.7)+
  #geom_histogram_interactive(bins=10)+
  geom_point_interactive()+
    sjPlot::theme_sjplot2() +
  
labs(y = "Suma puntajes Compromiso sostenible",x="Días despues del 25-07",caption="Línea vertical= Máximo de 3 valores perdidos atribuibles a combinaciones de respuesta por defecto")+
  geom_vline(xintercept = 9, col = 2, lty = 2)
# xlim(c(-1,2000))
tooltip_css <- "background-color:gray;color:white;font-style:italic;padding:10px;border-radius:10px 20px 10px 20px;"
ggiraph(code = {print(p_corr)}, tooltip_extra_css = tooltip_css, tooltip_opacity = .75)
```

```{r 2022-corr-felipe3,dpi = 320, message=T, error=T, eval=T, warnings=F, fig.height=5, fig.width=18}

message("Asociación de compromiso sostenible, días desde el 25-07, estratificado por dirección (1,000 remuestreos)")
ggstatsplot::grouped_ggscatterstats(data = data.frame(encuesta2_rec) %>%                                    dplyr::mutate(group=dplyr::case_when(a_dir=="Operaciones"~"Operaciones",a_dir=="Ventas"~"Ventas",T~"Resto")),
                            x = dias_despues,
                            y = compromiso_sostenible_ags,
                            xlab="Días después del 25-07", 
                            ylab="Compromiso sostenible (suma)",
                            grouping.var = group,
                            nboot= 1000,
                            type = "p" )
#ggside

jpeg("_Fig1_scatter.jpg", width = 18, height = 5, units = 'in', res = 600)
ggstatsplot::grouped_ggscatterstats(data = data.frame(encuesta2_rec) %>%                                    dplyr::mutate(group=dplyr::case_when(a_dir=="Operaciones"~"Operaciones",a_dir=="Ventas"~"Ventas",T~"Resto")),
                            x = dias_despues,
                            y = compromiso_sostenible_ags,
                            xlab="Días después del 25-07", 
                            ylab="Compromiso sostenible (suma)",
                            grouping.var = group,
                            nboot= 1000,
                            type = "p" )
dev.off()
```

```{r 2022-corr-felipe3b,dpi = 320, message=T, error=T, eval=T, warnings=F, fig.height=5, fig.width=20}
message("Asociación de compromiso sostenible y Feedback, estratificado por dirección (1,000 remuestreos)")
ggstatsplot::grouped_ggbarstats(data = data.frame(encuesta2_rec) %>%  dplyr::mutate(group=dplyr::case_when(a_dir=="Operaciones"~"Operaciones",a_dir=="Ventas"~"Ventas",T~"Resto"),  ges_des_1_rec= factor(dplyr::case_when(ges_des_1=="Tiendo a estar de acuerdo"~1, ges_des_1=="De Acuerdo"~1, T~ 0),levels=c(0,1),labels=c("Otros","...de acuerdo/De acuerdo"))),
                            x = ges_des_1_rec,
                            y = compromiso_sostenible_ags,
                            xlab="Compromiso sostenible (suma)", 
                            ylab="Feedback",
                            grouping.var = group,
                            nboot= 1000,
                            type = "p" )
#ggside

jpeg("_Fig2_scatter.jpg", width = 20, height = 10, units = 'in', res = 1200)
ggstatsplot::grouped_ggbarstats(data = data.frame(encuesta2_rec) %>%  dplyr::mutate(group=dplyr::case_when(a_dir=="Operaciones"~"Operaciones",a_dir=="Ventas"~"Ventas",T~"Resto"),  ges_des_1_rec= factor(dplyr::case_when(ges_des_1=="Tiendo a estar de acuerdo"~1, ges_des_1=="De Acuerdo"~1, T~ 0),levels=c(0,1),labels=c("Otros","...de acuerdo/De acuerdo"))),
                            x = ges_des_1_rec,
                            y = compromiso_sostenible_ags,
                            xlab="Compromiso sostenible (suma)", 
                            ylab="Feedback",
                            grouping.var = group,
                            nboot= 1000,
                            type = "p" )
dev.off()

message("Asociación de compromiso sostenible y Feedback (dicotomizada), estratificado por dirección (1,000 remuestreos)")
ggstatsplot::grouped_ggbetweenstats(data = data.frame(encuesta2_rec) %>%  dplyr::mutate(group=dplyr::case_when(a_dir=="Operaciones"~"Operaciones",a_dir=="Ventas"~"Ventas",T~"Resto"),  ges_des_1_rec= factor(dplyr::case_when(ges_des_1=="Tiendo a estar de acuerdo"~1, ges_des_1=="De Acuerdo"~1, T~ 0),levels=c(0,1),labels=c("Otros","...de acuerdo/De acuerdo"))),
                            x = ges_des_1_rec,
                            y = compromiso_sostenible_ags,
                            ylab="Compromiso sostenible (suma)", 
                            xlab="Feedback",
                            grouping.var = group,
                            nboot= 1000,
                            type = "p" )

jpeg("_Fig3_violin.jpg", width = 20, height = 5, units = 'in', res = 600)
ggstatsplot::grouped_ggbetweenstats(data = data.frame(encuesta2_rec) %>%  dplyr::mutate(group=dplyr::case_when(a_dir=="Operaciones"~"Operaciones",a_dir=="Ventas"~"Ventas",T~"Resto"),  ges_des_1_rec= factor(dplyr::case_when(ges_des_1=="Tiendo a estar de acuerdo"~1, ges_des_1=="De Acuerdo"~1, T~ 0),levels=c(0,1),labels=c("Otros","...de acuerdo/De acuerdo"))),
                            x = ges_des_1_rec,
                            y = compromiso_sostenible_ags,
                            ylab="Compromiso sostenible (suma)", 
                            xlab="Feedback",
                            grouping.var = group,
                            nboot= 1000,
                            type = "p" )
dev.off()

message("Asociación de compromiso sostenible y Feedback, estratificado por dirección (1,000 remuestreos)")
ggstatsplot::grouped_ggbetweenstats(data = data.frame(encuesta2_rec) %>%  dplyr::mutate(group=dplyr::case_when(a_dir=="Operaciones"~"Operaciones",a_dir=="Ventas"~"Ventas",T~"Resto"),  ges_des_1_rec= factor(dplyr::case_when(ges_des_1=="Tiendo a estar de acuerdo"~1, ges_des_1=="De Acuerdo"~1, T~ 0),levels=c(0,1),labels=c("Otros","...de acuerdo/De acuerdo"))),
                            x = ges_des_1,
                            y = compromiso_sostenible_ags,
                            ylab="Compromiso sostenible (suma)", 
                            xlab="Feedback",
                            grouping.var = group,
                            nboot= 1000,
                            type = "p" )

jpeg("_Fig4_violin.jpg", width = 20, height = 5, units = 'in', res = 600)
ggstatsplot::grouped_ggbetweenstats(data = data.frame(encuesta2_rec) %>%  dplyr::mutate(group=dplyr::case_when(a_dir=="Operaciones"~"Operaciones",a_dir=="Ventas"~"Ventas",T~"Resto"),  ges_des_1_rec= factor(dplyr::case_when(ges_des_1=="Tiendo a estar de acuerdo"~1, ges_des_1=="De Acuerdo"~1, T~ 0),levels=c(0,1),labels=c("Otros","...de acuerdo/De acuerdo"))),
                            x = ges_des_1,
                            y = compromiso_sostenible_ags,
                            ylab="Compromiso sostenible (suma)", 
                            xlab="Feedback",
                            grouping.var = group,
                            nboot= 1000,
                            type = "p" )
dev.off()

message("Asociación de compromiso sostenible y Feedback, estratificado por dirección, descartando a quienes indican 0 recomendando a la empresa como un buen lugar para trabajar (1,000 remuestreos)")
ggstatsplot::grouped_ggbetweenstats(data = data.frame(encuesta2_rec) %>%  dplyr::mutate(group=dplyr::case_when(a_dir=="Operaciones"~"Operaciones",a_dir=="Ventas"~"Ventas",T~"Resto"),  ges_des_1_rec= factor(dplyr::case_when(ges_des_1=="Tiendo a estar de acuerdo"~1, ges_des_1=="De Acuerdo"~1, T~ 0),levels=c(0,1),labels=c("Otros","...de acuerdo/De acuerdo")))%>% dplyr::filter(enps_lugar_trab>0),
                            x = ges_des_1,
                            y = compromiso_sostenible_ags,
                            ylab="Compromiso sostenible (suma)", 
                            xlab="Feedback",
                            grouping.var = group,
                            nboot= 1000,
                            type = "p" )

jpeg("_Fig5_violin.jpg", width = 20, height = 5, units = 'in', res = 600)
ggstatsplot::grouped_ggbetweenstats(data = data.frame(encuesta2_rec) %>%  dplyr::mutate(group=dplyr::case_when(a_dir=="Operaciones"~"Operaciones",a_dir=="Ventas"~"Ventas",T~"Resto"),  ges_des_1_rec= factor(dplyr::case_when(ges_des_1=="Tiendo a estar de acuerdo"~1, ges_des_1=="De Acuerdo"~1, T~ 0),levels=c(0,1),labels=c("Otros","...de acuerdo/De acuerdo")))%>% dplyr::filter(enps_lugar_trab>0),
                            x = ges_des_1,
                            y = compromiso_sostenible_ags,
                            ylab="Compromiso sostenible (suma)", 
                            xlab="Feedback",
                            grouping.var = group,
                            nboot= 1000,
                            type = "p" )
dev.off()

message("Asociación de compromiso sostenible y Feedback (dicotomizado), estratificado por dirección, descartando a quienes indican 0 recomendando a la empresa como un buen lugar para trabajar (1,000 remuestreos)")
ggstatsplot::grouped_ggbetweenstats(data = data.frame(encuesta2_rec) %>%  dplyr::mutate(group=dplyr::case_when(a_dir=="Operaciones"~"Operaciones",a_dir=="Ventas"~"Ventas",T~"Resto"),  ges_des_1_rec= factor(dplyr::case_when(ges_des_1=="Tiendo a estar de acuerdo"~1, ges_des_1=="De Acuerdo"~1, T~ 0),levels=c(0,1),labels=c("Otros","...de acuerdo/De acuerdo")))%>% dplyr::filter(enps_lugar_trab>0),
                            x = ges_des_1_rec,
                            y = compromiso_sostenible_ags,
                            ylab="Compromiso sostenible (suma)", 
                            xlab="Feedback",
                            grouping.var = group,
                            nboot= 1000,
                            type = "p" )

jpeg("_Fig6_violin.jpg", width = 20, height = 5, units = 'in', res = 600)
ggstatsplot::grouped_ggbetweenstats(data = data.frame(encuesta2_rec) %>%  dplyr::mutate(group=dplyr::case_when(a_dir=="Operaciones"~"Operaciones",a_dir=="Ventas"~"Ventas",T~"Resto"),  ges_des_1_rec= factor(dplyr::case_when(ges_des_1=="Tiendo a estar de acuerdo"~1, ges_des_1=="De Acuerdo"~1, T~ 0),levels=c(0,1),labels=c("Otros","...de acuerdo/De acuerdo")))%>% dplyr::filter(enps_lugar_trab>0),
                            x = ges_des_1_rec,
                            y = compromiso_sostenible_ags,
                            ylab="Compromiso sostenible (suma)", 
                            xlab="Feedback",
                            grouping.var = group,
                            nboot= 1000,
                            type = "p" )
dev.off()

message("Asociación de compromiso sostenible y Feedback (dicotomizado), estratificado por dirección, descartando a quienes indican 6 o menos recomendando a la empresa como un buen lugar para trabajar (1,000 remuestreos)")
ggstatsplot::grouped_ggbetweenstats(data = data.frame(encuesta2_rec) %>%  dplyr::mutate(group=dplyr::case_when(a_dir=="Operaciones"~"Operaciones",a_dir=="Ventas"~"Ventas",T~"Resto"),  ges_des_1_rec= factor(dplyr::case_when(ges_des_1=="Tiendo a estar de acuerdo"~1, ges_des_1=="De Acuerdo"~1, T~ 0),levels=c(0,1),labels=c("Otros","...de acuerdo/De acuerdo")))%>% dplyr::filter(enps_lugar_trab>=7),
                            x = ges_des_1_rec,
                            y = compromiso_sostenible_ags,
                            ylab="Compromiso sostenible (suma)", 
                            xlab="Feedback",
                            grouping.var = group,
                            nboot= 1000,
                            type = "p" )
jpeg("_Fig7_violin.jpg", width = 20, height = 5, units = 'in', res = 600)
ggstatsplot::grouped_ggbetweenstats(data = data.frame(encuesta2_rec) %>%  dplyr::mutate(group=dplyr::case_when(a_dir=="Operaciones"~"Operaciones",a_dir=="Ventas"~"Ventas",T~"Resto"),  ges_des_1_rec= factor(dplyr::case_when(ges_des_1=="Tiendo a estar de acuerdo"~1, ges_des_1=="De Acuerdo"~1, T~ 0),levels=c(0,1),labels=c("Otros","...de acuerdo/De acuerdo")))%>% dplyr::filter(enps_lugar_trab>=7),
                            x = ges_des_1_rec,
                            y = compromiso_sostenible_ags,
                            ylab="Compromiso sostenible (suma)", 
                            xlab="Feedback",
                            grouping.var = group,
                            nboot= 1000,
                            type = "p" )
dev.off()
```

:::controlly
```{r finalfit,dpi = 320, message=F, error=T, eval=T, warnings=F}

encuesta2_rec %>%  dplyr::mutate(group=factor(dplyr::case_when(a_dir=="Operaciones"~"Operaciones",a_dir=="Ventas"~"Ventas",T~"Resto"), levels=c("Resto", "Ventas", "Operaciones")),  ges_des_1_rec= factor(dplyr::case_when(ges_des_1=="Tiendo a estar de acuerdo"~1, ges_des_1=="De Acuerdo"~1, T~ 0),levels=c(0,1),labels=c("Otros","...de acuerdo/De acuerdo"))) %>%
  dplyr::mutate(ges_des_1_rec= ff_label(ges_des_1_rec,"Feedback superiores")) %>% 
    finalfit("compromiso_sostenible_ags", c("group", "ges_des_1_rec", "dias_despues", "sexo", "antiguedad")) %>% data.table::data.table(keep.rownames = F) %>%  knitr::kable("markdown")

encuesta2_rec2<-
encuesta2_rec %>%  dplyr::mutate(group=factor(dplyr::case_when(a_dir=="Operaciones"~"Operaciones",a_dir=="Ventas"~"Ventas",T~"Resto"), levels=c("Resto", "Ventas", "Operaciones")),  ges_des_1_rec= factor(dplyr::case_when(ges_des_1=="Tiendo a estar de acuerdo"~1, ges_des_1=="De Acuerdo"~1, T~ 0),levels=c(0,1),labels=c("Otros","...de acuerdo/De acuerdo")))

```
:::

`r message(finalfit(encuesta2_rec2,"compromiso_sostenible_ags", c("group", "ges_des_1_rec", "dias_despues", "sexo", "antiguedad"), metrics=T)[[2]])`

<br>

```{r comparativo-total-2022,dpi = 320, message=F, error=T, eval=T, warnings=F}
for (i in 1:length(encuesta2_rec)){
  x<-names(encuesta2_rec)[i]
attr(encuesta2_rec[[x]],"label")<-attributes(encuesta2_rec)$variable.labels[[i]]
}

library(compareGroups)

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
  table0_all <- suppressWarnings(compareGroups(group ~ 
      sexo+
      comp_sos_1+
      comp_sos_2+
      comp_sos_3+
      comp_sos_4+
      comp_sos_5+
      comp_sos_6+
      comp_sos_7+
      comp_sos_8+
      comp_sos_9+
      ges_des_1+
      enps_lugar_trab+
      sexo+
      edad+
      dias_despues+
      c_area+
      antiguedad+
      funcion, 
           method= c(
      comp_sos_1=3,
      comp_sos_2=3,
      comp_sos_3=3,
      comp_sos_4=3,
      comp_sos_5=3,
      comp_sos_6=3,
      comp_sos_7=3,
      comp_sos_8=3,
      comp_sos_9=3,
      ges_des_1=3,
      enps_lugar_trab=2,
      dias_despues=2,
      antiguedad=3,
      c_area=3,
      edad=2
),
    data = data.frame(encuesta2_rec) %>%                                    dplyr::mutate(group=dplyr::case_when(a_dir=="Operaciones"~"Operaciones",a_dir=="Ventas"~"Ventas",T~"Resto")),
    include.miss = T, #baja el número de casos
    p.corrected=T,
    chisq.test.perm=T,
    chisq.test.seed=1234,
    var.equal=T)
  )
#group
restab0_all <- createTable(table0_all, show.p.overall = T)

pvals0 <- getResults(table0_all)
#p.adjust(pvals, method = "BH")
export2md(restab0_all, size=10, first.strip=T, hide.no="no", position="center",
          format="html",caption= "Descriptivo Aplicación Total (2022)",
          #col.names=c("Variables", "Todos los casos", "N")
         )%>%
  kableExtra::add_footnote(c("Note. N= Número de participantes con al menos una respuesta válida en las variables seleccionadas; Variables continuas se presentan como medianas y percentiles 25 y 75;", 
                             "Variables categóricas son presentadas como el recuento y el porcentaje"), notation = "none")%>%
  kableExtra::kable_classic() %>% 
  kableExtra::scroll_box(width = "100%", height = "800px")
```


```{r comparativo-total,dpi = 320, message=F, error=T, eval=T, warnings=F}
#rm(list=ls());gc()
for (i in 1:length(encuesta_rec)){
  x<-names(encuesta_rec)[i]
attr(encuesta_rec[[x]],"label")<-attributes(encuesta_rec)$variable.labels[[i]]
}

library(compareGroups)

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
  table1_all <- suppressWarnings(compareGroups( ~ 
      sexo+
      b_ger+
      comp_sos_1+
      comp_sos_2+
      comp_sos_3+
      comp_sos_4+
      comp_sos_5+
      comp_sos_6+
      comp_sos_7+
      comp_sos_8+
      comp_sos_9+
      dllo_prof_1+
      dllo_prof_2+
      dllo_prof_3+
      lid_1+
      lid_2+
      ent_trab_1+
      ent_trab_2+
      covid_1+
      covid_2+
      covid_3+
      covid_4+
      intencion_1+
      com_1+
      com_2+
      ges_des_1+
      ges_des_2+
      comp_ben_1+
      comp_ben_2+
      superv_1+
      superv_2+
      superv_3+
      enps_lugar_trab+
      enps_prod_serv+
        suma_parcial, 
           method= c(
      sexo=3,
      b_ger=3,
      comp_sos_1=3,
      comp_sos_2=3,
      comp_sos_3=3,
      comp_sos_4=3,
      comp_sos_5=3,
      comp_sos_6=3,
      comp_sos_7=3,
      comp_sos_8=3,
      comp_sos_9=3,
      dllo_prof_1=3,
      dllo_prof_2=3,
      dllo_prof_3=3,
      lid_1=3,
      lid_2=3,
      ent_trab_1=3,
      ent_trab_2=3,
      covid_1=3,
      covid_2=3,
      covid_3=3,
      covid_4=3,
      intencion_1=3,
      com_1=3,
      com_2=3,
      ges_des_1=3,
      ges_des_2=3,
      comp_ben_1=3,
      comp_ben_2=3,
      superv_1=3,
      superv_2=3,
      superv_3=3,
      enps_lugar_trab=2,
      enps_prod_serv=2,
      suma_parcial=2
),
    data = encuesta_rec,
    include.miss = T, #baja el número de casos
    p.corrected=T,
    chisq.test.perm=T,
    chisq.test.seed=1234,
    var.equal=T)
  )

restab1_all <- createTable(table1_all, show.p.overall = T)

pvals1 <- getResults(table1_all)
#p.adjust(pvals, method = "BH")
export2md(restab1_all, size=10, first.strip=T, hide.no="no", position="center",
          format="html",caption= "Descriptivo Aplicación Total",
          col.names=c("Variables", "Todos los casos", "N")
         )%>%
  kableExtra::add_footnote(c("Note. N= Número de participantes con al menos una respuesta válida en las variables seleccionadas; Variables continuas se presentan como medianas y percentiles 25 y 75;", 
                             "Variables categóricas son presentadas como el recuento y el porcentaje"), notation = "none")%>%
  kableExtra::kable_classic() %>% 
  kableExtra::scroll_box(width = "100%", height = "800px")
```



```{r comparativo-sexo,dpi = 320, message=F, error=T, eval=F, warnings=F}
#janitor::tabyl(p20_contr_cont_med_pev_1_simpler)
#   p27_cond_trab_sup_jef
table2_sex <- suppressWarnings(compareGroups(sexo ~ 
      b_ger+
      comp_sos_1+
      comp_sos_2+
      comp_sos_3+
      comp_sos_4+
      comp_sos_5+
      comp_sos_6+
      comp_sos_7+
      comp_sos_8+
      comp_sos_9+
      dllo_prof_1+
      dllo_prof_2+
      dllo_prof_3+
      lid_1+
      lid_2+
      ent_trab_1+
      ent_trab_2+
      covid_1+
      covid_2+
      covid_3+
      covid_4+
      intencion_1+
      com_1+
      com_2+
      ges_des_1+
      ges_des_2+
      comp_ben_1+
      comp_ben_2+
      superv_1+
      superv_2+
      superv_3+
      enps_lugar_trab+
      enps_prod_serv+
        suma_parcial, 
           method= c(
      sexo=3,
      b_ger=3,
      comp_sos_1=3,
      comp_sos_2=3,
      comp_sos_3=3,
      comp_sos_4=3,
      comp_sos_5=3,
      comp_sos_6=3,
      comp_sos_7=3,
      comp_sos_8=3,
      comp_sos_9=3,
      dllo_prof_1=3,
      dllo_prof_2=3,
      dllo_prof_3=3,
      lid_1=3,
      lid_2=3,
      ent_trab_1=3,
      ent_trab_2=3,
      covid_1=3,
      covid_2=3,
      covid_3=3,
      covid_4=3,
      intencion_1=3,
      com_1=3,
      com_2=3,
      ges_des_1=3,
      ges_des_2=3,
      comp_ben_1=3,
      comp_ben_2=3,
      superv_1=3,
      superv_2=3,
      superv_3=3,
      enps_lugar_trab=2,
      enps_prod_serv=2,
      suma_parcial=2
),
    data = encuesta_rec,
    include.miss = T, #baja el número de casos
    p.corrected=T,
    chisq.test.perm=T,
    chisq.test.seed=1234,
    var.equal=T)
  )

restab2_sex <- createTable(table2_sex, show.p.overall = T)

pvals2 <- getResults(table2_sex)
#p.adjust(pvals, method = "BH")
export2md(restab2_sex, size=10, first.strip=T, hide.no="no", position="center",
          format="html",caption= "Descriptivo Aplicación Total según Sexo",
          col.names=c("Variables", "Hombres", "Mujeres", "Valor-p")
         )%>%
  kableExtra::add_footnote(c("Note. N= Número de participantes con al menos una respuesta válida en las variables seleccionadas; Variables continuas se presentan como medianas y percentiles 25 y 75;", 
                             "Variables categóricas son presentadas como el recuento y el porcentaje"), notation = "none")%>%
  kableExtra::kable_classic() %>% 
  kableExtra::scroll_box(width = "100%", height = "800px")
```

<br>

### Datos Generales

<br>

```{r fig-sex, dpi = 320, warning=T,message=F,fig.align='center', fig.cap="Sexo", error=T, out.width='100%', eval=T}
library(plotly)

sexo_df<-
encuesta_rec %>%
     dplyr::group_by(sexo)%>%
       dplyr::summarise(n=n(),percent=round(n/sum(n),2))%>% 
     dplyr::ungroup()%>%
    dplyr::mutate(valid_percent=scales::percent(n/(sum(n)-sum(n[is.na(sexo)])),2),
                  valid_percent=ifelse(is.na(sexo),NA,valid_percent),
                  percent=scales::percent(n/(sum(n)),2))%>%   
#      dplyr::mutate(label=paste0("",p7_exp_c19_trab_cont,"<br>",n,"(",percent,")<br>Válido= ",valid_percent)) %>% 
  dplyr::mutate(label=paste0(sexo,"\n(",valid_percent,")")) #%>%   
      #dplyr::filter(!is.na(sexo))
sex_plotly<-
sexo_df %>% 
plot_ly(labels = ~sexo, values = ~n, type = 'pie',hole = 0.6, textposition = 'outside',textinfo = 'text', sort = FALSE,
        automargin = TRUE,
        text = ~label,
        direction = "clockwise",
        textfont = list(color = "black", size = 14),
        marker = list(colors = c(gray.colors(length(unique(encuesta_rec$sexo))-1), "#FF5252"))) %>%
  layout(yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = T)) %>% 
  layout(xaxis = list(ticktext = c("Ninguno", "1 a 10", "11 a 30", "31 a 100", "No Responde")))%>% 
  layout(showlegend = FALSE) %>% 
  layout(margin = m)

htmltools::tagList(list(sex_plotly))

no_mostrar=0
if(no_mostrar==1){
p_10 %>% htmlwidgets::onRender(
        "function(el, x) {
  var gd = document.getElementById(el.id); 
  Plotly.downloadImage(gd, {format: 'svg', scale: 4, width: 600, height: 800,filename: 'p10'});
  }"
    )
}
```

```{r fig-gerencia, dpi = 320, warning=T,message=F,fig.align='center', fig.cap="Gerencia", error=T, out.width="100%", eval=T, fig.height=10, fig.width=10}

b_ger_df<-
encuesta_rec %>%
     dplyr::group_by(b_ger)%>%
       dplyr::summarise(n=n(),percent=round(n/sum(n),2))%>% 
     dplyr::ungroup()%>%
    dplyr::mutate(valid_percent=scales::percent(n/(sum(n)-sum(n[is.na(b_ger)])),2),
                  valid_percent=ifelse(is.na(b_ger),NA,valid_percent),
                  percent=scales::percent(n/(sum(n)),2))%>%   
#      dplyr::mutate(label=paste0("",p7_exp_c19_trab_cont,"<br>",n,"(",percent,")<br>Válido= ",valid_percent)) %>% 
  dplyr::mutate(label=paste0(b_ger,"\n(",valid_percent,")")) #%>%   

b_ger_plotly<-
b_ger_df %>% 
plot_ly(labels = ~b_ger, values = ~n, type = 'pie',hole = 0.3, textposition = 'outside',textinfo = 'text', sort = FALSE,
        automargin = TRUE,
        text = ~label,
        direction = "clockwise",
        textfont = list(color = "black", size = 14),
        marker = list(colors = c(gray.colors(length(unique(encuesta_rec$b_ger))-1), "#FF5252"))) %>%
  layout(yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = T)) %>% 
  layout(xaxis = list(ticktext = c("Ninguno", "1 a 10", "11 a 30", "31 a 100", "No Responde")))%>% 
  layout(showlegend = FALSE)%>% 
  layout(margin = m)

htmltools::tagList(list(b_ger_plotly))

no_mostrar=0
if(no_mostrar==1){
p_10 %>% htmlwidgets::onRender(
        "function(el, x) {
  var gd = document.getElementById(el.id); 
  Plotly.downloadImage(gd, {format: 'svg', scale: 4, width: 600, height: 800,filename: 'p10'});
  }"
    )
}
```

<br>

### Componentes

<br>

Se revirtieron los valores de los ítems correspondientes a insatisfacción (3 y 5), pero sólo para la suma de los puntajes.

<br>

```{r fig-comp-sos, echo=T, cache= T, paged.print=TRUE, warning=T, fig.cap="Gráfico de Barras, Preguntas Sobre Compromiso Sostenible", fig.align="center",error=T}
invisible(c("Compromiso Sostenible", "Desarrollo Profesional", "Liderazgo",	"Entorno de Trabajo", "Covid", "Intención de permanecer en la Compañía",	"Comunicación",	"Gestión del Desempeño",	"Compensación y Beneficios",	"Supervisor Inmediato"))
#`
comp_sos_bars<-
encuesta_rec %>% 
  dplyr::mutate_at(.vars=vars(starts_with("comp_sos_")),.funs = ~as.numeric(.)-1) %>% 
  dplyr::select(starts_with("comp_sos_")) %>% 
  tidyr::gather(key = "key", value = "val") %>% 
  dplyr::group_by(key,val) %>% 
  dplyr::mutate(sum=n()) %>% 
  dplyr::slice(1) %>% 
  dplyr::ungroup() %>% 
  dplyr::left_join(var_lbls_no_char,by=c("key"="nam")) %>% 
  dplyr::rename("label"="var_lab") %>% 
  dplyr::group_by(key) %>% 
  dplyr::mutate(label= max(label,na.rm=T)) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(key,val) %>% 
  dplyr::slice(1) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(val_text=dplyr::case_when(val==0~"Muy en desacuerdo(0)",
                                          val==1~"En desacuerdo(1)",
                                          val==2~"Ni acuerdo ni desacuerdo(2)",
                                          val==3~"De acuerdo(3)",
                                          val==4~"Muy de acuerdo(4)",
                                          is.na(val)~"No Responde"
                                            )) %>% 
  dplyr::mutate(items_num=as.numeric(substr(key, nchar(key), nchar(key)))) %>% 
  dplyr::group_by(key) %>% 
  dplyr::mutate(perc=scales::percent(sum/sum(sum)), 
                valid_perc=scales::percent(sum/sum(sum[!is.na(val)])),
                valid_perc=ifelse(is.na(val),NA,valid_perc)) %>% 
  dplyr::ungroup()%>% 
  dplyr::filter(!is.na(val))%>% 
  dplyr::mutate(valid_perc_num=readr::parse_number(valid_perc, "\\d+"))
  
for (i in 1:nrow(comp_sos_bars)){
  comp_sos_bars$label[i]<-stringi::stri_paste(paste(stringi::stri_wrap(comp_sos_bars$label[i], width =40), "<br>"), collapse='')
}  
comp_sos_bars$label_text<-paste0("Código: ",comp_sos_bars$key,"<br>Valor:",comp_sos_bars$val_text,"<br>Porcentaje:",comp_sos_bars$perc,"<br>Válido:",comp_sos_bars$valid_perc,"<br>Etiqueta:",comp_sos_bars$label)

comp_sos_bars_plot<-  
    ggplot(comp_sos_bars,aes(x=items_num,y=sum,fill=factor(val), label= label_text))+
    geom_col() +
  sjPlot::theme_sjplot2()+
  labs(x="Ítems",y="Número de Respuestas\n")+
  theme(strip.background  = element_blank(),
        strip.text = element_text(face="bold", size=7))+
  scale_x_continuous(breaks=c(1:9))+
  scale_fill_brewer(name= "Values",labels=c(paste0(1:length(levels(encuesta_rec$comp_sos_1))),"NR"), na.value = "gray80", palette="Reds")+
  theme(strip.text.x = element_text(size = 8, face = "bold"),
        axis.text.y = element_blank(),
        plot.caption=element_text(hjust = 0))

ggplotly(comp_sos_bars_plot, tooltip = c("label_text"))%>%
  layout(xaxis= list(showticklabels = T), showlegend=F)#, height = 750, width=1100)
```


```{r fig-comp-sos-b, echo=T, cache= T, paged.print=TRUE, warning=T, fig.cap="Gráfico de Barras, Preguntas Sobre Compromiso Sostenible", fig.align="center",error=T, fig.height=8}
invisible(c("Compromiso Sostenible", "Desarrollo Profesional", "Liderazgo",	"Entorno de Trabajo", "Covid", "Intención de permanecer en la Compañía",	"Comunicación",	"Gestión del Desempeño",	"Compensación y Beneficios",	"Supervisor Inmediato"))
library(ggrepel)
comp_sos_bars %>% 
ggplot(aes(x=items_num,y=valid_perc_num/100,fill=val_text, label= valid_perc))+
    geom_col() +
    scale_fill_grey(name= "Respuestas", start = 0.2, end = 0.8, na.value = "#FF5252")+#
  sjPlot::theme_sjplot2()+
  labs(x="Ítems",y="Número de Respuestas\n")+
      ylim(0,1.1)+
  #facet_wrap(~items, nrow = 3)+
  theme(strip.background  = element_blank(),
        strip.text = element_text(face="bold", size=6))+
  theme(strip.text.x = element_text(size = 10, face = "bold"),
        axis.text.x= element_text(size = 12),
        axis.title.y= element_blank(),
        axis.title.x= element_blank(),
        axis.text.y = element_blank(),
        legend.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.caption=element_text(hjust = 0),
        legend.position="bottom")+
  geom_label_repel(#position = position_dodge(width = .5),    # move to center of bars
              #vjust = 0,    # nudge above top of bar
            position = position_stack(vjust = 0.5),
              size = 6,
            direction = "y",
            force=1,
            seed=123,
            colour = "white", fontface = "bold")+ #+
  scale_x_discrete(limits =paste0(1:9))#+
  #scale_x_discrete(labels =c("Trabajo contribuye\nen la empresa","Formación y\npreparación","Oportunidades\nde formación"))
```

<br>

Se verá el Desarrollo Profesional


```{r fig-dllo-prof-1, echo=T, cache= T, paged.print=TRUE, warning=T, fig.cap="Gráfico de Barras, Desarrollo Profesional (1)", fig.align="center",error=T}
invisible(c("Compromiso Sostenible", "Desarrollo Profesional", "Liderazgo",	"Entorno de Trabajo", "Covid", "Intención de permanecer en la Compañía",	"Comunicación",	"Gestión del Desempeño",	"Compensación y Beneficios",	"Supervisor Inmediato"))
dllo_prof_bars<-
encuesta_rec %>% 
  dplyr::mutate_at(.vars=vars(paste0("dllo_prof_",1:3)),.funs = ~as.numeric(.)-1) %>% 
  dplyr::select(paste0("dllo_prof_",1:3)) %>% 
  tidyr::gather(key = "key", value = "val") %>% 
  dplyr::group_by(key,val) %>% 
  dplyr::mutate(sum=n()) %>% 
  dplyr::slice(1) %>% 
  dplyr::ungroup() %>% 
  dplyr::left_join(var_lbls_no_char,by=c("key"="nam")) %>% 
  dplyr::rename("label"="var_lab") %>% 
  dplyr::group_by(key) %>% 
  dplyr::mutate(label= max(label,na.rm=T)) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(key,val) %>% 
  dplyr::slice(1) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(val_text=dplyr::case_when(val==0~"Nunca(0)",
                                          val==1~"A veces(1)",
                                          val==2~"A menudo(2)",
                                          val==3~"Siempre(3)",
                                          is.na(val)~"No Responde")) %>% 
  dplyr::mutate(items_num=readr::parse_number(key, "\\d+")) %>% 
  #dplyr::mutate(items_num=as.numeric(substr(key, nchar(key), nchar(key))))
  dplyr::group_by(key) %>% 
  dplyr::mutate(perc=scales::percent(sum/sum(sum)), 
                valid_perc=scales::percent(sum/sum(sum[!is.na(val)])),
                valid_perc=ifelse(is.na(val),NA,valid_perc)) %>% 
  dplyr::ungroup()%>% 
  dplyr::filter(!is.na(val))%>% 
  dplyr::mutate(valid_perc_num=readr::parse_number(valid_perc, "\\d+"))
  
for (i in 1:nrow(dllo_prof_bars)){
  dllo_prof_bars$label[i]<-stringi::stri_paste(paste(stringi::stri_wrap(dllo_prof_bars$label[i], width =40), "<br>"), collapse='')
}  
dllo_prof_bars$label_text<-paste0("Código: ",dllo_prof_bars$key,"<br>Valor:",dllo_prof_bars$val_text,"<br>Porcentaje:",dllo_prof_bars$perc,"<br>Válido:",dllo_prof_bars$valid_perc,"<br>Etiqueta:",dllo_prof_bars$label)

dllo_prof_bars_plot<-  
    ggplot(dllo_prof_bars,aes(x=items_num,y=sum,fill=val, label= label_text))+
    geom_col() +
  sjPlot::theme_sjplot2()+
  labs(x="Ítems",y="Número de Respuestas\n")+
  theme(strip.background  = element_blank(),
        strip.text = element_text(face="bold", size=7))+
  scale_x_continuous(breaks=c(1:12))+
  scale_fill_brewer(name= "Values",labels=c(paste0(1:length(levels(encuesta_rec$dllo_prof_1))),"NR"), na.value = "gray80", palette="Reds")+
  theme(strip.text.x = element_text(size = 8, face = "bold"),
        axis.text.y = element_blank(),
        plot.caption=element_text(hjust = 0))


dllo_prof_bars_plot<-  
    ggplot(dllo_prof_bars,aes(x=items_num,y=sum,fill=factor(val), label= label_text))+
    geom_col() +
  sjPlot::theme_sjplot2()+
  labs(x="Ítems",y="Número de Respuestas\n")+
  theme(strip.background  = element_blank(),
        strip.text = element_text(face="bold", size=7))+
  scale_x_continuous(breaks=c(1:9))+
  scale_fill_brewer(name= "Values",labels=c(paste0(1:length(levels(encuesta_rec$dllo_prof_1))),"NR"), na.value = "gray80", palette="Reds")+
  theme(strip.text.x = element_text(size = 8, face = "bold"),
        axis.text.y = element_blank(),
        plot.caption=element_text(hjust = 0))

ggplotly(dllo_prof_bars_plot, tooltip = c("label_text"))%>%
  layout(xaxis= list(showticklabels = T), showlegend=F)#, height = 750, width=1100)
##, na.value = "gray80", palette="Reds"
```

```{r dllo-prof-2, echo=T, cache= T, paged.print=TRUE, warning=T, fig.cap="Gráfico de Barras, Preguntas Sobre Desarrollo Profesional (2)", fig.align="center",error=T, fig.height=8}
invisible("ALERTA: Que se modifique")

library(ggrepel)
dllo_prof_bars %>% 
ggplot(aes(x=as.character(key),y=valid_perc_num/100,fill=val_text, label= valid_perc))+
    geom_col() +
    scale_fill_grey(name= "Respuestas", start = 0.2, end = 0.8, na.value = "#FF5252")+#
  sjPlot::theme_sjplot2()+
  labs(x="Ítems",y="Número de Respuestas\n")+
      ylim(0,1.1)+
  #facet_wrap(~items, nrow = 3)+
  theme(strip.background  = element_blank(),
        strip.text = element_text(face="bold", size=6))+
  theme(strip.text.x = element_text(size = 13, face = "bold"),
        axis.text.x= element_text(size = 13),
        axis.title.y= element_blank(),
        axis.title.x= element_blank(),
        axis.text.y = element_blank(),
        legend.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.caption=element_text(hjust = 0),
        legend.position="bottom")+
  geom_label_repel(#position = position_dodge(width = .5),    # move to center of bars
              #vjust = 0,    # nudge above top of bar
            position = position_stack(vjust = 0.5),
              size = 6,
            direction = "y",
            force=1,
            seed=123,
            colour = "white", fontface = "bold") +
  #scale_x_discrete(limits =paste0("Desarrollo\nProfesional\n",1:3))
  scale_x_discrete(labels =c("Permanecer\nen la empresa","Formación y\npreparación","Oportunidades\nde formación"))
```

<br>

```{r fig-lid-ent-trab, echo=T, cache= T, paged.print=TRUE, warning=T, fig.cap="Gráfico de Barras, Preguntas Sobre Liderazgo y Entorno de Trabajo", fig.align="center",error=T}
lid_ent_trab_bars<-
encuesta_rec %>% 
  dplyr::mutate_at(.vars=vars(starts_with("lid"),starts_with("ent_trab")),.funs = ~as.numeric(.)-1) %>% 
  dplyr::select(starts_with("lid"),starts_with("ent_trab")) %>% 
  tidyr::gather(key = "key", value = "val") %>% 
  dplyr::group_by(key,val) %>% 
  dplyr::mutate(sum=n()) %>% 
  dplyr::slice(1) %>% 
  dplyr::ungroup() %>% 
  dplyr::left_join(var_lbls_no_char,by=c("key"="nam")) %>% 
  dplyr::rename("label"="var_lab") %>% 
  dplyr::group_by(key) %>% 
  dplyr::mutate(label= max(label,na.rm=T)) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(key,val) %>% 
  dplyr::slice(1) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(val_text=dplyr::case_when(val==0~"Nunca(0)",
                                          val==1~"Sólo unas pocas veces(1)",
                                          val==2~"Algunas veces(2)",
                                          val==3~"La mayoría de las veces(3)",
                                          val==4~"Siempre(4)",
                                          is.na(val)~"No Responde"
                                            )) %>% 
  dplyr::mutate(items_num=as.numeric(substr(key, nchar(key), nchar(key)))) %>% 
  #dplyr::mutate(items_num=readr::parse_number(key, "\\d+")) %>% 
  dplyr::group_by(key) %>% 
  dplyr::mutate(perc=scales::percent(sum/sum(sum)), 
                valid_perc=scales::percent(sum/sum(sum[!is.na(val)])),
                valid_perc=ifelse(is.na(val),NA,valid_perc)) %>% 
  dplyr::ungroup()%>% 
  dplyr::filter(!is.na(val))%>% 
  dplyr::mutate(valid_perc_num=readr::parse_number(valid_perc, "\\d+"))
  
for (i in 1:nrow(lid_ent_trab_bars)){
  lid_ent_trab_bars$label[i]<-stringi::stri_paste(paste(stringi::stri_wrap(lid_ent_trab_bars$label[i], width =40), "<br>"), collapse='')
}  
lid_ent_trab_bars$label_text<-paste0("Código: ",lid_ent_trab_bars$key,"<br>Valor:",lid_ent_trab_bars$val_text,"<br>Porcentaje:",lid_ent_trab_bars$perc,"<br>Válido:",lid_ent_trab_bars$valid_perc,"<br>Etiqueta:",lid_ent_trab_bars$label)

lid_ent_trab_bars_plot<-  
  #   ggplot(lid_ent_trab_bars,aes(x=items_num,y=sum,fill=val, label= label_text))+
  #   geom_col() +
  # sjPlot::theme_sjplot2()+
  # labs(x="Ítems",y="Número de Respuestas\n")+
  # theme(strip.background  = element_blank(),
  #       strip.text = element_text(face="bold", size=7))+
  # scale_x_continuous(breaks=c(1:6))+
  # theme(strip.text.x = element_text(size = 8, face = "bold"),
  #       axis.text.y = element_blank(),
  #       plot.caption=element_text(hjust = 0))
   ggplot(lid_ent_trab_bars,aes(x=key,y=sum,fill=factor(val), label= label_text))+
    geom_col() +
  sjPlot::theme_sjplot2()+
  labs(x="Ítems",y="Número de Respuestas\n")+
  theme(strip.background  = element_blank(),
        strip.text = element_text(face="bold", size=7))+
  #scale_x_continuous(breaks=c(1:9))+
  scale_fill_brewer(name= "Values",labels=c(paste0(1:length(levels(encuesta_rec$lid_1))),"NR"), na.value = "gray80", palette="Reds")+
  theme(strip.text.x = element_text(size = 8, face = "bold"),
        axis.text.y = element_blank(),
        plot.caption=element_text(hjust = 0))+
  scale_x_discrete(labels =c("Preocupación\ncomo empleado","Comodidad con\nvalores","Optimismo\nfuturo empresa","Confianza decisiones\n directivo"))

ggplotly(lid_ent_trab_bars_plot, tooltip = c("label_text"))%>%
  layout(xaxis= list(showticklabels = T), showlegend=F)#, height = 750, width=1100)
```

```{r fig-lid-ent-trab-2, echo=T, cache= T, paged.print=TRUE, warning=T, fig.cap="Gráfico de Barras, Preguntas Sobre Liderazgo y Entorno de Trabajo (2)", fig.align="center",error=T, fig.height=8}

library(ggrepel)
lid_ent_trab_bars %>% 
ggplot(aes(x=key,y=valid_perc_num/100,fill=val_text, label= valid_perc))+
    geom_col() +
    scale_fill_grey(name= "Respuestas", start = 0.2, end = 0.8, na.value = "#FF5252")+#
  sjPlot::theme_sjplot2()+
  labs(x="Ítems",y="Número de Respuestas\n")+
      ylim(0,1.1)+
  #facet_wrap(~items, nrow = 3)+
  theme(strip.background  = element_blank(),
        strip.text = element_text(face="bold", size=6))+
  theme(strip.text.x = element_text(size = 13, face = "bold"),
        axis.text.x= element_text(size = 13),
        axis.title.y= element_blank(),
        axis.title.x= element_blank(),
        axis.text.y = element_blank(),
        legend.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.caption=element_text(hjust = 0),
        legend.position="bottom")+
  geom_label_repel(#position = position_dodge(width = .5),    # move to center of bars
              #vjust = 0,    # nudge above top of bar
            position = position_stack(vjust = 0.5),
              size = 6,
            direction = "y",
            force=1,
            seed=123,
            colour = "white", fontface = "bold") +
  scale_x_discrete(labels =c("Preocupación\ncomo empleado","Comodidad con\nvalores","Optimismo\nfuturo empresa","Confianza decisiones\n directivo"))
```


```{r fig-covid-19, echo=T, cache= T, paged.print=TRUE, warning=T, fig.cap="Gráfico de Barras, Preguntas Sobre COVID-19", fig.align="center",error=T}
covid_19_bars<-
encuesta_rec %>% 
  dplyr::mutate_at(.vars=vars(paste0("covid_",1:4)),.funs = ~as.numeric(.)-1) %>% 
  dplyr::select(paste0("covid_",1:4)) %>% 
  tidyr::gather(key = "key", value = "val") %>% 
  dplyr::group_by(key,val) %>% 
  dplyr::mutate(sum=n()) %>% 
  dplyr::slice(1) %>% 
  dplyr::ungroup() %>% 
  dplyr::left_join(var_lbls_no_char,by=c("key"="nam")) %>% 
  dplyr::rename("label"="var_lab") %>% 
  dplyr::group_by(key) %>% 
  dplyr::mutate(label= max(label,na.rm=T)) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(key,val) %>% 
  dplyr::slice(1) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(val_text=dplyr::case_when(val==0~"Nunca(0)",
                                          val==1~"Sólo unas pocas veces(1)",
                                          val==2~"Algunas veces(2)",
                                          val==3~"La mayoría de las veces(3)",
                                          val==4~"Siempre(4)",
                                          is.na(val)~"No Responde"
                                            )) %>% 
  dplyr::mutate(items_num=as.numeric(substr(key, nchar(key), nchar(key)))) %>% 
  #dplyr::mutate(items_num=readr::parse_number(key, "\\d+")) %>% 
  dplyr::group_by(key) %>% 
  dplyr::mutate(perc=scales::percent(sum/sum(sum)), 
                valid_perc=scales::percent(sum/sum(sum[!is.na(val)])),
                valid_perc=ifelse(is.na(val),NA,valid_perc)) %>% 
  dplyr::ungroup()%>% 
  dplyr::filter(!is.na(val))%>% 
  dplyr::mutate(valid_perc_num=readr::parse_number(valid_perc, "\\d+"))
  
for (i in 1:nrow(covid_19_bars)){
  covid_19_bars$label[i]<-stringi::stri_paste(paste(stringi::stri_wrap(covid_19_bars$label[i], width =40), "<br>"), collapse='')
}  
covid_19_bars$label_text<-paste0("Código: ",covid_19_bars$key,"<br>Valor:",covid_19_bars$val_text,"<br>Porcentaje:",covid_19_bars$perc,"<br>Válido:",covid_19_bars$valid_perc,"<br>Etiqueta:",covid_19_bars$label)

covid_19_bars_plot<-  
  #   ggplot(lid_ent_trab_bars,aes(x=items_num,y=sum,fill=val, label= label_text))+
  #   geom_col() +
  # sjPlot::theme_sjplot2()+
  # labs(x="Ítems",y="Número de Respuestas\n")+
  # theme(strip.background  = element_blank(),
  #       strip.text = element_text(face="bold", size=7))+
  # scale_x_continuous(breaks=c(1:6))+
  # theme(strip.text.x = element_text(size = 8, face = "bold"),
  #       axis.text.y = element_blank(),
  #       plot.caption=element_text(hjust = 0))
   ggplot(covid_19_bars,aes(x=key,y=sum,fill=factor(val), label= label_text))+
    geom_col() +
  sjPlot::theme_sjplot2()+
  labs(x="Ítems",y="Número de Respuestas\n")+
  theme(strip.background  = element_blank(),
        strip.text = element_text(face="bold", size=7))+
  #scale_x_continuous(breaks=c(1:9))+
  scale_fill_brewer(name= "Values",labels=c(paste0(1:length(levels(encuesta_rec$covid_1))),"NR"), na.value = "gray80", palette="Reds")+
  theme(strip.text.x = element_text(size = 8, face = "bold"),
        axis.text.y = element_blank(),
        plot.caption=element_text(hjust = 0))+
  scale_x_discrete(labels =c("Confianza\nrespuesta líderes","Compañía\nprotege","Confianza\nprotección líderes","Información\n trabajadores"))

ggplotly(covid_19_bars_plot, tooltip = c("label_text"))%>%
  layout(xaxis= list(showticklabels = T), showlegend=F)#, height = 750, width=1100)
```

```{r covid-19-2, echo=T, cache= T, paged.print=TRUE, warning=T, fig.cap="Gráfico de Barras, Preguntas Sobre COVID-19 (2)", fig.align="center",error=T, fig.height=8}

library(ggrepel)
covid_19_bars %>% 
ggplot(aes(x=key,y=valid_perc_num/100,fill=val_text, label= valid_perc))+
    geom_col() +
    scale_fill_grey(name= "Respuestas", start = 0.2, end = 0.8, na.value = "#FF5252")+#
  sjPlot::theme_sjplot2()+
  labs(x="Ítems",y="Número de Respuestas\n")+
      ylim(0,1.1)+
  #facet_wrap(~items, nrow = 3)+
  theme(strip.background  = element_blank(),
        strip.text = element_text(face="bold", size=6))+
  theme(strip.text.x = element_text(size = 13, face = "bold"),
        axis.text.x= element_text(size = 13),
        axis.title.y= element_blank(),
        axis.title.x= element_blank(),
        axis.text.y = element_blank(),
        legend.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.caption=element_text(hjust = 0),
        legend.position="bottom")+
  geom_label_repel(#position = position_dodge(width = .5),    # move to center of bars
              #vjust = 0,    # nudge above top of bar
            position = position_stack(vjust = 0.5),
              size = 6,
            direction = "y",
            force=1,
            seed=123,
            colour = "white", fontface = "bold") +
  scale_x_discrete(labels =c("Confianza\nrespuesta líderes","Compañía\nprotege","Confianza\nprotección líderes","Información\n trabajadores"))
```


```{r otros1, echo=T, cache= T, paged.print=TRUE, warning=T, fig.cap="Gráfico de Barras, Preguntas Sobre Otras variables", fig.align="center",error=T}
#"com_1"           "com_2"           "ges_des_1"       "ges_des_2"      
#[37] "comp_ben_1"      "comp_ben_2"     
resto_bars<-
encuesta_rec %>% 
  dplyr::mutate_at(.vars=vars(c("com_1", "com_2", "ges_des_1", "ges_des_2", "comp_ben_1", "comp_ben_2")),.funs = ~as.numeric(.)-1) %>% 
  dplyr::select(c("com_1", "com_2", "ges_des_1", "ges_des_2", "comp_ben_1", "comp_ben_2")) %>% 
  tidyr::gather(key = "key", value = "val") %>% 
  dplyr::group_by(key,val) %>% 
  dplyr::mutate(sum=n()) %>% 
  dplyr::slice(1) %>% 
  dplyr::ungroup() %>% 
  dplyr::left_join(var_lbls_no_char,by=c("key"="nam")) %>% 
  dplyr::rename("label"="var_lab") %>% 
  dplyr::group_by(key) %>% 
  dplyr::mutate(label= max(label,na.rm=T)) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(key,val) %>% 
  dplyr::slice(1) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(val_text=dplyr::case_when(val==0~"Nunca(0)",
                                          val==1~"Sólo unas pocas veces(1)",
                                          val==2~"Algunas veces(2)",
                                          val==3~"La mayoría de las veces(3)",
                                          val==4~"Siempre(4)",
                                          is.na(val)~"No Responde"
                                            )) %>% 
  dplyr::mutate(items_num=as.numeric(substr(key, nchar(key), nchar(key)))) %>% 
  #dplyr::mutate(items_num=readr::parse_number(key, "\\d+")) %>% 
  dplyr::group_by(key) %>% 
  dplyr::mutate(perc=scales::percent(sum/sum(sum)), 
                valid_perc=scales::percent(sum/sum(sum[!is.na(val)])),
                valid_perc=ifelse(is.na(val),NA,valid_perc)) %>% 
  dplyr::ungroup()%>% 
  dplyr::filter(!is.na(val))%>% 
  dplyr::mutate(valid_perc_num=readr::parse_number(valid_perc, "\\d+"))
  
for (i in 1:nrow(resto_bars)){
  resto_bars$label[i]<-stringi::stri_paste(paste(stringi::stri_wrap(resto_bars$label[i], width =40), "<br>"), collapse='')
}  
resto_bars$label_text<-paste0("Código: ",resto_bars$key,"<br>Valor:",resto_bars$val_text,"<br>Porcentaje:",resto_bars$perc,"<br>Válido:",resto_bars$valid_perc,"<br>Etiqueta:",resto_bars$label)

resto_bars_plot<-  
  #   ggplot(lid_ent_trab_bars,aes(x=items_num,y=sum,fill=val, label= label_text))+
  #   geom_col() +
  # sjPlot::theme_sjplot2()+
  # labs(x="Ítems",y="Número de Respuestas\n")+
  # theme(strip.background  = element_blank(),
  #       strip.text = element_text(face="bold", size=7))+
  # scale_x_continuous(breaks=c(1:6))+
  # theme(strip.text.x = element_text(size = 8, face = "bold"),
  #       axis.text.y = element_blank(),
  #       plot.caption=element_text(hjust = 0))
   ggplot(resto_bars,aes(x=key,y=sum,fill=factor(val), label= label_text))+
    geom_col() +
  sjPlot::theme_sjplot2()+
  labs(x="Ítems",y="Número de Respuestas\n")+
  theme(strip.background  = element_blank(),
        strip.text = element_text(face="bold", size=7))+
  #scale_x_continuous(breaks=c(1:9))+
  scale_fill_brewer(name= "Values",labels=c(paste0(1:length(levels(encuesta_rec$comp_ben_1))),"NR"), na.value = "gray80", palette="Reds")+
  theme(strip.text.x = element_text(size = 8, face = "bold"),
        axis.text.y = element_blank(),
        plot.caption=element_text(hjust = 0))+
  scale_x_discrete(labels =c("Esfuerzo\nconocer\nempleados","Información\npara hacer\ntrabajo","Programa\nBeneficios\n responde\nnecesidades", "Remuneraciones\ncompetitivas","Recibe\nfeedback\nregular","Reconoce\ndesempeño\nexcelente"))

ggplotly(resto_bars_plot, tooltip = c("label_text"))%>%
  layout(xaxis= list(showticklabels = T), showlegend=F)#, height = 750, width=1100)
```

```{r otros-2, echo=T, cache= T, paged.print=TRUE, warning=T, fig.cap="Gráfico de Barras, Preguntas Sobre Otras variables (2)", fig.align="center",error=T, fig.height=8}

library(ggrepel)
resto_bars %>% 
ggplot(aes(x=key,y=valid_perc_num/100,fill=val_text, label= valid_perc))+
    geom_col() +
    scale_fill_grey(name= "Respuestas", start = 0.2, end = 0.8, na.value = "#FF5252")+#
  sjPlot::theme_sjplot2()+
  labs(x="Ítems",y="Número de Respuestas\n")+
      ylim(0,1.1)+
  #facet_wrap(~items, nrow = 3)+
  theme(strip.background  = element_blank(),
        strip.text = element_text(face="bold", size=6))+
  theme(strip.text.x = element_text(size = 13, face = "bold"),
        axis.text.x= element_text(size = 13),
        axis.title.y= element_blank(),
        axis.title.x= element_blank(),
        axis.text.y = element_blank(),
        legend.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.caption=element_text(hjust = 0),
        legend.position="bottom")+
  geom_label_repel(#position = position_dodge(width = .5),    # move to center of bars
              #vjust = 0,    # nudge above top of bar
            position = position_stack(vjust = 0.5),
              size = 6,
            direction = "y",
            force=1,
            seed=123,
            colour = "white", fontface = "bold")+
  scale_x_discrete(labels =c("Esfuerzo conocer\nempleados","Información para\n hacer\ntrabajo","Programa\nBeneficios\n responde\nnecesidades", "Remuneraciones\ncompetitivas","Recibe\nfeedback\nregular","Reconoce\ndesempeño\nexcelente"))
```

```{r fig-superv1, echo=T, cache= T, paged.print=TRUE, warning=T, fig.cap="Gráfico de Barras, Preguntas Sobre Supervisor/a", fig.align="center",error=T}
superv_bars<-
encuesta_rec %>% 
  dplyr::mutate_at(.vars=vars(paste0("superv_",1:3)),.funs = ~as.numeric(.)-1) %>% 
  dplyr::select(paste0("superv_",1:3)) %>% 
  tidyr::gather(key = "key", value = "val") %>% 
  dplyr::group_by(key,val) %>% 
  dplyr::mutate(sum=n()) %>% 
  dplyr::slice(1) %>% 
  dplyr::ungroup() %>% 
  dplyr::left_join(var_lbls_no_char,by=c("key"="nam")) %>% 
  dplyr::rename("label"="var_lab") %>% 
  dplyr::group_by(key) %>% 
  dplyr::mutate(label= max(label,na.rm=T)) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(key,val) %>% 
  dplyr::slice(1) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(val_text=dplyr::case_when(val==0~"Nunca(0)",
                                          val==1~"Sólo unas pocas veces(1)",
                                          val==2~"Algunas veces(2)",
                                          val==3~"La mayoría de las veces(3)",
                                          val==4~"Siempre(4)",
                                          is.na(val)~"No Responde"
                                            )) %>% 
  dplyr::mutate(items_num=as.numeric(substr(key, nchar(key), nchar(key)))) %>% 
  #dplyr::mutate(items_num=readr::parse_number(key, "\\d+")) %>% 
  dplyr::group_by(key) %>% 
  dplyr::mutate(perc=scales::percent(sum/sum(sum)), 
                valid_perc=scales::percent(sum/sum(sum[!is.na(val)])),
                valid_perc=ifelse(is.na(val),NA,valid_perc)) %>% 
  dplyr::ungroup()%>% 
  dplyr::filter(!is.na(val))%>% 
  dplyr::mutate(valid_perc_num=readr::parse_number(valid_perc, "\\d+"))
  
for (i in 1:nrow(superv_bars)){
  superv_bars$label[i]<-stringi::stri_paste(paste(stringi::stri_wrap(superv_bars$label[i], width =40), "<br>"), collapse='')
}  
superv_bars$label_text<-paste0("Código: ",superv_bars$key,"<br>Valor:",superv_bars$val_text,"<br>Porcentaje:",superv_bars$perc,"<br>Válido:",superv_bars$valid_perc,"<br>Etiqueta:",superv_bars$label)

superv_bars_plot<-  
  #   ggplot(lid_ent_trab_bars,aes(x=items_num,y=sum,fill=val, label= label_text))+
  #   geom_col() +
  # sjPlot::theme_sjplot2()+
  # labs(x="Ítems",y="Número de Respuestas\n")+
  # theme(strip.background  = element_blank(),
  #       strip.text = element_text(face="bold", size=7))+
  # scale_x_continuous(breaks=c(1:6))+
  # theme(strip.text.x = element_text(size = 8, face = "bold"),
  #       axis.text.y = element_blank(),
  #       plot.caption=element_text(hjust = 0))
   ggplot(superv_bars,aes(x=key,y=sum,fill=factor(val), label= label_text))+
    geom_col() +
  sjPlot::theme_sjplot2()+
  labs(x="Ítems",y="Número de Respuestas\n")+
  theme(strip.background  = element_blank(),
        strip.text = element_text(face="bold", size=7))+
  #scale_x_continuous(breaks=c(1:9))+
  scale_fill_brewer(name= "Values",labels=c(paste0(1:length(levels(encuesta_rec$superv_1))),"NR"), na.value = "gray80", palette="Reds")+
  theme(strip.text.x = element_text(size = 8, face = "bold"),
        axis.text.y = element_blank(),
        plot.caption=element_text(hjust = 0))+
  scale_x_discrete(labels =c("Fomenta trabajo\nen equipo","Reconoce buen\n trabajo","Fomenta\nel desarrollo"))

ggplotly(superv_bars_plot, tooltip = c("label_text"))%>%
  layout(xaxis= list(showticklabels = T), showlegend=F)#, height = 750, width=1100)
```

```{r superv-2, echo=T, cache= T, paged.print=TRUE, warning=T, fig.cap="Gráfico de Barras, Preguntas Sobre Supervisor/a (2)", fig.align="center",error=T, fig.height=8}

library(ggrepel)
superv_bars %>% 
ggplot(aes(x=key,y=valid_perc_num/100,fill=val_text, label= valid_perc))+
    geom_col() +
    scale_fill_grey(name= "Respuestas", start = 0.2, end = 0.8, na.value = "#FF5252")+#
  sjPlot::theme_sjplot2()+
  labs(x="Ítems",y="Número de Respuestas\n")+
      ylim(0,1.1)+
  #facet_wrap(~items, nrow = 3)+
  theme(strip.background  = element_blank(),
        strip.text = element_text(face="bold", size=6))+
  theme(strip.text.x = element_text(size = 13, face = "bold"),
        axis.text.x= element_text(size = 13),
        axis.title.y= element_blank(),
        axis.title.x= element_blank(),
        axis.text.y = element_blank(),
        legend.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.caption=element_text(hjust = 0),
        legend.position="bottom")+
  geom_label_repel(#position = position_dodge(width = .5),    # move to center of bars
              #vjust = 0,    # nudge above top of bar
            position = position_stack(vjust = 0.5),
              size = 6,
            direction = "y",
            force=1,
            seed=123,
            colour = "white", fontface = "bold") +
  scale_x_discrete(labels =c("Fomenta trabajo\nen equipo","Reconoce buen\n trabajo","Fomenta\nel desarrollo"))
```

<br>

---------------------------------------------------------------------------------


# Compilación

## Descarga para exportación

```{r save-export, echo=T, cache= T, paged.print=TRUE, warning=F, error=T}

#attr(uss_rec$surv,"label")<- "Supervivencia de Respuestas"

var_labels_df<-data.frame()
for (i in 1:length(encuesta_rec)){
  x<-names(encuesta_rec)[i]
var_labels_df<-rbind.data.frame(var_labels_df, cbind(x, attr(encuesta_rec[[x]],"label")))
}

codebook::var_label(encuesta_rec) <-
var_labels_df%>% 
  codebook::dict_to_list()

#rio::export(encuesta_rec, file= paste0(getwd(),"/_bd_encuesta_rec_ins.dta"))

write_csv2(encuesta_rec,
  paste0(getwd(),"/_bd_encuesta_rec_ins2022.csv"),
           na="")

save.image("__encuesta_rec_exp_post_crash2022.RData")
```

Para explorar los datos de la encuesta 2022

<div style="border: 1px solid #ddd; padding: 5px; overflow-y: scroll; height:600px; overflow-x: scroll; width:100%">
```{r tab-exp, message=FALSE, warning=FALSE, eval=T}
rpivotTable(data = encuesta2_rec %>% dplyr::select(-(hora:correo_val_cor)), rows="b_ger",cols = c("sexo"), vals = "Cuenta", aggregatorName = "Cuenta",rendererName = "Table", locale="es")
```
</div>

<br>

<br>

<br>

```{r expandr-para-la-gente, message=FALSE, warning=FALSE, eval=F}
rm(list=ls());gc()

load("__encuesta_rec_exp_post_crash2.RData")

ExPanDaR::ExPanD(df= encuesta_rec %>% dplyr::select(-(response_id:custom_value)) %>%  dplyr::select(-correo),title = "Datos Encuesta Empresa Seguridad")
#options(rsconnect.http.trace = TRUE)
#options(rsconnect.http.verbose = TRUE)
#options(rsconnect.launch.browser = FALSE)
#getOption("rsconnect.max.bundle.size")
options(shiny.error = browser)

## Including Plots
#plot(pressure)
```

## Información de la Sesión

```{r session_info, echo=T, paged.print=TRUE}
Sys.getenv("R_LIBS_USER")
rstudioapi::getSourceEditorContext()


cbind.data.frame(label=data.frame(attr(unlist(sessionInfo()$R.version),"names")),data.table::data.table(unlist(sessionInfo()$R.version))) %>% 
  knitr::kable(format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Propiedades del documento"),
               col.names = c("Categoría","Valor"),
               align =c('l',rep('c', 101)),
               escape=T)%>%
    kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 12)

sessionInfo()$locale
sessionInfo()$running

sesion_info <- devtools::session_info()
dplyr::select(
  tibble::as_tibble(sesion_info$packages),
  c(package, loadedversion, source)
) %>% 
  DT::datatable(filter = 'top', colnames = c('Row number' =1,'Variable' = 2, 'Percentage'= 3),
              caption = htmltools::tags$caption(
        style = 'caption-side: top; text-align: left;',
        '', htmltools::em('Paquetes estadísticos utilizados')),
      options=list(
initComplete = htmlwidgets::JS(
        "function(settings, json) {",
        "$(this.api().tables().body()).css({
            'font-family': 'Helvetica Neue',
            'font-size': '50%', 
            'code-inline-font-size': '15%', 
            'white-space': 'nowrap',
            'line-height': '0.75em',
            'min-height': '0.5em'
            });",#;
        "}")))

unlink("*_cache", recursive = T, force = T, expand = TRUE)
```

