---
title: "Material Suplementario"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: hide
    toc: true # table of content true
    toc_depth: 5  # upto three depths of headings (specified by #, ## and ###)
    toc_float: true
bibliography: rmarkdown_validacion.bib
nocite: '@*'
---

```{css zoom-lib-src, echo = FALSE}
script src = "https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"
```

```{js zoom-jquery, echo = FALSE}
 $(document).ready(function() {
    $('body').prepend('<div class=\"zoomDiv\"><img src=\"\" class=\"zoomImg\"></div>');
    // onClick function for all plots (img's)
    $('img:not(.zoomImg)').click(function() {
      $('.zoomImg').attr('src', $(this).attr('src')).css({width: '100%'});
      $('.zoomDiv').css({opacity: '1', width: 'auto', border: '1px solid white', borderRadius: '5px', position: 'fixed', top: '50%', left: '50%', marginRight: '-50%', transform: 'translate(-50%, -50%)', boxShadow: '0px 0px 50px #888888', zIndex: '50', overflow: 'auto', maxHeight: '100%'});
    });
    // onClick function for zoomImg
    $('img.zoomImg').click(function() {
      $('.zoomDiv').css({opacity: '0', width: '0%'}); 
    });
  });
```

```{=html}
<style type="text/css">
.tablelines table, .tablelines td, .tablelines th {
        border: 1px solid black;
        }
.centrado {
    text-align: center;
}
.table.center {
    margin-left:auto; 
    margin-right:auto;
  }
.table_wrapper{
    display: block;
    overflow-x: auto;
    white-space: nowrap;
}
code.r{
  font-size: 8px;
}
body{ /* Normal  */
      text-align: justify;
  }
.superbigimage{
    overflow-y:scroll;
    white-space: nowrap;
}
.superbigimage img{
    overflow-y: scroll;
    overflow-x: hidden;
}
</style>
```

```{=html}
<style>
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 20px; text-align: justify;}
</style>
```

```{r setup001, include=F, eval=F}
if(isTRUE(getOption('knitr.in.progress'))==T){
  
  load(paste0(getwd(),"/BD_2020_for_svychisq.Rdata"))
  BD_2020_input_filter<-BD_2020_input[,c(paste0("naq",1:22),paste0("lid_des",1:14), paste0("a47_top_",1:6),paste0("prec",c(1,2,3,5,6,7,8)),"prec3r",paste0("vul",1:7),"k6_2", "k2_elevado","climasex", "mujer", "precr1","vul","zona","weight", "autonaq", "ocuprev_nocalif")]
  
  saveRDS(BD_2020_input_filter, file = "my_data.rds")

    BD_2020_input<-readRDS(file = "my_data.rds")
}
```

```{r setup01, include=T, eval=T}
rm(list=ls());gc()
temp <- tempfile()
#https://drive.google.com/file/d/1Uuu0BdgnDyKPNsrWfBzL4qJGo1a5U_3L/view?usp=sharing
BD_2020_input<-readRDS(url("https://drive.google.com/uc?export=download&id=1Uuu0BdgnDyKPNsrWfBzL4qJGo1a5U_3L","rb")) 
#xaringan::inf_mr()
```

```{r setup, include=T, message=F, warning=F}

if(!require(dplyr)){install.packages("dplyr")}
if(!require(rmarkdown)){install.packages("rmarkdown")}
if(!require(survey)){install.packages("survey")}
if(!require(DT)){install.packages("DT")}
if(!require(htmlwidgets)){install.packages("htmlwidgets")}
if(!require(ggplot2)){install.packages("ggplot2")}
if(!require(jtools)){install.packages("jtools")}
if(!require(lavaan)){install.packages("lavaan")}
if(!require(psych)){install.packages("psych")}
if(!require(weights)){install.packages("weights")}
if(!require(coefficientalpha)){install.packages("coefficientalpha")}
if(!require(semTools)){install.packages("psychometric")}
if(!require(lavaan.survey)){install.packages("lavaan.survey")}
if(!require(data.table)){install.packages("data.table")}
#if(!require(VGAM)){install.packages("VGAM")}
if(!require(knitr)){install.packages("knitr")}
if(!require(kableExtra)){install.packages("kableExtra")}
if(!require(Weighted.Desc.Stat)){install.packages("Weighted.Desc.Stat")}
if(!require(ufs)){install.packages("ufs")}
if(!require(finalfit)){install.packages("finalfit")}
if(!require(stringr)){install.packages("stringr")}
if(!require(janitor)){install.packages("janitor")}
if(!require(lavaanPlot)){install.packages("lavaanPlot")}

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#
#FUNCIONES GENERICAS
local({r <- getOption("repos")
       r["CRAN"] <- "http://cran.r-project.org" 
       options(repos=r)
})
copiar_nombres <- function(x,row.names=FALSE,col.names=TRUE,dec=",",...) {
  if(class(ungroup(x))[1]=="tbl_df"){
        if(options()$OutDec=="."){
            options(OutDec = dec)
            write.table(format(data.frame(x)),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ".")
          return(x)
        } else {
            options(OutDec = ",")
            write.table(format(data.frame(x)),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ",")
          return(x)    
        }
  } else {
        if(options()$OutDec=="."){
            options(OutDec = dec)
            write.table(format(x),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ".")
          return(x)
        } else {
            options(OutDec = ",")
            write.table(format(x),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ",")
          return(x)       
  }
 }
}  
guardar_tablas <- function (x,y) {writexl::write_xlsx(as.data.frame(x, keeprownames= T),paste0(y,".xlsx"))}
grabar_doc <- function(x) {paste0(dirname(file.choose()),"/",x)}


#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
ajusteAFC <- function (x) {as.data.frame(cbind("Modelo"=deparse(substitute(x)),
                    "gl"=round(lavaan::fitMeasures(x) ["df"],digits=3),
                    "WLS X2"=round(lavaan::fitMeasures(x)["chisq"],digits=3),
                    "CMIN/df"=round((lavaan::fitMeasures(x)["chisq"]/fitMeasures(x) ["df"]),digits=3),
                    "aGFI"=round(lavaan::fitMeasures(x)["agfi"],digits=3),
                    "GFI"=round(lavaan::fitMeasures(x)["gfi"],digits=3),
                    "RMSEA [90% IC]"=paste0(round(lavaan::fitMeasures(x) ["rmsea"],3),"[",round(lavaan::fitMeasures(x) ["rmsea.ci.lower"],3),"-",round(lavaan::fitMeasures(x) ["rmsea.ci.upper"],3),"]"),
                    "CFit"=round(lavaan::fitMeasures(x)["rmsea.pvalue"],digits=3),
                    "CFI"=round(lavaan::fitMeasures(x)["cfi"],digits=3),
                    "NNFI"=round(lavaan::fitMeasures(x)["nnfi"],digits=3)))

  
  return(
    as.data.frame(cbind("Modelo"=deparse(substitute(x)),
                    "gl"=round(lavaan::fitMeasures(x) ["df"],digits=3),
                    "WLS X2"=sprintf("%7.3f",round(lavaan::fitMeasures(x)["chisq"],digits=3)),
                    "CMIN/df"=sprintf("%5.3f",round((lavaan::fitMeasures(x)["chisq"]/fitMeasures(x) ["df"]),digits=3)),
                    "aGFI"=sprintf("%5.3f",round(lavaan::fitMeasures(x)["agfi"],digits=3)),
                    "GFI"=sprintf("%5.3f",round(lavaan::fitMeasures(x)["gfi"],digits=3)),
                    "RMSEA [90% IC]"=paste0(sprintf("%5.3f",round(lavaan::fitMeasures(x) ["rmsea"],3)),"[",sprintf("%5.3f",round(lavaan::fitMeasures(x) ["rmsea.ci.lower"],3)),"-",sprintf("%5.3f",round(lavaan::fitMeasures(x) ["rmsea.ci.upper"],3)),"]"),
                    "CFit"=sprintf("%5.3f",round(lavaan::fitMeasures(x)["rmsea.pvalue"],digits=3)),
                    "CFI"=sprintf("%5.3f",round(lavaan::fitMeasures(x)["cfi"],digits=3)),
                    "NNFI"=sprintf("%5.3f",round(lavaan::fitMeasures(x)["nnfi"],digits=3))))
  )
}

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

LR_svy2<- function (x, y, z) {
  return(paste0("-2Log(LR) (",
                regTermTest(x,as.formula(paste0("~",y,"+",z)), method="LRT")$df, ", ",
                regTermTest(x,as.formula(paste0("~",y,"+",z)), method="LRT")$ddf, ")= ",
                sprintf(round(as.numeric(regTermTest(x,as.formula(paste0("~",y,"+",z)), method="LRT")$chisq/
                                           regTermTest(x,as.formula(paste0("~",y,"+",z)), method="LRT")$lambda), 3), fmt = '%#.3f'),
                regTermTest(x,as.formula(paste0("~",y,"+",z)), method="LRT")$ddf, ", p=",
                round(regTermTest(x,as.formula(paste0("~",y,"+",z)),method="LRT")$p,5)))
}
LR_svy1<- function (x, y) {
  return(paste0("-2Log(LR) (",
                regTermTest(x,as.formula(paste0("~",y)), method="LRT")$df, ", ",
                regTermTest(x,as.formula(paste0("~",y)), method="LRT")$ddf, ")= ",
                sprintf(round(as.numeric(regTermTest(x,as.formula(paste0("~",y)), method="LRT")$chisq/
                                           regTermTest(x,as.formula(paste0("~",y)), method="LRT")$lambda), 3), fmt = '%#.3f'),
                regTermTest(x,as.formula(paste0("~",y)), method="LRT")$ddf, ", p=",
                round(regTermTest(x,as.formula(paste0("~",y)),method="LRT")$p,5)))
  
}
LR_svy3<- function (x, y, z, a) {
  paste0("-2Log(LR) (",
         regTermTest(x,as.formula(paste0("~",y,"+",z,"+",a)), method="LRT")$df, ", ",
         regTermTest(x,as.formula(paste0("~",y,"+",z,"+",a)), method="LRT")$ddf, ")= ",
         sprintf(round(as.numeric(regTermTest(x,as.formula(paste0("~",y,"+",z,"+",a)), method="LRT")$chisq/
                                    regTermTest(x,as.formula(paste0("~",y,"+",z,"+",a)), method="LRT")$lambda), 3), fmt = '%#.3f'),
         regTermTest(x,as.formula(paste0("~",y,"+",z,"+",a)), method="LRT")$ddf, ", p=",
         round(regTermTest(x,as.formula(paste0("~",y,"+",z,"+",a)),method="LRT")$p,5))
}
weighted.moments <-
  function(x,w8=NULL){
    if(is.null(w8)) w8<-rep(1,length(x))
    w  <- w8/sum(w8)
    n  <- length(x)
    Ex <- t(x)%*%w
    wm <- Ex
    Ex2<- t(x*x)%*%w 
    wsd<- sqrt(1/(1-sum(w^2))*(Ex2-wm^2)) # using Cramer and cov.wt (using unbiased method)
    wtd.sd<-sqrt(wtd.var(x,w8)) #using Hmisc
    Ex3<- t(x^3)%*%w
    wsk<- n^(5/2)/((n-1)*(n-2))*t(w^(3/2))%*%(((x-wm)/wsd)^3)
    m2.stata<- t(w)%*%((x-wm)^2) # see summarize in stata manual p.1825-6
    m3.stata<- t(w)%*%((x-wm)^3) 
    wsk.stata<-m3.stata / m2.stata^(3/2) 
    list(fm=Ex,weighted.mean=wm,sm=Ex2,weighted.sd=wsd,wtd.sd=wtd.sd,tm=Ex3,w.skew.SAS=wsk,w.skew.Stata=wsk.stata) # using formulae from SAS and from Stata
  }

exportar<- function (x) {temp <- round(data.frame(cbind(lmtest::coeftest(x), 
                                                        exp(coef(x)),exp(confint(x)))),3)
temp2 <- setNames(temp, c("Variables","Est","Std. Err.", "Z value", "p|z|","OR","95% CI - +"))
return(copiar_nombres(temp2))}
```

```{r paso0_definir_diseno_muestral,eval=T, echo=T, paged.print=TRUE, eval=T}
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

dsgn_BD_05_02 <- survey::svydesign(ids = ~1, data = BD_2020_input, weights = ~weight)

dsgn_mujer<- subset(BD_2020_input,mujer==1)
dsgn_hombre<- subset(BD_2020_input,mujer==0)
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
condisc <- function(x){
    std.loadings<- inspect(x, what="std")$lambda
    #std.loadings
    std.loadings[std.loadings==0] <- NA
    #std.loadings
    std.loadings <- std.loadings^2
    #std.loadings
    ave <- colMeans(std.loadings, na.rm=TRUE)
    #ave
    #factor correlation matrix
    fcor <- lavInspect(x, "cor.lv")
    #fcor
    sqfcor <- fcor^2
    #sqfcor
    list(Squared_Factor_Correlation=round(sqfcor, digits=2),
         Average_Variance_Extracted=round(ave, digits=2))
    #https://github.com/mmoglu/condisc
}

options(OutDec= ".")
```

# Exploratorio

A continuación se presenta un resumen de los datos.

```{r paso1_definir_var_y_transf,eval=T, echo=T, paged.print=TRUE, eval=T}
no_mostrar=1
if(no_mostrar==0){
BD_2020_input%>%
    dplyr::mutate_at(.vars= vars(vul1, vul2, vul3, vul4, vul5, vul6, vul7),.funs = ~as.numeric(.)-1)%>%
    dplyr::mutate(vul = rowSums(dplyr::select(., .dots = paste0("vul",c(1:7))),na.rm=F))%>%
    dplyr::mutate(vul=ifelse(vul>2,1,0))%>%
    dplyr::mutate_at(.vars= vars(prec1, prec2, prec3, prec5, prec6, prec7, prec8, vul),.funs = ~as.numeric(.)-1)%>%
    dplyr::mutate(precr12= rowSums(dplyr::select(., .dots = c(paste0("prec",c(1,2,3,5,6,7,8)),"vul")),na.rm=F))%>%
    #dplyr::mutate(precsum= ifelse(precsum>2,1,0))%>% 
    dplyr::mutate(precr12= dplyr::if_else(precr12>2,1,0,NA_real_))%>% 
    dplyr::mutate(precr12=as.factor(precr12))%>%janitor::tabyl(precr1,precr12)
#table(car::recode(rowSums(BD_2020_input1[c("vul", "prec1", "prec2", "prec3", "prec5",
#                                  "prec6", "prec7", "prec8")],na.rm=F),"0:2=0;3:7=1"))
#precr1    1   2 NA_
#      1 1423   0   0
#      2    0 453   0
#
}
NAQ_R2<- paste0("naq",1:22)
LID_DES<- paste0("lid_des", 1:14)

BD_2020_input%>%
  dplyr::mutate_at(.vars= vars(vul1, vul2, vul3, vul4, vul5, vul6, vul7),.funs = ~as.numeric(.)-1)%>%
  dplyr::mutate_at(.vars= vars(prec1, prec2, prec3, prec5, prec6, prec7, prec8, vul),.funs = ~as.numeric(.)-1)%>%
  dplyr::mutate(vul = rowSums(dplyr::select(., .dots = paste0("vul",c(1:7))),na.rm=F))%>%
  dplyr::mutate(vul= ifelse(vul>2,1,0))%>%
  dplyr::mutate(precr1= rowSums(dplyr::select(., .dots = c(paste0("prec",c(1,2,3,5,6,7,8)),"vul")),na.rm=F))%>%
  dplyr::mutate(precr1= if_else(precr1>2,1,0,NA_real_))%>%#janitor::tabyl(precr1,precr12)
  dplyr::mutate(precr1=as.factor(precr1))%>%
  #janitor::tabyl(precr1,precsum)
dplyr::mutate_at(.vars= vars(naq1, naq2, naq3,naq4, naq5, naq6, naq7, naq8, naq9, naq10, naq11, naq12, naq13, naq14, naq15, naq16, naq17, naq18, naq19, naq20, naq21, naq22),.funs = ~as.numeric(.)-1)%>%
  dplyr::mutate_at(.vars= vars(lid_des1, lid_des2, lid_des3,lid_des4, lid_des5, lid_des6, lid_des7, lid_des8, lid_des9, lid_des10, lid_des11, lid_des12, lid_des13, lid_des14),.funs = ~as.numeric(.)-1)%>%
  
  dplyr::mutate(naq_r_af_sum = rowSums(dplyr::select(., .dots = paste0("naq",c(8,9,22))),na.rm=T))%>%
  dplyr::mutate(naq_r_ap_sum = rowSums(dplyr::select(., .dots = paste0("naq",c(2,4,5,6,7,10,11,12,13,15,17,20))),na.rm=T))%>%
  dplyr::mutate(naq_r_rt_sum = rowSums(dplyr::select(., .dots = paste0("naq",c(1,3,14,16,18, 19, 21))),na.rm=T))%>%
  dplyr::mutate(naq_sum = rowSums(dplyr::select(., .dots = paste0("naq",1:22)),na.rm=T))%>%
  dplyr::mutate(lid_des_sum = rowSums(dplyr::select(., .dots = paste0("lid_des",c(3,5,7,9,1,4,8,10))),na.rm=T))%>%
  
  dplyr::mutate(lc = rowSums(dplyr::select(., .dots = paste0("lid_des",c(2,6,11,12,13,14))),na.rm=T))%>%
  dplyr::mutate(lc2 = rowSums(dplyr::select(., .dots = paste0("lid_des",c(6,11,12,14))),na.rm=T))%>%
  dplyr::mutate(lf = rowSums(dplyr::select(., .dots = paste0("lid_des",c(3,5,7,9))),na.rm=T))%>%
  dplyr::mutate(lf2 = rowSums(dplyr::select(., .dots = paste0("lid_des",c(5,7,9))),na.rm=T))%>%
  dplyr::mutate(la = rowSums(dplyr::select(., .dots = paste0("lid_des",c(1,4,8,10))),na.rm=T))%>%
  dplyr::mutate(lid_des_sum = rowSums(dplyr::select(., .dots = paste0("lid_des",c(3,5,7,9,1,4,8,10))),na.rm=T))%>%
  dplyr::mutate(lid_des_sum2 = rowSums(dplyr::select(., .dots = paste0("lid_des",c(5,7,9,1,4,8,10))),na.rm=T))%>%
  
dplyr::mutate_at(.vars= vars(naq1, naq2, naq3,naq4, naq5, naq6, naq7, naq8, naq9, naq10, naq11, naq12, naq13, naq14, naq15, naq16, naq17, naq18, naq19, naq20, naq21, naq22),.funs = ~factor(.))%>%
  dplyr::mutate_at(.vars= vars(lid_des1, lid_des2, lid_des3,lid_des4, lid_des5, lid_des6, lid_des7, lid_des8, lid_des9, lid_des10, lid_des11, lid_des12, lid_des13, lid_des14),.funs = ~factor(.))%>%
 # janitor::tabyl(naq_sum,naq_sum2)
  assign("BD_2020_input",., envir = .GlobalEnv)

BD_2020_input%>%
dplyr::mutate_at(.vars= vars(naq1, naq2, naq3,naq4, naq5, naq6, naq7, naq8, naq9, naq10, naq11, naq12, naq13, naq14, naq15, naq16, naq17, naq18, naq19, naq20, naq21, naq22),.funs = ~as.numeric(.)-1)%>%
  dplyr::mutate_at(.vars= vars(lid_des1, lid_des2, lid_des3,lid_des4, lid_des5, lid_des6, lid_des7, lid_des8, lid_des9, lid_des10, lid_des11, lid_des12, lid_des13, lid_des14),.funs = ~as.numeric(.)-1)%>%
  assign("BD_2020_input_num",., envir = .GlobalEnv)

skimr::skim(BD_2020_input[,c(NAQ_R2,LID_DES,paste0("a47_top_",1:6), "k2_elevado","climasex", "mujer", "precr1","zona","autonaq","ocuprev_nocalif")])%>% 
  tibble::as_tibble() %>%
  dplyr::mutate(complete_rate=scales::percent(1-complete_rate,3))%>%
  dplyr::select(-factor.ordered)%>%
  knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Tabla S1. Resumen de Variables"),
               col.names = c("Tipo","Variable","Perdidos","% Perdidos","Nro. de Valores Únicos","Valores más frecuentes"),
align =rep('c', 101)) %>%
  kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 10) %>%
     kableExtra::add_footnote(c("Nota. Variables que empiezan con 'naq' aluden a los ítems del cuestinoario NAQ-R;","Variables que empiezan con 'lid_des' aluden a los ítems del cuestinoario DLS;","Variables que empiezan con 'a47_top' aluden a los ítems del la escala de Distrés Psicológico (K6);","k2_elevado= Suma puntajes brutos K6 Dicotomizada (2= Distrés elevado)","climasex= Clima Sexista","mujer= Sexo(1= Mujer)","precr1= Índice de Precariedad Laboral","zona= Zona Metropolitana de Residencia (1= Santiago,2=Valparaíso, 3=Concepción)", "autonaq= Autodefinición NAQ-R, como víctima de acoso laboral","ocuprev_nocalif= Trabajadores no calificados (Operadores de máquinas, técnicos, transportistas & no-cualificados vs. Trabajadores de oficina, Vendedores, Administrativos Calificados, Trabajadores de servicios cualificados, Profesionales y Jefaturas)"), 
                            notation = "none")%>%
  kableExtra::scroll_box(width = "100%", height = "375px")
```

<br>

De la Tabla S1 se puede interpretar que existe un bajo porcentaje de valores perdidos. Por otra parte, la naturaleza de los ítems es ordinal o dicotómica.

<br>

```{r paso1_exp_sum_var,eval=T, echo=T, paged.print=TRUE, eval=T}
dsgn_BD_05_02 <- survey::svydesign(ids = ~1, data = BD_2020_input, weights = ~weight)
#ocuprev_nocalif
dsgn_mujer<- subset(BD_2020_input,mujer==1)
dsgn_hombre<- subset(BD_2020_input,mujer==0)
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
n<- c("naq_sum", "naq_r_ap_sum", "naq_r_rt_sum", "naq_r_af_sum", "lc", "lc2","la", "lf", "lf2", "lid_des_sum","lid_des_sum2", "k6_2")
desc<-data.frame()
for (i in c("naq_sum", "naq_r_ap_sum", "naq_r_rt_sum", 
            "naq_r_af_sum", "lc", "lc2","la", "lf", "lf2", 
            "lid_des_sum","lid_des_sum2", "k6_2")) {
  dat<- data.table::as.data.table(cbind("M (DE)"= paste0(round(unlist(svymean(as.formula(paste0("~",i)),dsgn_BD_05_02,na.rm=T))[1],2),"\n(",
                                                         round(Weighted.Desc.Stat::w.sd(BD_2020_input[i], BD_2020_input$weight),2),")"),
                                        "Mdn (Q1-Q3)"=paste0(round(svyquantile(as.formula(paste0("~", i)), quantiles=.5, design= dsgn_BD_05_02,na.rm=T)[[1]][[1]],2), "\n(",
                                                             round(svyquantile(as.formula(paste0("~", i)), quantiles=.25, design= dsgn_BD_05_02,na.rm=T)[[1]][[1]],2),"-",
                                                             round(svyquantile(as.formula(paste0("~", i)), quantiles=.75, design= dsgn_BD_05_02,na.rm=T)[[1]][[1]],2),")"),
                                        Kurt= round(Weighted.Desc.Stat::w.kurtosis(BD_2020_input[i], BD_2020_input$weight),2),
                                        Skew= round(Weighted.Desc.Stat::w.skewness(BD_2020_input[i], BD_2020_input$weight),2)))
  desc<- rbind(desc, dat)
}
desc<-
desc%>%
  dplyr::mutate(Variable=c("Suma de puntajes brutos NAQ-R",
                      "Suma de puntajes brutos Acoso dirigido a la Persona",
                      "Suma de puntajes brutos Rel. con el Trabajo",
                      "Suma de puntajes brutos Acoso Físico",
                      "Suma de puntajes brutos Lid. Constructivo (ít. 2,6,11,12,13 & 14)",
                      "Suma de puntajes brutos Lid. Constructivo (ít. 6,11,12 & 14)",
                      "Suma de puntajes brutos Lid. Autoritario (ít. 1,4,8 & 10)",
                      "Suma de puntajes brutos Lid. Laissez-Faire (ít. 3,5,7 & 9)",
                      "Suma de puntajes brutos Lid. Laissez-Faire (ít. 5,7 & 9)",
                      "Suma de puntajes brutos Lid. Destructivos (ít. 3,5,7,9,1,4,8 & 10)",
                      "Suma de puntajes brutos Lid. Destructivos (ít. 5,7,9,1,4,8 & 10)",
                      "Suma de puntajes brutos Distrés Psicológico"))%>%
  dplyr::select(Variable,everything())

#pearson
set.seed(123)
cor_wtd<-svycor(~naq_sum+ naq_r_ap_sum+ naq_r_rt_sum+ naq_r_af_sum+ lc+ lc2+la+ lf+ lf2+ lid_des_sum+lid_des_sum2+ k6_2
, design = dsgn_BD_05_02, digits = 2, sig.stats = TRUE, bootn = 10000, mean1 = TRUE)

cor_wtd_sig<-
data.frame(cbind(cor=data.table(round(matrix(cor_wtd$cors),2)),
p=data.table(matrix(cor_wtd$p.values))))%>%
  dplyr::rename("cor"="cor.V1","p"="p.V1")%>%
  dplyr::mutate(cor=dplyr::case_when(p<.001~paste0(sprintf("%4.2f",cor),"***"),
                    p<.01~paste0(sprintf("%4.2f",cor),"**"),
                    p<.05~paste0(sprintf("%4.2f",cor),"*"),
                    TRUE~paste0(sprintf("%4.2f",cor))))%>%
  dplyr::mutate(cor=ifelse(grepl("1.00",cor),"",cor))%>%
  dplyr::select(-p)

pearson<-
data.frame(Vars=cbind(c("naq_sum", "naq_r_ap_sum", "naq_r_rt_sum", "naq_r_af_sum", "lc", "lc2","la", "lf", "lf2", "lid_des_sum","lid_des_sum2", "k6_2"),
      `1`=cor_wtd_sig[1:length(n),],
      `2`=cor_wtd_sig[(length(n)*1)+1:(length(n)*1),],
      `3`=cor_wtd_sig[(length(n)*2)+1:(length(n)*1),],
      `4`=cor_wtd_sig[(length(n)*3)+1:(length(n)*1),],
      `5`=cor_wtd_sig[(length(n)*4)+1:(length(n)*1),],
      `6`=cor_wtd_sig[(length(n)*5)+1:(length(n)*1),],
      `7`=cor_wtd_sig[(length(n)*6)+1:(length(n)*1),],
      `8`=cor_wtd_sig[(length(n)*7)+1:(length(n)*1),],
      `9`=cor_wtd_sig[(length(n)*8)+1:(length(n)*1),],
      `10`=cor_wtd_sig[(length(n)*9)+1:(length(n)*1),],
      `11`=cor_wtd_sig[(length(n)*10)+1:(length(n)*1),],
      `12`=cor_wtd_sig[(length(n)*11)+1:(length(n)*1),]))
yy<-
data.frame(cbind(desc,pearson[-1]))%>%
  dplyr::select_all(~gsub("^Vars", "", .))%>%
  knitr::kable(.,format = "html", format.args = list(decimal.mark = ",", big.mark = "."),
               caption = paste0("Tabla S2. Resumen de Variables, Suma de Ítems (Ponderada)"),
               col.names = c("Variable","M (DE)",  "Mdn(Q1-Q3)", "Curtosis", "Asimetría",paste0(1:12)))
      kableExtra::column_spec(yy,1, width="20em")%>%
      kableExtra::add_footnote(c("Nota. Mdn= Mediana; Q1= Percentil 25; Q3= Percentil 75; Kurt= Curtosis; Skew= Asimetría"), 
                            notation = "none")%>%
  kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 10)%>%
  kableExtra::scroll_box(width = "100%", height = "375px")
```

<br>

Un análisis de la suma de los ítems ponderados por sexo y región, permiten sospechar que las variables no siguen una distribución normal (Tabla S2).

<br>

```{r fig1_naq_qq, echo=T, fig.align='center', fig.pos='H', fig.cap= "Figura S1. Gráficos Cuantil-Cuantil Ítems NAQ-R (intervalos de confianza en naranjo)", fig.height=14, message=FALSE, error=T}
par(mfrow=c(7,4))
for (k in 1:22) {
         car::qqPlot(data.frame(BD_2020_input_num)[,paste0("naq",k)], col = "skyblue4",  main = paste("Ítem NAQ-R",k),xlab="Cuartiles Teóricos", ylab="Cuartiles Empíricos",id=F, col.lines="orange")
}
```
<br>

Lo anterior, puede corroborarse en los gráficos cuantil-cuantil presentados, en los que la línea roja representa una distirbución normal, mientras que los puntos azules reflejan la distribución presente en los datos, las cuales se superponen en el menor de los casos.

<br>

```{r paso2a_mvn_naq,eval=T, echo=T, paged.print=TRUE, eval=T}
options(knitr.kable.NA = '')
MVN::mvn(BD_2020_input_num[,paste0("naq",1:22)], subset = NULL, mvnTest = "mardia", covariance = TRUE, tol = 1e-25, alpha = 0.5,
         scale = FALSE, desc = TRUE, transform = "none", R = 1000,
         univariateTest = "Lillie",
         univariatePlot = "none", multivariatePlot = "none",
         multivariateOutlierMethod = "none", bc = FALSE, bcType = "rounded",
         showOutliers = FALSE, showNewData = FALSE)$multivariateNormality%>%
  data.frame()%>%
  dplyr::mutate(across(c("Statistic","p.value"),~ifelse(grepl("NA",.),NA_real_,as.numeric(as.character(.)))))%>%
  dplyr::mutate(Statistic=sprintf("%8.2f",Statistic))%>%
  dplyr::mutate(p.value=sprintf("%5.3f",p.value))%>%
  dplyr::mutate(across(c("Statistic","p.value"),~ifelse(grepl("NA",.),"-",as.character(.))))%>%
   knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Tabla S3. Normalidad Multivariada NAQ-R"),
               col.names = c("Prueba","Estadistico","Valor p","Normalidad"),
align =c('l',rep('c', 101)))%>%
      kableExtra::add_footnote(c("Nota. Mardia Skewness= Asimetría Multivariante de Mardia (1970); Mardia Kurtosis= Curtosis Multivariante de Mardia (1970)"), notation = "none")%>%
  kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 13)
```

<br>

A partir de la prueba de Mardia, se puede interpretar que los ítems del NAQ no siguen una distirbución multivariada normal. 

<br>

```{r fig2_naq_qq, echo=T, fig.align='center', fig.pos='H', fig.cap= "Figura S2. Gráficos Cuantil-Cuantil Ítems DLS (intervalos de confianza en naranjo)", fig.height=14, message=FALSE, error=T}
#grey(0.8)
par(mfrow=c(7,4))
for (k in 1:14) {
         car::qqPlot(data.frame(BD_2020_input_num)[,paste0("lid_des",k)], col = "skyblue4", main = paste("Ítem DLS",k),
                xlab="Cuartiles Teóricos",
                ylab="Cuartiles Empíricos",id=F, col.lines="orange")
}
```
<br>

Una observación de los gráficos expuestos nos permite interpretar que los ítems del DLS no siguen una distribución normal. Ya que al igual que en los ítems del NAQ, las respuestas observadas se alejan de un patrón de distribución normal (línea roja), razón por la que no se superponen.

<br>

```{r paso2a_mvn_lid_des,eval=T, echo=T, paged.print=TRUE, eval=T}
options(knitr.kable.NA = '')
MVN::mvn(BD_2020_input_num[,paste0("lid_des",1:14)], subset = NULL, mvnTest = "mardia", covariance = TRUE, tol = 1e-25, alpha = 0.5,
         scale = FALSE, desc = TRUE, transform = "none", R = 1000,
         univariateTest = "Lillie",
         univariatePlot = "none", multivariatePlot = "none",
         multivariateOutlierMethod = "none", bc = FALSE, bcType = "rounded",
         showOutliers = FALSE, showNewData = FALSE)$multivariateNormality%>%
  data.frame()%>%
  dplyr::mutate(across(c("Statistic","p.value"),~ifelse(grepl("NA",.),NA_real_,as.numeric(as.character(.)))))%>%
  dplyr::mutate(Statistic=sprintf("%8.2f",Statistic))%>%
  dplyr::mutate(p.value=sprintf("%5.3f",p.value))%>%
  dplyr::mutate(across(c("Statistic","p.value"),~ifelse(grepl("NA",.),"-",as.character(.))))%>%
   knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Tabla S4. Normalidad Multivariada DLS"),
               col.names = c("Prueba","Estadistico","Valor p","Normalidad"),
align =c('l',rep('c', 101)))%>%
    kableExtra::add_footnote(c("Nota. Mardia Skewness= Asimetría Multivariante de Mardia (1970); Mardia Kurtosis= Curtosis Multivariante de Mardia (1970)"), notation = "none")%>%
  kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 13)
```

<br>

De igual forma, los ítems de  DLS tampoco siguen una distribución multivariada normal.

<br>

# Factorial

## Exploración Matriz policórica

Generamos una serie de modelos, de igual forma que el ejrcicio hecho por Einarsen, et al., para la validación de la escala en el Reino Unido [@Einarsen2009]. El primer modelo especifica sólo 1 Factor (Actos negativos) compuestos por los 22 ítems. El segundo especifica 2 Sub-factores correlacionados: acoso relacionado con el trabajo (ítems 1,3,16, 18, 19 y 21) y dirigido a la persona (ítems 2, 4, 5, 6, 7, 10, 11, 12, 13, 15, 17, 20, 8, 9 y 22). El tercero está compuesto por acoso relacionado con el trabajo, relacionado con la persona y físicamente intimidatorio.


Éstos los combinamos con modelos que asumen la presencia de un factor, Liderazgos, compuesto por los 14 ítems. El siguiente modelo asume dos factores: liderazgos destructivos (ítems 3, 5, 7, 9, 1, 4, 8 y 10) y constructivos (ítems 2, 6, 11, 12, 13 y 14). El último modelo asume tres factores: liderazgo laissez-faire (ítems 3, 5, 7 y 9), autoritario (1, 4, 8 y 10) y constructivo (2, 6, 11, 12, 13 y 14) [@Aasland2010].

<br>


```{r fig3_polychor, echo=T, fig.align='center', fig.pos='H', fig.cap= "Figura S3. Matriz de correlaciones policóricas", message=FALSE, error=T, fig.retina=2}
#matriz policórica

naq_lds<-
c(paste0("naq",c(1,3,14,16,18,19,21,2,4,5,6,7,10,11,12,13,15,17,20,8,9,22)),
  paste0("lid_des",c(2,6,11,12,13,14,3,5,7,9,1,4,8,10)))

primer_policor_wgt <- reshape2::melt(as.matrix(psych::polychoric(BD_2020_input[,naq_lds],global=TRUE,ML=FALSE, std.err=FALSE,weight=BD_2020_input$weight,correct=.5,progress=TRUE,na.rm=TRUE, delete=TRUE)$rho))

ggheatmap_1 <- ggplot(primer_policor_wgt, aes(Var2, Var1, fill = value))+
  geom_tile(color = "white")+
  scale_fill_gradient2(low = "red", high = "blue", mid = "white", 
                       midpoint = 0, limit = c(-1,1), space = "Lab", 
                       name="Correlación\nPolicórica") +
  theme_minimal()+ # minimal theme
  theme(axis.text.x = element_text(angle = 45, vjust = 0.9, 
                                   size = 8, hjust = .9))+
  coord_fixed()+
  scale_x_continuous(breaks = 1:length(c(NAQ_R2,LID_DES)),
                     labels = c(paste0("RT",c(1,3,14,16,18,19,21)),
                                paste0("AP",c(2,4,5,6,7,10,11,12,13,15,17,20)),
                                paste0("AF",c(8,9,22)),
                                              paste0("Cons.",c(2,6,11,12,13,14)),
                                              paste0("LsFr.",c(3,5,7,9)),
                                              paste0("Aut.",c(1,4,8,10))))+
  scale_y_continuous(breaks = 1:length(c(NAQ_R2,LID_DES)),
                     labels = c(paste0("RT",c(1,3,14,16,18,19,21)),
                                paste0("AP",c(2,4,5,6,7,10,11,12,13,15,17,20)),
                                paste0("AF",c(8,9,22)),
                                              paste0("Cons.",c(2,6,11,12,13,14)),
                                              paste0("LsFr.",c(3,5,7,9)),
                                              paste0("Aut.",c(1,4,8,10))))+
  ylab("")+
  xlab("")+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  labs(caption="Nota. RT= Acoso Relacionado con el Trabajo; AP= Acoso Psicológico; AF= Acoso Físico;\nAut= Liderazgos Autoritarios; LsFr= Liderazgos Laissez-Faire;Cons.= Liderazgos Constructivos")
print(ggheatmap_1)
#para obtener los valores P de significación.
#lides_policor_wgt_2 <- psych::cor.ci(BD_2020_input[c(LID_DES_LC,LID_DES_LF,LID_DES_LT)],
#                  global=TRUE,ML=FALSE, std.err=FALSE,weight=BD_2020_input$weight, poly=T,
#                  correct=.5,progress=TRUE,na.rm=TRUE, delete=TRUE)$rho
#print(psych::corr.test(lides_policor_wgt_2), short=FALSE)  
```

<br>

Al observar la matriz de correlaciones policóricas, salta a la vista el tercer ítem de la escala, el que correlaciona fuertemente con la subescala de Liderazgos Constructivos. Por otra parte, los ítems vinculados a acoso correlacionan positivamente con los comportamientos Laissez-Faire y Autoritarios. Un análisis de la matriz de correlaciones policóricas permite observar que el ítem 3 no presenta correlaciones con el resto de las variables correspondientes a Liderazgo Laissez-Faire. `r invisible("Se decidió utilizar el método de estimación de mínimos cuadrados ponderados robusto con un estadístico $χ^2$ ajustado por media y varianza ('WLSV'), al ser el más utilizado en presencia de variables de caracter ordinal [@Viladrich2017]. Adicionalmente, fijamos la varianza del factor a 1 (estandarizamos las varianzas de los factores)")`.

<br>


```{r error_measurement, echo=T, message=FALSE, error=T}
coefficientalpha::tau.test(BD_2020_input[,NAQ_R2],complete=T)

coefficientalpha::tau.test(BD_2020_input_num[,paste0("lid_des",c(2,6,11,12,13,14))],complete=T)

coefficientalpha::tau.test(BD_2020_input_num[,paste0("lid_des",c(5,7,9))],complete=T)

coefficientalpha::tau.test(BD_2020_input_num[,paste0("lid_des",c(3,5,7,9))],complete=T)

coefficientalpha::tau.test(BD_2020_input_num[,paste0("lid_des",c(1,4,8,10))],complete=T)

coefficientalpha::tau.test(BD_2020_input_num[,paste0("lid_des",c(5,7,9,1,4,8,10))],complete=T)
```

## NAQ-R

Generamos una serie de modelos, de igual forma que el ejrcicio hecho por Einarsen, et al., para la validación de la escala en el Reino Unido [@Einarsen2009]. El primer modelo especifica sólo 1 Factor (Actos negativos) compuestos por los 22 ítems. El segundo especifica 2 Sub-factores correlacionados: acoso relacionado con el trabajo (ítems 1,3,16, 18, 19 y 21) y dirigido a la persona (ítems 2, 4, 5, 6, 7, 10, 11, 12, 13, 15, 17, 20, 8, 9 y 22). El tercero está compuesto por acoso relacionado con el trabajo, relacionado con la persona y físicamente intimidatorio.

<br>

```{r naq_paso1_ponderar,eval=T, echo=T, paged.print=TRUE, eval=T}
#especifico el modelo
mod_naqr  <-"RT =~ naq1 + naq3  +naq14 +naq16 +naq18 +naq19 +naq21
AP =~ naq2  +naq4  +naq5  +naq6  +naq7  +naq10+naq11 +naq12 +naq13 +naq15 +naq17 +naq20
AF =~ naq8  +naq9  +naq22"

mod_naqr1  <-"naq_R =~ naq1 + naq3  +naq14 +naq16 +
naq18 +naq19 +naq21+ naq2  +naq4  +naq5  +
naq6  +naq7  +naq10+naq11 +naq12 +naq13 +
naq15 +naq17 +naq20 + naq8  +naq9  +naq22"
mod_naqr2  <-"RT =~ naq1+ naq3+naq14+naq16+naq18+naq19+naq21
AP =~ naq2  +naq4  +naq5  +naq6  +naq7  +naq10+naq11 +naq12 +naq13 +naq15 +naq17 +naq20+ naq8  +naq9  +naq22"
naq_fa <- lavaan::cfa(mod_naqr, data = BD_2020_input, ordered=NAQ_R2, estimator= "WLS", warn = T, std.lv=T)
naq_fa1f <- lavaan::cfa(mod_naqr1, data = BD_2020_input, ordered=NAQ_R2, estimator= "WLS", warn = T, std.lv=T)
naq_fa2f <- lavaan::cfa(mod_naqr2, data = BD_2020_input, ordered=NAQ_R2, estimator= "WLS", warn = T, std.lv=T)
```

```{r naq_paso1_comp_tab_modelos_res,eval=T, echo=T, paged.print=TRUE, eval=T}
data.table(data.frame(rbind(ajusteAFC(naq_fa),ajusteAFC(naq_fa2f),ajusteAFC(naq_fa1f))),keep.rownames = T)%>%
  dplyr::mutate(rn=c("Tres Factores","Dos Factores", "Un Factor"))%>%
  dplyr::select(-Modelo)%>%
  knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Tabla S5. Comparativo Índices de Ajuste de Modelos Propuestos NAQ-R"),
               align =c('l',rep('c', 101)),
               col.names = c("Modelo","gl","WLS $\\chi^2$","CMIN/gl","aGFI","GFI", "RMSEA\n[IC 90%]","CFit","CFI","NNFI")) %>%
     # kableExtra::row_spec(1, bold= T, color= "black", background= "white")%>%
  kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 13)
```

<br>

A nivel descriptivo, el modelo que obtiene los mejores índices de ajuste es el tercero, compuesto por tres sub-factores, el que tiene valores RMSEA menores a 0,08 [@MacCallum1996].

<br>

```{r naq_paso2_comparativo_anova_modelos,eval=T, echo=T, paged.print=TRUE, eval=T}
lavaan::anova(naq_fa,naq_fa2f,naq_fa1f)%>%
  data.frame()%>%
  dplyr::mutate(mod=c("Modelo de 3 factores","Modelo de 2 factores (Comparación con modelo de 3 factores)","Modelo de 2 factores (Comparación con modelo de 1 factor)"))%>%
  dplyr::select(mod, everything())%>%#Df	AIC	BIC	Chisq	Chisq diff	Df diff	Pr(>Chisq)
  dplyr::select(-AIC,	-BIC)%>%
    dplyr::mutate(Chisq.diff=dplyr::case_when(Pr..Chisq.<.001~paste0(sprintf("%4.2f",Chisq.diff),"***"),
                    Pr..Chisq.<.01~paste0(sprintf("%4.2f",Chisq.diff),"**"),
                    Pr..Chisq.<.05~paste0(sprintf("%4.2f",Chisq.diff),"*"),
                    TRUE~paste0(sprintf("%4.2f",Chisq.diff))))%>%
  knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Tabla S6. Comparativo Índices de Ajuste, Diferencias Chi-Cuadrado entre Modelos Anidados"),
               align =c('l',rep('c', 101)),
               col.names = c("Parámetros","gl","Chi Cuadrado","Diff. Chi Cuadrado", "Diferencias en gl","Valores p (Diferencias)"))%>%
  kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 13)
```
<br>

De acuerdo a la prueba anova, el índice Chi-cuadrado es significativamente menor en el modelo de tres factores. 

<br>

A continuación, se muestra el detalle del modelo de 3 factores.

<br>

<div style="border: 1px solid #ddd; padding: 5px; overflow-y: scroll; height:350px; overflow-x: scroll; width:100%">
```{r paso3_summ_naq_3_fac,eval=T, echo=T, paged.print=TRUE, eval=T}
summary(naq_fa)
```
</div>

<br>

Y el de 1 factor

<div style="border: 1px solid #ddd; padding: 5px; overflow-y: scroll; height:350px; overflow-x: scroll; width:100%">
```{r paso3_summ_naq_1_fac,eval=T, echo=T, paged.print=TRUE, eval=T}
summary(naq_fa1f)
```
</div>


<br>

A continaución se presenta una Figura con la solución que asume tres factores.

<br>

```{r naq_fig1a_naq_fa, echo=T, fig.align='center', fig.pos='H', fig.cap= "Figura S5a. Cargas factoriales y comunalidades para NAQ-R", message=FALSE, error=T, fig.retina=2}
options(OutDec=",")
semPlot::semPaths(naq_fa, residuals=T, what="est",label.cex=1, edge.label.cex=1, sizeMan=6, thresholds=F, legend=F,intercepts=FALSE, 
                  curveAdjacent = TRUE,title=F, layout="tree",fade=FALSE,edge.color="black",label.scale=F,
                  edge.label.position=c(rep(c(0.5,0.55,0.6),7),0.5,rep(0.5,27),rep(0.5,26)),
                  sizeLat = 6,cut=1,curve=1, curvePivot=T,borders=FALSE, nCharNodes=0, 
                  nCharEdges=0,optimizeLatRes=F,edge.width = 1, node.width =1, node.height= 1, 
                  nodeLabels=c(paste0("",c(1,3,14,16,18,19,21,2,4,5,6,7,10,11,12,13,15,17,20,8,9,22)),"Relacionado con\nel Trabajo", "Acoso\nPsicológico", "Acoso\nFísico"), 
                   mar = c(5.8, 0.6, 5.8, 0.6))
options(OutDec=".")
```

<br>

Y el de 1 factor

```{r naq_fig1b_naq_fa, echo=T, fig.align='center', fig.pos='H', fig.cap= "Figura S5b. Cargas factoriales y comunalidades para NAQ-R", message=FALSE, error=T, fig.retina=2}
if(no_mostrar==0){
for (i in 2:100){
  ano<-i
  try(semPlot::semPaths(naq_fa1f, 
                  residuals=T, 
                  what="std", 
                  label.cex=1.5, 
                  edge.label.cex=1,
                  fade=FALSE,
                  thresholds = F,
                  edge.label.position=rep(.5,ano),
                  filetype="pdf",
                  filename=paste0("Número de parámetros ",ano),
                  intercepts=F)
    )
  }
}
options(OutDec=",")
#67 parámetros
semPlot::semPaths(naq_fa1f, residuals=T, what="est",label.cex=1, edge.label.cex=.8, sizeMan=4.5, thresholds=F, legend=F,intercepts=FALSE, 
                  curveAdjacent = TRUE,title=F, layout="tree",fade=FALSE,edge.color="black",label.scale=F,
                  edge.label.position=c(rep(c(0.5,0.55,0.6),7),rep(0.5,23),rep(0.5,23)),
                  sizeLat = 7,cut=1, curve=.8, curvePivot=T,borders=FALSE, nCharNodes=0,  nDigits=2,
                  nCharEdges=0,optimizeLatRes=F,edge.width = 1, node.width = .9, node.height= 1, 
                  nodeLabels=c(paste0("",c(1,3,14,16,18,19,21,2,4,5,6,7,10,11,12,13,15,17,20,8,9,22)),"Acoso\nLaboral"), 
                  mar = c(5.8, 0.8, 5.8, 0.8))
dev.print(png,"Figura S5b.png", width=10, height=6, res=600, units="in") 
options(OutDec=".")
```

<br>

### Disciminante y Consistencia

De acuerdo a Fornell & Lacker [-@fornell1981], la confiabilidad compuesta (CR) debiese ser mayor a 0,7 para evidencia de confiabilidad. En cambio, para evidencia para validez convergente, debiese ser mayor a 0,5. De todas maneras, si AVE es menor a 0,5 pero la confiabilidad compuesta es mayor a 0,6, la validez es válida.

<br>

```{r naq_afc_rel_2, echo=T, error=T, warning=FALSE, cache=TRUE, paged.print=TRUE}
loadings_naq <- standardizedSolution(naq_fa) %>%	
 dplyr::filter(op == "=~", lhs == "RT") %>% dplyr::select(est.std)
com_rel_naq <- sum(loadings_naq) ^ 2 / ((sum(loadings_naq)^ 2)  + sum(1 - loadings_naq ^ 2))	

loadings_naq2 <- standardizedSolution(naq_fa) %>%	
 dplyr::filter(op == "=~", lhs == "AP") %>% dplyr::select(est.std)
com_rel2_naq <- sum(loadings_naq2) ^ 2 / ((sum(loadings_naq2)^ 2)  + sum(1 - loadings_naq2 ^ 2))	

loadings_naq3 <- standardizedSolution(naq_fa) %>%	
 dplyr::filter(op == "=~", lhs == "AF") %>% dplyr::select(est.std)
com_rel3_naq <- sum(loadings_naq3) ^ 2 / ((sum(loadings_naq3)^ 2)  + sum(1 - loadings_naq3 ^ 2))	

avg_var_naq <- sum(loadings_naq ^ 2) / nrow(loadings_naq)	
avg_var2_naq <- sum(loadings_naq2 ^ 2) / nrow(loadings_naq2)	
avg_var3_naq <- sum(loadings_naq3 ^ 2) / nrow(loadings_naq3)	

cr_ave2_naq<-
data.frame(
Constructo=c("Relacionado con el Trabajo","Acoso Psicológico","Acoso Físico"),
AVE=round(c(avg_var_naq,avg_var2_naq,avg_var3_naq),2),
CR=round(c(com_rel_naq,com_rel2_naq,com_rel3_naq),2)
)

data.table(t(round(semTools::reliability(naq_fa, c("alpha.ord","omega","ave"),return.total=T),2)),keep.rownames = T) %>% 
  dplyr::mutate(rn=dplyr::case_when(rn=="RT"~"Relacionado con el Trabajo",rn=="AP"~"Acoso Psicológico",
                                    rn=="AF"~"Acoso Físico",T~"Total")) %>% 
  dplyr::left_join(cr_ave2_naq, by=c("rn"="Constructo")) %>% 
  knitr::kable(format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Tabla S7. Confiabilidad"),
               col.names = c("Constructo","Alfa ordinal", "omega", "Varianza Media Extraída/\nAverage variance extracted", "AVE", "Fiabilidad Compuesta"),
               escape=T)%>%
    kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 12) %>%
    kableExtra::add_footnote(c("Nota. AVE >0.5, eivdencia de validez convergente; Alfa >.7; RT= Relacionado con el Trabajo; AP= Acoso Psicológico; AF= Acoso Físico"),
                           notation = "none")%>%
  kableExtra::scroll_box(width = "100%", height = "375px")
```

<br>


```{r naq_afc_htmt, echo = T, eval = T}
# https://rdrr.io/cran/semTools/man/htmt.html

semTools::htmt(mod_naqr, BD_2020_input[,c(NAQ_R2)], sample.cov = NULL, missing = 'pairwise', ordered = c(NAQ_R2), absolute = T)%>% 
  as.data.table(keep.rownames = T) %>% 
  dplyr::mutate(across(where(is.numeric), ~ round(.x, 2))) %>% 
  knitr::kable(format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Tabla S8. Validez Discriminante"),
               align =c('l',rep('c', 101)),
               #col.names = c("Var. Latentes","Agotamiento y Estrés", "Sueño", "Estrés Postraumático", "Sint. Ansiosa", "Sint. Depresiva")
               escape=T)%>%
  kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 12) %>%
  kableExtra::add_footnote(c("Nota. Valores <.90, umbral en favor de validez discriminante; RT= Relacionado con el Trabajo; AP= Acoso Psicológico; AF= Acoso Físico"),
                           notation = "none")%>%
  kableExtra::scroll_box(width = "100%", height = "375px")
```

```{r naq_afc_disc_val, eval=T, echo=T, warning=FALSE}
#Calculate discriminant validity statistics based on a fitted lavaan object

#For the exploration, discriminant validity was examined with an R function, discriminantValidity, implemented in semToolspackage (Jorgensen et al., 2021). Discriminant validity was examined whether the two constructs, overall compliance and compliance with distancing measures, were distinguishable from each other. If a significant outcome results from 25χ2test, then discriminant validity between the tested constructs is supported, so the constructs are deemed to be distinct from each other (Jorgensen et al., 2021; Rönkkö & Cho, 2020). On the other hand, a non-significant outcome suggests that discriminant validity could not be supported, so it is impossible to distinguish the two constructs.The result of χ2test indicated that discriminant validity was supported, χ2(1) = 968.82, p< .001. Thus, although the two tested constructs, overall compliance and compliance with distancing measure, were significantly correlated with each other, they shall be treated as two distinguishable and independent constructs. It may suggest that the two items assess two unique and distinct constructs, so they could not be collapsed into one.

semTools::discriminantValidity(naq_fa, cutoff = 0.9, merge = F, level = 0.95) %>% 
  as.data.table(keep.rownames = T) %>% 
  dplyr::mutate(across(where(is.numeric), ~ round(.x, 2))) %>% 
  knitr::kable(format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Tabla S9. Validez Discriminante (2)"),
               align =c('l',rep('c', 101)),
               #col.names = c("Var. Latentes","Agotamiento y Estrés", "Sueño", "Estrés Postraumático", "Sint. Ansiosa", "Sint. Depresiva")
               escape=T)%>%
  kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 12) %>%
  kableExtra::add_footnote(c("Nota. RT= Relacionado con el Trabajo; AP= Acoso Psicológico; AF= Acoso Físico"),
                           notation = "none")%>%
  kableExtra::scroll_box(width = "100%", height = "375px")
```

```{r naq_unidim, eval=T, echo=T, warning=FALSE}
unidim(BD_2020_input[,c(NAQ_R2)], keys.list = NULL,cor="poly",correct=.5, check.keys = TRUE)
```

<br>

## DLS

### Primera aproximación

#### Comparación de modelos

<br>

Se especificaron los modelos que asumen la presencia de un factor, Liderazgos, compuesto por los 14 ítems. El siguiente modelo asume dos factores: liderazgos destructivos (ítems 3, 5, 7, 9, 1, 4, 8 y 10) y constructivos (ítems 2, 6, 11, 12, 13 y 14). El último modelo asume tres factores: liderazgo laissez-faire (ítems 3, 5, 7 y 9), autoritario (1, 4, 8 y 10) y constructivo (2, 6, 11, 12, 13 y 14) [@Aasland2010].

<br>

```{r dls_paso1_esp_modelos_dls,eval=T, echo=T, paged.print=TRUE, eval=T}
mod_lid_des_1f_inicial<-   "lid_des_CONS=~ lid_des2 + lid_des6 +lid_des11 +lid_des12+lid_des13+lid_des14+lid_des3+lid_des5+lid_des7+lid_des9+ lid_des1+lid_des4+lid_des8+lid_des10"
mod_lid_des_2f_inicial<-   "LC=~ lid_des2 + lid_des6 +lid_des11 +lid_des12+lid_des13+lid_des14
LD=~ lid_des3+lid_des5+lid_des7+lid_des9+lid_des1+lid_des4+lid_des8+lid_des10"
mod_lid_des_2f_inicial<-   "LC=~ lid_des2 + lid_des6 +lid_des11 +lid_des12+lid_des13+lid_des14
LD=~ lid_des3+lid_des5+lid_des7+lid_des9+lid_des1+lid_des4+lid_des8+lid_des10"
mod_lid_des_3f_inicial<-   "LC=~ lid_des2 + lid_des6 +lid_des11 +lid_des12+lid_des13+lid_des14
LF=~ lid_des3+lid_des5+lid_des7+lid_des9
LT=~ lid_des1+lid_des4+lid_des8+lid_des10"

invisible("Después de 17 octubre de 2021")
#Identification of a second order factor is the same process as identification of a single factor except you treat the first order factor as indicators rather than as observed outcomes.  
#https://stats.idre.ucla.edu/r/seminars/rcfa/
mod_lid_des_2f_inicial_2  <-"LC =~ lid_des2+ lid_des6+ lid_des11+ lid_des12+ lid_des13+ lid_des14
LF=~ lid_des3+lid_des5+lid_des7+lid_des9
LT=~ lid_des1+lid_des4+lid_des8+lid_des10
LID_DES =~  1*LT + 1*LF
LID_DES ~~ LID_DES
"
#NA*LF + equal('LID_DES=~LF')*LT 
```


```{r dls_paso2_definir_modelos_lavaan,eval=T, echo=T, paged.print=TRUE, eval=T}
#LID_DES <- names(BD_2020_input[paste0("lid_des", 1:14)])
LID_DES<- paste0("lid_des", 1:14)
lid_des_fa_1f_inicial<- lavaan::cfa(mod_lid_des_1f_inicial, data = BD_2020_input, ordered=LID_DES, estimator= "WLS", warn = T, std.lv=T)
lid_des_fa_2f_inicial<- lavaan::cfa(mod_lid_des_2f_inicial, data = BD_2020_input, ordered=LID_DES, estimator= "WLS", warn = T, std.lv=T)
lid_des_fa_2f_inicial_2<- lavaan::sem(mod_lid_des_2f_inicial_2, data = BD_2020_input, ordered=LID_DES, estimator= "WLS", warn = T, std.lv=T)#
lid_des_fa_3f_inicial<- lavaan::cfa(mod_lid_des_3f_inicial, data = BD_2020_input, ordered=LID_DES, estimator= "WLS", warn =T, std.lv=T)
```

<br>

A continuación, se presentan los índices de ajuste de los modelos de uno, dos y tres factores.

<br>

```{r dls_paso3_comp_tab_modelos_res_dls,eval=T, echo=T, paged.print=TRUE, eval=T}
data.table(data.frame(rbind(ajusteAFC(lid_des_fa_3f_inicial),ajusteAFC(lid_des_fa_2f_inicial),ajusteAFC(lid_des_fa_1f_inicial),ajusteAFC(lid_des_fa_2f_inicial_2))),keep.rownames = T)%>%
  dplyr::mutate(rn=c("Tres Factores","Dos Factores", "Un Factor", "Dos Factores (2do orden)"))%>%
  dplyr::select(-Modelo)%>%
  knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Tabla S10. Comparativo Índices de Ajuste de Modelos Propuestos DLS"),
               align =c('l',rep('c', 101)),
               col.names = c("Modelo","gl","WLS $\\chi^2$","CMIN/gl","aGFI","GFI", "RMSEA[IC 90%]","CFit","CFI","NNFI")) %>%
  kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 13)
```

<br>

El modelo de 3 factores especificado que asume la presencia 3 tipos de variables latentes correspondientes a los liderazgos planteados originalmente por Aasland, et al. [-@Aasland2010], no presenta un ajuste suficiente de acuerdo a los parámetros definidos. Igualmente, modelos que asumieron la presencia de uno o dos factores no presentan mejores índices de ajuste. Por lo mismo, se reespecifica dicho modelo conforme a índices de modificación. Estos criterios son de utilidad para orientar los parámetros a reespecificar, de la estructura factorial evaluada inicialmente.

<br>

De todas formas se presenta el detalle de la solución factorial del modelo de tres factores.

<br>

<div style="border: 1px solid #ddd; padding: 5px; overflow-y: scroll; height:350px; overflow-x: scroll; width:100%">
```{r dls_paso2_summ_naq_3_fac,eval=T, echo=T, paged.print=TRUE, eval=T}
summary(lid_des_fa_3f_inicial)
```
</div>

```{r dls_fig2_dls, echo=T, fig.align='center', fig.pos='H', fig.cap= "Figura S6. Cargas factoriales y comunalidades para DLS (solución inicial a estudiar)", message=FALSE, error=T, fig.retina=2}
options(OutDec=",")
semPlot::semPaths(lid_des_fa_3f_inicial, residuals=T, what="est", label.cex=1, 
                  edge.label.cex=1,fade=FALSE,
                  thresholds = F,label.scale=F,
                  edge.label.position=c(rep(c(0.45,0.55),7),rep(0.5,19),rep(0.5,18)), #11  it, #17 #14 parámetros para las cargas
                  intercepts=F, curveAdjacent = TRUE,title=F, layout="tree3",sizeMan=5, gui = T, 
                  allVars = FALSE,cut=1.1,sizeLat=5, edge.color="black",
                  curvePivot=T,borders=FALSE, edge.width = 0.5, node.width =1, node.height= 1,label.scale=T,curve = 1,
                  nodeLabels=c(paste0("",c(2,6,11,12,13,14,3,5,7,9,1,4,8,10)),"Liderazgo\nConstructivo","Liderazgo\nLaissez-Faire","Liderazgo\nAutoritario"),
                  mar = c(5.8, 0.8, 5.8, 0.8))
                  #edge.label.position=c(rep(c(0.45,0.55),5),0.45,rep(0.5,16),rep(0.5,15)), #11  it, 
#lid_des_fa_3f_inicial
options(OutDec=".")
```

<br>

Luego, se presentan los índices de modificación al modelo de tres factores. Se examinaron aquellos parámetros de modificación que presentaran un índice de modifcación (MI) mayor a 5 y cambios esperados del parámetro (Expected Parameter Change o SEPC) mayores a 0,2 [@Whittaker2012].

<br>

```{r dls_paso1_mi_dls_1,eval=T, echo=T, paged.print=TRUE, eval=T}
df_mi_dls_1<-
  subset(lavaan::modindices(lid_des_fa_3f_inicial)[order(lavaan::modindices(lid_des_fa_3f_inicial)$mi, decreasing=TRUE), ], mi > 5 & abs(sepc.all)>0.2)%>%
  data.frame()%>%
  dplyr::mutate(lhs=paste0(lhs,op,rhs))%>%
  dplyr::mutate(mi=sprintf("%04.2f",mi))%>%
  dplyr::mutate(sepc.all=sprintf("%04.2f",sepc.all))%>%
  dplyr::select(lhs,mi,sepc.all)
  
  knitr::kable(df_mi_dls_1,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Tabla S11. Índices de Modificación, Modelo de Tres Factores Inicial DLS"),
               align =c('l',rep('c', 101)),
               col.names = c("Relación entre variables","Índice de Modificación", "Cambio esperado del parámetro Estandarizado (SEPC)"))%>%
    kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 13) %>%
    kableExtra::row_spec(which(grepl("lid_des3",df_mi_dls_1$lhs)), bold= T, color= "black")%>%
    #kableExtra::row_spec(which(grepl("lid_des13",df_mi_dls_1$lhs)), bold= T, color = "#104e8b", background = "#d3d3d3")%>%
    #kableExtra::row_spec(which(grepl("lid_des2",df_mi_dls_1$lhs)), bold= T, color = "darkolivegreen4", background = "darkseagreen")%>%
  kableExtra::add_footnote(c("Nota. En negrita, parámetros a estudiar","=~ : efecto de una variable observada en una variable latente","~~: covarianza entre los errores de dos variables observadas"),
                            notation = "none")%>%
  kableExtra::scroll_box(width = "100%", height = "375px")
```

<br>

A partir de la Tabla S11, se puede observar que una buena parte de los parámetros involucran ítems correspondientes a la escala de Liderazgo Laissez-Faire, dado que los índices más altos muestran un vínculo con él, destacando el ítem 3. 

<br>

Si bien existen otros parámetros que sugieren vínculos con otros ítems de la Escala Laissez-Faire como el ítem 5, 9, y 7, para análisis confirmatorios se decide priorizar el análisis de ítems correspondientes a otros factores, con la finalidad de conservar al menos tres ítem por factor y con ello evitar introducir problemas de identificación del modelo [@Hair2010; @raubenheimerj.2004; @Carpenter2018].

<br>

Otro ítem muy frecuente entre los índices de modificación es el ítem 2, el que mostró una importante proporción de error (36% de la varianza) al interior de la subescala de Liderazgo Constructivo, junto con una importante relación con el ítem 3 y las variables latentes Liderazgo Laissez-Faire y Liderazgo Autoritario/Tiránico. Por último, se eliminó el ítem 13 (“¿Define y explica claramente las tareas que le asigna a usted y a sus compañeros de trabajo?”) el cual mostró altos MI’s.

<br>

Se probó eliminar el ítem 4, el cual también mostró varios y altos índices de modificación (MI’s y SEPC’s), resultando en un modelo en el que se eliminaron los ítems 3, 4 y 13, siendo los ítems que mayores índices de modificación mostraron, pero el ajuste producto de su eliminación terminó siendo comparativamente menor. Por otro lado, se especificó un modelo sin los ítems 2, 3 y 9, pero no mostró mejores índices de ajuste. Por último, también se probó eliminar el ítem 6 y conservar el ítem 2, y que mostró mejores parámetros de ajuste aunque no obtuvo un RMSEA satisfactorio.

<br>

### Reespecificación del Modelo DLS de 3 Factores

#### Comparación modelos

```{r paso1_reesp_modelos_dls_3,eval=T, echo=T, paged.print=TRUE, eval=T}
mod_lid_des_3f_sin3<-   "LC=~ lid_des2 + lid_des6 +lid_des11 +lid_des12+lid_des13+lid_des14
LF=~ lid_des5+lid_des7+lid_des9
LT=~ lid_des1+lid_des4+lid_des8+lid_des10"
mod_lid_des_2f_sin3<-   "LC=~ lid_des2 + lid_des6 +lid_des11 +lid_des12+lid_des13+lid_des14
LD=~ lid_des5+lid_des7+lid_des9+ lid_des1+lid_des4+lid_des8+lid_des10"
mod_lid_des_3f_sin2_3<-   "LC=~ lid_des6 +lid_des11 +lid_des12+lid_des13+lid_des14
LF=~ lid_des5+lid_des7+lid_des9
LT=~ lid_des1+lid_des4+lid_des8+lid_des10"
mod_lid_des_2f_sin2_3<-   "LC=~ lid_des6 +lid_des11 +lid_des12+lid_des13+lid_des14
LD=~ lid_des5+lid_des7+lid_des9+lid_des1+lid_des4+lid_des8+lid_des10"
mod_lid_des_3f_sin2_3_13<-   "LC=~ lid_des6 +lid_des11 +lid_des12+lid_des14
LF=~ lid_des5+lid_des7+lid_des9
LT=~ lid_des1+lid_des4+lid_des8+lid_des10"
mod_lid_des_2f_sin2_3_13<-   "LC=~ lid_des6 +lid_des11 +lid_des12+lid_des14
LD=~ lid_des5+lid_des7+lid_des9+lid_des1+lid_des4+lid_des8+lid_des10"
mod_lid_des_3f_sin2_3_6<-   "LC=~ lid_des11 +lid_des12+lid_des13+lid_des14
LF=~ lid_des5+lid_des7+lid_des9
LT=~ lid_des1+lid_des4+lid_des8+lid_des10"
mod_lid_des_2f_sin2_3_6<-   "LC=~ lid_des11 +lid_des12+lid_des13+lid_des14
LD=~ lid_des5+lid_des7+lid_des9+lid_des1+lid_des4+lid_des8+lid_des10"
mod_lid_des_3f_sin2_3_9<-   "LC=~ lid_des6 +lid_des11 +lid_des12+lid_des13+lid_des14
LF=~ lid_des5+lid_des7
LT=~ lid_des1+lid_des4+lid_des8+lid_des10"
mod_lid_des_2f_sin2_3_9<-   "LC=~ lid_des6 +lid_des11 +lid_des12+lid_des13+lid_des14
LD=~ lid_des5+lid_des7+lid_des1+lid_des4+lid_des8+lid_des10"
mod_lid_des_3f_sin3_13_4<-   "LC=~ lid_des2 + lid_des6 +lid_des11 +lid_des12+lid_des14
LF=~ lid_des5+lid_des7+lid_des9
LT=~ lid_des1+lid_des8+lid_des10"
mod_lid_des_2f_sin3_13_4<-   "LC=~ lid_des2 + lid_des6 +lid_des11 +lid_des12+lid_des14
LD=~ lid_des5+lid_des7+lid_des9+lid_des1+lid_des8+lid_des10"

#Identification of a second order factor is the same process as identification of a single factor except you treat the first order factor as indicators rather than as observed outcomes.  
#https://stats.idre.ucla.edu/r/seminars/rcfa/
mod_lid_des_2f_2_sin3  <-"LC =~ lid_des2+ lid_des6+ lid_des11+ lid_des12+ lid_des13+ lid_des14
LF=~ lid_des5+lid_des7+lid_des9
LT=~ lid_des1+lid_des4+lid_des8+lid_des10
LID_DES =~  1*LT + 1*LF
LID_DES ~~ LID_DES
"

mod_lid_des_2f_2_sin2_3  <-"LC =~ lid_des6+ lid_des11+ lid_des12+ lid_des13+ lid_des14
LF=~ lid_des5+lid_des7+lid_des9
LT=~ lid_des1+lid_des4+lid_des8+lid_des10
LID_DES =~  1*LT + 1*LF
LID_DES ~~ LID_DES
"

mod_lid_des_2f_2_sin2_3_13<-   "LC=~ lid_des6 +lid_des11 +lid_des12+lid_des14
LF=~ lid_des5+lid_des7+lid_des9
LT=~ lid_des1+lid_des4+lid_des8+lid_des10
LID_DES =~  1*LT + 1*LF
LID_DES ~~ LID_DES
"
```

```{r paso2_definir_modelos_lavaan_3,eval=T, echo=T, paged.print=TRUE, eval=T}
lid_des_fa_3f_sin3<-lavaan::cfa(mod_lid_des_3f_sin3,data=BD_2020_input,ordered=LID_DES[-3],estimator="WLS",warn=F,std.lv=T)
lid_des_fa_2f_sin3<-lavaan::cfa(mod_lid_des_2f_sin3,data=BD_2020_input,ordered=LID_DES[-3],estimator="WLS",warn=F,std.lv=T)
lid_des_fa_2f_2_sin3<-lavaan::cfa(mod_lid_des_2f_2_sin3,data=BD_2020_input,ordered=LID_DES[-3],estimator="WLS",warn=F,std.lv=T)
lid_des_fa_3f_sin2_3<-lavaan::cfa(mod_lid_des_3f_sin2_3,data=BD_2020_input,ordered=LID_DES[-c(2,3)],estimator="WLS",warn=F,std.lv=T)
lid_des_fa_2f_sin2_3<-lavaan::cfa(mod_lid_des_2f_sin2_3,data=BD_2020_input,ordered=LID_DES[-c(2,3)],estimator="WLS",warn=F,std.lv=T)
lid_des_fa_2f_2_sin2_3<-lavaan::cfa(mod_lid_des_2f_2_sin2_3,data=BD_2020_input,ordered=LID_DES[-c(2,3)],estimator="WLS",warn=F,std.lv=T)
lid_des_fa_3f_sin2_3_13<-lavaan::cfa(mod_lid_des_3f_sin2_3_13,data=BD_2020_input,ordered=LID_DES[-c(2,3,13)],estimator="WLS",warn=F,std.lv=T)
lid_des_fa_2f_sin2_3_13<-lavaan::cfa(mod_lid_des_2f_sin2_3_13,data=BD_2020_input,ordered=LID_DES[-c(2,3,13)],estimator="WLS",warn=F,std.lv=T)
lid_des_fa_2f_2_sin2_3_13<-lavaan::cfa(mod_lid_des_2f_2_sin2_3_13,data=BD_2020_input,ordered=LID_DES[-c(2,3,13)],estimator="WLS",warn=F,std.lv=T)
lid_des_fa_3f_sin2_3_6<-lavaan::cfa(mod_lid_des_3f_sin2_3_6,data=BD_2020_input,ordered=LID_DES[-c(2,3,6)],estimator="WLS",warn=F,std.lv=T)
lid_des_fa_2f_sin2_3_6<-lavaan::cfa(mod_lid_des_2f_sin2_3_6,data=BD_2020_input,ordered=LID_DES[-c(2,3,6)],estimator="WLS",warn=F,std.lv=T)
lid_des_fa_3f_sin2_3_9<-lavaan::cfa(mod_lid_des_3f_sin2_3_9,data=BD_2020_input,ordered=LID_DES[-c(2,3,9)],estimator="WLS",warn=F,std.lv=T)
lid_des_fa_2f_sin2_3_9<-lavaan::cfa(mod_lid_des_2f_sin2_3_9,data=BD_2020_input,ordered=LID_DES[-c(2,3,9)],estimator="WLS",warn=F,std.lv=T)
lid_des_fa_3f_sin3_13_4<-lavaan::cfa(mod_lid_des_3f_sin3_13_4,data=BD_2020_input,ordered=LID_DES[-c(3,13,4)],estimator="WLS",warn=F,std.lv=T)
lid_des_fa_2f_sin3_13_4<-lavaan::cfa(mod_lid_des_2f_sin3_13_4,data=BD_2020_input,ordered=LID_DES[-c(3,13,4)],estimator="WLS",warn=F,std.lv=T)
```

```{r paso3_comp_tab_modelos_res_dls_3,eval=T, echo=T, paged.print=TRUE, eval=T}
t3_lid_des<-data.table(data.frame(rbind(ajusteAFC(lid_des_fa_3f_sin3),
                                        ajusteAFC(lid_des_fa_2f_sin3),
                                        ajusteAFC(lid_des_fa_2f_2_sin3),
                            ajusteAFC(lid_des_fa_3f_sin2_3),
                            ajusteAFC(lid_des_fa_2f_sin2_3),
                            ajusteAFC(lid_des_fa_2f_2_sin2_3),
                            ajusteAFC(lid_des_fa_3f_sin2_3_13),
                            ajusteAFC(lid_des_fa_2f_sin2_3_13),
                            ajusteAFC(lid_des_fa_2f_2_sin2_3_13),
                            ajusteAFC(lid_des_fa_3f_sin2_3_6),
                            ajusteAFC(lid_des_fa_2f_sin2_3_6),
                            ajusteAFC(lid_des_fa_3f_sin2_3_9),
                            ajusteAFC(lid_des_fa_2f_sin2_3_9),
                            ajusteAFC(lid_des_fa_3f_sin3_13_4),
                            ajusteAFC(lid_des_fa_2f_sin3_13_4))),keep.rownames = T)%>%
  dplyr::mutate(rn=c("Tres Factores (ítem 3 eliminado)","Dos Factores (ítem 3 eliminado)","Dos Factores (2do orden, ítem 3 eliminado)","Tres Factores (ítem 2 y 3 eliminado)","Dos Factores (ítem 2 y 3 eliminado)","Dos Factores (2do orden, ítem 2 y 3 eliminado)","Tres Factores (ítem 2, 3 y 13 eliminado)","Dos Factores (ítem 2, 3 y 13 eliminado)", "Dos Factores (2do orden, ítem 2, 3 y 13 eliminado)", "Tres Factores (ítem 2, 3 y 6 eliminado)","Dos Factores (ítem 2, 3 y 6 eliminado)", "Tres Factores (ítem 2, 3 y 9 eliminado)","Dos Factores (ítem 2, 3 y 9 eliminado)", "Tres Factores (ítem 3, 4 y 13 eliminado)", "Dos Factores (ítem 3, 4 y 13 eliminado)"))%>%
  dplyr::select(-Modelo)

  knitr::kable(t3_lid_des,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Tabla S12. Comparativo Índices de Ajuste de Modelos Propuestos DLS"),
               align =c('l',rep('c', 101)),
               col.names = c("Modelo","gl","WLS $\\chi^2$","CMIN/gl","aGFI","GFI", "RMSEA\n[IC 90%]","CFit","CFI","NNFI")) %>%
  kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 13)%>%
  #kableExtra::row_spec(4, bold= T, color= "black", background= "white")%>%
  #pack_rows("Group 2", 8, 10)
    #label_row_css = "background-color: #666; color: #fff;")%>%
  kableExtra::pack_rows("Modelos principales", 1, 9, bold= T, color= "black", background= "white") %>% 
  kableExtra::pack_rows("Modelos alternativos", 10, 15, bold= T, color= "black", background= "white") %>% 
  kableExtra::add_footnote( c(paste("Nota. 2do orden= ítems de liderazgo destructivo correlacionan entre liderazgo autoritario y laissez-faire")), 
                            notation = "none")
```

<br>

El detalle del modelo reespecificado eliminando 3 ítems se presenta a continaución.

<br>

<div style="border: 1px solid #ddd; padding: 5px; overflow-y: scroll; height:350px; overflow-x: scroll; width:100%">
```{r paso2_summ_dls_3_fac_final,eval=T, echo=T, paged.print=TRUE, eval=T}
summary(lid_des_fa_3f_sin2_3_13)
```
</div>

Se dispone también de un modelo de 2 factores

<br>

<div style="border: 1px solid #ddd; padding: 5px; overflow-y: scroll; height:350px; overflow-x: scroll; width:100%">
```{r paso2_summ_dls_2_fac_final,eval=T, echo=T, paged.print=TRUE, eval=T}
summary(lid_des_fa_2f_sin2_3_13)
```
</div>

Se dispone también de un modelo de 3 factores, pero sólo elimnando el ítem 3.

<br>

<div style="border: 1px solid #ddd; padding: 5px; overflow-y: scroll; height:350px; overflow-x: scroll; width:100%">
```{r paso2_summ_dls_3_b_fac_final,eval=T, echo=T, paged.print=TRUE, eval=T}
summary(lid_des_fa_3f_sin3)
```
</div>

Y el de 2 factores, pero sólo eliminando el ítem 3.

<br>

<div style="border: 1px solid #ddd; padding: 5px; overflow-y: scroll; height:350px; overflow-x: scroll; width:100%">
```{r paso2_summ_dls_2_b_fac_final,eval=T, echo=T, paged.print=TRUE, eval=T}
summary(lid_des_fa_2f_sin3)
```
</div>

<br>

```{r dls_fig4_dls_a, echo=T, fig.align='center', fig.pos='H', fig.cap= "Figura S7a. Cargas factoriales y comunalidades para DLS (solución final pre-revisión)", message=FALSE, error=T, fig.retina=2}
options(OutDec=",")
semPlot::semPaths(lid_des_fa_3f_sin2_3_13, residuals=T, what="est", label.cex=1, edge.label.cex=1,fade=FALSE,
                  thresholds = F,label.scale=F,
                  edge.label.position=c(rep(c(0.45,0.55),5),0.45,rep(0.5,16),rep(0.5,15)), #11  it, 
                  intercepts=F, curveAdjacent = TRUE,title=F, layout="tree3",sizeMan=5, gui = T, allVars = FALSE,cut=1.1,sizeLat=5, edge.color="black",
                  curvePivot=T,borders=FALSE, edge.width = 0.5, node.width =1, node.height= 1,label.scale=T,curve = 1.5,
                  nodeLabels=c(paste0("",c(6,11,12,14,5,7,9,1,4,8,10)),"Liderazgo\nConstructivo","Liderazgo\nLaissez-Faire","Liderazgo\nAutoritario"),
                  mar = c(5.8, 0.8, 7.8, 0.8))
options(OutDec=".")
```

```{r dls_fig4_dls_b, echo=T, fig.align='center', fig.pos='H', fig.cap= "Figura S7b. Cargas factoriales y comunalidades para DLS (sin it. 3)", message=FALSE, error=T, fig.retina=2}
if(no_mostrar==0){
for (i in 2:100){
  ano<-i
  try(semPlot::semPaths(lid_des_fa_3f_sin3, 
                  residuals=T, 
                  what="std", 
                  label.cex=1.5, 
                  edge.label.cex=1,
                  fade=FALSE,
                  thresholds = F,
                  edge.label.position=rep(.5,ano),
                  filetype="pdf",
                  filename=paste0("Número de parámetros ",ano),
                  intercepts=F)
    )
  }
}
#48  43
options(OutDec=",")
semPlot::semPaths(lid_des_fa_3f_sin3, residuals=T, what="est", label.cex=1, edge.label.cex=1,fade=FALSE,
                  thresholds = F,label.scale=F,
                  edge.label.position=c(rep(c(0.45,0.55),6),0.45,rep(0.5,18),rep(0.5,17)), #11  it, 
                  intercepts=F, curveAdjacent = TRUE,title=F, layout="tree",sizeMan=5, gui = T, allVars = FALSE,cut=1.1,sizeLat=5, edge.color="black",
                  curvePivot=T,borders=FALSE, edge.width = 0.5, node.width =1, node.height= 1,label.scale=T,curve = 1,
                  nodeLabels=c(paste0("",c(2,6,11,12,13,14,5,7,9,1,4,8,10)),"Liderazgo\nConstructivo","Liderazgo\nLaissez-Faire","Liderazgo\nAutoritario"),
                  mar = c(5.8, 0.8, 5.8, 0.8))
options(OutDec=".")
```

```{r dls_fig4_dls_c, echo=T, fig.align='center', fig.pos='H', fig.cap= "Figura S7c. Cargas factoriales y comunalidades para DLS (2 factores, sin it. 3)", message=FALSE, error=T, fig.retina=2}
if(no_mostrar==0){
for (i in 2:100){
  ano<-i
  try(semPlot::semPaths(lid_des_fa_2f_sin3, 
                  residuals=T, 
                  what="std", 
                  label.cex=1.5, 
                  edge.label.cex=1,
                  fade=FALSE,
                  thresholds = F,
                  edge.label.position=rep(.5,ano),
                  filetype="pdf",
                  filename=paste0("Número de parámetros ",ano),
                  intercepts=F)
    )
  }
}
#48  43
options(OutDec=",")
semPlot::semPaths(lid_des_fa_2f_sin3, residuals=T, what="est", label.cex=1, 
                  edge.label.cex=1,fade=FALSE, thresholds = F,label.scale=F,
                  edge.label.position=c(rep(c(0.45,0.55),6),0.45,rep(0.5,15),rep(0.5,15)), #11  it, 
                  intercepts=F, curveAdjacent = TRUE,title=F, layout="tree",sizeMan=5, gui = T, allVars = FALSE,cut=1.1,sizeLat=4, edge.color="black",
                  curvePivot=T,borders=FALSE, edge.width = 0.5, node.width =1, node.height= 1,label.scale=T,curve = 1,
                  nodeLabels=c(paste0("",c(2,6,11,12,13,14,5,7,9,1,4,8,10)),"Liderazgo\nConstructivo","Liderazgos\nDestructivos"),
                  mar = c(5.8, 0.8, 5.8, 0.8))
dev.print(png,"Figura S7c.png", width=10, height=7, res=600, units="in") 
options(OutDec=".")
#lid_des_fa_2f_2_sin3 lid_des_fa_2f_2_sin2_3_13  mod_lid_des_2f_2_sin3 mod_lid_des_2f_2_sin2_3_13
```

```{r dls_fig4_dls_d, echo=T, fig.align='center', fig.pos='H', fig.cap= "Figura S7d. Cargas factoriales y comunalidades para DLS (2 factores, segundo orden, sin it. 3)", message=FALSE, error=T, fig.retina=2}
if(no_mostrar==0){
for (i in 2:100){
  ano<-i
  try(semPlot::semPaths(lid_des_fa_2f_2_sin3, 
                  residuals=T, 
                  what="std", 
                  label.cex=1.5, 
                  edge.label.cex=1,
                  fade=FALSE,
                  thresholds = F,
                  edge.label.position=rep(.5,ano),
                  filetype="pdf",
                  filename=paste0("Número de parámetros ",ano),
                  intercepts=F)
    )
  }
}
options(OutDec=",")
#47 segundo orden
semPlot::semPaths(lid_des_fa_2f_2_sin3, residuals=T, what="est", label.cex=.7,
                  edge.label.cex=.7, fade=FALSE, thresholds = F, label.scale=F,
                  edge.label.position= c(rep(c(0.45,0.55),6),0.45,rep(0.5,17),rep(0.5,17)), #11  it, 
                  intercepts=F, curveAdjacent =T, title=F, layout="tree", sizeMan=4, gui = T, allVars = FALSE, cut=1, sizeLat=8, edge.color="black",
                  curvePivot=T, borders=F, edge.width = 1, node.width =1.2, node.height= 1.2, curve = .3,
                   rotation = 1,
                  nodeLabels=c(paste0("",c(2,6,11,12,13,14,5,7,9,1,4,8,10)),"Liderazgo\nConstructivo","Liderazgo\nLaissez-Faire","Liderazgo\nAutoritario","Liderazgos\nDestructivos"),
                  mar = c(1.8, 0.7, 1.8, 0.7))
dev.print(png,"Figura S7d.png", width=10, height=6, res=600, units="in") 
options(OutDec=".")
#lid_des_fa_2f_2_sin3 lid_des_fa_2f_2_sin2_3_13  mod_lid_des_2f_2_sin3 mod_lid_des_2f_2_sin2_3_13
```

<br>

#### Confiabilidad


```{r dls_afc_rel_2a, echo=T, error=T, warning=FALSE, cache=TRUE, paged.print=TRUE}
loadings_dls <- standardizedSolution(lid_des_fa_3f_sin2_3_13) %>%	
  dplyr::filter(op == "=~", lhs == "LC") %>% dplyr::select(est.std)
com_rel_dls <- sum(loadings_dls) ^ 2 / ((sum(loadings_dls)^ 2)  + sum(1 - loadings_dls ^ 2))	

loadings2_dls <- standardizedSolution(lid_des_fa_3f_sin2_3_13) %>%	
  dplyr::filter(op == "=~", lhs == "LF") %>% dplyr::select(est.std)
com_rel2_dls <- sum(loadings2_dls) ^ 2 / ((sum(loadings2_dls)^ 2)  + sum(1 - loadings2_dls ^ 2))	

loadings3_dls <- standardizedSolution(lid_des_fa_3f_sin2_3_13) %>%	
  dplyr::filter(op == "=~", lhs == "LT") %>% dplyr::select(est.std)
com_rel3_dls <- sum(loadings3_dls) ^ 2 / ((sum(loadings3_dls)^ 2)  + sum(1 - loadings3_dls ^ 2))	

avg_var_dls <- sum(loadings_dls ^ 2) / nrow(loadings_dls)	
avg_var2_dls <- sum(loadings2_dls ^ 2) / nrow(loadings2_dls)	
avg_var3_dls <- sum(loadings3_dls ^ 2) / nrow(loadings3_dls)	

cr_ave_dls<-
  data.frame(
    Constructo=c("Liderazgo Constructivo","Liderazgo Laissez-Faire","Liderazgo Autoritario"),
    AVE=round(c(avg_var_dls,avg_var2_dls,avg_var3_dls),2),
    CR=round(c(com_rel_dls,com_rel2_dls,com_rel3_dls),2)
  )

#CR=El valor del estadístico debería ser superior a 0,7

data.table(t(round(semTools::reliability(lid_des_fa_3f_sin2_3_13, c("alpha.ord","omega","ave"),return.total=T),2)),keep.rownames = T) %>% 
  dplyr::mutate(rn=dplyr::case_when(rn=="LC"~"Liderazgo Constructivo",
                                    rn=="LF"~"Liderazgo Laissez-Faire",rn=="LT"~"Liderazgo Autoritario",T~"Total")) %>% 
  dplyr::left_join(cr_ave_dls, by=c("rn"="Constructo")) %>% 
  knitr::kable(format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Tabla S13a. Confiabilidad (sin ítemes 2, 3 y 13)"),
               col.names = c("Constructo","Alfa ordinal", "omega", "Varianza Media Extraída/\nAverage variance extracted", "AVE", "Fiabilidad Compuesta"),
               escape=T)%>%
  kableExtra::add_footnote(c("Nota. AVE >0.5, eivdencia de validez convergente; Alfa >=.7"),
                           notation = "none")%>%
  kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 12) %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
```

```{r dls_afc_rel_2b, echo=T, error=T, warning=FALSE, cache=TRUE, paged.print=TRUE}
loadings_dls_b <- standardizedSolution(lid_des_fa_3f_sin3) %>%	
  dplyr::filter(op == "=~", lhs == "LC") %>% dplyr::select(est.std)
com_rel_dls_b <- sum(loadings_dls_b) ^ 2 / ((sum(loadings_dls_b)^ 2)  + sum(1 - loadings_dls_b ^ 2))	

loadings2_dls_b <- standardizedSolution(lid_des_fa_3f_sin3) %>%	
  dplyr::filter(op == "=~", lhs == "LF") %>% dplyr::select(est.std)
com_rel2_dls_b <- sum(loadings2_dls_b) ^ 2 / ((sum(loadings2_dls_b)^ 2)  + sum(1 - loadings2_dls_b ^ 2))	

loadings3_dls_b <- standardizedSolution(lid_des_fa_3f_sin3) %>%	
  dplyr::filter(op == "=~", lhs == "LT") %>% dplyr::select(est.std)
com_rel3_dls_b <- sum(loadings3_dls_b) ^ 2 / ((sum(loadings3_dls_b)^ 2)  + sum(1 - loadings3_dls_b ^ 2))	

avg_var_dls_b <- sum(loadings_dls_b ^ 2) / nrow(loadings_dls_b)	
avg_var2_dls_b <- sum(loadings2_dls_b ^ 2) / nrow(loadings2_dls_b)	
avg_var3_dls_b <- sum(loadings3_dls_b ^ 2) / nrow(loadings3_dls_b)	

cr_ave_dls_b<-
  data.frame(
    Constructo=c("Liderazgo Constructivo","Liderazgo Laissez-Faire","Liderazgo Autoritario"),
    AVE=round(c(avg_var_dls_b,avg_var2_dls_b,avg_var3_dls_b),2),
    CR=round(c(com_rel_dls_b,com_rel2_dls_b,com_rel3_dls_b),2)
  )

#CR=El valor del estadístico debería ser superior a 0,7

data.table(t(round(semTools::reliability(lid_des_fa_3f_sin3, c("alpha.ord","omega","ave"),return.total=T),2)),keep.rownames = T) %>% 
  dplyr::mutate(rn=dplyr::case_when(rn=="LC"~"Liderazgo Constructivo",
                                    rn=="LF"~"Liderazgo Laissez-Faire",rn=="LT"~"Liderazgo Autoritario",T~"Total")) %>% 
  dplyr::left_join(cr_ave_dls, by=c("rn"="Constructo")) %>% 
  knitr::kable(format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Tabla S13b. Confiabilidad (3 factores, sin ítem 3)"),
               col.names = c("Constructo","Alfa ordinal", "omega", "Varianza Media Extraída/\nAverage variance extracted", "AVE", "Fiabilidad Compuesta"),
               escape=T)%>%
    kableExtra::add_footnote(c("Nota. AVE >0.5, eivdencia de validez convergente; Alfa >=.7"),
                           notation = "none")%>%
  kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 12) %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
```


```{r dls_afc_rel_2c, echo=T, error=T, warning=FALSE, cache=TRUE, paged.print=TRUE}
loadings_dls_c <- standardizedSolution(lid_des_fa_2f_sin3) %>%	
  dplyr::filter(op == "=~", lhs == "LC") %>% dplyr::select(est.std)
com_rel_dls_c <- sum(loadings_dls_c) ^ 2 / ((sum(loadings_dls_c)^ 2)  + sum(1 - loadings_dls_c ^ 2))	

loadings2_dls_c <- standardizedSolution(lid_des_fa_2f_sin3) %>%	
  dplyr::filter(op == "=~", lhs == "LD") %>% dplyr::select(est.std)
com_rel2_dls_c <- sum(loadings2_dls_c) ^ 2 / ((sum(loadings2_dls_c)^ 2)  + sum(1 - loadings2_dls_c ^ 2))	

avg_var_dls_c <- sum(loadings_dls_c ^ 2) / nrow(loadings_dls_c)	
avg_var2_dls_c <- sum(loadings2_dls_c ^ 2) / nrow(loadings2_dls_c)	

cr_ave_dls_c<-
  data.frame(
    Constructo=c("Liderazgo Constructivo","Liderazgos Destructivos"),
    AVE=round(c(avg_var_dls_c,avg_var2_dls_c),2),
    CR=round(c(com_rel_dls_c,com_rel2_dls_c),2)
  )

#CR=El valor del estadístico debería ser superior a 0,7

data.table(t(round(semTools::reliability(lid_des_fa_2f_sin3, c("alpha.ord","omega","ave"),return.total=T),2)),keep.rownames = T) %>% 
  dplyr::mutate(rn=dplyr::case_when(rn=="LC"~"Liderazgo Constructivo",
                                    rn=="LD"~"Liderazgos Destructivos",T~"Total")) %>% 
  dplyr::left_join(cr_ave_dls_c, by=c("rn"="Constructo")) %>% 
  knitr::kable(format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Tabla S13c. Confiabilidad (2 factores, sin ítem 3)"),
               col.names = c("Constructo","Alfa ordinal", "omega", "Varianza Media Extraída/\nAverage variance extracted", "AVE", "Fiabilidad Compuesta"),
               escape=T)%>%
    kableExtra::add_footnote(c("Nota. AVE >0.5, eivdencia de validez convergente; Alfa >=.7"),
                           notation = "none")%>%
  kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 12) %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
#lid_des_fa_2f_2_sin3 lid_des_fa_2f_2_sin2_3_13  mod_lid_des_2f_2_sin3 mod_lid_des_2f_2_sin2_3_13
```

```{r dls_afc_rel_2d, echo=T, error=T, warning=FALSE, cache=TRUE, paged.print=TRUE}
loadings_dls_d <- standardizedSolution(lid_des_fa_2f_2_sin3) %>%	
  dplyr::filter(op == "=~", lhs == "LC") %>% dplyr::select(est.std)
com_rel_dls_d <- sum(loadings_dls_d) ^ 2 / ((sum(loadings_dls_d)^ 2)  + sum(1 - loadings_dls_d ^ 2))	

loadings2_dls_d <- standardizedSolution(lid_des_fa_2f_2_sin3) %>%	
  dplyr::filter(op == "=~", lhs == "LF") %>% dplyr::select(est.std)
com_rel2_dls_d <- sum(loadings2_dls_d) ^ 2 / ((sum(loadings2_dls_d)^ 2)  + sum(1 - loadings2_dls_d ^ 2))	

loadings3_dls_d <- standardizedSolution(lid_des_fa_2f_2_sin3) %>%	
  dplyr::filter(op == "=~", lhs == "LT") %>% dplyr::select(est.std)
com_rel3_dls_d <- sum(loadings3_dls_d) ^ 2 / ((sum(loadings3_dls_d)^ 2)  + sum(1 - loadings3_dls_d ^ 2))	

avg_var_dls_d <- sum(loadings_dls_d ^ 2) / nrow(loadings_dls_d)	
avg_var2_dls_d <- sum(loadings2_dls_d ^ 2) / nrow(loadings2_dls_d)	
avg_var3_dls_d <- sum(loadings3_dls_d ^ 2) / nrow(loadings3_dls_d)	

cr_ave_dls_d<-
  data.frame(
    Constructo=c("Liderazgo Constructivo","Liderazgo Laissez-Faire","Liderazgo Autoritario"),
    AVE=round(c(avg_var_dls_d,avg_var2_dls_d,avg_var3_dls_d),2),
    CR=round(c(com_rel_dls_d,com_rel2_dls_d,com_rel3_dls_d),2)
  )

#Flora, D. B. (2020). Your Coefficient Alpha Is Probably Wrong, but Which Coefficient Omega Is Right? A Tutorial on Using R to Obtain Better Reliability Estimates. Advances in Methods and Practices in Psychological Science, 484–501. https://doi.org/10.1177/2515245920951747

#CR=El valor del estadístico debería ser superior a 0,7
#Reliability values at Levels 1 and 2 of the second-order factor, as well as the partial reliability value at Level 1
#estimates of ωu are unbiased with varying factor loadings (i.e., violation of tau equivalence), when alpha underestimates population reliability 

data.frame(semTools::reliabilityL2(lid_des_fa_2f_2_sin3,"LID_DES"))
data.table(t(round(semTools::reliability(lid_des_fa_2f_2_sin3, c("alpha.ord","omega","ave"),return.total=T),2)),keep.rownames = T) %>% 
  dplyr::mutate(rn=dplyr::case_when(rn=="LC"~"Liderazgo Constructivo",
                                    rn=="LF"~"Liderazgo Laissez-Faire",
                                    rn=="LT"~"Liderazgo Autoritario",
                                    rn=="LID_DES"~"Liderazgos Destructivos",T~"Total")) %>% 
  dplyr::left_join(cr_ave_dls_c, by=c("rn"="Constructo")) %>% 
  knitr::kable(format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Tabla S13d. Confiabilidad (segundo orden, sin ítem 3)"),
               col.names = c("Constructo","Alfa ordinal", "omega", "Varianza Media Extraída/\nAverage variance extracted", "AVE", "Fiabilidad Compuesta"),
               escape=T)%>%
      kableExtra::add_footnote(c("Nota. AVE >0.5, eivdencia de validez convergente; Alfa >=.7"),
                           notation = "none")%>%
  kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 12) %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
#lid_des_fa_2f_2_sin3 lid_des_fa_2f_2_sin2_3_13  mod_lid_des_2f_2_sin3 mod_lid_des_2f_2_sin2_3_13
```

```{r dls_afc_htmt_a, echo = T, eval = T}
# https://rdrr.io/cran/semTools/man/htmt.html

semTools::htmt(mod_lid_des_3f_sin2_3_13, BD_2020_input[,LID_DES[-c(2,3,13)]], sample.cov = NULL, missing = 'pairwise', ordered = LID_DES[-c(2,3,13)], absolute = T)%>% 
  as.data.table(keep.rownames = T) %>% 
  dplyr::mutate(across(where(is.numeric), ~ round(.x, 2))) %>% 
  knitr::kable(format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Tabla S14a. Validez Discriminante (3 factores, sin ítemes 2, 3 y 13)"),
               align =c('l',rep('c', 101)),
               #col.names = c("Var. Latentes","Agotamiento y Estrés", "Sueño", "Estrés Postraumático", "Sint. Ansiosa", "Sint. Depresiva")
               escape=T)%>%
  kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 12) %>%
  kableExtra::add_footnote(c("Nota. Valores <.90, umbral en favor de validez discriminante; LC= Liderazgo Constructivo; LF= Liderazgo Laissez-Faire; LT= Liderazgo Autoritario"),
                           notation = "none")%>%
  kableExtra::scroll_box(width = "100%", height = "375px")
```

```{r dls_afc_htmt_b, echo = T, eval = T}
# https://rdrr.io/cran/semTools/man/htmt.html
#mod_lid_des_2f_sin3  mod_lid_des_3f_sin3

semTools::htmt(mod_lid_des_3f_sin3, BD_2020_input[,LID_DES[-c(3)]], sample.cov = NULL, missing = 'pairwise', ordered = LID_DES[-c(3)], absolute = T)%>% 
  as.data.table(keep.rownames = T) %>% 
  dplyr::mutate(across(where(is.numeric), ~ round(.x, 2))) %>% 
  knitr::kable(format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Tabla S14b. Validez Discriminante (3 factores, sin ítem 3)"),
               align =c('l',rep('c', 101)),
               #col.names = c("Var. Latentes","Agotamiento y Estrés", "Sueño", "Estrés Postraumático", "Sint. Ansiosa", "Sint. Depresiva")
               escape=T)%>%
  kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 12) %>%
  kableExtra::add_footnote(c("Nota. Valores <.90, umbral en favor de validez discriminante; LC= Liderazgo Constructivo; LF= Liderazgo Laissez-Faire; LT= Liderazgo Autoritario"),
                           notation = "none")%>%
  kableExtra::scroll_box(width = "100%", height = "375px")
```

```{r dls_afc_htmt_c, echo = T, eval = T}
# https://rdrr.io/cran/semTools/man/htmt.html
#mod_lid_des_2f_sin3  mod_lid_des_3f_sin3

semTools::htmt(mod_lid_des_2f_sin3, BD_2020_input[,LID_DES[-c(3)]], sample.cov = NULL, missing = 'pairwise', ordered = LID_DES[-c(3)], absolute = T)%>% 
  as.data.table(keep.rownames = T) %>% 
  dplyr::mutate(across(where(is.numeric), ~ round(.x, 2))) %>% 
  knitr::kable(format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Tabla S14c. Validez Discriminante (2 factores, sin ítem 3)"),
               align =c('l',rep('c', 101)),
               #col.names = c("Var. Latentes","Agotamiento y Estrés", "Sueño", "Estrés Postraumático", "Sint. Ansiosa", "Sint. Depresiva")
               escape=T)%>%
  kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 12) %>%
  kableExtra::add_footnote(c("Nota. Valores <.90, umbral en favor de validez discriminante; LC= Liderazgo Constructivo; LD= Liderazgos Destructivos"),
                           notation = "none")%>%
  kableExtra::scroll_box(width = "100%", height = "375px")
```

```{r dls_afc_disc_val_a, eval=T, echo=T, warning=FALSE}
#Calculate discriminant validity statistics based on a fitted lavaan object

#For the exploration, discriminant validity was examined with an R function, discriminantValidity, implemented in semToolspackage (Jorgensen et al., 2021). Discriminant validity was examined whether the two constructs, overall compliance and compliance with distancing measures, were distinguishable from each other. If a significant outcome results from 25χ2test, then discriminant validity between the tested constructs is supported, so the constructs are deemed to be distinct from each other (Jorgensen et al., 2021; Rönkkö & Cho, 2020). On the other hand, a non-significant outcome suggests that discriminant validity could not be supported, so it is impossible to distinguish the two constructs.The result of χ2test indicated that discriminant validity was supported, χ2(1) = 968.82, p< .001. Thus, although the two tested constructs, overall compliance and compliance with distancing measure, were significantly correlated with each other, they shall be treated as two distinguishable and independent constructs. It may suggest that the two items assess two unique and distinct constructs, so they could not be collapsed into one.

#lid_des_fa_3f_sin2_3_13 lid_des_fa_3f_sin3 lid_des_fa_2f_sin3

semTools::discriminantValidity(lid_des_fa_3f_sin2_3_13, cutoff = 0.9, merge = F, level = 0.95) %>% 
  as.data.table(keep.rownames = T) %>% 
  dplyr::mutate(across(where(is.numeric), ~ round(.x, 2))) %>% 
  knitr::kable(format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Tabla S15a. Validez Discriminante (2) (3 factores, sin ítem 2, 3 y 13)"),
               align =c('l',rep('c', 101)),
               #col.names = c("Var. Latentes","Agotamiento y Estrés", "Sueño", "Estrés Postraumático", "Sint. Ansiosa", "Sint. Depresiva")
               escape=T)%>%
  kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 12) %>%
  kableExtra::add_footnote(c("Nota. LC= Liderazgo Constructivo; LF= Liderazgo Laissez-Faire; LT= Liderazgo Autoritario"),
                           notation = "none")%>%
  kableExtra::scroll_box(width = "100%", height = "375px")
```

```{r dls_afc_disc_val_b, eval=T, echo=T, warning=FALSE}
#Calculate discriminant validity statistics based on a fitted lavaan object

#For the exploration, discriminant validity was examined with an R function, discriminantValidity, implemented in semToolspackage (Jorgensen et al., 2021). Discriminant validity was examined whether the two constructs, overall compliance and compliance with distancing measures, were distinguishable from each other. If a significant outcome results from 25χ2test, then discriminant validity between the tested constructs is supported, so the constructs are deemed to be distinct from each other (Jorgensen et al., 2021; Rönkkö & Cho, 2020). On the other hand, a non-significant outcome suggests that discriminant validity could not be supported, so it is impossible to distinguish the two constructs.The result of χ2test indicated that discriminant validity was supported, χ2(1) = 968.82, p< .001. Thus, although the two tested constructs, overall compliance and compliance with distancing measure, were significantly correlated with each other, they shall be treated as two distinguishable and independent constructs. It may suggest that the two items assess two unique and distinct constructs, so they could not be collapsed into one.

#lid_des_fa_3f_sin2_3_13 lid_des_fa_3f_sin3 lid_des_fa_2f_sin3

semTools::discriminantValidity(lid_des_fa_3f_sin3, cutoff = 0.9, merge = F, level = 0.95) %>% 
  as.data.table(keep.rownames = T) %>% 
  dplyr::mutate(across(where(is.numeric), ~ round(.x, 2))) %>% 
  knitr::kable(format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Tabla S15b. Validez Discriminante (2) (3 factores, sin ítem 3)"),
               align =c('l',rep('c', 101)),
               #col.names = c("Var. Latentes","Agotamiento y Estrés", "Sueño", "Estrés Postraumático", "Sint. Ansiosa", "Sint. Depresiva")
               escape=T)%>%
  kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 12) %>%
  kableExtra::add_footnote(c("Nota. LC= Liderazgo Constructivo; LF= Liderazgo Laissez-Faire; LT= Liderazgo Autoritario"),
                           notation = "none")%>%
  kableExtra::scroll_box(width = "100%", height = "375px")
```

```{r dls_afc_disc_val_c, eval=T, echo=T, warning=FALSE}
#Calculate discriminant validity statistics based on a fitted lavaan object

#For the exploration, discriminant validity was examined with an R function, discriminantValidity, implemented in semToolspackage (Jorgensen et al., 2021). Discriminant validity was examined whether the two constructs, overall compliance and compliance with distancing measures, were distinguishable from each other. If a significant outcome results from 25χ2test, then discriminant validity between the tested constructs is supported, so the constructs are deemed to be distinct from each other (Jorgensen et al., 2021; Rönkkö & Cho, 2020). On the other hand, a non-significant outcome suggests that discriminant validity could not be supported, so it is impossible to distinguish the two constructs.The result of χ2test indicated that discriminant validity was supported, χ2(1) = 968.82, p< .001. Thus, although the two tested constructs, overall compliance and compliance with distancing measure, were significantly correlated with each other, they shall be treated as two distinguishable and independent constructs. It may suggest that the two items assess two unique and distinct constructs, so they could not be collapsed into one.

#lid_des_fa_3f_sin2_3_13 lid_des_fa_3f_sin3 lid_des_fa_2f_sin3

semTools::discriminantValidity(lid_des_fa_2f_sin3, cutoff = 0.9, merge = F, level = 0.95) %>% 
  as.data.table(keep.rownames = T) %>% 
  dplyr::mutate(across(where(is.numeric), ~ round(.x, 2))) %>% 
  knitr::kable(format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Tabla S15c. Validez Discriminante (2) (2 factores, sin ítem 3)"),
               align =c('l',rep('c', 101)),
               #col.names = c("Var. Latentes","Agotamiento y Estrés", "Sueño", "Estrés Postraumático", "Sint. Ansiosa", "Sint. Depresiva")
               escape=T)%>%
  kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 12) %>%
  kableExtra::add_footnote(c("Nota. LC= Liderazgo Constructivo; LF= Liderazgo Laissez-Faire; LT= Liderazgo Autoritario"),
                           notation = "none")%>%
  kableExtra::scroll_box(width = "100%", height = "375px")
```


```{r dls_afc_disc_val_c, eval=T, echo=T, warning=FALSE}
#Calculate discriminant validity statistics based on a fitted lavaan object

#For the exploration, discriminant validity was examined with an R function, discriminantValidity, implemented in semToolspackage (Jorgensen et al., 2021). Discriminant validity was examined whether the two constructs, overall compliance and compliance with distancing measures, were distinguishable from each other. If a significant outcome results from 25χ2test, then discriminant validity between the tested constructs is supported, so the constructs are deemed to be distinct from each other (Jorgensen et al., 2021; Rönkkö & Cho, 2020). On the other hand, a non-significant outcome suggests that discriminant validity could not be supported, so it is impossible to distinguish the two constructs.The result of χ2test indicated that discriminant validity was supported, χ2(1) = 968.82, p< .001. Thus, although the two tested constructs, overall compliance and compliance with distancing measure, were significantly correlated with each other, they shall be treated as two distinguishable and independent constructs. It may suggest that the two items assess two unique and distinct constructs, so they could not be collapsed into one.

#lid_des_fa_3f_sin2_3_13 lid_des_fa_3f_sin3 lid_des_fa_2f_sin3

semTools::discriminantValidity(lid_des_fa_2f_2_sin3, cutoff = 0.9, merge = F, level = 0.95) %>% 
  as.data.table(keep.rownames = T) %>% 
  dplyr::mutate(across(where(is.numeric), ~ round(.x, 2))) %>% 
  knitr::kable(format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Tabla S15d. Validez Discriminante (2) (segundo orden, sin ítem 3)"),
               align =c('l',rep('c', 101)),
               #col.names = c("Var. Latentes","Agotamiento y Estrés", "Sueño", "Estrés Postraumático", "Sint. Ansiosa", "Sint. Depresiva")
               escape=T)%>%
  kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 12) %>%
  kableExtra::add_footnote(c("Nota. LC= Liderazgo Constructivo; LF= Liderazgo Laissez-Faire; LT= Liderazgo Autoritario"),
                           notation = "none")%>%
  kableExtra::scroll_box(width = "100%", height = "375px")
```

```{r dls_unidim, eval=T, echo=T, warning=FALSE}
#2,6,11,12,13,14
#5,7,9,1,4,8,10

#https://rdrr.io/cran/psych/man/unidim.html

# u	=The estimate of unidimensionality which is just the product of
# av.r.fit	= The fit of the average r to the correlation matrix
# fa.fit	= The off diagonal fit from fa
# alpha	= Standardized alpha of the keyed items (after appropriate reversals)
# av.r	= The average interitem correlation of the keyed items.
# median.r = The median value of the iteritem correlations of the keyed items.
# Unidim.A	= The unidimensional criterion when items are keyed in positive direction.
# Unidim	= The raw value of the unidimensional criterion
# raw.model	= The ratio of the FF model to the sum(R)
# adj.model	= The ratio of the FF model to the sum(R) when items are flipped.
# Total	= The ratio of the sum(R - uniqueness)/sum(R)
# Total.A	 = Same ratio with flipped items

cat("Total")
unidim(BD_2020_input[,LID_DES], keys.list = NULL,cor="poly",correct=.5, check.keys = TRUE)

cat("Total. Sin ítem 3")
unidim(BD_2020_input[,LID_DES[-c(3)]], keys.list = NULL,cor="poly",correct=.5, check.keys = TRUE)

cat("Total. Sin ítem 2 y 3")
unidim(BD_2020_input[,LID_DES[-c(2,3)]], keys.list = NULL,cor="poly",correct=.5, check.keys = TRUE)

cat("Total. Sin ítem 2, 3 y 13")
unidim(BD_2020_input[,LID_DES[-c(2,3,13)]], keys.list = NULL,cor="poly",correct=.5, check.keys = TRUE)

cat("Liderazgo Destructivo")
unidim(BD_2020_input[,paste0("lid_des",c(3,5,7,9,1,4,8,10))], keys.list = NULL,cor="poly",correct=.5, check.keys = TRUE)

cat("Liderazgo Destructivo. Sin ítem 3")
unidim(BD_2020_input[,paste0("lid_des",c(5,7,9,1,4,8,10))], keys.list = NULL,cor="poly",correct=.5, check.keys = TRUE)

cat("Liderazgo Constructivo")
unidim(BD_2020_input[,paste0("lid_des",c(2,6,11,12,13,14))], keys.list = NULL,cor="poly",correct=.5, check.keys = TRUE)

cat("Liderazgo Constructivo. Sin ítem 2 y 3")
unidim(BD_2020_input[,paste0("lid_des",c(6,11,12,13,14))], keys.list = NULL,cor="poly",correct=.5, check.keys = TRUE)

cat("Liderazgo Destructivo. Sin ítem 2, 3 y 13")
unidim(BD_2020_input[,paste0("lid_des",c(6,11,12,14))], keys.list = NULL,cor="poly",correct=.5, check.keys = TRUE)
```

<br>

# Modelo de medida

## MM-Primera aproximación

### MM1-Comparación modelos

Se compararon distintos modelos, con todos los ítems. Desde modelos más complejos con variables latentes de segundo orden para Liderazgos Destructivos, hasta modelos que identificaron todos los ítems como parte de un mismo constructo.

<br>

<div style="border: 1px solid #ddd; padding: 5px; overflow-y: scroll; height:500px; overflow-x: scroll; width:100%;">
```{r paso1_construir_modelo, eval=T, echo=T, warning=FALSE, paged.print=TRUE}
#especifico el modelo

mod_med_0  <-"todo =~ naq1+ naq3+ naq14+ naq16+
naq18+ naq19+ naq21+ naq2+ naq4+ naq5+
naq6+ naq7+ naq10+ naq11+ naq12+ naq13+
naq15+ naq17+ naq20+ naq8+ naq9+ naq22+ lid_des2+ lid_des6+ lid_des11+ lid_des12+ lid_des13+ lid_des14+ lid_des3+ lid_des5+ lid_des7+ lid_des9+ lid_des1+ lid_des4+ lid_des8+ lid_des10
"

mod_med_0b  <-"todo =~ naq1+ naq3+ naq14+ naq16+
naq18+ naq19+ naq21+ naq2+ naq4+ naq5+
naq6+ naq7+ naq10+ naq11+ naq12+ naq13+
naq15+ naq17+ naq20+ naq8+ naq9+ naq22+ lid_des3+ lid_des5+ lid_des7+ lid_des9+ lid_des1+ lid_des4+ lid_des8+ lid_des10
lid_cons =~ lid_des2+ lid_des6+ lid_des11+ lid_des12+ lid_des13+ lid_des14
"

mod_med_1a  <-"naq_R =~ naq1+ naq3+ naq14+ naq16+
naq18+ naq19+ naq21+ naq2+ naq4+ naq5+
naq6+ naq7+ naq10+ naq11+ naq12+ naq13+
naq15+ naq17+ naq20+ naq8+ naq9+ naq22
lid_des=~ lid_des2+ lid_des6+ lid_des11+ lid_des12+ lid_des13+ lid_des14+ lid_des3+ lid_des5+ lid_des7+ lid_des9+ lid_des1+ lid_des4+ lid_des8+ lid_des10
"

mod_med_1b  <-"naq_R =~ naq1+ naq3+ naq14+ naq16+
naq18+ naq19+ naq21+ naq2+ naq4+ naq5+
naq6+ naq7+ naq10+ naq11+ naq12+ naq13+
naq15+ naq17+ naq20+ naq8+ naq9+ naq22
LC =~ lid_des2+ lid_des6+ lid_des11+ lid_des12+ lid_des13+ lid_des14
LD =~ lid_des3+ lid_des5+ lid_des7+ lid_des9+ lid_des1+ lid_des4+ lid_des8+ lid_des10
"

mod_med_1b2  <-"naq_R =~ naq1+ naq3+ naq14+ naq16+
naq18+ naq19+ naq21+ naq2+ naq4+ naq5+
naq6+ naq7+ naq10+ naq11+ naq12+ naq13+
naq15+ naq17+ naq20+ naq8+ naq9+ naq22
LC =~ lid_des2+ lid_des6+ lid_des11+ lid_des12+ lid_des13+ lid_des14
LD =~ lid_des3+ lid_des5+ lid_des7+ lid_des9+ lid_des1+ lid_des4+ lid_des8+ lid_des10
LID_DES =~ 1*LC + 1*LD
LID_DES ~~ LID_DES
"

mod_med_1c  <-"naq_R =~ naq1+ naq3+ naq14+ naq16+
naq18+ naq19+ naq21+ naq2+ naq4+ naq5+
naq6+ naq7+ naq10+ naq11+ naq12+ naq13+
naq15+ naq17+ naq20+ naq8+ naq9+ naq22
LC =~ lid_des2+ lid_des6+ lid_des11+ lid_des12+ lid_des13+ lid_des14
LF =~ lid_des3+ lid_des5+ lid_des7+ lid_des9
LT =~ lid_des1+ lid_des4+ lid_des8+ lid_des10
"

mod_med_1c2  <-"naq_R =~ naq1+ naq3+ naq14+ naq16+
naq18+ naq19+ naq21+ naq2+ naq4+ naq5+
naq6+ naq7+ naq10+ naq11+ naq12+ naq13+
naq15+ naq17+ naq20+ naq8+ naq9+ naq22
LC =~ lid_des2+ lid_des6+ lid_des11+ lid_des12+ lid_des13+ lid_des14
LF =~ lid_des3+ lid_des5+ lid_des7+ lid_des9
LT =~ lid_des1+ lid_des4+ lid_des8+ lid_des10
LID_DES =~ 1*LT + 1*LF
LID_DES ~~ LID_DES
"

mod_med_2a  <-"RT =~ naq1+ naq3+naq14+naq16+naq18+naq19+naq21
AP =~ naq2+ naq4+ naq5+ naq6+ naq7+ naq10+ naq11+ naq12+ naq13+ naq15+ naq17+ naq20+ naq8+ naq9+ naq22
lid_des=~ lid_des2+ lid_des6+ lid_des11+ lid_des12+ lid_des13+ lid_des14+ lid_des3+ lid_des5+ lid_des7+ lid_des9+ lid_des1+ lid_des4+ lid_des8+ lid_des10
"

mod_med_2b  <-"RT =~ naq1+ naq3+naq14+naq16+naq18+naq19+naq21
AP =~ naq2+ naq4+ naq5+ naq6+ naq7+ naq10+ naq11+ naq12+ naq13+ naq15+ naq17+ naq20+ naq8+ naq9+ naq22
LC =~ lid_des2+ lid_des6+ lid_des11+ lid_des12+ lid_des13+ lid_des14
LD =~ lid_des3+ lid_des5+ lid_des7+ lid_des9+ lid_des1+ lid_des4+ lid_des8+ lid_des10
"

mod_med_2b2  <-"RT =~ naq1+ naq3+naq14+naq16+naq18+naq19+naq21
AP =~ naq2+ naq4+ naq5+ naq6+ naq7+ naq10+ naq11+ naq12+ naq13+ naq15+ naq17+ naq20+ naq8+ naq9+ naq22
LC =~ lid_des2+ lid_des6+ lid_des11+ lid_des12+ lid_des13+ lid_des14
LD =~ lid_des3+ lid_des5+ lid_des7+ lid_des9+ lid_des1+ lid_des4+ lid_des8+ lid_des10
LID_DES =~ 1*LC + 1*LD
LID_DES ~~ LID_DES
"

mod_med_2c  <-"RT =~ naq1+ naq3+naq14+naq16+naq18+naq19+naq21
AP =~ naq2+ naq4+ naq5+ naq6+ naq7+ naq10+ naq11+ naq12+ naq13+ naq15+ naq17+ naq20+ naq8+ naq9+ naq22
LC =~ lid_des2+ lid_des6+ lid_des11+ lid_des12+ lid_des13+ lid_des14
LF =~ lid_des3+ lid_des5+ lid_des7+ lid_des9
LT =~ lid_des1+ lid_des4+ lid_des8+ lid_des10
"

mod_med_2c2  <-"RT =~ naq1+ naq3+naq14+naq16+naq18+naq19+naq21
AP =~ naq2+ naq4+ naq5+ naq6+ naq7+ naq10+ naq11+ naq12+ naq13+ naq15+ naq17+ naq20+ naq8+ naq9+ naq22
LC =~ lid_des2+ lid_des6+ lid_des11+ lid_des12+ lid_des13+ lid_des14
LF =~ lid_des3+ lid_des5+ lid_des7+ lid_des9
LT =~ lid_des1+ lid_des4+ lid_des8+ lid_des10
LID_DES =~ 1*LT + 1*LF
LID_DES ~~ LID_DES
"

mod_med_3a  <-"RT =~ naq1 + naq3  +naq14 +naq16 +naq18 +naq19 +naq21
AP =~ naq2  +naq4  +naq5  +naq6  +naq7  +naq10+naq11 +naq12 +naq13 +naq15 +naq17 +naq20
AF =~ naq8  +naq9  +naq22
lid_des=~ lid_des2+ lid_des6+ lid_des11+ lid_des12+ lid_des13+ lid_des14+ lid_des3+ lid_des5+ lid_des7+ lid_des9+ lid_des1+ lid_des4+ lid_des8+ lid_des10
"

mod_med_3b  <-"RT =~ naq1 + naq3  +naq14 +naq16 +naq18 +naq19 +naq21
AP =~ naq2  +naq4  +naq5  +naq6  +naq7  +naq10+naq11 +naq12 +naq13 +naq15 +naq17 +naq20
AF =~ naq8  +naq9  +naq22
LC =~ lid_des2+ lid_des6+ lid_des11+ lid_des12+ lid_des13+ lid_des14
LD =~ lid_des3+ lid_des5+ lid_des7+ lid_des9+ lid_des1+ lid_des4+ lid_des8+ lid_des10
"

mod_med_3b2  <-"RT =~ naq1 + naq3  +naq14 +naq16 +naq18 +naq19 +naq21
AP =~ naq2  +naq4  +naq5  +naq6  +naq7  +naq10+naq11 +naq12 +naq13 +naq15 +naq17 +naq20
AF =~ naq8  +naq9  +naq22
LC =~ lid_des2+ lid_des6+ lid_des11+ lid_des12+ lid_des13+ lid_des14
LD =~ lid_des3+ lid_des5+ lid_des7+ lid_des9+ lid_des1+ lid_des4+ lid_des8+ lid_des10
LID_DES =~ 1*LC + 1*LD
LID_DES ~~ LID_DES
"

mod_med_3c  <-"RT =~ naq1 + naq3  +naq14 +naq16 +naq18 +naq19 +naq21
AP =~ naq2  +naq4  +naq5  +naq6  +naq7  +naq10+naq11 +naq12 +naq13 +naq15 +naq17 +naq20
AF =~ naq8  +naq9  +naq22
LC=~ lid_des2+ lid_des6+ lid_des11+ lid_des12+ lid_des13+ lid_des14
LF=~ lid_des3+ lid_des5+ lid_des7+ lid_des9
LT=~ lid_des1+ lid_des4+ lid_des8+ lid_des10
"

mod_med_3c2  <-"RT =~ naq1 + naq3  +naq14 +naq16 +naq18 +naq19 +naq21
AP =~ naq2  +naq4  +naq5  +naq6  +naq7  +naq10+naq11 +naq12 +naq13 +naq15 +naq17 +naq20
AF =~ naq8  +naq9  +naq22
LC=~ lid_des2+ lid_des6+ lid_des11+ lid_des12+ lid_des13+ lid_des14
LF=~ lid_des3+ lid_des5+ lid_des7+ lid_des9
LT=~ lid_des1+ lid_des4+ lid_des8+ lid_des10
LID_DES =~ 1*LF + 1*LT
LID_DES ~~ LID_DES
"


invisible("The weight matrix itself is the same for WLSMV, WLSM, and WLS. It is how it is used that differs. For paramter estimates, WLS uses the entire weight matrix, while WLSMV and WLS use only the diagonal of the weight matrix. For standard errors and tests of fit, WLS, WLSM, and WLS use the entire weight matrix, but they use it is different ways.(Muthen, DuToit, and Spisic)")

invisible("WLSMV es: estimator = ´DWLS´
se = ´robust.sem´
test = ´scaled.shifted´")

#todo
mod_med_fa_naq1_lid_des0 <- lavaan::cfa(mod_med_0, data = BD_2020_input, ordered=c(NAQ_R2,LID_DES), estimator= "WLS", warn = T, std.lv=T)
#todo vs. LC
mod_med_fa_naq1_lid_des0b <- lavaan::cfa(mod_med_0b, data = BD_2020_input, ordered=c(NAQ_R2,LID_DES), estimator= "WLS", warn = T, std.lv=T)
#NAQ vs. LID-DES amplio
mod_med_fa_naq1_lid_des1 <- lavaan::cfa(mod_med_1a, data = BD_2020_input, ordered=c(NAQ_R2,LID_DES), estimator= "WLS", warn = T, std.lv=T)
#NAQ vs. LC + LD
mod_med_fa_naq1_lid_des2 <- lavaan::cfa(mod_med_1b, data = BD_2020_input, ordered=c(NAQ_R2,LID_DES), estimator= "WLS", warn = T, std.lv=T)
#NAQ vs. 2do orden LID DES (LC+ LD) amplio
mod_med_fa_naq1_lid_des22 <- lavaan::cfa(mod_med_1b2, data = BD_2020_input, ordered=c(NAQ_R2,LID_DES), estimator= "WLS", warn = T, std.lv=T)
#NAQ vs. LC+ LF´LT
mod_med_fa_naq1_lid_des3 <- lavaan::cfa(mod_med_1c, data = BD_2020_input, ordered=c(NAQ_R2,LID_DES), estimator= "WLS", warn = T, std.lv=T)

#NAQ 2do orden LID DES (LT+ LF)
mod_med_fa_naq1_lid_des32 <- lavaan::cfa(mod_med_1c2, data = BD_2020_input, ordered=c(NAQ_R2,LID_DES), estimator= "WLS", warn = T, std.lv=T)
#RT+ AP vs. LID DES amplio
mod_med_fa_naq2_lid_des1 <- lavaan::cfa(mod_med_2a, data = BD_2020_input, ordered=c(NAQ_R2,LID_DES), estimator= "WLS", warn = T, std.lv=T)
#RT+ AP vs. LC+ LD
mod_med_fa_naq2_lid_des2 <- lavaan::cfa(mod_med_2b, data = BD_2020_input, ordered=c(NAQ_R2,LID_DES), estimator= "WLS", warn = T, std.lv=T)
#RT+ AP vs. LID DES 2do orden (LC+ LD) amplio
mod_med_fa_naq2_lid_des22 <- lavaan::cfa(mod_med_2b2, data = BD_2020_input, ordered=c(NAQ_R2,LID_DES), estimator= "WLS", warn = T, std.lv=T)

#RT+ AP vs. LC+ LF+ LT
mod_med_fa_naq2_lid_des3 <- lavaan::cfa(mod_med_2c, data = BD_2020_input, ordered=c(NAQ_R2,LID_DES), estimator= "WLS", warn = T, std.lv=T)

#RT+ AP vs. 2do orden LID DES (LC+ LD) amplio
mod_med_fa_naq2_lid_des32 <- lavaan::cfa(mod_med_2c2, data = BD_2020_input, ordered=c(NAQ_R2,LID_DES), estimator= "WLS", warn = T, std.lv=T)

#RT+ AP+ AF vs. LID DES amplio
mod_med_fa_naq3_lid_des1 <- lavaan::cfa(mod_med_3a, data = BD_2020_input, ordered=c(NAQ_R2,LID_DES), estimator= "WLS", warn = T, std.lv=T)
#RT+ AP+ AF vs. LC+ LD
mod_med_fa_naq3_lid_des2 <- lavaan::cfa(mod_med_3b, data = BD_2020_input, ordered=c(NAQ_R2,LID_DES), estimator= "WLS", warn = T, std.lv=T)
#RT+ AP+ AF vs. LID DES 2do orden (LC+ LD) amplio
mod_med_fa_naq3_lid_des22 <- lavaan::cfa(mod_med_3b2, data = BD_2020_input, ordered=c(NAQ_R2,LID_DES), estimator= "WLS", warn = T, std.lv=T)
#RT+ AP+ AF vs. LC+ LF+ LT
mod_med_fa_naq3_lid_des3 <- lavaan::cfa(mod_med_3c, data = BD_2020_input, ordered=c(NAQ_R2,LID_DES), estimator= "WLS", warn = T, std.lv=T)

#RT+ AP+ AF vs. 2do orden LID DES (LT+ LF)
mod_med_fa_naq3_lid_des32 <- lavaan::cfa(mod_med_3c2, data = BD_2020_input, ordered=c(NAQ_R2,LID_DES), estimator= "WLS", warn = T, std.lv=T)

#unloadNamespace("lavaan")
#devtools::unload("lavaan")
invisible("Las de segundo orden fueron los únicos que no convergieron")
```

</div>

```{r paso1_comp_tab_modelos_res,eval=T, echo=T, paged.print=TRUE, eval=T}
invisible("https://stats.idre.ucla.edu/r/seminars/rcfa/.  non-centrality parameter which measures the degree of misspecification. cutoff criteria as defined in Kline (2016, p.274-275)= <= .05 close-fit, .05 .08) reasonable approximate fit, fails close-fit but also fails poor-fit, >=.10 poor-fit")

if(no_mostrar==0){
  invisible("variance-covariance not positive definite!, model is not identified?")
#Correlation of 0.99 sounds like the problem.  That typically happens when you have omitted a correlated error somewhere. 
#Ah, the large MIs might explain it.
#You have global fit, but local misfit and you should probably try to address that.
#I came to know that two variables have cross-loadings with other factors, after dropping those variables, the problem was solved.

#Check the determinant (which is negative) or eigenvalues (the last is negative).
  det(lavInspect(naq_fa_naq3_lid_des32, "cov.lv"))
  
  #SRMR≤0.08.
  fitMeasures(naq_fa_naq3_lid_des32, c("srmr"))
  
  #Range should be 0≤RMSEA≤0.10
  #This study used CFI≥0.95 for 'an acceptable fit'
  # Hu and Bentler recommend TLI≥0.95. This study used TFI≥0.95
   #Threshold for acceptable model fit is SRMR≤0.08.
  #Threshold for assessing WRMR should be <1.0.This index is used only for confirmatory factor analysis. It has been assessed
  #to be most suitable in assessing models from non-normal data suited for models whose variables measured on different scales
  
  #https://www.researchgate.net/post/Whats-the-standard-of-fit-indices-in-SEM
  #CFI, CFI and TLI >=0.95 (Kline, 2005)
  #AVE > 0.5
  
  #SRMR should be lower than the threshold of 0.08 suggested by Hu and Bentler (1999) and the 0.10 by Ringle (2016).
  #In case of large sample with >7 latent variables with or without complexity it's extremely difficult to get the standard p value or RMSEA. You have to trade off.

  #Up until the early nineties, an RMSEA in the range of 0.05 to 0.10 was considered an indication of fair fit and values above 0.10 indicated poor fit (MacCallum et al, 1996).

  
}
  dat_tab_afc<-
data.table(data.frame(rbind(ajusteAFC(mod_med_fa_naq1_lid_des0),ajusteAFC(mod_med_fa_naq1_lid_des0b),
                            ajusteAFC(mod_med_fa_naq1_lid_des1),ajusteAFC(mod_med_fa_naq1_lid_des2),
                            ajusteAFC(mod_med_fa_naq1_lid_des22),
                            ajusteAFC(mod_med_fa_naq1_lid_des3),
                            ajusteAFC(mod_med_fa_naq1_lid_des32),
                            ajusteAFC(mod_med_fa_naq2_lid_des1),ajusteAFC(mod_med_fa_naq2_lid_des2),
                            ajusteAFC(mod_med_fa_naq2_lid_des22),
                            ajusteAFC(mod_med_fa_naq2_lid_des3),
                            ajusteAFC(mod_med_fa_naq2_lid_des32),
                            ajusteAFC(mod_med_fa_naq3_lid_des1),ajusteAFC(mod_med_fa_naq3_lid_des2),
                            ajusteAFC(mod_med_fa_naq3_lid_des22),
                            ajusteAFC(mod_med_fa_naq3_lid_des3),
                            ajusteAFC(mod_med_fa_naq3_lid_des32)
                            )),keep.rownames = T)%>%
  dplyr::mutate(rn=c("Único factor",
                     "2 Factores: NAQ y DL vs. Lid Constructivos",
                     "NAQ-R (1 Factor) & DLS (1 Factor)",
                     "NAQ-R (1 Factor) & DLS (2 Factores)",
                     "NAQ-R (1 Factor) & DLS (2 Factores) (2do orden, LID DES [LC+ LD])",                     
                     "NAQ-R (1 Factor) & DLS (3 Factores)",
                     "NAQ-R (1 Factor) & DLS (3 Factores) (2do orden, LID DES [LT+ LF])",
                     "NAQ-R (2 Factores) & DLS (1 Factor)",    
                     "NAQ-R (2 Factores) & DLS (2 Factores)",
                     "NAQ-R (2 Factores) & DLS (2 Factores) (2do orden, LID DES [LC+ LD])",                     
                     "NAQ-R (2 Factores) & DLS (3 Factores)",
                     "NAQ-R (2 Factores) & DLS (3 Factores) (2do orden, LID DES [LT+ LF])",                     
                     "NAQ-R (3 Factores) & DLS (1 Factor)",
                     "NAQ-R (3 Factores) & DLS (2 Factores)",
                     "NAQ-R (3 Factores) & DLS (2 Factores) (2do orden, LID DES [LC+ LD])",
                     "NAQ-R (3 Factores) & DLS (3 Factores)",
                     "NAQ-R (3 Factores) & DLS (3 Factores) (2do orden, LID DES [LT+ LF])"
                     ))%>%
  dplyr::arrange(desc(CFI),desc(gl)) 
  
  dat_tab_afc %>% 
  #dplyr::select(-Modelo)%>%
  knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Tabla S16. Comparativo Índices de Ajuste de Modelos Propuestos"),
               align =c('l',rep('c', 101)),
               col.names = c("Modelo","Término","gl","WLS $\\chi^2$","CMIN/gl","aGFI","GFI", "RMSEA\n[IC 90%]","CFit","CFI","NNFI"),
               escape=T) %>%
      #kableExtra::row_spec(1:5,bold= T, color= "black", background= "white")%>%
      kableExtra::add_footnote(c("Nota. Ordenados de mayor a menor CFI y grados de libertad"), notation = "none")%>%
  kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 11)


invisible("– WLS (classical WLS, full weight matrix, classic standard errors and test statistic) – WLSM (DWLS + robust standard errors + mean-adjusted test statistic)")
```

<br>

Para explorar la estructura factorial de las pruebas, se seleccionó los modelos que asumen 3 factores para ambas escalas (`mod_med_fa_naq3_lid_des3`). Posteriormente, comparamos los modelos en función del chi-cuadrado obtenido.

<br>

<div style="border: 1px solid #ddd; padding: 5px; overflow-y: scroll; height:350px; overflow-x: scroll; width:100%">
```{r afc_paso1_std_summ,eval=T, echo=T, paged.print=TRUE, eval=T}
summary(mod_med_fa_naq3_lid_des3, standardized=T)
```
</div>

<br>

```{r paso2_comparativo_anova_modelos,eval=T, echo=T, paged.print=TRUE, eval=T}
invisible("Compared to D1 and D3, D2 is a notoriously poor pooling method (sometimes resulting in higher or lower Type I errors than nominal alpha levels, depending on the data), so that might explain why CFI looks weird when calculated from D2 statistics.")

invisible("Thanks for clarifying what I meant by 'depending on the data.' Admittedly, my advice is based on only a couple studies comparing (some of) these statistics.  Namely, the original source for D2 (Li, Meng, Raghunathan, & Rubin, 1991) only advised using it as a screening statistic, not to rely on it for inference.  But in a more recent study (to which I assume you are referring, as you are a coauthor), Grund et al. (2016) found that D2 did perform well with moderate-to-large N and low FMI, at least in the context of pooling ANOVA results (i.e., testing mean structure), which are models that do not require large samples anyway.")

if(no_mostrar==0){
dput(dat_tab_afc$Modelo)
}

anova_lavaan1<-
lavaan::anova(mod_med_fa_naq3_lid_des3,
mod_med_fa_naq2_lid_des3,
mod_med_fa_naq1_lid_des3,
mod_med_fa_naq3_lid_des1,
mod_med_fa_naq1_lid_des1,
mod_med_fa_naq2_lid_des1,
mod_med_fa_naq1_lid_des0,
mod_med_fa_naq3_lid_des2,
mod_med_fa_naq1_lid_des2,
mod_med_fa_naq2_lid_des2,
mod_med_fa_naq2_lid_des32,
mod_med_fa_naq3_lid_des32,
mod_med_fa_naq1_lid_des32,
mod_med_fa_naq1_lid_des0b,
mod_med_fa_naq3_lid_des22,
mod_med_fa_naq2_lid_des22,
mod_med_fa_naq1_lid_des22
)%>%
  data.frame()%>%
  # dplyr::mutate(mod=c("NAQ-R (1 Factor) & DLS (1 Factor)",
  #                    "NAQ-R (1 Factor) & DLS (2 Factores)",
  #                    "NAQ-R (1 Factor) & DLS (3 Factores)",
  #                    "NAQ-R (2 Factores) & DLS (1 Factor)",
  #                    "NAQ-R (2 Factores) & DLS (2 Factores)",
  #                    "NAQ-R (2 Factores) & DLS (3 Factores)",
  #                    "NAQ-R (3 Factores) & DLS (1 Factor)",
  #                    "NAQ-R (3 Factores) & DLS (2 Factores)",
  #                    "NAQ-R (3 Factores) & DLS (3 Factores)"))%>%
  #dplyr::select(mod, everything())%>%#Df	AIC	BIC	Chisq	Chisq diff	Df diff	Pr(>Chisq)
  dplyr::select(-AIC,	-BIC)%>%
    dplyr::mutate(Chisq.diff=dplyr::case_when(Pr..Chisq.<.001~paste0(sprintf("%4.2f",Chisq.diff),"***"),
                    Pr..Chisq.<.01~paste0(sprintf("%4.2f",Chisq.diff),"**"),
                    Pr..Chisq.<.05~paste0(sprintf("%4.2f",Chisq.diff),"*"),
                    TRUE~paste0(sprintf("%4.2f",Chisq.diff))))


(first_comp<-
compareFit(mod_med_fa_naq3_lid_des3,
mod_med_fa_naq2_lid_des3,
mod_med_fa_naq1_lid_des3,
mod_med_fa_naq3_lid_des1,
mod_med_fa_naq1_lid_des1,
mod_med_fa_naq2_lid_des1,
mod_med_fa_naq1_lid_des0,
mod_med_fa_naq3_lid_des2,
mod_med_fa_naq1_lid_des2,
mod_med_fa_naq2_lid_des2,
mod_med_fa_naq2_lid_des32,
mod_med_fa_naq3_lid_des32,
mod_med_fa_naq1_lid_des32,
mod_med_fa_naq1_lid_des0b,
mod_med_fa_naq3_lid_des22,
mod_med_fa_naq2_lid_des22,
mod_med_fa_naq1_lid_des22, nested = FALSE, moreIndices=T))

data.table(first_comp@fit.diff,keep.rownames = T)[,c("rn", "npar", "df", "agfi", "gfi", "rmsea", "rmsea.ci.lower", "rmsea.ci.upper", "cfi")] %>% 
    dplyr::mutate_if(is.numeric, funs(round(.,3))) %>% 
  knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Tabla S17. Comparativo Índices de Ajuste, Diferencias Chi-Cuadrado entre Modelos Anidados"),
               col.names= c("Comparación","$\\Delta$ Parámetros","$\\Delta$ gl","$\\Delta$ aGFI","$\\Delta$ GFI", "$\\Delta$ RMSEA","$\\Delta$ RMSEA lo","$\\Delta$ RMSEA up","$\\Delta$ CFI"),
               align =c('l',rep('c', 101)),
               #col.names = c("Parámetros","gl","Chi Cuadrado","Diff. Chi Cuadrado", "Diferencias en gl","Valores p (Diferencias)"),
               escape=T)%>%
    kableExtra::row_spec(which(grepl("mod_med_fa_naq1_lid_des2",row.names(first_comp@fit.diff))), bold=T) %>% 
  kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 10)
```

<br>

### MM1-Modelo seleccionado

<br>

A continuación, se muestra el detalle del modelo de 3 factores para cada escala.

<br>

```{r afc_std_load_phi, echo = T, eval = T}
cols_labels<-
  data.frame(V1=c(paste0("naq",1:22),paste0("lid_des",1:14)),
             label=c(  
"1. Alguien le ha ocultado información que ha afectado a su rendimiento. [1. Someone withholding information which affects your performance ]",
"2. Ha sido humillado o ridiculizado en relación a su trabajo. [2. Being humiliated or ridiculed in connection with your work]",
"3. Le han ordenado realizar un trabajo que está por debajo de su nivel de competencia o calificación. [3. Being ordered to do work below your level of competence]",
"4. Le han cambiado de realizar tareas de responsabilidad por otras más triviales o desagradables. [4. Having key areas of responsibility removed or replaced with more trivial or unpleasant tasks]",
"5. Se han extendido rumores sobre usted. [5. Spreading of gossip and rumors about you]",
"6. Ha sido ignorado, excluido o le han dejado de hablar. [6. Being ignored or excluded]",
"7. Le han insultado u ofendido con comentarios sobre usted, sus actitudes o su vida privada. [7. Having insulting or offensive remarks made about your person]",
"8. Le han gritado o ha sido objeto de enfados espontáneos. [8. Being shouted at or being the target of spontaneous anger]",
"9. Ha sufrido conductas intimidatorias como ser apuntado con el dedo, la invasión de su espacio personal, empujones, que no le dejen pasar, etc. [9. Intimidating behavior such as finger-pointing, invasion of personal space, shoving, blocking/barring the way]",
"10. Ha visto detalles o indirectas de otros que le sugieran abandonar su trabajo. [10. Hints or signals from others that you should quit your job]",
"11. Le han recordado continuamente sus errores y fallos. [11. Repeated reminders of your errors or mistakes]",
"12. Ha sido ignorado o ha recibido una reacción hostil cuando se ha acercado a alguien. [12. Being ignored or facing a hostile reaction when you approach]",
"13. Ha recibido críticas persistentes sobre su trabajo y esfuerzo [13. Persistent criticism of your work and effort]",
"14. Sus opiniones y puntos de vista han sido ignorados. [14. Having your opinions and views ignored ]",
"15. Ha recibido bromas pesadas de gente con la que no se lleva bien. [15. Practical jokes carried out by people you do not get on with]",
"16. Le han asignado tareas u objetivos inalcanzables. [16. Being given tasks with unreasonable or impossible targets or deadlines]",
"17. Ha recibido acusaciones (reclamos) en su contra. [17. Having allegations made against you]",
"18. Ha sido excesivamente supervisado en su trabajo. [18. Excessive monitoring of your work]",
"19. Ha sido presionado para no reclamar algo a lo que tiene derecho (p. Ej., licencia por enfermedad, vacaciones, viáticos, etc.) [19. Pressure not to claim something which by right you are entitled to]",
"20. Ha sido objeto de numerosas tomaduras de pelo y sarcasmos. [20. Being the subject of excessive teasing and sarcasm]",
"21. Ha sido expuesto a una excesiva carga de trabajo. [21. Being exposed to an unmanageable workload]",
"22. Ha recibido amenazas de violencia o de abusos físicos. [22. Threats of violence or physical abuse or actual abuse]",
"1. ¿Lo ha humillado a usted o a otros empleados/as, si no alcanzan los estándares esperados? [1. Has humiliated you, or other employees, if you/they fail to live up to his/her standards? ]",
"2. ¿Ha incentivado las ideas o propuestas creativas o innovadoras? [2. Encourages innovative thinking? ]",
"3. ¿No ha mostrado preocupación por los resultados? [3. Has steered away from showing concern about results? ]",
"4. ¿Ha hecho gestos (por ejemplo, muecas, miradas, ademanes) a usted o a otros empleados para demostrar que no está satisfecho con su esfuerzo o el de los demás? [4. Has imitated, or made faces (e.g. rolled eyes, stuck out tongue etc.) at you or other employees to show that he/she is not satisfied with your/other’s work efforts? ]",
"5. ¿Ha evitado tomar decisiones? [5. Has avoided making decisions? ]",
"6. El supervisor/la supervisora ¿reconoce el buen desempeño? [6. Gives recognition for good performance? ]",
"7. ¿Ha evitado involucrarse en su trabajo? [7. Has avoided getting involved in your work? ]",
"8. ¿Ha difundido información incorrecta sobre usted o sus compañeros/as de trabajo, con el fin de dañar su posición o la de ellos en la empresa? [8. Has spread incorrect information about you or your co-workers, in order to harm your/their position in the firm? ]",
"9. ¿Ha estado ausente cuando se le/a necesita? [9. Is likely to be absent when needed? ]",
"10. ¿Le ha retado por teléfono, le colgó (cortó), o enviado un correo grosero porque pensó que había hecho un mal trabajo? [10. Has given you a dressing down on the phone, hung up on you or sent you a crass email because he/she thought you had done a bad job? ]",
"11. ¿Busca la manera de desarrollar sus capacidades? [11. Is a driving force for development? ]",
"12. ¿Establece objetivos claros e inequívocos? [12. Sets clear and unambiguous objectives? ]",
"13. ¿Define y explica claramente las tareas que le asigna a usted y a sus compañeros de trabajo?  [13. Defines and clearly explains work assignments to you and your co-workers? ]",
"14. ¿Es flexible y está dispuesto/a a pensar de manera innovadora? [14. Is flexible and willing to think innovatively? ]"))

#Cargas factoriales.
afc_lambda_std_primer_mod<-
    data.table::data.table(lavaan::lavInspect(mod_med_fa_naq3_lid_des3, what = "std", add.labels = TRUE)$`lambda`,keep.rownames = T) %>% 
    dplyr::left_join(cols_labels, by=c("rn"="V1")) %>% 
    dplyr::select(label,everything()) %>% 
    dplyr::mutate(across(where(is.numeric), ~ round(.x, 2))) %>% 
    dplyr::mutate(across(where(is.numeric), ~ ifelse(.x==0,NA,.x)))

for (i in 1:nrow(afc_lambda_std_primer_mod)){
    afc_lambda_std_primer_mod$label[i]<-stringr::str_wrap(afc_lambda_std_primer_mod$label[i], width = 40, indent = 0, exdent = 0)
}

#R cuadrado var latentes
afc_psi_std_primer_mod<-
    cbind.data.frame(label=c("Acoso Rel. con el Trabajo", "Acoso Psicológico", "Acoso Físico", "Liderazgo Constructivo", "Lid. Laissez-Faire", "Liderazgo Autoritario"),
                     data.table::data.table(lavaan::lavInspect(mod_med_fa_naq3_lid_des3, what = "std", add.labels = TRUE)$psi,keep.rownames = T)) %>% 
    dplyr::mutate(across(where(is.numeric), ~ round(.x, 2))) %>% 
    dplyr::mutate(across(where(is.numeric), ~ ifelse(.x==1,NA,.x))) 


rbind.data.frame(afc_lambda_std_primer_mod,
                 afc_psi_std_primer_mod) %>% 
    knitr::kable(format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
                 caption = paste0("Tabla S18. Cargas Factoriales y Covarianzas Variables Latentes"),
                 align =c('l',rep('c', 101)),
                 col.names = c("Ítem","Código", "RT", "AP", "AF", "LC", "LF", "LT"),
                 escape=T)%>%
    kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 12) %>%
    kableExtra::pack_rows("Variables manifiestas", 1, nrow(afc_lambda_std_primer_mod)) %>%
    kableExtra::pack_rows("Variables latentes", nrow(afc_lambda_std_primer_mod)+1, nrow(afc_lambda_std_primer_mod)+nrow(afc_psi_std_primer_mod)) %>%
    kableExtra::add_footnote(c("Nota. RT= Relacionado con el Trabajo; AP= Acoso Psicológico; AF=Acoso Físico; LC= Liderazgo Constructivo; LF= Liderazgo Laissez-Faire; LT= Liderazgo Autoritario"),
                             notation = "none")%>%
    kableExtra::scroll_box(width = "100%", height = "375px")
#A factor with 2 variables is only considered reliable when the variables are highly correlated with each another (r > .70) but fairly uncorrelated with other variables. Yong, A. G., & Pearce, S. (2013, p. 80).
```

<br>

A continuación se presenta una Figura con la solución seleccionada.

<br>

```{r fig1_paso1_fa, echo=T, fig.align='center', fig.pos='H', fig.width=19, fig.cap= "Figura S8. Cargas factoriales estandarizadas y comunalidades para NAQ-R y DLS", message=FALSE, error=T, fig.retina=2}

#labels1 <- list(mpg = "Miles Per Gallon", cyl = "Cylinders", disp = "Displacement", hp = "Horsepower", qsec = "Speed", wt = "Weight") #define labels
lavaanPlot::lavaanPlot(model = mod_med_fa_naq3_lid_des3, coefs = TRUE, stand = TRUE, sig = 0.05) #standardized regression paths, showing only paths with p<= .05
```
<br>

Se utilizó el criterio HTMT (razón heterorazgo-monorrazgo) de las correlaciones, para explorar la validez discriminante de cada variable latente [@Henseler2015].

<br>

```{r afc_paso1_htmt, echo = T, eval = T}
# https://rdrr.io/cran/semTools/man/htmt.html

semTools::htmt(mod_med_3c, BD_2020_input[,c(NAQ_R2,LID_DES)], sample.cov = NULL, missing = 'pairwise', ordered = c(NAQ_R2,LID_DES), absolute = T)%>% 
  as.data.table(keep.rownames = T) %>% 
  dplyr::mutate(across(where(is.numeric), ~ round(.x, 2))) %>% 
  knitr::kable(format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Tabla S19. Validez Discriminante"),
               align =c('l',rep('c', 101)),
               #col.names = c("Var. Latentes","Agotamiento y Estrés", "Sueño", "Estrés Postraumático", "Sint. Ansiosa", "Sint. Depresiva")
               escape=T)%>%
    kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 12) %>%
  kableExtra::add_footnote(c("Nota. Valores <.90, umbral en favor de validez discriminante; RT= Relacionado con el Trabajo; AP= Acoso Psicológico; AF= Acoso Físico; LC= Liderazgo Constructivo; LF= Liderazgo Laissez-Faire; LT= Liderazgo Autoritario"),
                            notation = "none")%>%
  kableExtra::scroll_box(width = "100%", height = "375px")

#  Technically, the HTMT provides two advantages over the disattenuated construct score correlation: The HTMT does not require a factor analysis to obtain factor loadings, nor does it require the calculation of construct scores. This allows for determining the HTMT even if the raw data is not available, but the correlation matrix is. Furthermore, HTMT builds on the available measures and data and—contrary to the standard MTMM approach—does not require simultaneous surveying of the same theoretical concept with alternative measurement approaches. Therefore, this approach does not suffer from the standard MTMM approach’s well-known issues regarding data requirements and parallel measures (Schmitt 1978; Schmitt and Stults 1986).
# We suggest assessing the heterotrait-monotrait ratio (HTMT) of the correlations, which is the average of the heterotrait-heteromethod correlations (i.e., the correlations of indicators across constructs measuring different phenomena), relative to the average of the monotrait-heteromethod correlations 

#Use the HTMT criterion to assess discriminant validity! If the HTMT value is below 0.90, discriminant validity has been established between two reflective constructs. 

 #Some authors suggest a threshold of 0.85 (Kline 2011), whereas others propose a value of 0.90 (Teo et al. 2008).

```

<br>

A partir de la tabla anterior, se observan índices menores a .85 en algunos casos, pero todos menores al umbral obligatorio de .90 **salvo los componentes del NAQ**, lo cual permite aportar evidencia a favor de variables latentes que se distinguen entre ellas a excepción del NAQ-R. 

<br>

```{r afc_paso1_disc_val, eval=T, echo=T, warning=FALSE}
#Calculate discriminant validity statistics based on a fitted lavaan object

#For the exploration, discriminant validity was examined with an R function, discriminantValidity, implemented in semToolspackage (Jorgensen et al., 2021). Discriminant validity was examined whether the two constructs, overall compliance and compliance with distancing measures, were distinguishable from each other. If a significant outcome results from 25χ2test, then discriminant validity between the tested constructs is supported, so the constructs are deemed to be distinct from each other (Jorgensen et al., 2021; Rönkkö & Cho, 2020). On the other hand, a non-significant outcome suggests that discriminant validity could not be supported, so it is impossible to distinguish the two constructs.The result of χ2test indicated that discriminant validity was supported, χ2(1) = 968.82, p< .001. Thus, although the two tested constructs, overall compliance and compliance with distancing measure, were significantly correlated with each other, they shall be treated as two distinguishable and independent constructs. It may suggest that the two items assess two unique and distinct constructs, so they could not be collapsed into one.

semTools::discriminantValidity(mod_med_fa_naq3_lid_des3, cutoff = 0.9, merge = F, level = 0.95) %>% 
    as.data.table(keep.rownames = T) %>% 
  dplyr::mutate(across(where(is.numeric), ~ round(.x, 2))) %>% 
  knitr::kable(format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Tabla S20. Validez Discriminante (2)"),
               align =c('l',rep('c', 101)),
               #col.names = c("Var. Latentes","Agotamiento y Estrés", "Sueño", "Estrés Postraumático", "Sint. Ansiosa", "Sint. Depresiva")
               escape=T)%>%
    kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 12) %>%
  kableExtra::add_footnote(c("Nota. RT= Relacionado con el Trabajo; AP= Acoso Psicológico; AF= Acoso Físico; LC= Liderazgo Constructivo; LF= Liderazgo Laissez-Faire; LT= Liderazgo Autoritario"),
                            notation = "none")%>%
  kableExtra::scroll_box(width = "100%", height = "375px")
```

<br>

La medida de validez discriminante sugiere que los constructos Acoso Relacionado con el Trabajo y Acoso Psicológico no debiesen ser distitnos uno de otro, y por tanto, no debiesen distinguirse y tratarse como constructos independientes [@Ronkko2020].

<br>

```{r afc_paso1_rel, echo=T, cache= T, paged.print=TRUE, warning=F, error=T}
#https://rdrr.io/cran/semTools/man/reliability.html

#Because reliability() can only handle one factor, it ignores the upper variables (the 'higher-order factor') of your model.

#average variance extracted (AVE)
#reliabilityL2(fit, "EMT")

#Average Variance Extracted: A measure to assess convergent validity.

#As a rule of thumb and for adequate convergent, an AVE of at least 0.50 is highly recommended. That been said, an AVE less than 0.50 means your items explain more errors than the variance in your constructs. For any measurement model, an AVE must be calculated for each construct and must be at least 0.50.

#values above 0.7 are considered very good, whereas, the level of 0.5 is acceptable.

data.frame(round(semTools::reliability(mod_med_fa_naq3_lid_des3, c("alpha.ord","omega","ave"),return.total=T),2)) %>% 
  dplyr::mutate(name=c("Alfa ordinal", "omega","Varianza Media Extraída/ Average variance extracted")) %>% 
  dplyr::select(name,everything()) %>% 
  knitr::kable(format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Tabla S21. Confiabilidad"),
               escape=T)%>%
    kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 12) %>%
    kableExtra::add_footnote(c("Nota. AVE >0.5, eivdencia de validez convergente; Alfa >=.7; RT= Relacionado con el Trabajo; AP= Acoso Personal; AF= Acoso Físico; LC= Liderazgo Constructivo; LF= Liderazgo Laissez-Faire; LT= Liderazgo Autoritario"),
                            notation = "none")%>%
    kableExtra::scroll_box(width = "100%", height = "375px")

#"Note that this formula is modified from Fornell & Larcker (1981)  in the case that factor variances are not 1."

#Measure of the amount of variance that is captured by a construct in relation to the amount of variance due to measurement error. 

#reliabilityL2() should be used to calculate composite reliability of a higher-order factor.

#You should note that there is very little evidence that the AVE comparison detects discriminant validity problems.

```

<br>

Para dar mayor evidencia de consistencia interna a priori, utilizamos el $\beta$ de Revelle, que es indicador de la peor confiabilidad partida en correlaciones policóricas entre las respuestas ordinales [@Revelle2005].

<br>

```{r afc_paso1_rel2, echo=T, cache= T, paged.print=TRUE, warning=F, error=T}
#Revelle’s β is more conservative than other measures of internal consistency and provides a minimum estimate of the saturation of a
#scale’s items on a common, i.e. general, factor (Zinbarg et al., 2005). To interpret the sum of items on a scale as adequately representing a unitary construct a common rule has been β > 0.5 (Revelle, 1979).    
df_splithalf<-
data.frame(
rbind(
c(Variable="NAQ total",Revelle_B=round(splitHalf(BD_2020_input_num[paste0("naq",1:22)],check.keys=T)$minrb,2)),
c("Acoso Psicológico",round(splitHalf(BD_2020_input_num[paste0("naq",c(2,4,5,6,7,10,11,12,13,15,17,20))],check.keys=T)$minrb,2)),
c("Acoso Rel. Trabajo",round(splitHalf(BD_2020_input_num[paste0("naq",c(1,3,14,16,18,19,21))],check.keys=T)$minrb,2)),
c("Acoso Físico",round(splitHalf(BD_2020_input_num[paste0("naq",c(8,9,22))],check.keys=T)$minrb,2)),
c("Lid. Constructivo",round(splitHalf(BD_2020_input_num[paste0("lid_des",c(6,11,12,14))],check.keys=T)$minrb,2)),
c("Lid. Autoritario",round(splitHalf(BD_2020_input_num[paste0("lid_des",c(1,4,8,10))],check.keys=T)$minrb,2)),
c("Laissez-Faire",round(splitHalf(BD_2020_input_num[paste0("lid_des",c(3,5,7,9))],check.keys=T)$minrb,2)),
c("Lid. Destructivos",round(splitHalf(BD_2020_input_num[paste0("lid_des",c(3,5,7,9,1,4,8,10))],check.keys=T)$minrb,2)),
c("Distrés Psicológico (K6)",round(splitHalf(BD_2020_input_num[paste0("a47_top_",1:6)] %>% 
              dplyr::mutate_all(~as.numeric(.)),check.keys=T)$minrb,2))
  )
)

df_splithalf %>% 
  knitr::kable(format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Tabla S22. Confiabilidad"),
               col.names = c("Variable", "Revelle's β "),
               escape=T)%>%
    kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 12) %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
```

<br>

El liderazgo laissez-faire muestra problemas con el punto de corte establecido >.5.

<br>

```{r paso1_mi_res,eval=T, echo=T, paged.print=TRUE, eval=T}
cor_table <- residuals(mod_med_fa_naq3_lid_des3, type = "standardized")$cov

cor_table[lower.tri(cor_table)] <- NA # erase the upper triangle
diag(cor_table) <- NA # erase the diagonal 0's

 knitr::kable(cor_table,digits=2,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Tabla S23. Matriz de Residuos Estandarizados, Modelo Inicial"),
               align =c('l',rep('c', 101)))%>%
         kableExtra::column_spec(match("lid_des3",attr(cor_table,"dimnames")[[2]])+1,bold= T, color= "black", background= "white")%>%
kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 10) %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
# covarianzas estandarizadas residuales de los ítems, las cuales, según Fernández Aráuz (2015), pueden ser entendidas como “el número de desviaciones estándar por el cual los residuos ajustados difieren de los residuos de valor cero que estarían asociados con un modelo de ajuste perfecto” (p. 58) y, por tanto, pueden generar que se subestime o sobreestime la relación entre los indicadores. Al revisar estos valores, se encontraron valores altos (> 2,56) 
 #standardized residual covariance, +-2.58. greater or lower than that then delete it.
```

<br>

Atendiendo a la inquietud presentada en la revisión del formato de los ítemes, se presentan los índices de modificación, sin haber eliminado ítems. Se examinaron aquellos parámetros de modificación que presentaran un índice de modifcación (MI) mayor a 5 y cambios esperados del parámetro (Expected Parameter Change o SEPC) mayores a 0,2 [@Whittaker2012].

<br>

```{r afc_paso1_mi,eval=T, echo=T, paged.print=TRUE, eval=T}
modelo_inicial<-
  subset(lavaan::modindices(mod_med_fa_naq3_lid_des3)[order(lavaan::modindices(mod_med_fa_naq3_lid_des3)$mi, decreasing=TRUE), ], mi > 5 & abs(sepc.all)>0.2)%>%
  data.frame()%>%
  dplyr::mutate(lhs=paste0(lhs,op,rhs))%>%
  dplyr::mutate(mi=sprintf("%04.2f",mi))%>%
  dplyr::mutate(sepc.all=sprintf("%04.2f",sepc.all))%>%
  dplyr::select(lhs,mi,sepc.all)
  
  knitr::kable(modelo_inicial,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Tabla S24. Índices de Modificación, Modelo Inicial Seleccionado"),
               align =c('l',rep('c', 101)),
              col.names = c("Relación entre variables","Índice de Modificación", "Cambio esperado del parámetro Estandarizado (SEPC)"),
               escape=T)%>%
    kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 13) %>%
    kableExtra::row_spec(which(grepl("lid_des3",modelo_inicial$lhs)), bold= T)%>% #, color= "white", background= "tomato"
  kableExtra::add_footnote(c("Nota. En negrita, parámetros a estudiar por contener un término cuya eliminación mejoraría ostensiblemente el ajuste a os datos del modelo","=~ : efecto de una variable observada en una variable latente","~~: covarianza entre los errores de dos variables observadas","RT= Relacionado con el Trabajo; AP= Acoso Personal; LC= Liderazgo Constructivo; LF= Liderazgo Laissez-Faire; LT= Liderazgo Autoritario"),
                            notation = "none")%>%
  kableExtra::scroll_box(width = "100%", height = "375px")
```

<br>

```{r, echo = FALSE, eval = F}
"to provide minimum coverage of the construct's theoretical domain" (Hair et al., 2010, pg.676).

A factor with 2 variables is only considered reliable when the variables are highly correlated with each another (r > .70) but fairly uncorrelated with other variables. Yong, A. G., & Pearce, S. (2013, p. 80).
An item selection procedure to maximise scale reliability and validity
J. Raubenheimer
SA Journal of Industrial Psychology | Vol 30, No 4 | a168 | DOI: https://doi.org/10.4102/sajip.v30i4.168 | © 2004 J. Raubenheimer | This work is licensed under CC Attribution 4.0
Submitted: 26 October 2004 | Published: 26 October 2004
Bollen (1989) fully and thoroughly discusses the issues of identification of CFA models in chapter 7. See p. 244 specifically regarding three- and two-indicator rules.
It is recommended that each subscale include at least three items in order to capture the true central
of each dimension
<!---
Uno de los ítems con mayores índices de modificación y que aparece de manera más recurrente fue el ítem 3, que resultó estar empíricamente vinculado a la variable latente Liderazgos Constructivos (LC), e ítems que corresponden a Liderazgos Constructivos, pero también a la variable latente concerniente a Liderazgos Autoritarios (Aut). Por otra parte, también se observa que el ítem 2 mostraría mejores . Con la remoción del ítem 3, 
Los índices de modificación representan la disminución en el valor de chi-cuadrado que se produciría en caso se realizará lo sugerido. ¿Cómo saber cuando es importante? Va a depender de cada análisis, es distinto un modelo estructural con chi-cuadrado de 1500 de valor que presenta IM de 35 puntos; que un modelo estructural de chi-cuadrado 65 con el mismo valor en IM.
Esta información se adiciona al “expected parameter change” (epc) y su valor estandarizado (sepc.all) para tener mayor noción del cambio a nivel estadístico que se realizaría.
Dicho lo anterior verificamos que los IM sugieren que habría un cambio de 36 puntos menos en el chi-cuadrado (valor actual de 85.3) si se modificase su pertenencia al factor visual. Mientras que si se correlaciona los errores del indicador 7 y 8, habría un cambio de 34.15, además de que la correlación sería de 0.86 (sepc.all).
--->
```

<br>

El ítem 3 de liderazgo destructivo muestra altos índices de modificación, por lo que debiese estudiarse su eliminación.

<br>

## MM-Segunda aproximación

### MM2-Comparación modelos

`r invisible("**Debiese ser sin el ítem 3 LID-DES y con un sólo factor en el NAQ-R**")`

Se comparó un modelo que no incluyó el item 3 de la escala de liderazgo destructivo, por considerarse problemático.

<br>

<br>

<div style="border: 1px solid #ddd; padding: 5px; overflow-y: scroll; height:500px; overflow-x: scroll; width:100%;">
```{r paso2_ponderar_modelo_sin_lid_des3, eval=T, echo=T, warning=T, paged.print=TRUE}
#especifico el modelo

mod_med2_0  <-"todo =~ naq1+ naq3+ naq14+ naq16+
naq18+ naq19+ naq21+ naq2+ naq4+ naq5+
naq6+ naq7+ naq10+ naq11+ naq12+ naq13+
naq15+ naq17+ naq20+ naq8+ naq9+ naq22+ lid_des2+ lid_des6+ lid_des11+ lid_des12+ lid_des13+ lid_des14+ lid_des5+ lid_des7+ lid_des9+ lid_des1+ lid_des4+ lid_des8+ lid_des10
"

mod_med2_0b  <-"WB_LD =~ naq1+ naq3+ naq14+ naq16+
naq18+ naq19+ naq21+ naq2+ naq4+ naq5+
naq6+ naq7+ naq10+ naq11+ naq12+ naq13+
naq15+ naq17+ naq20+ naq8+ naq9+ naq22+ lid_des5+ lid_des7+ lid_des9+ lid_des1+ lid_des4+ lid_des8+ lid_des10
lid_cons =~ lid_des2+ lid_des6+ lid_des11+ lid_des12+ lid_des13+ lid_des14
"

mod_med2_1a  <-"naq_R =~ naq1+ naq3+ naq14+ naq16+
naq18+ naq19+ naq21+ naq2+ naq4+ naq5+
naq6+ naq7+ naq10+ naq11+ naq12+ naq13+
naq15+ naq17+ naq20+ naq8+ naq9+ naq22
lid_des=~ lid_des2+ lid_des6+ lid_des11+ lid_des12+ lid_des13+ lid_des14+ lid_des5+ lid_des7+ lid_des9+ lid_des1+ lid_des4+ lid_des8+ lid_des10
"

mod_med2_1b  <-"naq_R =~ naq1+ naq3+ naq14+ naq16+
naq18+ naq19+ naq21+ naq2+ naq4+ naq5+
naq6+ naq7+ naq10+ naq11+ naq12+ naq13+
naq15+ naq17+ naq20+ naq8+ naq9+ naq22
LC =~ lid_des2+ lid_des6+ lid_des11+ lid_des12+ lid_des13+ lid_des14
LD =~ lid_des5+ lid_des7+ lid_des9+ lid_des1+ lid_des4+ lid_des8+ lid_des10
"

mod_med2_1b2  <-"naq_R =~ naq1+ naq3+ naq14+ naq16+
naq18+ naq19+ naq21+ naq2+ naq4+ naq5+
naq6+ naq7+ naq10+ naq11+ naq12+ naq13+
naq15+ naq17+ naq20+ naq8+ naq9+ naq22
LC =~ lid_des2+ lid_des6+ lid_des11+ lid_des12+ lid_des13+ lid_des14
LD =~ lid_des5+ lid_des7+ lid_des9+ lid_des1+ lid_des4+ lid_des8+ lid_des10
LID_DES =~ 1*LC + 1*LD
LID_DES ~~ LID_DES
"

mod_med2_1c  <-"naq_R =~ naq1+ naq3+ naq14+ naq16+
naq18+ naq19+ naq21+ naq2+ naq4+ naq5+
naq6+ naq7+ naq10+ naq11+ naq12+ naq13+
naq15+ naq17+ naq20+ naq8+ naq9+ naq22
LC =~ lid_des2+ lid_des6+ lid_des11+ lid_des12+ lid_des13+ lid_des14
LF =~ lid_des5+ lid_des7+ lid_des9
LT =~ lid_des1+ lid_des4+ lid_des8+ lid_des10
"

mod_med2_1c2  <-"naq_R =~ naq1+ naq3+ naq14+ naq16+
naq18+ naq19+ naq21+ naq2+ naq4+ naq5+
naq6+ naq7+ naq10+ naq11+ naq12+ naq13+
naq15+ naq17+ naq20+ naq8+ naq9+ naq22
LC =~ lid_des2+ lid_des6+ lid_des11+ lid_des12+ lid_des13+ lid_des14
LF =~ lid_des5+ lid_des7+ lid_des9
LT =~ lid_des1+ lid_des4+ lid_des8+ lid_des10
LID_DES =~ 1*LT + 1*LF
LID_DES ~~ LID_DES
"

mod_med2_2a  <-"RT =~ naq1+ naq3+naq14+naq16+naq18+naq19+naq21
AP =~ naq2+ naq4+ naq5+ naq6+ naq7+ naq10+ naq11+ naq12+ naq13+ naq15+ naq17+ naq20+ naq8+ naq9+ naq22
lid_des=~ lid_des2+ lid_des6+ lid_des11+ lid_des12+ lid_des13+ lid_des14+ lid_des5+ lid_des7+ lid_des9+ lid_des1+ lid_des4+ lid_des8+ lid_des10
"

mod_med2_2b  <-"RT =~ naq1+ naq3+naq14+naq16+naq18+naq19+naq21
AP =~ naq2+ naq4+ naq5+ naq6+ naq7+ naq10+ naq11+ naq12+ naq13+ naq15+ naq17+ naq20+ naq8+ naq9+ naq22
LC =~ lid_des2+ lid_des6+ lid_des11+ lid_des12+ lid_des13+ lid_des14
LD =~ lid_des5+ lid_des7+ lid_des9+ lid_des1+ lid_des4+ lid_des8+ lid_des10
"

mod_med2_2b2  <-"RT =~ naq1+ naq3+naq14+naq16+naq18+naq19+naq21
AP =~ naq2+ naq4+ naq5+ naq6+ naq7+ naq10+ naq11+ naq12+ naq13+ naq15+ naq17+ naq20+ naq8+ naq9+ naq22
LC =~ lid_des2+ lid_des6+ lid_des11+ lid_des12+ lid_des13+ lid_des14
LD =~ lid_des5+ lid_des7+ lid_des9+ lid_des1+ lid_des4+ lid_des8+ lid_des10
LID_DES =~ 1*LC + 1*LD
LID_DES ~~ LID_DES
"

mod_med2_2c  <-"RT =~ naq1+ naq3+naq14+naq16+naq18+naq19+naq21
AP =~ naq2+ naq4+ naq5+ naq6+ naq7+ naq10+ naq11+ naq12+ naq13+ naq15+ naq17+ naq20+ naq8+ naq9+ naq22
LC =~ lid_des2+ lid_des6+ lid_des11+ lid_des12+ lid_des13+ lid_des14
LF =~ lid_des5+ lid_des7+ lid_des9
LT =~ lid_des1+ lid_des4+ lid_des8+ lid_des10
"

mod_med2_2c2  <-"RT =~ naq1+ naq3+naq14+naq16+naq18+naq19+naq21
AP =~ naq2+ naq4+ naq5+ naq6+ naq7+ naq10+ naq11+ naq12+ naq13+ naq15+ naq17+ naq20+ naq8+ naq9+ naq22
LC =~ lid_des2+ lid_des6+ lid_des11+ lid_des12+ lid_des13+ lid_des14
LF =~ lid_des5+ lid_des7+ lid_des9
LT =~ lid_des1+ lid_des4+ lid_des8+ lid_des10
LID_DES =~ 1*LT + 1*LF
LID_DES ~~ LID_DES
"

mod_med2_3a  <-"RT =~ naq1 + naq3  +naq14 +naq16 +naq18 +naq19 +naq21
AP =~ naq2  +naq4  +naq5  +naq6  +naq7  +naq10+naq11 +naq12 +naq13 +naq15 +naq17 +naq20
AF =~ naq8  +naq9  +naq22
lid_des=~ lid_des2+ lid_des6+ lid_des11+ lid_des12+ lid_des13+ lid_des14+ lid_des5+ lid_des7+ lid_des9+ lid_des1+ lid_des4+ lid_des8+ lid_des10
"

mod_med2_3b  <-"RT =~ naq1 + naq3  +naq14 +naq16 +naq18 +naq19 +naq21
AP =~ naq2  +naq4  +naq5  +naq6  +naq7  +naq10+naq11 +naq12 +naq13 +naq15 +naq17 +naq20
AF =~ naq8  +naq9  +naq22
LC =~ lid_des2+ lid_des6+ lid_des11+ lid_des12+ lid_des13+ lid_des14
LD =~ lid_des5+ lid_des7+ lid_des9+ lid_des1+ lid_des4+ lid_des8+ lid_des10
"

mod_med2_3b2  <-"RT =~ naq1 + naq3  +naq14 +naq16 +naq18 +naq19 +naq21
AP =~ naq2  +naq4  +naq5  +naq6  +naq7  +naq10+naq11 +naq12 +naq13 +naq15 +naq17 +naq20
AF =~ naq8  +naq9  +naq22
LC =~ lid_des2+ lid_des6+ lid_des11+ lid_des12+ lid_des13+ lid_des14
LD =~ lid_des5+ lid_des7+ lid_des9+ lid_des1+ lid_des4+ lid_des8+ lid_des10
LID_DES =~ 1*LC + 1*LD
LID_DES ~~ LID_DES
"

mod_med2_3c  <-"RT =~ naq1 + naq3  +naq14 +naq16 +naq18 +naq19 +naq21
AP =~ naq2  +naq4  +naq5  +naq6  +naq7  +naq10+naq11 +naq12 +naq13 +naq15 +naq17 +naq20
AF =~ naq8  +naq9  +naq22
LC=~ lid_des2+ lid_des6+ lid_des11+ lid_des12+ lid_des13+ lid_des14
LF=~ lid_des5+ lid_des7+ lid_des9
LT=~ lid_des1+ lid_des4+ lid_des8+ lid_des10
"

mod_med2_3c2  <-"RT =~ naq1 + naq3  +naq14 +naq16 +naq18 +naq19 +naq21
AP =~ naq2  +naq4  +naq5  +naq6  +naq7  +naq10+naq11 +naq12 +naq13 +naq15 +naq17 +naq20
AF =~ naq8  +naq9  +naq22
LC=~ lid_des2+ lid_des6+ lid_des11+ lid_des12+ lid_des13+ lid_des14
LF=~ lid_des5+ lid_des7+ lid_des9
LT=~ lid_des1+ lid_des4+ lid_des8+ lid_des10
LID_DES =~ 1*LF + 1*LT
LID_DES ~~ LID_DES
"

#todo
mod_med2_fa_naq1_lid_des0 <- lavaan::cfa(mod_med2_0, data = BD_2020_input, ordered=setdiff(c(NAQ_R2,LID_DES),"lid_des3"), estimator= "WLS", warn = T, std.lv=T)
#todo vs. LC
mod_med2_fa_naq1_lid_des0b <- lavaan::cfa(mod_med2_0b, data = BD_2020_input, ordered=setdiff(c(NAQ_R2,LID_DES),"lid_des3"), estimator= "WLS", warn = T, std.lv=T)
#NAQ vs. LID-DES amplio
mod_med2_fa_naq1_lid_des1 <- lavaan::cfa(mod_med2_1a, data = BD_2020_input, ordered=setdiff(c(NAQ_R2,LID_DES),"lid_des3"), estimator= "WLS", warn = T, std.lv=T)
#NAQ vs. LC + LD
mod_med2_fa_naq1_lid_des2 <- lavaan::cfa(mod_med2_1b, data = BD_2020_input, ordered=setdiff(c(NAQ_R2,LID_DES),"lid_des3"), estimator= "WLS", warn = T, std.lv=T)
#NAQ vs. 2do orden LID DES (LC+ LD) amplio
mod_med2_fa_naq1_lid_des22 <- lavaan::cfa(mod_med2_1b2, data = BD_2020_input, ordered=setdiff(c(NAQ_R2,LID_DES),"lid_des3"), estimator= "WLS", warn = T, std.lv=T)
#NAQ vs. LC+ LF´LT
mod_med2_fa_naq1_lid_des3 <- lavaan::cfa(mod_med2_1c, data = BD_2020_input, ordered=setdiff(c(NAQ_R2,LID_DES),"lid_des3"), estimator= "WLS", warn = T, std.lv=T)

#NAQ 2do orden LID DES (LT+ LF)
mod_med2_fa_naq1_lid_des32 <- lavaan::cfa(mod_med2_1c2, data = BD_2020_input, ordered=setdiff(c(NAQ_R2,LID_DES),"lid_des3"), estimator= "WLS", warn = T, std.lv=T)
#RT+ AP vs. LID DES amplio
mod_med2_fa_naq2_lid_des1 <- lavaan::cfa(mod_med2_2a, data = BD_2020_input, ordered=setdiff(c(NAQ_R2,LID_DES),"lid_des3"), estimator= "WLS", warn = T, std.lv=T)
#RT+ AP vs. LC+ LD
mod_med2_fa_naq2_lid_des2 <- lavaan::cfa(mod_med2_2b, data = BD_2020_input, ordered=setdiff(c(NAQ_R2,LID_DES),"lid_des3"), estimator= "WLS", warn = T, std.lv=T)
#RT+ AP vs. LID DES 2do orden (LC+ LD) amplio
mod_med2_fa_naq2_lid_des22 <- lavaan::cfa(mod_med2_2b2, data = BD_2020_input, ordered=setdiff(c(NAQ_R2,LID_DES),"lid_des3"), estimator= "WLS", warn = T, std.lv=T)

#RT+ AP vs. LC+ LF+ LT
mod_med2_fa_naq2_lid_des3 <- lavaan::cfa(mod_med2_2c, data = BD_2020_input, ordered=setdiff(c(NAQ_R2,LID_DES),"lid_des3"), estimator= "WLS", warn = T, std.lv=T)

#RT+ AP vs. 2do orden LID DES (LC+ LD) amplio
mod_med2_fa_naq2_lid_des32 <- lavaan::cfa(mod_med2_2c2, data = BD_2020_input, ordered=setdiff(c(NAQ_R2,LID_DES),"lid_des3"), estimator= "WLS", warn = T, std.lv=T)

#RT+ AP+ AF vs. LID DES amplio
mod_med2_fa_naq3_lid_des1 <- lavaan::cfa(mod_med2_3a, data = BD_2020_input, ordered=setdiff(c(NAQ_R2,LID_DES),"lid_des3"), estimator= "WLS", warn = T, std.lv=T)
#RT+ AP+ AF vs. LC+ LD
mod_med2_fa_naq3_lid_des2 <- lavaan::cfa(mod_med2_3b, data = BD_2020_input, ordered=setdiff(c(NAQ_R2,LID_DES),"lid_des3"), estimator= "WLS", warn = T, std.lv=T)
#RT+ AP+ AF vs. LID DES 2do orden (LC+ LD) amplio
mod_med2_fa_naq3_lid_des22 <- lavaan::cfa(mod_med2_3b2, data = BD_2020_input, ordered=setdiff(c(NAQ_R2,LID_DES),"lid_des3"), estimator= "WLS", warn = T, std.lv=T)
#RT+ AP+ AF vs. LC+ LF+ LT
mod_med2_fa_naq3_lid_des3 <- lavaan::cfa(mod_med2_3c, data = BD_2020_input, ordered=setdiff(c(NAQ_R2,LID_DES),"lid_des3"), estimator= "WLS", warn = T, std.lv=T)

#RT+ AP+ AF vs. 2do orden LID DES (LT+ LF)
mod_med2_fa_naq3_lid_des32 <- lavaan::cfa(mod_med2_3c2, data = BD_2020_input, ordered=setdiff(c(NAQ_R2,LID_DES),"lid_des3"), estimator= "WLS", warn = T, std.lv=T)

invisible("Las de segundo orden fueron los únicos que no convergieron")
```

</div>

<br>

Por cuestiones de parsimonia, se seleccionó el modelo con mayor cantidad de parámetros libres, diferencias en los CFI's menores de `r 0.967-0.955` y `r .09-0.078` para RMSEA (`mod_med2_fa_naq1_lid_des2`), de acuerdo al criterio estipulado.

<br>

```{r paso2_comp_tab_modelos_res_2,eval=T, echo=T, paged.print=TRUE, eval=T}
#options(OutDec= ",") 

 dat_tab_afc2<-
  data.table(data.frame(rbind(ajusteAFC(mod_med2_fa_naq1_lid_des0),ajusteAFC(mod_med2_fa_naq1_lid_des0b),
                            ajusteAFC(mod_med2_fa_naq1_lid_des1),ajusteAFC(mod_med2_fa_naq1_lid_des2),
                            ajusteAFC(mod_med2_fa_naq1_lid_des22),
                            ajusteAFC(mod_med2_fa_naq1_lid_des3),
                            ajusteAFC(mod_med2_fa_naq1_lid_des32),
                            ajusteAFC(mod_med2_fa_naq2_lid_des1),ajusteAFC(mod_med2_fa_naq2_lid_des2),
                            ajusteAFC(mod_med2_fa_naq2_lid_des22),
                            ajusteAFC(mod_med2_fa_naq2_lid_des3),
                            ajusteAFC(mod_med2_fa_naq2_lid_des32),
                            ajusteAFC(mod_med2_fa_naq3_lid_des1),ajusteAFC(mod_med2_fa_naq3_lid_des2),
                            ajusteAFC(mod_med2_fa_naq3_lid_des22),
                            ajusteAFC(mod_med2_fa_naq3_lid_des3),
                            ajusteAFC(mod_med2_fa_naq3_lid_des32)
                            )),keep.rownames = T)%>%
  dplyr::mutate(rn=c("Único factor",
                     "2 Factores: NAQ y DL vs. Lid Constructivos",
                     "NAQ-R (1 Factor) & DLS (1 Factor)",
                     "NAQ-R (1 Factor) & DLS (2 Factores)",
                     "NAQ-R (1 Factor) & DLS (2 Factores) (2do orden, LID DES [LC+ LD])",                     
                     "NAQ-R (1 Factor) & DLS (3 Factores)",
                     "NAQ-R (1 Factor) & DLS (3 Factores) (2do orden, LID DES [LT+ LF])",
                     "NAQ-R (2 Factores) & DLS (1 Factor)",    
                     "NAQ-R (2 Factores) & DLS (2 Factores)",
                     "NAQ-R (2 Factores) & DLS (2 Factores) (2do orden, LID DES [LC+ LD])",                     
                     "NAQ-R (2 Factores) & DLS (3 Factores)",
                     "NAQ-R (2 Factores) & DLS (3 Factores) (2do orden, LID DES [LT+ LF])",                     
                     "NAQ-R (3 Factores) & DLS (1 Factor)",
                     "NAQ-R (3 Factores) & DLS (2 Factores)",
                     "NAQ-R (3 Factores) & DLS (2 Factores) (2do orden, LID DES [LC+ LD])",
                     "NAQ-R (3 Factores) & DLS (3 Factores)",
                     "NAQ-R (3 Factores) & DLS (3 Factores) (2do orden, LID DES [LT+ LF])"
                     ))%>%
  dplyr::arrange(desc(CFI),desc(gl)) 
  
  #dplyr::select(-Modelo)%>%
  knitr::kable(dat_tab_afc2,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Tabla S25. Comparativo Índices de Ajuste de Modelos Propuestos"),
               align =c('l',rep('c', 101)),
               col.names = c("Modelo","Término","gl","WLS $\\chi^2$","CMIN/gl","aGFI","GFI", "RMSEA\n[IC 90%]","CFit","CFI","NNFI"),
               escape=T) %>%
      #kableExtra::row_spec(1:5,bold= T, color= "black", background= "white")%>%
      kableExtra::add_footnote(c("Nota. Ordenados de mayor a menor CFI y grados de libertad"), notation = "none")%>%
  kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 11)
```

<br>

De la tabla se observó que los modelos de un factor de Liderazgos Destructivos no obtuvieron un ajuste adecuado en el RMSEA y CMIN/gl [@marsh1985]. Por cuestiones de parsimonia, se seleccionó el modelo con mayor cantidad de parámetros libres pero con RMSEA menores al umbral puesto, diferencias en los CFI's menores a `r 0.968-0.962` y `r 0.046-0.043` para RMSEA (`mod_med2_fa_naq1_lid_des2`) [@chen2007;@cheung2002].

<br>

```{r paso2_comparativo_anova_modelos_2,eval=T, echo=T, paged.print=TRUE, eval=T}
if(no_mostrar==0){
dput(dat_tab_afc2$Modelo)
}

anova_lavaan2<-
lavaan::anova(mod_med2_fa_naq3_lid_des3,
mod_med2_fa_naq1_lid_des3,
mod_med2_fa_naq2_lid_des3,
mod_med2_fa_naq2_lid_des2,
mod_med2_fa_naq3_lid_des2,
mod_med2_fa_naq1_lid_des2,
mod_med2_fa_naq1_lid_des0b,
mod_med2_fa_naq3_lid_des32,
mod_med2_fa_naq2_lid_des32,
mod_med2_fa_naq1_lid_des32,
mod_med2_fa_naq3_lid_des1,
mod_med2_fa_naq1_lid_des1,
mod_med2_fa_naq2_lid_des1,
mod_med2_fa_naq1_lid_des0,
mod_med2_fa_naq3_lid_des22,
mod_med2_fa_naq1_lid_des22,
mod_med2_fa_naq2_lid_des22)%>%
  data.frame()%>%
  dplyr::select(-AIC,	-BIC)%>%
    dplyr::mutate(Chisq.diff=dplyr::case_when(Pr..Chisq.<.001~paste0(sprintf("%4.2f",Chisq.diff),"***"),
                    Pr..Chisq.<.01~paste0(sprintf("%4.2f",Chisq.diff),"**"),
                    Pr..Chisq.<.05~paste0(sprintf("%4.2f",Chisq.diff),"*"),
                    TRUE~paste0(sprintf("%4.2f",Chisq.diff))))


(second_comp<-
compareFit(mod_med2_fa_naq3_lid_des3,
mod_med2_fa_naq1_lid_des3,
mod_med2_fa_naq2_lid_des3,
mod_med2_fa_naq2_lid_des2,
mod_med2_fa_naq3_lid_des2,
mod_med2_fa_naq1_lid_des2,
mod_med2_fa_naq1_lid_des0b,
mod_med2_fa_naq3_lid_des32,
mod_med2_fa_naq2_lid_des32,
mod_med2_fa_naq1_lid_des32,
mod_med2_fa_naq3_lid_des1,
mod_med2_fa_naq1_lid_des1,
mod_med2_fa_naq2_lid_des1,
mod_med2_fa_naq1_lid_des0,
mod_med2_fa_naq3_lid_des22,
mod_med2_fa_naq1_lid_des22,
mod_med2_fa_naq2_lid_des22, nested = T, moreIndices=T, baseline.model=mod_med2_fa_naq1_lid_des2))

options(knitr.kable.NA = '')
data.table(second_comp@fit.diff,keep.rownames = T)[,c("rn", "npar", "df", "agfi", "gfi", "rmsea", "rmsea.ci.lower", "rmsea.ci.upper", "cfi")] %>% 
    dplyr::mutate_if(is.numeric, funs(round(.,3))) %>% 
  knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Tabla S26. Comparativo Índices de Ajuste, Diferencias Chi-Cuadrado entre Modelos Anidados"),
               col.names= c("Comparación","$\\Delta$ Parámetros","$\\Delta$ gl","$\\Delta$ aGFI","$\\Delta$ GFI", "$\\Delta$ RMSEA","$\\Delta$ RMSEA lo","$\\Delta$ RMSEA up","$\\Delta$ CFI"),
               align =c('l',rep('c', 101)),
               #col.names = c("Parámetros","gl","Chi Cuadrado","Diff. Chi Cuadrado", "Diferencias en gl","Valores p (Diferencias)"),
               escape=T)%>%
  kableExtra::row_spec(which(grepl("mod_med2_fa_naq1_lid_des2",row.names(second_comp@fit.diff))), bold=T) %>% 
  kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 10)
```

<br>

### MM2-Modelos seleccionados

<br>

<div style="border: 1px solid #ddd; padding: 5px; overflow-y: scroll; height:350px; overflow-x: scroll; width:100%">
```{r afc_paso2_std_summ_0,eval=T, echo=T, paged.print=TRUE, eval=T}
summary(mod_med2_fa_naq3_lid_des3, standardized=T)
```
</div>

```{r fig1_paso2_fa_0, echo=T, fig.align='center', fig.pos='H', fig.cap= "Figura S9_0. Cargas factoriales estandarizadas y comunalidades para NAQ-R y DLS, Primer Modelo (de medición)", message=FALSE, error=T, fig.retina=2}

lavaanPlot::lavaanPlot(model = mod_med2_fa_naq3_lid_des3, coefs = TRUE, stand = TRUE, sig = 0.05) #standardized regression paths, showing only paths with p<= .05
```


<div style="border: 1px solid #ddd; padding: 5px; overflow-y: scroll; height:350px; overflow-x: scroll; width:100%">
```{r afc_paso2_std_summ_a,eval=T, echo=T, paged.print=TRUE, eval=T}
summary(mod_med2_fa_naq1_lid_des2, standardized=T)
```
</div>

<br>

```{r afc_paso2_std_load_phi_2, echo = T, eval = T}
#Cargas factoriales.
afc_lambda_std_segundo_mod<-
    data.table::data.table(lavaan::lavInspect(mod_med2_fa_naq1_lid_des2, what = "std", add.labels = TRUE)$`lambda`,keep.rownames = T) %>% 
    dplyr::left_join(cols_labels, by=c("rn"="V1")) %>% 
    dplyr::select(label,everything()) %>% 
    dplyr::mutate(across(where(is.numeric), ~ round(.x, 2))) %>% 
    dplyr::mutate(across(where(is.numeric), ~ ifelse(.x==0,NA,.x)))

for (i in 1:nrow(afc_lambda_std_segundo_mod)){
    afc_lambda_std_segundo_mod$label[i]<-stringr::str_wrap(afc_lambda_std_segundo_mod$label[i], width = 40, indent = 0, exdent = 0)
}

#R cuadrado var latentes
afc_psi_std_segundo_mod<-
    cbind.data.frame(label=c("Acoso Laboral", "Liderazgo Constructivo", "Liderazgos Destructivos"),
                     data.table::data.table(lavaan::lavInspect(mod_med2_fa_naq1_lid_des2, what = "std", add.labels = TRUE)$psi,keep.rownames = T)) %>% 
    dplyr::mutate(across(where(is.numeric), ~ round(.x, 2))) %>% 
    dplyr::mutate(across(where(is.numeric), ~ ifelse(.x==1,NA,.x))) 

options(knitr.kable.NA = '')
rbind.data.frame(afc_lambda_std_segundo_mod,
                 afc_psi_std_segundo_mod) %>% 
    knitr::kable(format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
                 caption = paste0("Tabla S27a. Cargas Factoriales y Covarianzas Variables Latentes"),
                 align =c('l',rep('c', 101)),
                 col.names = c("Ítem","Código", "NAQ-R", "LC", "LD"),
                 escape=T)%>%
    kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 12) %>%
    kableExtra::pack_rows("Variables manifiestas", 1, nrow(afc_lambda_std_segundo_mod)) %>%
    kableExtra::pack_rows("Variables latentes", nrow(afc_lambda_std_segundo_mod)+1, nrow(afc_lambda_std_segundo_mod)+nrow(afc_psi_std_segundo_mod)) %>%
    kableExtra::add_footnote(c("Nota. NAQ-R= Acoso Laboral; LC= Liderazgo Constructivo; LD= Liderazgos Destructivos"),
                             notation = "none")%>%
    kableExtra::scroll_box(width = "100%", height = "375px")
#A factor with 2 variables is only considered reliable when the variables are highly correlated with each another (r > .70) but fairly uncorrelated with other variables. Yong, A. G., & Pearce, S. (2013, p. 80).
```

<br>

De la tabla anterior llama la atención las bajas cargas factoriales estandarizadas del ítem 7, junto con la importante covarianza del NAQ-R y los Liderazgos Destructivos. A este respecto, es factible en algunos casos encontrar algunas cargas triviales, siempre y cuando las medidas de validez discrimnante y el promedio de la varianza explicada por el factor se encuentren en niveles aceptables. Por ejemplo, Tabachnick y Fidell [-@tabachnick2007] sugieren un punto de corte de .32 para arriba (p. 646), particularmente en modelos en los que los ítems tienen distintas distribuciones de frecuencias, los que permitirían un mínimo nivel de interpretación, considerando además un tamaño de la muestra superior a 350 casos.

`r invisible(" if the item is conceptually so ambiguous and error-prone I would have problems to regard it as a useful measurement instrument")`

A continuación se presenta una Figura con la solución seleccionada.


```{r fig1_paso2_fa_22, echo=T, fig.align='center', fig.pos='H', fig.cap= "Figura S9a. Cargas factoriales estandarizadas y comunalidades para NAQ-R y DLS, Primer Modelo (alt)", message=FALSE, error=T, fig.retina=2}

if(no_mostrar==0){
for (i in 2:600){
  ano<-i
  try(semPlot::semPaths(mod_med2_fa_naq1_lid_des2, 
                  residuals=F, 
                  what="std", 
                  label.cex=1.5, 
                  edge.label.cex=1,
                  fade=FALSE,
                  thresholds = F,
                  edge.label.position=rep(.5,ano),
                  filetype="pdf",
                  filename=paste0("Número de parámetros ",ano),
                  intercepts=F)
    )
  }
}
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#114 parametros con residuos
#41 sin residuos
options(OutDec=",")
semPlot::semPaths(mod_med2_fa_naq1_lid_des2, residuals=F, what="std",label.cex=.7, edge.label.cex=.6, sizeMan=3, thresholds=F, legend=F,intercepts=FALSE, 
                  curveAdjacent = TRUE,title=F, layout="tree",fade=FALSE,edge.color="black", curvature=1.4,
                  edge.label.position=c(rep(c(0.5,.55,0.6,0.65),8),.45,0.5,.55,rep(0.5,6)),#,rep(c(0.5,.55),21),rep(0.5,31)
                  sizeLat = 10,cut=1.4,curve=.7, curvePivot=T,borders=FALSE, nCharNodes=0, 
                  label.scale=F,
                  nCharEdges=0,optimizeLatRes=T,edge.width = 1.5, node.width =1, node.height= 1, 
                  nodeLabels=c(paste0("\nNQ\n",c(1,3,14,16,18,19,21,2,4,5,6,7,10,11,12,13,15,17,20,8,9,22)),
                               paste0("\nDL\n",c(2,6,11,12,13,14)),
                               paste0("\nDL\n",c(5,7,9,1,4,8,10)),"Acoso\nLaboral", "Liderazgo\nConstructivo", "Liderazgos\nDestructivos"), 
                  mar = c(4.5, 0.5, 4.5, 0.5),
                  #filetype="png",
                  #filename="sempaths"
                  )
#text(-0.9, -1.15, labels = "LD= Liderazgos Destructivos\nLC=Liderazgo Constructivo\nAL=Acoso Laboral", cex=.8, adj=0)
#text(0.58, 1.3, labels = "LD= Liderazgos Destructivos\nLC= Liderazgo Constructivo\nAL= Acoso Laboral", cex=.8, adj=0)
# text(-1.05, -1.27, labels = "NQ= Ítems del Cuestionario de Conductas Negativas\nDL= Ítems de la Escala de Liderazgos Destructivos", cex=.5, adj=0, font=3)
dev.print(png,"Figura S9a.png", width=7, height=4, res=600, units="in") 
#dev.off()
options(OutDec=".")
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
```


<br>

<div style="border: 1px solid #ddd; padding: 5px; overflow-y: scroll; height:350px; overflow-x: scroll; width:100%">
```{r afc_paso2_std_summ_b,eval=T, echo=T, paged.print=TRUE, eval=T}
summary(mod_med2_fa_naq1_lid_des0b, standardized=T)
```
</div>

<br>

A continuación, un segundo modelo más parsimonioso pero que no distingue entre liderazgos destructivos y conductas negativas.

<br>

```{r afc_paso2_std_load_phi_2b, echo = T, eval = T}
#Cargas factoriales.
afc_lambda_std_segundo_mod_b<-
    data.table::data.table(lavaan::lavInspect(mod_med2_fa_naq1_lid_des0b, what = "std", add.labels = TRUE)$`lambda`,keep.rownames = T) %>% 
    dplyr::left_join(cols_labels, by=c("rn"="V1")) %>% 
    dplyr::select(label,everything()) %>% 
    dplyr::mutate(across(where(is.numeric), ~ round(.x, 2))) %>% 
    dplyr::mutate(across(where(is.numeric), ~ ifelse(.x==0,NA,.x)))

for (i in 1:nrow(afc_lambda_std_segundo_mod_b)){
    afc_lambda_std_segundo_mod_b$label[i]<-stringr::str_wrap(afc_lambda_std_segundo_mod_b$label[i], width = 40, indent = 0, exdent = 0)
}

#R cuadrado var latentes
afc_psi_std_segundo_mod_b<-
    cbind.data.frame(label=c("Acoso Laboral y Liderazgos Destructivos", "Liderazgo Constructivo"),
                     data.table::data.table(lavaan::lavInspect(mod_med2_fa_naq1_lid_des0b, what = "std", add.labels = TRUE)$psi,keep.rownames = T)) %>% 
    dplyr::mutate(across(where(is.numeric), ~ round(.x, 2))) %>% 
    dplyr::mutate(across(where(is.numeric), ~ ifelse(.x==1,NA,.x))) 

options(knitr.kable.NA = '')
rbind.data.frame(afc_lambda_std_segundo_mod_b,
                 afc_psi_std_segundo_mod_b) %>% 
    knitr::kable(format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
                 caption = paste0("Tabla S27b. Cargas Factoriales y Covarianzas Variables Latentes"),
                 align =c('l',rep('c', 101)),
                 col.names = c("Ítem","Código", "WB y LD", "LC"),
                 escape=T)%>%
    kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 12) %>%
    kableExtra::pack_rows("Variables manifiestas", 1, nrow(afc_lambda_std_segundo_mod_b)) %>%
    kableExtra::pack_rows("Variables latentes", nrow(afc_lambda_std_segundo_mod_b)+1, nrow(afc_lambda_std_segundo_mod_b)+nrow(afc_psi_std_segundo_mod_b)) %>%
    kableExtra::add_footnote(c("Nota. WB_LD= Acoso Laboral y Liderazgos Destructivos; lid_cons= Liderazgo Constructivo"),
                             notation = "none")%>%
    kableExtra::scroll_box(width = "100%", height = "375px")
#A factor with 2 variables is only considered reliable when the variables are highly correlated with each another (r > .70) but fairly uncorrelated with other variables. Yong, A. G., & Pearce, S. (2013, p. 80).
```

<br>

```{r fig1_paso2_fa_0b, echo=T, fig.align='center', fig.pos='H', fig.cap= "Figura S9b. Cargas factoriales estandarizadas y comunalidades para NAQ-R y DLS, Segundo Modelo (alt)", message=FALSE, error=T, fig.retina=2}

if(no_mostrar==0){
for (i in 2:600){
  ano<-i
  try(semPlot::semPaths(mod_med2_fa_naq1_lid_des0b, 
                  residuals=F, 
                  what="std", 
                  label.cex=1.5, 
                  edge.label.cex=1,
                  fade=FALSE,
                  thresholds = F,
                  edge.label.position=rep(.5,ano),
                  filetype="pdf",
                  filename=paste0("Número de parámetros ",ano),
                  intercepts=F)
    )
  }
}
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#37 parámetros 0b
options(OutDec=",")
semPlot::semPaths(mod_med2_fa_naq1_lid_des0b, residuals=F, what="std",label.cex=.7, edge.label.cex=.6, sizeMan=3, thresholds=F, legend=F,intercepts=FALSE, 
                  curveAdjacent = TRUE,title=F, layout="tree",fade=FALSE,edge.color="black", curvature=1.4,
                  edge.label.position=c(rep(c(0.5,.55,0.6,0.65),8),0.5,.55,0.6,.5,rep(0.5,1)),#,rep(c(0.5,.55),21),rep(0.5,31)
                  sizeLat = 10,cut=1.4,curve=.7, curvePivot=T,borders=FALSE, nCharNodes=0, 
                  label.scale=F,
                  nCharEdges=0,optimizeLatRes=T,edge.width = 1.5, node.width =1, node.height= 1, 
                  nodeLabels=c(paste0("\nNQ\n",c(1,3,14,16,18,19,21,2,4,5,6,7,10,11,12,13,15,17,20,8,9,22)),
                               paste0("\nDL\n",c(5,7,9,1,4,8,10)),
                               paste0("\nDL\n",c(2,6,11,12,13,14)),"Acoso Laboral y\nLiderazgos Destructivos", "Liderazgo\nConstructivo"), 
                  mar = c(4.5, 0.5, 4.5, 0.5),
                  #filetype="png",
                  #filename="sempaths"
                  )
#text(-0.9, -1.15, labels = "LD= Liderazgos Destructivos\nLC=Liderazgo Constructivo\nAL=Acoso Laboral", cex=.8, adj=0)
#text(0.58, 1.3, labels = "LD= Liderazgos Destructivos\nLC= Liderazgo Constructivo\nAL= Acoso Laboral", cex=.8, adj=0)
# text(-1.05, -1.27, labels = "NQ= Ítems del Cuestionario de Conductas Negativas\nDL= Ítems de la Escala de Liderazgos Destructivos", cex=.5, adj=0, font=3)
dev.print(png,"Figura S9b.png", width=7, height=4, res=600, units="in") 
#dev.off()
options(OutDec=".")
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
```

<br>

Se utilizó el criterio HTMT (razón heterorazgo-monorrazgo) de las correlaciones, para explorar la validez discriminante de cada variable latente [@Henseler2015].

<br>

```{r afc_paso2_htmt_2, echo = T, eval = T}
semTools::htmt(mod_med2_1b, BD_2020_input[,c(NAQ_R2,setdiff(LID_DES,"lid_des3"))], sample.cov = NULL, missing = 'pairwise', ordered = c(NAQ_R2,setdiff(LID_DES,"lid_des3")), absolute = T)%>% 
  as.data.table(keep.rownames = T) %>% 
  dplyr::mutate(across(where(is.numeric), ~ round(.x, 2))) %>% 
  knitr::kable(format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Tabla S28a. Validez Discriminante"),
               align =c('l',rep('c', 101)),
               #col.names = c("Var. Latentes","Agotamiento y Estrés", "Sueño", "Estrés Postraumático", "Sint. Ansiosa", "Sint. Depresiva")
               escape=T)%>%
    kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 12) %>%
  kableExtra::add_footnote(c("Nota. Valores <.90, umbral en favor de validez discriminante; NAQ-R= Acoso Laboral; LC= Liderazgo Constructivo; LD= Liderazgos Destructivos"),
                            notation = "none")%>%
  kableExtra::scroll_box(width = "100%", height = "375px")
```

```{r afc_paso2_htmt_2b, echo = T, eval = T}
semTools::htmt(mod_med2_0b, BD_2020_input[,c(NAQ_R2,setdiff(LID_DES,"lid_des3"))], sample.cov = NULL, missing = 'pairwise', ordered = c(NAQ_R2,setdiff(LID_DES,"lid_des3")), absolute = T)%>% 
  as.data.table(keep.rownames = T) %>% 
  dplyr::mutate(across(where(is.numeric), ~ round(.x, 2))) %>% 
  knitr::kable(format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Tabla S28b. Validez Discriminante"),
               align =c('l',rep('c', 101)),
               #col.names = c("Var. Latentes","Agotamiento y Estrés", "Sueño", "Estrés Postraumático", "Sint. Ansiosa", "Sint. Depresiva")
               escape=T)%>%
    kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 12) %>%
  kableExtra::add_footnote(c("Nota. Valores <.90, umbral en favor de validez discriminante; WB_LD= Acoso Laboral y Liderazgos Destructivos; LC= Liderazgo Constructivo "),
                            notation = "none")%>%
  kableExtra::scroll_box(width = "100%", height = "375px")
```

<br>

A partir de la tabla anterior, se observan índices menores a .85 en algunos casos, pero todos menores al umbral obligatorio de .90 **salvo los componentes del NAQ**, lo cual permite aportar evidencia a favor de variables latentes que se distinguen entre ellas a excepción del NAQ-R. 

<br>

```{r afc_paso2_disc_val_2, eval=T, echo=T, warning=FALSE}
semTools::discriminantValidity(mod_med2_fa_naq1_lid_des2, cutoff = 0.9, merge = F, level = 0.95) %>% 
    as.data.table(keep.rownames = T) %>% 
  dplyr::mutate(across(where(is.numeric), ~ round(.x, 2))) %>% 
  knitr::kable(format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Tabla S29a. Validez Discriminante (2)"),
               align =c('l',rep('c', 101)),
               #col.names = c("Var. Latentes","Agotamiento y Estrés", "Sueño", "Estrés Postraumático", "Sint. Ansiosa", "Sint. Depresiva")
               escape=T)%>%
    kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 12) %>%
  kableExtra::add_footnote(c("Nota. NAQ-R= Acoso Laboral; LC= Liderazgo Constructivo; LD= Liderazgos Destructivos"),
                            notation = "none")%>%
  kableExtra::scroll_box(width = "100%", height = "375px")

if(no_mostrar==0){
  semTools::htmt(mod_med2_3c, BD_2020_input[,c(NAQ_R2,setdiff(LID_DES,"lid_des3"))], sample.cov = NULL, missing = 'pairwise', ordered = c(NAQ_R2,setdiff(LID_DES,"lid_des3")), absolute = T)%>% 
  as.data.table(keep.rownames = T)%>% copiar_nombres()
  
  semTools::discriminantValidity(mod_med2_fa_naq3_lid_des3, cutoff = 0.9, merge = F, level = 0.95) %>% 
    as.data.table(keep.rownames = T)%>% copiar_nombres()
  
  data.table(t(round(semTools::reliability(mod_med2_fa_naq3_lid_des3, c("alpha.ord","omega","ave"),return.total=T),2)),keep.rownames = T) %>% copiar_nombres()
  
}
```


```{r afc_paso2_disc_val_2b, eval=T, echo=T, warning=FALSE}
semTools::discriminantValidity(mod_med2_fa_naq1_lid_des0b, cutoff = 0.9, merge = F, level = 0.95) %>% 
    as.data.table(keep.rownames = T) %>% 
  dplyr::mutate(across(where(is.numeric), ~ round(.x, 2))) %>% 
  knitr::kable(format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Tabla S29b. Validez Discriminante (2)"),
               align =c('l',rep('c', 101)),
               #col.names = c("Var. Latentes","Agotamiento y Estrés", "Sueño", "Estrés Postraumático", "Sint. Ansiosa", "Sint. Depresiva")
               escape=T)%>%
    kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 12) %>%
  kableExtra::add_footnote(c("Nota. WB_LD= Acoso Laboral y Liderazgos Destructivos; lid_cons= Liderazgo Constructivo"),
                            notation = "none")%>%
  kableExtra::scroll_box(width = "100%", height = "375px")
```

<br>

La medida de validez discriminante indica que los constructos no parecen estar exageradamente relacionados, por lo que debiesen ser distintos uno de otro, y por tanto, debiesen distinguirse y tratarse como constructos independientes [@Ronkko2020].

<br>

```{r afc_paso2_rel_2, echo=T, error=T, warning=FALSE, cache=TRUE, paged.print=TRUE}
loadings <- standardizedSolution(mod_med2_fa_naq1_lid_des2) %>%	
 dplyr::filter(op == "=~", lhs == "LD") %>% dplyr::select(est.std)
com_rel <- sum(loadings) ^ 2 / ((sum(loadings)^ 2)  + sum(1 - loadings ^ 2))	

loadings2 <- standardizedSolution(mod_med2_fa_naq1_lid_des2) %>%	
 dplyr::filter(op == "=~", lhs == "LC") %>% dplyr::select(est.std)
com_rel2 <- sum(loadings2) ^ 2 / ((sum(loadings2)^ 2)  + sum(1 - loadings2 ^ 2))	

loadings3 <- standardizedSolution(mod_med2_fa_naq1_lid_des2) %>%	
 dplyr::filter(op == "=~", lhs == "naq_R") %>% dplyr::select(est.std)
com_rel3 <- sum(loadings3) ^ 2 / ((sum(loadings3)^ 2)  + sum(1 - loadings3 ^ 2))	

avg_var <- sum(loadings ^ 2) / nrow(loadings)	
avg_var2 <- sum(loadings2 ^ 2) / nrow(loadings2)	
avg_var3 <- sum(loadings3 ^ 2) / nrow(loadings3)	

cr_ave2<-
data.frame(
Constructo=c("Liderazgos Destructivos","Liderazgo Constructivo","Acoso Laboral"),
AVE=round(c(avg_var,avg_var2,avg_var3),2),
CR=round(c(com_rel,com_rel2,com_rel3),2)
)
#CR=El valor del estadístico debería ser superior a 0,7. regla mínima de aceptación según Nunally (1978) está en una fiabilidad de 0,7 en etapas tempranas de investigación y en un más estricto 0,8 en la investigación básica
options(knitr.kable.NA = '')
data.table(t(round(semTools::reliability(mod_med2_fa_naq1_lid_des2, c("alpha.ord","omega","ave"),return.total=T),2)),keep.rownames = T) %>% 
  dplyr::mutate(rn=dplyr::case_when(rn=="naq_R"~"Acoso Laboral",rn=="LD"~"Liderazgos Destructivos",
                                    rn=="LC"~"Liderazgo Constructivo",T~"Total")) %>% 
  dplyr::left_join(cr_ave2, by=c("rn"="Constructo")) %>% 
  knitr::kable(format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Tabla S30a. Confiabilidad"),
               col.names = c("Constructo","Alfa ordinal","omega", "Varianza Media Extraída/\nAverage variance extracted", "AVE", "Fiabilidad Compuesta"),
               escape=T)%>%
  kableExtra::add_footnote(c("Nota. AVE >0.5, eivdencia de validez convergente; Alfa >=.7"),
                           notation = "none")%>%
    kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 12) %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
```


```{r afc_paso2_rel_2b, echo=T, error=T, warning=FALSE, cache=TRUE, paged.print=TRUE}
loadingsb <- standardizedSolution(mod_med2_fa_naq1_lid_des0b) %>%	
 dplyr::filter(op == "=~", lhs == "WB_LD") %>% dplyr::select(est.std)
com_relb <- sum(loadingsb) ^ 2 / ((sum(loadingsb)^ 2)  + sum(1 - loadingsb ^ 2))	

loadings2b <- standardizedSolution(mod_med2_fa_naq1_lid_des0b) %>%	
 dplyr::filter(op == "=~", lhs == "lid_cons") %>% dplyr::select(est.std)
com_rel2b <- sum(loadings2b) ^ 2 / ((sum(loadings2b)^ 2)  + sum(1 - loadings2b ^ 2))	

avg_varb <- sum(loadingsb ^ 2) / nrow(loadingsb)	
avg_var2b <- sum(loadings2b ^ 2) / nrow(loadings2b)	

cr_ave2b<-
data.frame(
Constructo=c("Acoso Laboral y Liderazgos Destructivos","Liderazgo Constructivo"),
AVE=round(c(avg_varb,avg_var2b),2),
CR=round(c(com_relb,com_rel2b),2)
)
#CR=El valor del estadístico debería ser superior a 0,7. regla mínima de aceptación según Nunally (1978) está en una fiabilidad de 0,7 en etapas tempranas de investigación y en un más estricto 0,8 en la investigación básica
options(knitr.kable.NA = '')
data.table(t(round(semTools::reliability(mod_med2_fa_naq1_lid_des0b, c("alpha.ord","omega","ave"),return.total=T),2)),keep.rownames = T) %>% 
  dplyr::mutate(rn=dplyr::case_when(rn=="WB_LD"~"Acoso Laboral y Liderazgos Destructivos",
                                    rn=="lid_cons"~"Liderazgo Constructivo",T~"Total")) %>% 
  dplyr::left_join(cr_ave2b, by=c("rn"="Constructo")) %>% 
  knitr::kable(format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Tabla S30b. Confiabilidad"),
               col.names = c("Constructo","Alfa ordinal","omega","Varianza Media Extraída/\nAverage variance extracted", "AVE", "Fiabilidad Compuesta"),
               escape=T)%>%
    kableExtra::add_footnote(c("Nota. AVE >0.5, eivdencia de validez convergente; Alfa >=.7"),
                           notation = "none")%>%
    kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 12) %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
```

<br>

`r invisible("Tell u what - poor fitness indexes mean failed construct validity. And poor AVE means failed convergent validity. Plus, low CR means the construct failed composite reliability.")`

De todas maneras, para dar mayor evidencia de consistencia interna a priori, utilizamos el $\beta$ de Revelle, que es indicador de la peor confiabilidad partida en correlaciones policóricas entre las respuestas ordinales [@Revelle2005].

<br>

```{r afc_paso2_rel2_2, echo=T, cache= T, paged.print=TRUE, warning=F, error=T}
df_splithalf_2<-
data.frame(
rbind(
c(Variable="Acoso Laboral",Revelle_B=round(splitHalf(BD_2020_input_num[paste0("naq",1:22)],check.keys=T)$minrb,2)),
c("Acoso Laboral y Lid. Destructivos",Revelle_B=round(splitHalf(BD_2020_input_num[c(paste0("naq",1:22),paste0("lid_des",c(5,7,9,1,4,8,10)))],check.keys=T)$minrb,2)),
c("Lid. Constructivo",round(splitHalf(BD_2020_input_num[paste0("lid_des",c(6,11,12,14))],check.keys=T)$minrb,2)),
c("Lid. Destructivos",round(splitHalf(BD_2020_input_num[paste0("lid_des",c(5,7,9,1,4,8,10))],check.keys=T)$minrb,2)),
c("Distrés Psicológico (K6)",round(splitHalf(BD_2020_input_num[paste0("a47_top_",1:6)] %>% 
              dplyr::mutate_all(~as.numeric(.)),check.keys=T)$minrb,2))
  )
)

df_splithalf_2 %>% 
  knitr::kable(format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Tabla S31. Confiabilidad"),
               col.names = c("Variable", "Revelle's β "),
               escape=T)%>%
    kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 12) %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
```

<br>

A partir de la tabla anterior, se puede señalar que todas las variables latentes presentaron una confiabilidad más alta que el punto de corte establecido .5.

<br>

```{r paso2_mi_res_2,eval=T, echo=T, paged.print=TRUE, eval=T}
cor_table2 <- residuals(mod_med2_fa_naq1_lid_des2, type = "standardized")$cov

cor_table2[lower.tri(cor_table2)] <- NA # erase the upper triangle
diag(cor_table2) <- NA # erase the diagonal 0's

 knitr::kable(cor_table2,digits=2,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Tabla S32. Matriz de Residuos Estandarizados, Modelo sin ítem 3 Liderazgo Destructivo"),
               align =c('l',rep('c', 101)))%>%
         kableExtra::column_spec(match("naq7",attr(cor_table2,"dimnames")[[2]])+1,bold= T, color= "black", background= "white")%>%
kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 10) %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
```

<br>

Atendiendo a la inquietud presentada en la revisión del formato de los ítemes, se presentan los índices de modificación en ambos modelos, sin haber eliminado ítems. Se examinaron aquellos parámetros de modificación que presentaran un índice de modifcación (MI) mayor a 5 y cambios esperados del parámetro (Expected Parameter Change o SEPC) mayores a 0,2 [@Whittaker2012].

<br>

```{r afc_paso2_mi_2,eval=T, echo=T, paged.print=TRUE, eval=T}
segundo_modelo_mis<-
  subset(lavaan::modindices(mod_med2_fa_naq1_lid_des2)[order(lavaan::modindices(mod_med2_fa_naq1_lid_des2)$mi, decreasing=TRUE), ], mi > 5 & abs(sepc.all)>0.2)%>%
  data.frame()%>%
  dplyr::mutate(lhs=paste0(lhs,op,rhs))%>%
  dplyr::mutate(mi=sprintf("%04.2f",mi))%>%
  dplyr::mutate(sepc.all=sprintf("%04.2f",sepc.all))%>%
  dplyr::select(lhs,mi,sepc.all)


  # subset(lavaan::modindices(mod_med2_fa_naq1_lid_des2)[order(lavaan::modindices(mod_med2_fa_naq1_lid_des2)$mi, decreasing=TRUE), ], mi > 5 & abs(sepc.all)>0.2)%>%
  # data.frame()%>%
  #   melt()
  # group_by(Item, Month) %>%
  # summarise(value = mean(value))
  
  knitr::kable(segundo_modelo_mis,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Tabla S33a. Índices de Modificación, Modelo Sin ítem 3, Liderazgos Destructivos"),
               align =c('l',rep('c', 101)),
              col.names = c("Relación entre variables","Índice de Modificación", "Cambio esperado del parámetro Estandarizado (SEPC)"),
               escape=T)%>%
    kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 13) %>%
    kableExtra::row_spec(which(grepl("lid_des7",segundo_modelo_mis$lhs)), bold= T)%>% #, color= "white", background= "tomato"
  kableExtra::add_footnote(c("Nota. En negrita, parámetros a estudiar por contener un término cuya eliminación mejoraría ostensiblemente el ajuste a os datos del modelo","=~ : efecto de una variable observada en una variable latente","~~: covarianza entre los errores de dos variables observadas","NAQ-R= Acoso Laboral; LC= Liderazgo Constructivo; LD= Liderazgos Destructivos"),
                            notation = "none")%>%
  kableExtra::scroll_box(width = "100%", height = "375px")
```

<br>

Se puede observar que los ítems con mayores índices de modificación son los ítemes 13 de la escala de liderazgos destructivos, seguido por el ítem 22 de acoso laboral, y los ítems 1, 12 y 14 de la escala de liderazgos destructivos.

<br>

```{r afc_paso2_mi_2b,eval=T, echo=T, paged.print=TRUE, eval=T}
segundo_modelo_mis_b<-
  subset(lavaan::modindices(mod_med2_fa_naq1_lid_des0b)[order(lavaan::modindices(mod_med2_fa_naq1_lid_des0b)$mi, decreasing=TRUE), ], mi > 5 & abs(sepc.all)>0.2)%>%
  data.frame()%>%
  dplyr::mutate(lhs=paste0(lhs,op,rhs))%>%
  dplyr::mutate(mi=sprintf("%04.2f",mi))%>%
  dplyr::mutate(sepc.all=sprintf("%04.2f",sepc.all))%>%
  dplyr::select(lhs,mi,sepc.all)

  
  knitr::kable(segundo_modelo_mis_b,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Tabla S33b. Índices de Modificación, Modelo Sin ítem 3, 2 factores"),
               align =c('l',rep('c', 101)),
              col.names = c("Relación entre variables","Índice de Modificación", "Cambio esperado del parámetro Estandarizado (SEPC)"),
               escape=T)%>%
    kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 13) %>%
  #  kableExtra::row_spec(which(grepl("lid_des7",segundo_modelo_mis$lhs)), bold= T)%>% #, color= "white", background= "tomato"
 # kableExtra::add_footnote(c("Nota. En negrita, parámetros a estudiar por contener un término cuya eliminación mejoraría ostensiblemente el ajuste a os datos del modelo","=~ : efecto de una variable observada en una variable latente","~~: covarianza entre los errores de dos variables observadas","NAQ-R= Acoso Laboral; LC= Liderazgo Constructivo; LD= Liderazgos Destructivos"),
 #                           notation = "none")%>%
  kableExtra::scroll_box(width = "100%", height = "375px")
```

<br>

Se puede observar que los ítems con mayores índices de modificación son los ítemes 13 y 12 de liderazgos destructivos, sumado al ítem 22 y 3 de acoso laboral.

<br>

# Descripción de Variables Seleccionadas y Recodificadas

<br>

**En primer lugar, se generaron las variables de suma de puntajes dicotomizados, suma de puntajes brutos, entre otras**.

<br>

```{r paso3_asignar_var_factor,eval=T, echo=T, paged.print=TRUE, eval=T}
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_Definir Postestratificación#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

pred_scores_latent_factors<-lavPredict(mod_med2_fa_naq1_lid_des2) 

# +1 = 1 standard deviation above the mean
# +0.35 = 0.35 standard deviation above the mean
# 0.00 = score equal to the mean
# -0.25 = 0.25 standard deviation below the mean
# - 2.30 = 2.30 standard deviation below the mean
# values greater than |3.0|
# or
# values greater than |4.0| --> see if they are outliers (could be just asymmetric data)

#DescTools::Quantile(lc_sum$lc2, weights=BD_2020_input$weight, probs=c(.25, .5, .75))

BD_2020_input%>%
dplyr::mutate_at(.vars= vars(naq1, naq2, naq3,naq4, naq5, naq6, naq7, naq8, naq9, naq10, naq11, naq12, naq13, naq14, naq15, naq16, naq17, naq18, naq19, naq20, naq21, naq22),.funs = ~as.numeric(.)-1)%>%
  dplyr::mutate_at(.vars= vars(lid_des1, lid_des2, lid_des3,lid_des4, lid_des5, lid_des6, lid_des7, lid_des8, lid_des9, lid_des10, lid_des11, lid_des12, lid_des13, lid_des14),.funs = ~as.numeric(.)-1)%>%
  #OCT 2021= Liderazgo constructivo conserva ítems 2 y 13.
  dplyr::mutate(lc2 = rowSums(dplyr::select(., .dots = paste0("lid_des",c(2,6,11,12,13,14))),na.rm=T))%>%
  dplyr::mutate(lf2 = rowSums(dplyr::select(., .dots = paste0("lid_des",c(5,7,9))),na.rm=T))%>%
  dplyr::mutate(la = rowSums(dplyr::select(., .dots = paste0("lid_des",c(1,4,8,10))),na.rm=T))%>%
  dplyr::mutate(lid_des_sum = rowSums(dplyr::select(., .dots = paste0("lid_des",c(5,7,9,1,4,8,10))),na.rm=T))%>%

  dplyr::mutate(across(paste0("naq",1:22), ~car::recode(.,"3:4=1;0:2=0"),.names="{col}_rec"))%>%
  dplyr::mutate(across(paste0("lid_des",1:14), ~car::recode(.,"2:3=1;0:1=0"),.names="{col}_rec"))%>%
  
  dplyr::mutate(naq_dic = rowSums(dplyr::select(., .dots = paste0("naq",1:22,"_rec")),na.rm=T))%>%
  dplyr::mutate(naq_dic_logit = car::recode(naq_dic,"0=0;1=1;2:hi=2"))%>%
  dplyr::mutate(naq_dic_autocat = dplyr::case_when(autonaq==2 & naq_dic_logit==2~2,
                                                   autonaq==2 & naq_dic_logit<2~1,
                                                   TRUE~0))%>%
  dplyr::mutate(naq_dic_autocat = as.factor(naq_dic_autocat))%>%
  dplyr::mutate(naq_sum_cuartil = car::recode(naq_sum,"0:0=0;1:4=1;5:10=2;11:hi=3"))%>%
  dplyr::mutate(naq_sum_cuartil_ord = factor(car::recode(naq_sum,"0:0=0;1:4=1;5:10=2;11:hi=3"),
                                             labels=c("0","1","2","3"),ordered=T))%>%
  dplyr::mutate(lc_sum_cuartil = car::recode(lc,"1:4=0;5:8=1;9:12=2;13:hi=3"))%>%
  dplyr::mutate(lc_sum_cuartil_ord = factor(lc_sum_cuartil,
                                            labels=c("0","1","2","3"), ordered=T))%>%
  #OCT 2021= Liderazgo constructivo conserva ítems 2 y 13.
  dplyr::mutate(lc_rec = rowSums(dplyr::select(., .dots = paste0("lid_des",c(2,6,11,12,13,14),"_rec")),na.rm=T))%>%
  dplyr::mutate(lc_rec = car::recode(lc_rec,"4:hi=4"))%>%
  dplyr::mutate(lc_rec_logit = car::recode(lc_rec,"0=2;1=1;2:hi=0"))%>%
  
  dplyr::mutate(lid_des_dic = rowSums(dplyr::select(., .dots = paste0("lid_des",c(5,7,9,1,4,8,10),"_rec")),na.rm=T))%>%
  dplyr::mutate(lid_des_dic = car::recode(lid_des_dic,"4:7=4"))%>% #ojo, esto no estaba tan claro en stata
  dplyr::mutate(lid_des_sum_cuartil = car::recode(lid_des_sum,"0=0;1:2=1;3:4=2;5:hi=3"))%>%
  dplyr::mutate(lid_des_sum_cuartil_ord = factor(car::recode(lid_des_sum,"0=0;1:2=1;3:4=2;5:hi=3"),
                labels=c("0","1","2","3"),ordered=T))%>%
  dplyr::mutate(lid_des_dic_logit = car::recode(lid_des_dic,"0=0;1=1;2:hi=2"))%>%

  dplyr::mutate(lf_dic = rowSums(dplyr::select(., .dots = paste0("lid_des",c(5,7,9),"_rec")),na.rm=T))%>%#,1,4,8,10
  dplyr::mutate(lf_dic = car::recode(lf_dic,"4:7=4"))%>% #ojo, esto no estaba tan claro en stata
  
  dplyr::mutate(la_dic = rowSums(dplyr::select(., .dots = paste0("lid_des",c(1,4,8,10),"_rec")),na.rm=T))%>%#,
  dplyr::mutate(la_dic = car::recode(la_dic,"4:7=4"))%>% #ojo, esto no estaba tan claro en stata
  
  dplyr::mutate(k2_elevado_num = ifelse(as.numeric(k2_elevado)==2,1,0))%>%

dplyr::mutate_at(.vars= vars(naq1, naq2, naq3,naq4, naq5, naq6, naq7, naq8, naq9, naq10, naq11, naq12, naq13, naq14, naq15, naq16, naq17, naq18, naq19, naq20, naq21, naq22),.funs = ~factor(.))%>%
  dplyr::mutate_at(.vars= vars(lid_des1, lid_des2, lid_des3,lid_des4, lid_des5, lid_des6, lid_des7, lid_des8, lid_des9, lid_des10, lid_des11, lid_des12, lid_des13, lid_des14),.funs = ~factor(.))%>%
  dplyr::mutate_at(.vars= vars(lc_rec_logit, naq_dic_logit, lid_des_dic_logit, naq_sum_cuartil, lid_des_sum_cuartil,lc_sum_cuartil),.funs = ~factor(.+1))%>%
 #janitor::tabyl(la2,la_rec)
  assign("BD_2020_input",., envir = .GlobalEnv)

invisible(
 c("lf_rec_logit", "la_rec_logit", "lc_rec_logit", 
               "naq_dic_logit", "lid_des_dic_logit", 
               "naq_sum_cuartil", "lid_des_sum_cuartil")
)
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#Se hace numerica la variable
#BD_2020_input$k2_elevado_num <- as.numeric(BD_2020_input$k2_elevado == "2")

dsgn_BD_05_02 <- survey::svydesign(ids = ~1, data = BD_2020_input, weights = ~weight)

dsgn_mujer<- subset(BD_2020_input,mujer==1)
dsgn_hombre<- subset(BD_2020_input,mujer==0)
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

BD_2020_input%>%
dplyr::mutate_at(.vars= vars(naq1, naq2, naq3,naq4, naq5, naq6, naq7, naq8, naq9, naq10, naq11, naq12, naq13, naq14, naq15, naq16, naq17, naq18, naq19, naq20, naq21, naq22),.funs = ~as.numeric(.)-1)%>%
  dplyr::mutate_at(.vars= vars(lid_des1, lid_des2, lid_des3,lid_des4, lid_des5, lid_des6, lid_des7, lid_des8, lid_des9, lid_des10, lid_des11, lid_des12, lid_des13, lid_des14),.funs = ~as.numeric(.)-1)%>%
    dplyr::mutate_at(.vars= vars(a47_top_1, a47_top_2, a47_top_3,a47_top_4, a47_top_5, a47_top_6),.funs = ~as.numeric(.)-1)%>%
  assign("BD_2020_input_num",., envir = .GlobalEnv)
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

n<- c("naq_sum", "naq_r_ap_sum", "naq_r_rt_sum", "naq_r_af_sum", "lc2","la", "lf2", "lid_des_sum", "k6_2")
desc<-data.frame()
for (i in c("naq_sum", "naq_r_ap_sum", "naq_r_rt_sum", 
            "naq_r_af_sum", "lc2","la", "lf2", 
            "lid_des_sum", "k6_2")) {
  dat<- data.frame("M (DE)"= paste0(round(unlist(svymean(as.formula(paste0("~",i)),dsgn_BD_05_02,na.rm=T))[1],2)," (",
                                                         sprintf("%4.2f",round(Weighted.Desc.Stat::w.sd(BD_2020_input[i], BD_2020_input$weight),2)),")")                                        )
  desc<- rbind(desc, dat)
}
desc<-
desc%>%
  dplyr::mutate(Variable=c("Suma de puntajes brutos NAQ-R",
                      "Suma de puntajes brutos Acoso dirigido a la Persona",
                      "Suma de puntajes brutos Rel. con el Trabajo",
                      "Suma de puntajes brutos Acoso Físico",
                      "Suma de puntajes brutos Lid. Constructivo (ít. 2,6,11,12 & 14)",
                      "Suma de puntajes brutos Lid. Autoritario (ít. 1,4,8 & 10)",
                      "Suma de puntajes brutos Lid. Laissez-Faire (ít. 5,7 & 9)",
                      "Suma de puntajes brutos Lid. Destructivos (ít. 5,7,9,1,4,8 & 10)",
                      "Suma de puntajes brutos Distrés Psicológico"))%>%
  dplyr::select(Variable,everything())

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#2021-11-01
rowise_mean_sds<-
rbind.data.frame(
cbind("Suma de puntajes brutos NAQ-R", sprintf("%4.2f",Hmisc::wtd.mean(apply(BD_2020_input_num[,paste0("naq",1:22)], 1, mean, na.rm = TRUE), weights=BD_2020_input_num$weight, normwt="ignored", na.rm=TRUE)),
sprintf("%4.2f",Hmisc::wtd.mean(apply(BD_2020_input_num[,paste0("naq",1:22)], 1, sd, na.rm = TRUE), weights=BD_2020_input_num$weight, normwt="ignored", na.rm=TRUE))),

cbind("Suma de puntajes brutos Lid. Constructivo (ít. 2,6,11,12 & 14)",
sprintf("%4.2f",Hmisc::wtd.mean(apply(BD_2020_input_num[,paste0("lid_des",c(2,6,11,12,13,14))], 1, mean, na.rm = TRUE), weights=BD_2020_input_num$weight, normwt="ignored", na.rm=TRUE)),
sprintf("%4.2f",Hmisc::wtd.mean(apply(BD_2020_input_num[,paste0("lid_des",c(2,6,11,12,13,14))], 1, sd, na.rm = TRUE), weights=BD_2020_input_num$weight, normwt="ignored", na.rm=TRUE))),

cbind("Suma de puntajes brutos Lid. Destructivos (ít. 5,7,9,1,4,8 & 10)",
sprintf("%4.2f",Hmisc::wtd.mean(apply(BD_2020_input_num[,paste0("lid_des",c(5,7,9,1,4,8,10))], 1, mean, na.rm = TRUE), weights=BD_2020_input_num$weight, normwt="ignored", na.rm=TRUE)),
sprintf("%4.2f",Hmisc::wtd.mean(apply(BD_2020_input_num[,paste0("lid_des",c(5,7,9,1,4,8,10))], 1, sd, na.rm = TRUE), weights=BD_2020_input_num$weight, normwt="ignored", na.rm=TRUE))),

cbind("Suma de puntajes brutos Distrés Psicológico",
sprintf("%4.2f",Hmisc::wtd.mean(apply(BD_2020_input_num[,paste0("a47_top_",1:6)], 1, mean, na.rm = TRUE), weights=BD_2020_input_num$weight, normwt="ignored", na.rm=TRUE)),
sprintf("%4.2f",Hmisc::wtd.mean(apply(BD_2020_input_num[,paste0("a47_top_",1:6)], 1, sd, na.rm = TRUE), weights=BD_2020_input_num$weight, normwt="ignored", na.rm=TRUE)))
)

desc<-
desc%>%
dplyr::left_join(rowise_mean_sds,by=c("Variable"="V1")) %>% 
  dplyr::rename("rwM"="V2", "rwSD"="V3")
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

#pearson
set.seed(123)
cor_wtd<-svycor(~naq_sum+ naq_r_ap_sum+ naq_r_rt_sum+ naq_r_af_sum+ lc2+la+ lf2+ lid_des_sum+ k6_2
, design = dsgn_BD_05_02, digits = 2, sig.stats = TRUE, bootn = 10000, mean1 = TRUE)

cor_wtd_sig<-
data.frame(cbind(cor=data.table(round(matrix(cor_wtd$cors),2)),
p=data.table(matrix(cor_wtd$p.values))))%>%
  dplyr::rename("cor"="cor.V1","p"="p.V1")%>%
  dplyr::mutate(cor=dplyr::case_when(p<.001~paste0(sprintf("%4.2f",cor),"***"),
                    p<.01~paste0(sprintf("%4.2f",cor),"**"),
                    p<.05~paste0(sprintf("%4.2f",cor),"*"),
                    TRUE~paste0(sprintf("%4.2f",cor))))%>%
  dplyr::mutate(cor=ifelse(grepl("1.00",cor),"",cor))%>%
  dplyr::select(-p)

# melt(data.table(cor_wtd$cors,keep.rownames = T)) %>% 
#     dplyr::mutate(join=paste0(rn,"_",variable)) %>% 
#     melt(data.table(cor_wtd$p.values,keep.rownames = T))

pearson<-
data.frame(Vars=cbind(c("naq_sum", "naq_r_ap_sum", "naq_r_rt_sum", "naq_r_af_sum", "lc2","la", "lf2", "lid_des_sum", "k6_2"),
      `1`=cor_wtd_sig[1:length(n),],
      `2`=cor_wtd_sig[(length(n)*1)+1:(length(n)*1),],
      `3`=cor_wtd_sig[(length(n)*2)+1:(length(n)*1),],
      `4`=cor_wtd_sig[(length(n)*3)+1:(length(n)*1),],
      `5`=cor_wtd_sig[(length(n)*4)+1:(length(n)*1),],
      `6`=cor_wtd_sig[(length(n)*5)+1:(length(n)*1),],
      `7`=cor_wtd_sig[(length(n)*6)+1:(length(n)*1),],
      `8`=cor_wtd_sig[(length(n)*7)+1:(length(n)*1),],
      `9`=cor_wtd_sig[(length(n)*8)+1:(length(n)*1),]))

alfas<-c(as.numeric(round(psych::alpha(BD_2020_input_num[paste0("naq",1:22)],check.keys=TRUE)$total$raw_alpha,2)),
      as.numeric(round(psych::alpha(BD_2020_input_num[paste0("naq",c(2,4,5,6,7,10,11,12,13,15,17,20))],check.keys=TRUE)$total$raw_alpha,2)),
      as.numeric(round(psych::alpha(BD_2020_input_num[paste0("naq",c(1,3,14,16,18,19,21))],check.keys=TRUE)$total$raw_alpha,2)),
      as.numeric(round(psych::alpha(BD_2020_input_num[paste0("naq",c(8,9,22))],check.keys=TRUE)$total$raw_alpha,2)),
      as.numeric(round(psych::alpha(BD_2020_input_num[paste0("lid_des",c(6,11,12,14))],check.keys=TRUE)$total$raw_alpha,2)),
      as.numeric(round(psych::alpha(BD_2020_input_num[paste0("lid_des",c(1,4,8,10))],check.keys=TRUE)$total$raw_alpha,2)),
      as.numeric(round(psych::alpha(BD_2020_input_num[paste0("lid_des",c(5,7,9))],check.keys=TRUE)$total$raw_alpha,2)),
      as.numeric(round(psych::alpha(BD_2020_input_num[paste0("lid_des",c(5,7,9,1,4,8,10))],check.keys=TRUE)$total$raw_alpha,2)),
      as.numeric(round(psych::alpha(BD_2020_input_num[paste0("a47_top_",1:6)],check.keys=TRUE)$total$raw_alpha,2))
                 )

for (i in (1:length(alfas))){
      pearson[i,colnames(pearson)[2:length(colnames(pearson))][i]]<-sprintf("%4.2f",alfas[i])
}

data.frame(cbind(desc,pearson[-1]))%>%
  dplyr::select_all(~gsub("^Vars", "", .))%>%
  knitr::kable(.,format = "html", format.args = list(decimal.mark = ",", big.mark = "."),
               caption = paste0("Tabla S34. Resumen de Variables Seleccionadas, Suma de Ítems (Ponderada)"),
               col.names = c("Variable","M (DE)","M (por fila)","DE (por fila)",  paste0(1:9)))%>%
      kableExtra::add_footnote(c("Nota. Alfa de cronbach en diagonal"), 
                            notation = "none")%>%
  kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 10)%>%
  kableExtra::scroll_box(width = "100%", height = "375px")
```

<br>

Usando el criterio Leymann [-@Leymann1990], resultó más prevalente el Lid. Constructivo (`r scales::percent(sum(round(prop.table(svytable(~lc_rec_logit, dsgn_BD_05_02)),3)[1:2],na.rm=T))`), seguido por Laissez-Faire (`r scales::percent(sum(round(prop.table(svytable(~lf_dic, dsgn_BD_05_02)),3)[2:5],na.rm=T))`), y Autoritario (`r scales::percent(sum(round(prop.table(svytable(~la_dic, dsgn_BD_05_02)),3)[2:5]))`). Usando el criterio estricto propuesto por Mikkelsen & Einarsen [-@Mikkelsen2001], el porcentaje de trabajadores(as) que reportan acoso es de `r scales::percent(sum(round(prop.table(svytable(~naq_dic_logit, dsgn_BD_05_02)),3)[3:10],na.rm=T))` y liderazgos destructivos, `r scales::percent(sum(prop.table(svytable(~lid_des_dic, dsgn_BD_05_02))[3:5]))`, mientras que quienes se identifican como acosados una vez presentada una definición de acoso laboral es de `r scales::percent(sum(round(prop.table(svytable(~autonaq, dsgn_BD_05_02)),3)[2:4],na.rm=T))`. El `r scales::percent(sum(prop.table(svytable(~lid_des_dic, dsgn_BD_05_02))[2:5]))` mostró exposición a algún tipo de liderazgo destructivo. Por último, quienes se identifican como acosados y a la vez dos o más conductas de acoso es de `r scales::percent(sum(round(prop.table(svytable(~naq_dic_autocat, dsgn_BD_05_02)),3)[3:4],na.rm=T))`.

<br>

# Asociaciones con Variables (Razón de Prevalencia)

Después de recodificar las variables de acuerdo a las reespecificaciones al instrumento DLS, indagamos en las asociaciones entre conductas negativas y estilos de liderazgo.

<br>

### Distrés

```{r paso3a_pr_raw,eval=T, echo=T, paged.print=TRUE, eval=T}
# CREA LA VARIABLE CON EL AJUSTE DEL MODELO CRUDO
options(knitr.kable.NA = '')
PRraw<-data.table()
for(scale in  c("k2_elevado==2")){
  for(var in c("naq_dic_logit", 
                "lc_rec_logit", "lid_des_dic_logit",
               "naq_sum_cuartil", "lid_des_sum_cuartil","naq_dic_autocat")){
    # dynamically generate formula
    fmla <- as.formula(paste0(scale, " ~ ", factor(var)))
    
    # fit glm model
    assign(paste0("svyglm_",as.character(scale),"_",as.character(var)), svyglm(fmla, design=dsgn_BD_05_02, family=quasipoisson(link=log)))
    fit <- svyglm(fmla, design=dsgn_BD_05_02, family=quasipoisson(link=log))
    #print(round(Epi::ci.lin(fit, Exp=T),3))
    PRraw<- rbind(PRraw,paste0("svyglm2_",as.character(scale),"_",as.character(var)),data.table(data.table(round(Epi::ci.lin(fit, Exp=T),3),keep.rownames = T)), fill=T)
  }
}
PRraw_mod<-
PRraw%>%
  dplyr::rename("Modelo"="x","Categoría"="rn")%>%
    dplyr::mutate(Modelo=dplyr::case_when(grepl("lf_rec",Modelo)~"Suma dicotomizada de Liderazgos Laissez-Faire",
                                        grepl("la_rec",Modelo)~"Suma dicotomizada de Liderazgos Autoritarios",
                                        grepl("lc_rec",Modelo)~"Suma dicotomizada de Liderazgos Constructivos",
                                        grepl("naq_dic_logit",Modelo)~"Suma dicotomizada de Conductas Negativas",
                                        grepl("lid_des_dic",Modelo)~"Suma dicotomizada de Liderazgos Destructivos",
                                        grepl("naq_sum_cuartil",Modelo)~"Suma de puntajes brutos de Conductas Negativas (en cuartiles)",
                                        grepl("lid_des_sum_cuartil",Modelo)~"Suma de puntajes brutos de Conductas Negativas (en cuartiles)",
                                        grepl("naq_dic_autocat",Modelo)~"Combinación de Autodefinición y Reporte Conductas Negativas",
                                        TRUE~Modelo))%>%
  data.frame()%>%
  dplyr::filter(!grepl("(Intercept)",Categoría))%>%
  dplyr::mutate(Categoría=dplyr::case_when(grepl("lf_rec_logit2",Categoría)~"1 conducta",
                                           grepl("lf_rec_logit3",Categoría)~"2 o más",
                                           grepl("la_rec_logit2",Categoría)~"1 conducta",
                                           grepl("la_rec_logit3",Categoría)~"2 o más",
                                           grepl("lc_rec_logit2",Categoría)~"1 conducta",
                                           grepl("lc_rec_logit3",Categoría)~"Ausencia conductas",
                                           grepl("naq_dic_logit2",Categoría)~"1 conducta",
                                           grepl("naq_dic_logit3",Categoría)~"2 o más",
                                           grepl("lid_des_dic_logit2",Categoría)~"1 conducta",
                                           grepl("lid_des_dic_logit3",Categoría)~"2 o más",
                                           grepl("naq_sum_cuartil2",Categoría)~"1-4 puntos",
                                           grepl("naq_sum_cuartil3",Categoría)~"5-10 puntos",
                                           grepl("naq_sum_cuartil4",Categoría)~"11 o más",
                                           grepl("lid_des_sum_cuartil2",Categoría)~"1-2 puntos",
                                           grepl("lid_des_sum_cuartil3",Categoría)~"3-4 puntos",
                                           grepl("lid_des_sum_cuartil4",Categoría)~"5 o más",
                                           grepl("naq_dic_autocat1",Categoría)~"Autodefinición",
                                           grepl("naq_dic_autocat2",Categoría)~"Autodefinición y 2 o más conductas"))%>%
  dplyr::mutate(`exp.Est..`=sprintf("%04.2f",`exp.Est..`))%>%
  dplyr::mutate(`exp.Est..`= ifelse(grepl("NA",`exp.Est..`),NA_character_,`exp.Est..`))%>%
  dplyr::mutate(PRraw=`exp.Est..`)%>%
  dplyr::mutate(PRraw=dplyr::case_when(P<.001~paste0(PRraw,"***"),P<.01~paste0(PRraw,"**"),P<.05~paste0(PRraw,"*"),TRUE~PRraw))%>%
  dplyr::mutate(`X2.5.`= sprintf("%04.2f",`X2.5.`))%>%
  dplyr::mutate(`X97.5.`=sprintf("%04.2f",`X97.5.`))%>%
  dplyr::mutate("95% IC"=paste0("[",`X2.5.`,"-",`X97.5.`,"]"))%>%
  dplyr::mutate("95% IC"= ifelse(grepl("NA]",`95% IC`),NA_character_,`95% IC`))%>%
  dplyr::select(Modelo,Categoría,PRraw, "95% IC")
```

```{r paso3b_pr1,eval=T, echo=T, paged.print=TRUE, eval=T}
# CREA LA VARIABLE CON EL AJUSTE DEL MODELO, MAS VAR. GENERO
PR1<-data.table()
for(scale in  c("k2_elevado==2")){
for(var in c("naq_dic_logit", 
                "lc_rec_logit", "lid_des_dic_logit",
               "naq_sum_cuartil", "lid_des_sum_cuartil","naq_dic_autocat")){
    # dynamically generate formula
    fmla <- as.formula(paste0(scale, " ~ ", factor(var), "+ mujer + climasex"))
    
    # fit glm model
    assign(paste0("svyglm2_",as.character(scale),"_",as.character(var)), svyglm(fmla, design=dsgn_BD_05_02, family=quasipoisson(link=log)))
    fit <- svyglm(fmla, design=dsgn_BD_05_02, family=quasipoisson(link=log))
    #print(round(Epi::ci.lin(fit, Exp=T),3))
    PR1<- rbind(PR1,paste0("svyglm2_",as.character(scale),"_",as.character(var)),data.table(data.table(round(Epi::ci.lin(fit, Exp=T),3),keep.rownames = T)), fill=T)
  }
}

PR1_mod<-
PR1%>%
  dplyr::rename("Modelo"="x","Categoría"="rn")%>%
    dplyr::mutate(Modelo=dplyr::case_when(grepl("lf_rec",Modelo)~"Suma dicotomizada de Liderazgos Laissez-Faire",
                                        grepl("la_rec",Modelo)~"Suma dicotomizada de Liderazgos Autoritarios",
                                        grepl("lc_rec",Modelo)~"Suma dicotomizada de Liderazgos Constructivos",
                                        grepl("naq_dic_logit",Modelo)~"Suma dicotomizada de Conductas Negativas",
                                        grepl("lid_des_dic",Modelo)~"Suma dicotomizada de Liderazgos Destructivos",
                                        grepl("naq_sum_cuartil",Modelo)~"Suma de puntajes brutos de Conductas Negativas (en cuartiles)",
                                        grepl("lid_des_sum_cuartil",Modelo)~"Suma de puntajes brutos de Conductas Negativas (en cuartiles)",
                                        grepl("naq_dic_autocat",Modelo)~"Combinación de Autodefinición y Reporte Conductas Negativas",
                                        TRUE~Modelo))%>%
  data.frame()%>%
  dplyr::filter(!grepl("(Intercept)",Categoría))%>%
  dplyr::mutate(Categoría=dplyr::case_when(grepl("lf_rec_logit2",Categoría)~"1 conducta",
                                           grepl("lf_rec_logit3",Categoría)~"2 o más",
                                           grepl("la_rec_logit2",Categoría)~"1 conducta",
                                           grepl("la_rec_logit3",Categoría)~"2 o más",
                                           grepl("lc_rec_logit2",Categoría)~"1 conducta",
                                           grepl("lc_rec_logit3",Categoría)~"Ausencia conductas",
                                           grepl("naq_dic_logit2",Categoría)~"1 conducta",
                                           grepl("naq_dic_logit3",Categoría)~"2 o más",
                                           grepl("lid_des_dic_logit2",Categoría)~"1 conducta",
                                           grepl("lid_des_dic_logit3",Categoría)~"2 o más",
                                           grepl("naq_sum_cuartil2",Categoría)~"1-4 puntos",
                                           grepl("naq_sum_cuartil3",Categoría)~"5-10 puntos",
                                           grepl("naq_sum_cuartil4",Categoría)~"11 o más",
                                           grepl("lid_des_sum_cuartil2",Categoría)~"1-2 puntos",
                                           grepl("lid_des_sum_cuartil3",Categoría)~"3-4 puntos",
                                           grepl("lid_des_sum_cuartil4",Categoría)~"5 o más",
                                           grepl("naq_dic_autocat1",Categoría)~"Autodefinición",
                                           grepl("naq_dic_autocat2",Categoría)~"Autodefinición y 2 o más conductas"))%>%
  dplyr::filter(grepl("*",`Categoría`)|grepl("*",`Modelo`))%>%
  dplyr::mutate(`exp.Est..`=sprintf("%04.2f",`exp.Est..`))%>%
  dplyr::mutate(`exp.Est..`= ifelse(grepl("NA",`exp.Est..`),NA_character_,`exp.Est..`))%>%
  dplyr::mutate(PR1=`exp.Est..`)%>%
  dplyr::mutate(PR1=dplyr::case_when(P<.001~paste0(PR1,"***"),P<.01~paste0(PR1,"**"),P<.05~paste0(PR1,"*"),TRUE~PR1))%>%
  dplyr::mutate(`X2.5.`= sprintf("%04.2f",`X2.5.`))%>%
  dplyr::mutate(`X97.5.`=sprintf("%04.2f",`X97.5.`))%>%
  dplyr::mutate("95% IC"=paste0("[",`X2.5.`,"-",`X97.5.`,"]"))%>%
  dplyr::mutate("95% IC"= ifelse(grepl("NA]",`95% IC`),NA_character_,`95% IC`))%>%
  dplyr::select(Modelo,Categoría,PR1, "95% IC")
```

```{r paso3b_pr2,eval=T, echo=T, paged.print=TRUE, eval=T}
# CREA LA VARIABLE CON EL AJUSTE DEL MODELO, MAS VAR. GENERO Y PREC
PR2<-data.table()
for(scale in  c("k2_elevado==2")){
for(var in c("naq_dic_logit", 
                "lc_rec_logit", "lid_des_dic_logit",
               "naq_sum_cuartil", "lid_des_sum_cuartil", "naq_dic_autocat")){
    # dynamically generate formula
    fmla <- as.formula(paste0(scale, " ~ ", factor(var), "+ mujer + climasex + precr1+ zona+ ocuprev_nocalif"))
    
    # fit glm model
    assign(paste0("svyglm3_",as.character(scale),"_",as.character(var)), svyglm(fmla, design=dsgn_BD_05_02, family=quasipoisson(link=log)))
    fit <- svyglm(fmla, design=dsgn_BD_05_02, family=quasipoisson(link=log))
    #print(round(Epi::ci.lin(fit, Exp=T),3))
    PR2<- rbind(PR2,paste0("svyglm2_",as.character(scale),"_",as.character(var)),data.table(data.table(round(Epi::ci.lin(fit, Exp=T),3),keep.rownames = T)), fill=T)
  }
}
#dsgn_BD_05_02$variables$ocuprev_nocalif

PR2_mod<-
PR2%>%
  dplyr::rename("Modelo"="x","Categoría"="rn")%>%
  data.frame()%>%
  dplyr::mutate(Modelo=dplyr::case_when(grepl("lf_rec",Modelo)~"Suma dicotomizada de Liderazgos Laissez-Faire",
                                        grepl("la_rec",Modelo)~"Suma dicotomizada de Liderazgos Autoritarios",
                                        grepl("lc_rec",Modelo)~"Suma dicotomizada de Liderazgos Constructivos",
                                        grepl("naq_dic_logit",Modelo)~"Suma dicotomizada de Conductas Negativas",
                                        grepl("lid_des_dic",Modelo)~"Suma dicotomizada de Liderazgos Destructivos",
                                        grepl("naq_sum_cuartil",Modelo)~"Suma de puntajes brutos de Conductas Negativas (en cuartiles)",
                                        grepl("lid_des_sum_cuartil",Modelo)~"Suma de puntajes brutos de Conductas Negativas (en cuartiles)",
                                        grepl("naq_dic_autocat",Modelo)~"Combinación de Autodefinición y Reporte Conductas Negativas",
                                        TRUE~Modelo))%>%
  
  dplyr::filter(!grepl("(Intercept)",Categoría))%>%
  dplyr::mutate(Categoría=dplyr::case_when(grepl("lf_rec_logit2",Categoría)~"1 conducta",
                                           grepl("lf_rec_logit3",Categoría)~"2 o más",
                                           grepl("la_rec_logit2",Categoría)~"1 conducta",
                                           grepl("la_rec_logit3",Categoría)~"2 o más",
                                           grepl("lc_rec_logit2",Categoría)~"1 conducta",
                                           grepl("lc_rec_logit3",Categoría)~"Ausencia conductas",
                                           grepl("naq_dic_logit2",Categoría)~"1 conducta",
                                           grepl("naq_dic_logit3",Categoría)~"2 o más",
                                           grepl("lid_des_dic_logit2",Categoría)~"1 conducta",
                                           grepl("lid_des_dic_logit3",Categoría)~"2 o más",
                                           grepl("naq_sum_cuartil2",Categoría)~"1-4 puntos",
                                           grepl("naq_sum_cuartil3",Categoría)~"5-10 puntos",
                                           grepl("naq_sum_cuartil4",Categoría)~"11 o más",
                                           grepl("lid_des_sum_cuartil2",Categoría)~"1-2 puntos",
                                           grepl("lid_des_sum_cuartil3",Categoría)~"3-4 puntos",
                                           grepl("lid_des_sum_cuartil4",Categoría)~"5 o más",
                                           grepl("naq_dic_autocat1",Categoría)~"Autodefinición",
                                           grepl("naq_dic_autocat2",Categoría)~"Autodefinición y 2 o más conductas"))%>%
  dplyr::filter(grepl("*",`Categoría`)|grepl("*",`Modelo`))%>%
  dplyr::mutate(`exp.Est..`=sprintf("%04.2f",`exp.Est..`))%>%
  dplyr::mutate(`exp.Est..`= ifelse(grepl("NA",`exp.Est..`),NA_character_,`exp.Est..`))%>%
  dplyr::mutate(PR2=`exp.Est..`)%>%
  dplyr::mutate(PR2=dplyr::case_when(P<.001~paste0(PR2,"***"),P<.01~paste0(PR2,"**"),P<.05~paste0(PR2,"*"),TRUE~PR2))%>%
  dplyr::mutate(`X2.5.`= sprintf("%04.2f",`X2.5.`))%>%
  dplyr::mutate(`X97.5.`=sprintf("%04.2f",`X97.5.`))%>%
  dplyr::mutate("95% IC"=paste0("[",`X2.5.`,"-",`X97.5.`,"]"))%>%
  dplyr::mutate("95% IC"= ifelse(grepl("NA]",`95% IC`),NA_character_,`95% IC`))%>%
  dplyr::select(Modelo,Categoría,PR2, "95% IC")
```


```{r paso3_modelos_juntos_pr_raw_pr1_pr2,eval=T, echo=T, paged.print=TRUE, eval=T, include=T}
pr_total_para_exp<-
data.frame(cbind.data.frame(data.table(PRraw_mod),data.table(PR1_mod),data.table(PR2_mod)))%>%
  dplyr::select(-Categoría.1,-Categoría.2,-Modelo.1,-Modelo.2)%>%
  dplyr::rename("95% IC"="X95..IC","95% IC."="X95..IC.1","95% IC,"="X95..IC.2")
#copiar_nombres(pr_total_para_exp)

pr_total_para_exp%>%
knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
    caption = paste0("Tabla S35. Razón de Prevalencia, Asociación con Distrés Psicológico"),
    align =c('l',rep('c', 101)))%>%
    kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 10) %>%
    kableExtra::add_footnote( c("PRraw= Modelo Crudo","PR1= Modelo Ajustado por Sexo y Clima Sexista","PR2= Modelo Ajustado por Sexo, Clima Sexista, Precariedad, Zona Residencial Metropolitana y Ocupación"), 
    notation = "none") %>%
    kableExtra::scroll_box(width = "100%", height = "375px")
```

<br>

#### Utilizando sumas
 
```{r paso3a_pr_raw_lineal,eval=T, echo=T, paged.print=TRUE, eval=T}
# CREA LA VARIABLE CON EL AJUSTE DEL MODELO CRUDO

#dsgn_BD_05_02$variables$lid_des_sum
options(knitr.kable.NA = '')
PRraw_cont<-data.table()
for(scale in  c("k2_elevado==2")){
  for(var in c("naq_sum", 
                "lc", "lid_des_sum")){
    # dynamically generate formula
    fmla <- as.formula(paste0(scale, " ~ ", factor(var)))
    
    # fit glm model
    assign(paste0("svyglm_",as.character(scale),"_",as.character(var)), svyglm(fmla, design=dsgn_BD_05_02, family=quasipoisson(link=log)))
    fit <- svyglm(fmla, design=dsgn_BD_05_02, family=quasipoisson(link=log))
    #print(round(Epi::ci.lin(fit, Exp=T),3))
    PRraw_cont<- rbind(PRraw_cont,paste0("svyglm2_",as.character(scale),"_",as.character(var)),data.table(data.table(round(Epi::ci.lin(fit, Exp=T),3),keep.rownames = T)), fill=T)
  }
}
PRraw_mod_cont<-
PRraw_cont%>%
  dplyr::rename("Modelo"="x","Categoría"="rn")%>%
    dplyr::mutate(Modelo=dplyr::case_when(
                                        grepl("lc",Modelo)~"Suma de puntajes brutos de Liderazgos Constructivos",
                                        grepl("lid_des_sum",Modelo)~"Suma de puntajes brutos de Liderazgos Destructivos",
                                        grepl("naq_sum",Modelo)~"Suma de puntajes brutos de Conductas Negativas",
                                        TRUE~Modelo))%>%
  data.frame()%>%
  dplyr::filter(!grepl("(Intercept)",Categoría))%>%
  dplyr::mutate(Categoría=dplyr::case_when(grepl("lf_rec_logit2",Categoría)~"1 conducta",
                                           grepl("lf_rec_logit3",Categoría)~"2 o más",
                                           grepl("la_rec_logit2",Categoría)~"1 conducta",
                                           grepl("la_rec_logit3",Categoría)~"2 o más",
                                           grepl("lc_rec_logit2",Categoría)~"1 conducta",
                                           grepl("lc_rec_logit3",Categoría)~"Ausencia conductas",
                                           grepl("naq_dic_logit2",Categoría)~"1 conducta",
                                           grepl("naq_dic_logit3",Categoría)~"2 o más",
                                           grepl("lid_des_dic_logit2",Categoría)~"1 conducta",
                                           grepl("lid_des_dic_logit3",Categoría)~"2 o más",
                                           grepl("naq_sum_cuartil2",Categoría)~"1-4 puntos",
                                           grepl("naq_sum_cuartil3",Categoría)~"5-10 puntos",
                                           grepl("naq_sum_cuartil4",Categoría)~"11 o más",
                                           grepl("lid_des_sum_cuartil2",Categoría)~"1-2 puntos",
                                           grepl("lid_des_sum_cuartil3",Categoría)~"3-4 puntos",
                                           grepl("lid_des_sum_cuartil4",Categoría)~"5 o más",
                                           grepl("naq_dic_autocat1",Categoría)~"Autodefinición",
                                           grepl("naq_dic_autocat2",Categoría)~"Autodefinición y 2 o más conductas",T~NA_character_))%>%
  dplyr::mutate(`exp.Est..`=sprintf("%04.2f",`exp.Est..`))%>%
  dplyr::mutate(`exp.Est..`= ifelse(grepl("NA",`exp.Est..`),NA_character_,`exp.Est..`))%>%
  dplyr::mutate(PRraw=`exp.Est..`)%>%
  dplyr::mutate(PRraw=dplyr::case_when(P<.001~paste0(PRraw,"***"),P<.01~paste0(PRraw,"**"),P<.05~paste0(PRraw,"*"),TRUE~PRraw))%>%
  dplyr::mutate(`X2.5.`= sprintf("%04.2f",`X2.5.`))%>%
  dplyr::mutate(`X97.5.`=sprintf("%04.2f",`X97.5.`))%>%
  dplyr::mutate("95% IC"=paste0("[",`X2.5.`,"-",`X97.5.`,"]"))%>%
  dplyr::mutate("95% IC"= ifelse(grepl("NA]",`95% IC`),NA_character_,`95% IC`))%>%
  dplyr::select(Modelo,Categoría,PRraw, "95% IC")
```

```{r paso3b_pr1_lineal,eval=T, echo=T, paged.print=TRUE, eval=T}
# CREA LA VARIABLE CON EL AJUSTE DEL MODELO, MAS VAR. GENERO
PR1_cont<-data.table()
for(scale in  c("k2_elevado==2")){
  for(var in c("naq_sum", 
                "lc", "lid_des_sum")){
    # dynamically generate formula
    fmla <- as.formula(paste0(scale, " ~ ", factor(var), "+ mujer + climasex"))
    
    # fit glm model
    assign(paste0("svyglm2_",as.character(scale),"_",as.character(var)), svyglm(fmla, design=dsgn_BD_05_02, family=quasipoisson(link=log)))
    fit <- svyglm(fmla, design=dsgn_BD_05_02, family=quasipoisson(link=log))
    #print(round(Epi::ci.lin(fit, Exp=T),3))
    PR1_cont<- rbind(PR1_cont,paste0("svyglm2_",as.character(scale),"_",as.character(var)),data.table(data.table(round(Epi::ci.lin(fit, Exp=T),3),keep.rownames = T)), fill=T)
  }
}

PR1_mod_cont<-
PR1_cont%>%
  dplyr::rename("Modelo"="x","Categoría"="rn")%>%
    dplyr::mutate(Modelo=dplyr::case_when(grepl("lc",Modelo)~"Suma de puntajes brutos de Liderazgos Constructivos",
                                        grepl("lid_des_sum",Modelo)~"Suma de puntajes brutos de Liderazgos Destructivos",
                                        grepl("naq_sum",Modelo)~"Suma de puntajes brutos de Conductas Negativas",
                                        TRUE~Modelo))%>%
  data.frame()%>%
  dplyr::filter(!grepl("(Intercept)",Categoría))%>%
  dplyr::filter(!grepl("mujer|climasex",`Categoría`))%>%
  dplyr::mutate(Categoría=dplyr::case_when(grepl("lf_rec_logit2",Categoría)~"1 conducta",
                                           grepl("lf_rec_logit3",Categoría)~"2 o más",
                                           grepl("la_rec_logit2",Categoría)~"1 conducta",
                                           grepl("la_rec_logit3",Categoría)~"2 o más",
                                           grepl("lc_rec_logit2",Categoría)~"1 conducta",
                                           grepl("lc_rec_logit3",Categoría)~"Ausencia conductas",
                                           grepl("naq_dic_logit2",Categoría)~"1 conducta",
                                           grepl("naq_dic_logit3",Categoría)~"2 o más",
                                           grepl("lid_des_dic_logit2",Categoría)~"1 conducta",
                                           grepl("lid_des_dic_logit3",Categoría)~"2 o más",
                                           grepl("naq_sum_cuartil2",Categoría)~"1-4 puntos",
                                           grepl("naq_sum_cuartil3",Categoría)~"5-10 puntos",
                                           grepl("naq_sum_cuartil4",Categoría)~"11 o más",
                                           grepl("lid_des_sum_cuartil2",Categoría)~"1-2 puntos",
                                           grepl("lid_des_sum_cuartil3",Categoría)~"3-4 puntos",
                                           grepl("lid_des_sum_cuartil4",Categoría)~"5 o más",
                                           grepl("naq_dic_autocat1",Categoría)~"Autodefinición",
                                           grepl("naq_dic_autocat2",Categoría)~"Autodefinición y 2 o más conductas",T~NA_character_))%>%
  dplyr::mutate(`exp.Est..`=sprintf("%04.2f",`exp.Est..`))%>%
  dplyr::mutate(`exp.Est..`= ifelse(grepl("NA",`exp.Est..`),NA_character_,`exp.Est..`))%>%
  dplyr::mutate(PR1=`exp.Est..`)%>%
  dplyr::mutate(PR1=dplyr::case_when(P<.001~paste0(PR1,"***"),P<.01~paste0(PR1,"**"),P<.05~paste0(PR1,"*"),TRUE~PR1))%>%
  dplyr::mutate(`X2.5.`= sprintf("%04.2f",`X2.5.`))%>%
  dplyr::mutate(`X97.5.`=sprintf("%04.2f",`X97.5.`))%>%
  dplyr::mutate("95% IC"=paste0("[",`X2.5.`,"-",`X97.5.`,"]"))%>%
  dplyr::mutate("95% IC"= ifelse(grepl("NA]",`95% IC`),NA_character_,`95% IC`))%>%
  dplyr::select(Modelo,Categoría,PR1, "95% IC")
```

```{r paso3b_pr2_lineal,eval=T, echo=T, paged.print=TRUE, eval=T}
# CREA LA VARIABLE CON EL AJUSTE DEL MODELO, MAS VAR. GENERO Y PREC
PR2_cont<-data.table()
for(scale in  c("k2_elevado==2")){
  for(var in c("naq_sum", 
                "lc", "lid_des_sum")){
    # dynamically generate formula
    fmla <- as.formula(paste0(scale, " ~ ", factor(var), "+ mujer + climasex + precr1+ zona+ ocuprev_nocalif"))
    
    # fit glm model
    assign(paste0("svyglm3_",as.character(scale),"_",as.character(var)), svyglm(fmla, design=dsgn_BD_05_02, family=quasipoisson(link=log)))
    fit <- svyglm(fmla, design=dsgn_BD_05_02, family=quasipoisson(link=log))
    #print(round(Epi::ci.lin(fit, Exp=T),3))
    PR2_cont<- rbind(PR2_cont,paste0("svyglm2_",as.character(scale),"_",as.character(var)),data.table(data.table(round(Epi::ci.lin(fit, Exp=T),3),keep.rownames = T)), fill=T)
  }
}
#dsgn_BD_05_02$variables$ocuprev_nocalif

PR2_mod_cont<-
PR2_cont%>%
  dplyr::rename("Modelo"="x","Categoría"="rn")%>%
  data.frame()%>%
    dplyr::mutate(Modelo=dplyr::case_when(grepl("lc",Modelo)~"Suma de puntajes brutos de Liderazgos Constructivos",
                                        grepl("lid_des_sum",Modelo)~"Suma de puntajes brutos de Liderazgos Destructivos",
                                        grepl("naq_sum",Modelo)~"Suma de puntajes brutos de Conductas Negativas",
                                        TRUE~Modelo))%>%
  
  dplyr::filter(!grepl("(Intercept)",Categoría))%>%
  dplyr::filter(!grepl("mujer|climasex|precr1|ocuprev_nocalif|zona",`Categoría`))%>%
  dplyr::mutate(Categoría=dplyr::case_when(grepl("lf_rec_logit2",Categoría)~"1 conducta",
                                           grepl("lf_rec_logit3",Categoría)~"2 o más",
                                           grepl("la_rec_logit2",Categoría)~"1 conducta",
                                           grepl("la_rec_logit3",Categoría)~"2 o más",
                                           grepl("lc_rec_logit2",Categoría)~"1 conducta",
                                           grepl("lc_rec_logit3",Categoría)~"Ausencia conductas",
                                           grepl("naq_dic_logit2",Categoría)~"1 conducta",
                                           grepl("naq_dic_logit3",Categoría)~"2 o más",
                                           grepl("lid_des_dic_logit2",Categoría)~"1 conducta",
                                           grepl("lid_des_dic_logit3",Categoría)~"2 o más",
                                           grepl("naq_sum_cuartil2",Categoría)~"1-4 puntos",
                                           grepl("naq_sum_cuartil3",Categoría)~"5-10 puntos",
                                           grepl("naq_sum_cuartil4",Categoría)~"11 o más",
                                           grepl("lid_des_sum_cuartil2",Categoría)~"1-2 puntos",
                                           grepl("lid_des_sum_cuartil3",Categoría)~"3-4 puntos",
                                           grepl("lid_des_sum_cuartil4",Categoría)~"5 o más",
                                           grepl("naq_dic_autocat1",Categoría)~"Autodefinición",
                                           grepl("naq_dic_autocat2",Categoría)~"Autodefinición y 2 o más conductas"))%>%
  dplyr::mutate(`exp.Est..`=sprintf("%04.2f",`exp.Est..`))%>%
  dplyr::mutate(`exp.Est..`= ifelse(grepl("NA",`exp.Est..`),NA_character_,`exp.Est..`))%>%
  dplyr::mutate(PR2=`exp.Est..`)%>%
  dplyr::mutate(PR2=dplyr::case_when(P<.001~paste0(PR2,"***"),P<.01~paste0(PR2,"**"),P<.05~paste0(PR2,"*"),TRUE~PR2))%>%
  dplyr::mutate(`X2.5.`= sprintf("%04.2f",`X2.5.`))%>%
  dplyr::mutate(`X97.5.`=sprintf("%04.2f",`X97.5.`))%>%
  dplyr::mutate("95% IC"=paste0("[",`X2.5.`,"-",`X97.5.`,"]"))%>%
  dplyr::mutate("95% IC"= ifelse(grepl("NA]",`95% IC`),NA_character_,`95% IC`))%>%
  dplyr::select(Modelo,Categoría,PR2, "95% IC")
```


```{r paso3_modelos_juntos_pr_raw_pr1_pr2_lineal,eval=T, echo=T, paged.print=TRUE, eval=T, include=T}
pr_total_para_exp_cont<-
data.frame(cbind.data.frame(data.table(PRraw_mod_cont),data.table(PR1_mod_cont),data.table(PR2_mod_cont)))%>%
  dplyr::select(-Categoría.1,-Categoría.2,-Modelo.1,-Modelo.2)%>%
  dplyr::rename("95% IC"="X95..IC","95% IC_1"="X95..IC.1","95% IC_2"="X95..IC.2")
#copiar_nombres(pr_total_para_exp)

pr_total_para_exp_cont%>%
knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
    caption = paste0("Tabla S36. Razón de Prevalencia, Asociación con Distrés Psicológico"),
    align =c('l',rep('c', 101)),
    escape=T)%>%
    kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 12) %>%
    kableExtra::add_footnote( c("PRraw= Modelo Crudo","PR1= Modelo Ajustado por Sexo y Clima Sexista","PR2= Modelo Ajustado por Sexo, Clima Sexista, Precariedad, Zona Residencial Metropolitana y Ocupación"), 
    notation = "none") %>%
    kableExtra::scroll_box(width = "100%", height = "375px")
```

<br>

Se generan medidas de asociación entre autocategorización de acoso laboral y cada predictor, controlando por todas las variables.

<br>

```{r paso3a_modelo_total_lineal,eval=T, echo=T, paged.print=TRUE, eval=T, include=T}
dependent = "k2_elevado==2"
explanatory = c("naq_sum", "lc", "lid_des_sum", "mujer", "climasex", "precr1", "zona", "ocuprev_nocalif")
ajuste_3a = dsgn_BD_05_02 %>%
  svyglmmulti(dependent, explanatory, family = quasipoisson(link="log"))  %>%
  ff_metrics()

mod1a<-svyglm(k2_elevado == 2 ~ naq_sum+ lc+ lid_des_sum + mujer + climasex + precr1 + zona + 
           ocuprev_nocalif, design=dsgn_BD_05_02, family=quasipoisson(link=log))
Rverosimil=mod1a$null.deviance-mod1a$deviance
pchisq(Rverosimil, 3, lower.tail = FALSE)

if(no_mostrar==0){
logit_lit1a=log(mod1a$fitted.values/(1-mod1a$fitted.values))
summary(logit_lit1a)
plot(mod1a$survey.design$variables$naq_sum,logit_lit1a)
plot(mod1a$survey.design$variables$lid_des_sum,logit_lit1a)
plot(mod1a$survey.design$variables$lc,logit_lit1a)
}

Epi::ci.lin(svyglm(k2_elevado == 2 ~ naq_sum+ lc+ lid_des_sum + mujer + climasex + precr1 + zona + 
           ocuprev_nocalif, design=dsgn_BD_05_02, family=quasipoisson(link=log)), Exp=T)%>%
  data.table(keep.rownames=T)%>%
  data.frame() %>% 
    dplyr::mutate(`exp.Est..`=sprintf("%04.2f",`exp.Est..`))%>%
  dplyr::mutate(`exp.Est..`= ifelse(grepl("NA",`exp.Est..`),NA_character_,`exp.Est..`))%>%
  dplyr::mutate(PR2=`exp.Est..`)%>%
  dplyr::mutate(PR2=dplyr::case_when(P<.001~paste0(PR2,"***"),P<.01~paste0(PR2,"**"),P<.05~paste0(PR2,"*"),TRUE~PR2))%>%
  dplyr::mutate(`X2.5.`= sprintf("%04.2f",`X2.5.`))%>%
  dplyr::mutate(`X97.5.`=sprintf("%04.2f",`X97.5.`))%>%
  dplyr::mutate("95% IC"=paste0("[",`X2.5.`,"-",`X97.5.`,"]"))%>%
  dplyr::mutate("95% IC"= ifelse(grepl("NA]",`95% IC`),NA_character_,`95% IC`))%>%
  dplyr::mutate(Predictora=dplyr::case_when(grepl("lc",rn)~"Suma de puntajes brutos de Liderazgos Constructivos",
                                        grepl("lid_des_sum",rn)~"Suma de puntajes brutos de Liderazgos Destructivos",
                                        grepl("naq_sum",rn)~"Suma de puntajes brutos de Conductas Negativas",
                                        TRUE~NA_character_))%>%  
  dplyr::filter(!is.na(Predictora)) %>% 
  dplyr::select(Predictora, PR2, `95% IC`) %>% 
knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
    caption = paste0("Tabla S37a. Razón de Prevalencia, Incorporando todos los predictores y variables confusoras"),
    align =c('l',rep('c', 101)),
    escape=T)%>%
    kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 12) %>%
    kableExtra::add_footnote( c("Nota. Modelo Ajustado por Sexo, Clima Sexista, Precariedad, Zona Residencial Metropolitana y Ocupación",ajuste_3a), 
    notation = "none") %>%
    kableExtra::scroll_box(width = "100%", height = "375px")
```


```{r paso3b_modelo_total_lineal,eval=T, echo=T, paged.print=TRUE, eval=T, include=T}
# dplyr::mutate(naq_sum_cuartil = car::recode(naq_sum,"0:0=0;1:4=1;5:10=2;11:hi=3"))%>%
#     dplyr::mutate(lc_sum_cuartil = car::recode(lc,"1:4=0;5:8=1;9:12=2;13:hi=3"))%>%
#     dplyr::mutate(lid_des_sum_cuartil = car::recode(lid_des_sum,"0=0;1:2=1;3:4=2;5:hi=3"))%>%
#    
dependent = "k2_elevado==2"
explanatory = c("naq_sum_cuartil", "lc_sum_cuartil", "lid_des_sum_cuartil", "mujer", "climasex", "precr1", "zona", "ocuprev_nocalif")
ajuste_3b = dsgn_BD_05_02 %>%
  svyglmmulti(dependent, explanatory, family = quasipoisson(link="log"))  %>%
  ff_metrics()

mod1b<-svyglm(k2_elevado == 2 ~ naq_sum_cuartil+ lc_sum_cuartil+ lid_des_sum_cuartil + mujer + climasex + precr1 + zona + ocuprev_nocalif, design=dsgn_BD_05_02, family=quasipoisson(link=log))
Rverosimil=mod1b$null.deviance-mod1b$deviance
pchisq(Rverosimil, 3, lower.tail = FALSE)

Epi::ci.lin(svyglm(k2_elevado == 2 ~ naq_sum_cuartil+ lc_sum_cuartil+ lid_des_sum_cuartil + mujer + climasex + precr1 + zona + 
           ocuprev_nocalif, design=dsgn_BD_05_02, family=quasipoisson(link=log)), Exp=T)%>%
  data.table(keep.rownames=T)%>%
  data.frame() %>% 
    dplyr::mutate(rn=dplyr::case_when(grepl("lc_sum_cuartil2",rn)~"LC, 5-8 puntos",
                                           grepl("lc_sum_cuartil3",rn)~"LC, 9-12 puntos",
                                           grepl("lc_sum_cuartil4",rn)~"LC, 13 o más",
                                           grepl("naq_sum_cuartil2",rn)~"NAQ, 1-4 puntos",
                                           grepl("naq_sum_cuartil3",rn)~"NAQ, 5-10 puntos",
                                           grepl("naq_sum_cuartil4",rn)~"NAQ, 11 o más",
                                           grepl("lid_des_sum_cuartil2",rn)~"LD, 1-2 puntos",
                                           grepl("lid_des_sum_cuartil3",rn)~"LD, 3-4 puntos",
                                           grepl("lid_des_sum_cuartil4",rn)~"LD, 5 o más", T~rn))%>%
    dplyr::mutate(`exp.Est..`=sprintf("%04.2f",`exp.Est..`))%>%
  dplyr::mutate(`exp.Est..`= ifelse(grepl("NA",`exp.Est..`),NA_character_,`exp.Est..`))%>%
  dplyr::mutate(PR2=`exp.Est..`)%>%
  dplyr::mutate(PR2=dplyr::case_when(P<.001~paste0(PR2,"***"),P<.01~paste0(PR2,"**"),P<.05~paste0(PR2,"*"),TRUE~PR2))%>%
  dplyr::mutate(`X2.5.`= sprintf("%04.2f",`X2.5.`))%>%
  dplyr::mutate(`X97.5.`=sprintf("%04.2f",`X97.5.`))%>%
  dplyr::mutate("95% IC"=paste0("[",`X2.5.`,"-",`X97.5.`,"]"))%>%
  dplyr::mutate("95% IC"= ifelse(grepl("NA]",`95% IC`),NA_character_,`95% IC`))%>%
  dplyr::filter(grepl("^NAQ|^LC|^LD",rn)) %>% 
  dplyr::select(rn, PR2, `95% IC`) %>% 
knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
    caption = paste0("Tabla S37b. Razón de Prevalencia, Incorporando todos los predictores y variables confusoras"),
    align =c('l',rep('c', 101)),
    escape=T)%>%
    kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 12) %>%
    kableExtra::add_footnote( c("Nota. Modelo Ajustado por Sexo, Clima Sexista, Precariedad, Zona Residencial Metropolitana y Ocupación", ajuste_3b), 
    notation = "none") %>%
    kableExtra::scroll_box(width = "100%", height = "375px")  
```

```{r paso3c_modelo_total_lineal,eval=T, echo=T, paged.print=TRUE, eval=T, include=T}

dependent = "k2_elevado==2"
explanatory = c("naq_sum_cuartil_ord", "lc_sum_cuartil_ord", "lid_des_sum_cuartil_ord", "mujer", "climasex", "precr1", "zona", "ocuprev_nocalif")
ajuste_3c = dsgn_BD_05_02 %>%
  svyglmmulti(dependent, explanatory, family = quasipoisson(link="log"))  %>%
  ff_metrics()

mod1b_ord<-svyglm(k2_elevado == 2 ~ naq_sum_cuartil_ord+ lc_sum_cuartil_ord+ lid_des_sum_cuartil_ord + mujer + climasex + precr1 + zona + ocuprev_nocalif, design=dsgn_BD_05_02, family=quasipoisson(link=log))
Rverosimil=mod1b_ord$null.deviance-mod1b_ord$deviance
pchisq(Rverosimil, 3, lower.tail = FALSE)

#http://people.linguistics.mcgill.ca/~morgan/qmld-book/practical-regression-topics-2-ordered-factors-nonlinear-effects-model-predictions-post-hoc-tests.html
Epi::ci.lin(svyglm(k2_elevado == 2 ~ naq_sum_cuartil_ord+ lc_sum_cuartil_ord+ lid_des_sum_cuartil_ord + mujer + climasex + precr1 + zona + ocuprev_nocalif, design=dsgn_BD_05_02, family=quasipoisson(link=log)), Exp=T)%>%
  data.table(keep.rownames=T)%>%
  data.frame() %>% 
    dplyr::mutate(rn=dplyr::case_when(grepl("lc_sum_cuartil_ord.C",rn)~"LC, 5-8 puntos",
                                           grepl("lc_sum_cuartil_ord.Q",rn)~"LC, 9-12 puntos",
                                           grepl("lc_sum_cuartil_ord.L",rn)~"LC, 13 o más",
                                           grepl("naq_sum_cuartil_ord.C",rn)~"NAQ, 1-4 puntos",
                                           grepl("naq_sum_cuartil_ord.Q",rn)~"NAQ, 5-10 puntos",
                                           grepl("naq_sum_cuartil_ord.L",rn)~"NAQ, 11 o más",
                                           grepl("lid_des_sum_cuartil_ord.C",rn)~"LD, 1-2 puntos",
                                           grepl("lid_des_sum_cuartil_ord.Q",rn)~"LD, 3-4 puntos",
                                           grepl("lid_des_sum_cuartil_ord.L",rn)~"LD, 5 o más", T~rn))%>%
    dplyr::mutate(rn=factor(rn, levels=c("NAQ, 1-4 puntos","NAQ, 5-10 puntos","NAQ, 11 o más","LC, 5-8 puntos","LC, 9-12 puntos","LC, 13 o más","LD, 1-2 puntos","LD, 3-4 puntos","LD, 5 o más"))) %>% 
    #dplyr::arrange(rn) %>% 
    dplyr::mutate(`exp.Est..`=sprintf("%04.2f",`exp.Est..`))%>%
  dplyr::mutate(`exp.Est..`= ifelse(grepl("NA",`exp.Est..`),NA_character_,`exp.Est..`))%>%
  dplyr::mutate(PR2=`exp.Est..`)%>%
  dplyr::mutate(PR2=dplyr::case_when(P<.001~paste0(PR2,"***"),P<.01~paste0(PR2,"**"),P<.05~paste0(PR2,"*"),TRUE~PR2))%>%
  dplyr::mutate(`X2.5.`= sprintf("%04.2f",`X2.5.`))%>%
  dplyr::mutate(`X97.5.`=sprintf("%04.2f",`X97.5.`))%>%
  dplyr::mutate("95% IC"=paste0("[",`X2.5.`,"-",`X97.5.`,"]"))%>%
  dplyr::mutate("95% IC"= ifelse(grepl("NA]",`95% IC`),NA_character_,`95% IC`))%>%
  dplyr::filter(grepl("^NAQ|^LC|^LD",rn)) %>% 
  dplyr::select(rn, PR2, `95% IC`) %>% 
  dplyr::arrange(rn) %>% 
knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
    caption = paste0("Tabla S37c. Razón de Prevalencia, Incorporando todos los predictores y variables confusoras (ordenado)"),
    align =c('l',rep('c', 101)),
    escape=T)%>%
    kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 12) %>%
    kableExtra::add_footnote( c("Nota. Modelo Ajustado por Sexo, Clima Sexista, Precariedad, Zona Residencial Metropolitana y Ocupación", ajuste_3c), 
    notation = "none") %>%
    kableExtra::scroll_box(width = "100%", height = "375px")  
```                                           

<br>

### Autocategorización

#### Utilizando sumas
 
```{r paso4a_pr_raw_lineal,eval=T, echo=T, paged.print=TRUE, eval=T}

options(knitr.kable.NA = '')
PRraw_cont2<-data.table()
for(scale in  c("autonaq==2")){
  for(var in c("naq_sum", 
                "lc", "lid_des_sum")){
    # dynamically generate formula
    fmla <- as.formula(paste0(scale, " ~ ", factor(var)))
    
    # fit glm model
    assign(paste0("svyglm_",as.character(scale),"_",as.character(var)), svyglm(fmla, design=dsgn_BD_05_02, family=quasipoisson(link=log)))
    fit <- svyglm(fmla, design=dsgn_BD_05_02, family=quasipoisson(link=log))
    #print(round(Epi::ci.lin(fit, Exp=T),3))
    PRraw_cont2<- rbind(PRraw_cont2,paste0("svyglm2_",as.character(scale),"_",as.character(var)),data.table(data.table(round(Epi::ci.lin(fit, Exp=T),3),keep.rownames = T)), fill=T)
  }
}
PRraw_mod_cont2<-
PRraw_cont2%>%
  dplyr::rename("Modelo"="x","Categoría"="rn")%>%
    dplyr::mutate(Modelo=dplyr::case_when(
                                        grepl("lc",Modelo)~"Suma de puntajes brutos de Liderazgos Constructivos",
                                        grepl("lid_des_sum",Modelo)~"Suma de puntajes brutos de Liderazgos Destructivos",
                                        grepl("naq_sum",Modelo)~"Suma de puntajes brutos de Conductas Negativas",
                                        TRUE~Modelo))%>%
  data.frame()%>%
  dplyr::filter(!grepl("(Intercept)",Categoría))%>%
  dplyr::mutate(Categoría=dplyr::case_when(grepl("lf_rec_logit2",Categoría)~"1 conducta",
                                           grepl("lf_rec_logit3",Categoría)~"2 o más",
                                           grepl("la_rec_logit2",Categoría)~"1 conducta",
                                           grepl("la_rec_logit3",Categoría)~"2 o más",
                                           grepl("lc_rec_logit2",Categoría)~"1 conducta",
                                           grepl("lc_rec_logit3",Categoría)~"Ausencia conductas",
                                           grepl("naq_dic_logit2",Categoría)~"1 conducta",
                                           grepl("naq_dic_logit3",Categoría)~"2 o más",
                                           grepl("lid_des_dic_logit2",Categoría)~"1 conducta",
                                           grepl("lid_des_dic_logit3",Categoría)~"2 o más",
                                           grepl("naq_sum_cuartil2",Categoría)~"1-4 puntos",
                                           grepl("naq_sum_cuartil3",Categoría)~"5-10 puntos",
                                           grepl("naq_sum_cuartil4",Categoría)~"11 o más",
                                           grepl("lid_des_sum_cuartil2",Categoría)~"1-2 puntos",
                                           grepl("lid_des_sum_cuartil3",Categoría)~"3-4 puntos",
                                           grepl("lid_des_sum_cuartil4",Categoría)~"5 o más",
                                           grepl("naq_dic_autocat1",Categoría)~"Autodefinición",
                                           grepl("naq_dic_autocat2",Categoría)~"Autodefinición y 2 o más conductas",T~NA_character_))%>%
  dplyr::mutate(`exp.Est..`=sprintf("%04.2f",`exp.Est..`))%>%
  dplyr::mutate(`exp.Est..`= ifelse(grepl("NA",`exp.Est..`),NA_character_,`exp.Est..`))%>%
  dplyr::mutate(PRraw=`exp.Est..`)%>%
  dplyr::mutate(PRraw=dplyr::case_when(P<.001~paste0(PRraw,"***"),P<.01~paste0(PRraw,"**"),P<.05~paste0(PRraw,"*"),TRUE~PRraw))%>%
  dplyr::mutate(`X2.5.`= sprintf("%04.2f",`X2.5.`))%>%
  dplyr::mutate(`X97.5.`=sprintf("%04.2f",`X97.5.`))%>%
  dplyr::mutate("95% IC"=paste0("[",`X2.5.`,"-",`X97.5.`,"]"))%>%
  dplyr::mutate("95% IC"= ifelse(grepl("NA]",`95% IC`),NA_character_,`95% IC`))%>%
  dplyr::select(Modelo,Categoría,PRraw, "95% IC")
```

```{r paso4b_pr1_lineal,eval=T, echo=T, paged.print=TRUE, eval=T}
# CREA LA VARIABLE CON EL AJUSTE DEL MODELO, MAS VAR. GENERO
PR1_cont2<-data.table()
for(scale in  c("autonaq==2")){
  for(var in c("naq_sum", 
                "lc", "lid_des_sum")){
    # dynamically generate formula
    fmla <- as.formula(paste0(scale, " ~ ", factor(var), "+ mujer + climasex"))
    
    # fit glm model
    assign(paste0("svyglm2_",as.character(scale),"_",as.character(var)), svyglm(fmla, design=dsgn_BD_05_02, family=quasipoisson(link=log)))
    fit <- svyglm(fmla, design=dsgn_BD_05_02, family=quasipoisson(link=log))
    #print(round(Epi::ci.lin(fit, Exp=T),3))
    PR1_cont2<- rbind(PR1_cont2,paste0("svyglm2_",as.character(scale),"_",as.character(var)),data.table(data.table(round(Epi::ci.lin(fit, Exp=T),3),keep.rownames = T)), fill=T)
  }
}

PR1_mod_cont2<-
PR1_cont2%>%
  dplyr::rename("Modelo"="x","Categoría"="rn")%>%
    dplyr::mutate(Modelo=dplyr::case_when(grepl("lc",Modelo)~"Suma de puntajes brutos de Liderazgos Constructivos",
                                        grepl("lid_des_sum",Modelo)~"Suma de puntajes brutos de Liderazgos Destructivos",
                                        grepl("naq_sum",Modelo)~"Suma de puntajes brutos de Conductas Negativas",
                                        TRUE~Modelo))%>%
  data.frame()%>%
  dplyr::filter(!grepl("(Intercept)",Categoría))%>%
  dplyr::filter(!grepl("mujer|climasex",`Categoría`))%>%
  dplyr::mutate(Categoría=dplyr::case_when(grepl("lf_rec_logit2",Categoría)~"1 conducta",
                                           grepl("lf_rec_logit3",Categoría)~"2 o más",
                                           grepl("la_rec_logit2",Categoría)~"1 conducta",
                                           grepl("la_rec_logit3",Categoría)~"2 o más",
                                           grepl("lc_rec_logit2",Categoría)~"1 conducta",
                                           grepl("lc_rec_logit3",Categoría)~"Ausencia conductas",
                                           grepl("naq_dic_logit2",Categoría)~"1 conducta",
                                           grepl("naq_dic_logit3",Categoría)~"2 o más",
                                           grepl("lid_des_dic_logit2",Categoría)~"1 conducta",
                                           grepl("lid_des_dic_logit3",Categoría)~"2 o más",
                                           grepl("naq_sum_cuartil2",Categoría)~"1-4 puntos",
                                           grepl("naq_sum_cuartil3",Categoría)~"5-10 puntos",
                                           grepl("naq_sum_cuartil4",Categoría)~"11 o más",
                                           grepl("lid_des_sum_cuartil2",Categoría)~"1-2 puntos",
                                           grepl("lid_des_sum_cuartil3",Categoría)~"3-4 puntos",
                                           grepl("lid_des_sum_cuartil4",Categoría)~"5 o más",
                                           grepl("naq_dic_autocat1",Categoría)~"Autodefinición",
                                           grepl("naq_dic_autocat2",Categoría)~"Autodefinición y 2 o más conductas",T~NA_character_))%>%
  dplyr::mutate(`exp.Est..`=sprintf("%04.2f",`exp.Est..`))%>%
  dplyr::mutate(`exp.Est..`= ifelse(grepl("NA",`exp.Est..`),NA_character_,`exp.Est..`))%>%
  dplyr::mutate(PR1=`exp.Est..`)%>%
  dplyr::mutate(PR1=dplyr::case_when(P<.001~paste0(PR1,"***"),P<.01~paste0(PR1,"**"),P<.05~paste0(PR1,"*"),TRUE~PR1))%>%
  dplyr::mutate(`X2.5.`= sprintf("%04.2f",`X2.5.`))%>%
  dplyr::mutate(`X97.5.`=sprintf("%04.2f",`X97.5.`))%>%
  dplyr::mutate("95% IC"=paste0("[",`X2.5.`,"-",`X97.5.`,"]"))%>%
  dplyr::mutate("95% IC"= ifelse(grepl("NA]",`95% IC`),NA_character_,`95% IC`))%>%
  dplyr::select(Modelo,Categoría,PR1, "95% IC")
```

```{r paso4b_pr2_lineal,eval=T, echo=T, paged.print=TRUE, eval=T}
# CREA LA VARIABLE CON EL AJUSTE DEL MODELO, MAS VAR. GENERO Y PREC
PR2_cont2<-data.table()
for(scale in  c("autonaq==2")){
  for(var in c("naq_sum", 
                "lc", "lid_des_sum")){
    # dynamically generate formula
    fmla <- as.formula(paste0(scale, " ~ ", factor(var), "+ mujer + climasex + precr1+ zona+ ocuprev_nocalif"))
    
    # fit glm model
    assign(paste0("svyglm3_",as.character(scale),"_",as.character(var)), svyglm(fmla, design=dsgn_BD_05_02, family=quasipoisson(link=log)))
    fit <- svyglm(fmla, design=dsgn_BD_05_02, family=quasipoisson(link=log))
    #print(round(Epi::ci.lin(fit, Exp=T),3))
    PR2_cont2<- rbind(PR2_cont2,paste0("svyglm2_",as.character(scale),"_",as.character(var)),data.table(data.table(round(Epi::ci.lin(fit, Exp=T),3),keep.rownames = T)), fill=T)
  }
}
#dsgn_BD_05_02$variables$ocuprev_nocalif

PR2_mod_cont2<-
PR2_cont2%>%
  dplyr::rename("Modelo"="x","Categoría"="rn")%>%
  data.frame()%>%
    dplyr::mutate(Modelo=dplyr::case_when(grepl("lc",Modelo)~"Suma de puntajes brutos de Liderazgos Constructivos",
                                        grepl("lid_des_sum",Modelo)~"Suma de puntajes brutos de Liderazgos Destructivos",
                                        grepl("naq_sum",Modelo)~"Suma de puntajes brutos de Conductas Negativas",
                                        TRUE~Modelo))%>%
  
  dplyr::filter(!grepl("(Intercept)",Categoría))%>%
  dplyr::filter(!grepl("mujer|climasex|precr1|ocuprev_nocalif|zona",`Categoría`))%>%
  dplyr::mutate(Categoría=dplyr::case_when(grepl("lf_rec_logit2",Categoría)~"1 conducta",
                                           grepl("lf_rec_logit3",Categoría)~"2 o más",
                                           grepl("la_rec_logit2",Categoría)~"1 conducta",
                                           grepl("la_rec_logit3",Categoría)~"2 o más",
                                           grepl("lc_rec_logit2",Categoría)~"1 conducta",
                                           grepl("lc_rec_logit3",Categoría)~"Ausencia conductas",
                                           grepl("naq_dic_logit2",Categoría)~"1 conducta",
                                           grepl("naq_dic_logit3",Categoría)~"2 o más",
                                           grepl("lid_des_dic_logit2",Categoría)~"1 conducta",
                                           grepl("lid_des_dic_logit3",Categoría)~"2 o más",
                                           grepl("naq_sum_cuartil2",Categoría)~"1-4 puntos",
                                           grepl("naq_sum_cuartil3",Categoría)~"5-10 puntos",
                                           grepl("naq_sum_cuartil4",Categoría)~"11 o más",
                                           grepl("lid_des_sum_cuartil2",Categoría)~"1-2 puntos",
                                           grepl("lid_des_sum_cuartil3",Categoría)~"3-4 puntos",
                                           grepl("lid_des_sum_cuartil4",Categoría)~"5 o más",
                                           grepl("naq_dic_autocat1",Categoría)~"Autodefinición",
                                           grepl("naq_dic_autocat2",Categoría)~"Autodefinición y 2 o más conductas"))%>%
  dplyr::mutate(`exp.Est..`=sprintf("%04.2f",`exp.Est..`))%>%
  dplyr::mutate(`exp.Est..`= ifelse(grepl("NA",`exp.Est..`),NA_character_,`exp.Est..`))%>%
  dplyr::mutate(PR2=`exp.Est..`)%>%
  dplyr::mutate(PR2=dplyr::case_when(P<.001~paste0(PR2,"***"),P<.01~paste0(PR2,"**"),P<.05~paste0(PR2,"*"),TRUE~PR2))%>%
  dplyr::mutate(`X2.5.`= sprintf("%04.2f",`X2.5.`))%>%
  dplyr::mutate(`X97.5.`=sprintf("%04.2f",`X97.5.`))%>%
  dplyr::mutate("95% IC"=paste0("[",`X2.5.`,"-",`X97.5.`,"]"))%>%
  dplyr::mutate("95% IC"= ifelse(grepl("NA]",`95% IC`),NA_character_,`95% IC`))%>%
  dplyr::select(Modelo,Categoría,PR2, "95% IC")
```


```{r paso4_modelos_juntos_pr_raw_pr1_pr2_lineal,eval=T, echo=T, paged.print=TRUE, eval=T, include=T}
pr_total_para_exp_cont2<-
data.frame(cbind.data.frame(data.table(PRraw_mod_cont2),data.table(PR1_mod_cont2),data.table(PR2_mod_cont2)))%>%
  dplyr::select(-Categoría.1,-Categoría.2,-Modelo.1,-Modelo.2)%>%
  dplyr::rename("95% IC"="X95..IC","95% IC_1"="X95..IC.1","95% IC_2"="X95..IC.2")
#copiar_nombres(pr_total_para_exp)
options(knitr.kable.NA = '')
pr_total_para_exp_cont2%>%
knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
    caption = paste0("Tabla S38. Razón de Prevalencia, Asociación con Autocategorización Acoso Laboral"),
    align =c('l',rep('c', 101)),
    escape=T)%>%
    kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 12) %>%
    kableExtra::add_footnote( c("PRraw= Modelo Crudo","PR1= Modelo Ajustado por Sexo y Clima Sexista","PR2= Modelo Ajustado por Sexo, Clima Sexista, Precariedad, Zona Residencial Metropolitana y Ocupación"), 
    notation = "none") %>%
    kableExtra::scroll_box(width = "100%", height = "375px")
```

<br>

Se generan medidas de asociación entre autocategorización y cada predictor, controlando por todas las variables.

<br>

```{r paso4a_modelo_total_lineal,eval=T, echo=T, paged.print=TRUE, eval=T, include=T}
dependent = "autonaq==2"
explanatory = c("naq_sum", "lc", "lid_des_sum", "mujer", "climasex", "precr1", "zona", "ocuprev_nocalif")
ajuste_4a = dsgn_BD_05_02 %>%
  svyglmmulti(dependent, explanatory, family = quasipoisson(link="log"))  %>%
  ff_metrics()

Epi::ci.lin(svyglm(autonaq == 2 ~ naq_sum+ lc+ lid_des_sum + mujer + climasex + precr1 + zona + 
           ocuprev_nocalif, design=dsgn_BD_05_02, family=quasipoisson(link=log)), Exp=T)%>%
  data.table(keep.rownames=T)%>%
  data.frame() %>% 
    dplyr::mutate(`exp.Est..`=sprintf("%04.2f",`exp.Est..`))%>%
  dplyr::mutate(`exp.Est..`= ifelse(grepl("NA",`exp.Est..`),NA_character_,`exp.Est..`))%>%
  dplyr::mutate(PR2=`exp.Est..`)%>%
  dplyr::mutate(PR2=dplyr::case_when(P<.001~paste0(PR2,"***"),P<.01~paste0(PR2,"**"),P<.05~paste0(PR2,"*"),TRUE~PR2))%>%
  dplyr::mutate(`X2.5.`= sprintf("%04.2f",`X2.5.`))%>%
  dplyr::mutate(`X97.5.`=sprintf("%04.2f",`X97.5.`))%>%
  dplyr::mutate("95% IC"=paste0("[",`X2.5.`,"-",`X97.5.`,"]"))%>%
  dplyr::mutate("95% IC"= ifelse(grepl("NA]",`95% IC`),NA_character_,`95% IC`))%>%
  dplyr::mutate(Predictora=dplyr::case_when(grepl("lc",rn)~"Suma de puntajes brutos de Liderazgos Constructivos",
                                        grepl("lid_des_sum",rn)~"Suma de puntajes brutos de Liderazgos Destructivos",
                                        grepl("naq_sum",rn)~"Suma de puntajes brutos de Conductas Negativas",
                                        TRUE~NA_character_))%>%  
  dplyr::filter(!is.na(Predictora)) %>% 
  dplyr::select(Predictora, PR2, `95% IC`) %>% 
knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
    caption = paste0("Tabla S39a. Razón de Prevalencia, Incorporando todos los predictores y variables confusoras, Asociación con Autocategorización Acoso Laboral"),
    align =c('l',rep('c', 101)),
    escape=T)%>%
    kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 12) %>%
    kableExtra::add_footnote( c("PR2= Modelo Ajustado por Sexo, Clima Sexista, Precariedad, Zona Residencial Metropolitana y Ocupación",ajuste_4a), 
    notation = "none") %>%
    kableExtra::scroll_box(width = "100%", height = "375px")
```


```{r paso4b_modelo_total_lineal,eval=T, echo=T, paged.print=TRUE, eval=T, include=T}
# dplyr::mutate(naq_sum_cuartil = car::recode(naq_sum,"0:0=0;1:4=1;5:10=2;11:hi=3"))%>%
#     dplyr::mutate(lc_sum_cuartil = car::recode(lc,"1:4=0;5:8=1;9:12=2;13:hi=3"))%>%
#     dplyr::mutate(lid_des_sum_cuartil = car::recode(lid_des_sum,"0=0;1:2=1;3:4=2;5:hi=3"))%>%
#    
dependent = "autonaq==2"
explanatory = c("naq_sum_cuartil", "lc_sum_cuartil", "lid_des_sum_cuartil", "mujer", "climasex", "precr1", "zona", "ocuprev_nocalif")
ajuste_4b = dsgn_BD_05_02 %>%
  svyglmmulti(dependent, explanatory, family = quasipoisson(link="log"))  %>%
  ff_metrics()

Epi::ci.lin(svyglm(autonaq == 2 ~ naq_sum_cuartil+ lc_sum_cuartil+ lid_des_sum_cuartil + mujer + climasex + precr1 + zona + 
           ocuprev_nocalif, design=dsgn_BD_05_02, family=quasipoisson(link=log)), Exp=T)%>%
  data.table(keep.rownames=T)%>%
  data.frame() %>% 
    dplyr::mutate(rn=dplyr::case_when(grepl("lc_sum_cuartil2",rn)~"LC, 5-8 puntos",
                                           grepl("lc_sum_cuartil3",rn)~"LC, 9-12 puntos",
                                           grepl("lc_sum_cuartil4",rn)~"LC, 13 o más",
                                           grepl("naq_sum_cuartil2",rn)~"NAQ, 1-4 puntos",
                                           grepl("naq_sum_cuartil3",rn)~"NAQ, 5-10 puntos",
                                           grepl("naq_sum_cuartil4",rn)~"NAQ, 11 o más",
                                           grepl("lid_des_sum_cuartil2",rn)~"LD, 1-2 puntos",
                                           grepl("lid_des_sum_cuartil3",rn)~"LD, 3-4 puntos",
                                           grepl("lid_des_sum_cuartil4",rn)~"LD, 5 o más", T~rn))%>%
    dplyr::mutate(`exp.Est..`=sprintf("%04.2f",`exp.Est..`))%>%
  dplyr::mutate(`exp.Est..`= ifelse(grepl("NA",`exp.Est..`),NA_character_,`exp.Est..`))%>%
  dplyr::mutate(PR2=`exp.Est..`)%>%
  dplyr::mutate(PR2=dplyr::case_when(P<.001~paste0(PR2,"***"),P<.01~paste0(PR2,"**"),P<.05~paste0(PR2,"*"),TRUE~PR2))%>%
  dplyr::mutate(`X2.5.`= sprintf("%04.2f",`X2.5.`))%>%
  dplyr::mutate(`X97.5.`=sprintf("%04.2f",`X97.5.`))%>%
  dplyr::mutate("95% IC"=paste0("[",`X2.5.`,"-",`X97.5.`,"]"))%>%
  dplyr::mutate("95% IC"= ifelse(grepl("NA]",`95% IC`),NA_character_,`95% IC`))%>%
  dplyr::filter(grepl("^NAQ|^LC|^LD",rn)) %>% 
  dplyr::select(rn, PR2, `95% IC`) %>% 
knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
    caption = paste0("Tabla S39b. Razón de Prevalencia, Incorporando todos los predictores y variables confusoras, Asociación con Autocategorización Acoso Laboral"),
    align =c('l',rep('c', 101)),
    escape=T)%>%
    kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 12) %>%
    kableExtra::add_footnote( c("Nota. Modelo Ajustado por Sexo, Clima Sexista, Precariedad, Zona Residencial Metropolitana y Ocupación",ajuste_4b), 
    notation = "none") %>%
    kableExtra::scroll_box(width = "100%", height = "375px")  
  
```


```{r paso4c_modelo_total_lineal,eval=T, echo=T, paged.print=TRUE, eval=T, include=T}

dependent = "autonaq==2"
explanatory = c("naq_sum_cuartil_ord", "lc_sum_cuartil_ord", "lid_des_sum_cuartil_ord", "mujer", "climasex", "precr1", "zona", "ocuprev_nocalif")
ajuste4c = dsgn_BD_05_02 %>%
  svyglmmulti(dependent, explanatory, family = quasipoisson(link="log"))  %>%
  ff_metrics()

mod1b_ord<-svyglm(k2_elevado == 2 ~ naq_sum_cuartil_ord+ lc_sum_cuartil_ord+ lid_des_sum_cuartil_ord + mujer + climasex + precr1 + zona + ocuprev_nocalif, design=dsgn_BD_05_02, family=quasipoisson(link=log))
Rverosimil=mod1b_ord$null.deviance-mod1b_ord$deviance
pchisq(Rverosimil, 3, lower.tail = FALSE)


Epi::ci.lin(svyglm(autonaq == 2 ~ naq_sum_cuartil_ord+ lc_sum_cuartil_ord+ lid_des_sum_cuartil_ord + mujer + climasex + precr1 + zona + ocuprev_nocalif, design=dsgn_BD_05_02, family=quasipoisson(link=log)), Exp=T)%>%
  data.table(keep.rownames=T)%>%
  data.frame() %>% 
    dplyr::mutate(rn=dplyr::case_when(grepl("lc_sum_cuartil_ord.C",rn)~"LC, 5-8 puntos",
                                           grepl("lc_sum_cuartil_ord.Q",rn)~"LC, 9-12 puntos",
                                           grepl("lc_sum_cuartil_ord.L",rn)~"LC, 13 o más",
                                           grepl("naq_sum_cuartil_ord.C",rn)~"NAQ, 1-4 puntos",
                                           grepl("naq_sum_cuartil_ord.Q",rn)~"NAQ, 5-10 puntos",
                                           grepl("naq_sum_cuartil_ord.L",rn)~"NAQ, 11 o más",
                                           grepl("lid_des_sum_cuartil_ord.C",rn)~"LD, 1-2 puntos",
                                           grepl("lid_des_sum_cuartil_ord.Q",rn)~"LD, 3-4 puntos",
                                           grepl("lid_des_sum_cuartil_ord.L",rn)~"LD, 5 o más", T~rn))%>%
        dplyr::mutate(rn=factor(rn, levels=c("NAQ, 1-4 puntos","NAQ, 5-10 puntos","NAQ, 11 o más","LC, 5-8 puntos","LC, 9-12 puntos","LC, 13 o más","LD, 1-2 puntos","LD, 3-4 puntos","LD, 5 o más"))) %>%
  dplyr::arrange(rn) %>% 
    dplyr::mutate(`exp.Est..`=sprintf("%04.2f",`exp.Est..`))%>%
  dplyr::mutate(`exp.Est..`= ifelse(grepl("NA",`exp.Est..`),NA_character_,`exp.Est..`))%>%
  dplyr::mutate(PR2=`exp.Est..`)%>%
  dplyr::mutate(PR2=dplyr::case_when(P<.001~paste0(PR2,"***"),P<.01~paste0(PR2,"**"),P<.05~paste0(PR2,"*"),TRUE~PR2))%>%
  dplyr::mutate(`X2.5.`= sprintf("%04.2f",`X2.5.`))%>%
  dplyr::mutate(`X97.5.`=sprintf("%04.2f",`X97.5.`))%>%
  dplyr::mutate("95% IC"=paste0("[",`X2.5.`,"-",`X97.5.`,"]"))%>%
  dplyr::mutate("95% IC"= ifelse(grepl("NA]",`95% IC`),NA_character_,`95% IC`))%>%
  dplyr::filter(grepl("^NAQ|^LC|^LD",rn)) %>% 
  dplyr::select(rn, PR2, `95% IC`) %>% 
knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
    caption = paste0("Tabla S37c. Razón de Prevalencia, Incorporando todos los predictores y variables confusoras, Autocategorización como víctima de acoso laboral (ordenado)"),
    align =c('l',rep('c', 101)),
    escape=T)%>%
    kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 12) %>%
    kableExtra::add_footnote( c("Nota. Modelo Ajustado por Sexo, Clima Sexista, Precariedad, Zona Residencial Metropolitana y Ocupación", ajuste4c), 
    notation = "none") %>%
    kableExtra::scroll_box(width = "100%", height = "375px")  
```      

<br>

## Prueba t

De acuerdo a lo indicado por el editor, se hizo una prueba de comparación de medias o medianas o sumas de rangos entre los grupos de interés.

<br>

```{r paso3_prueba_t1,eval=T, echo=T, paged.print=TRUE, eval=T, include=T}

#svyttest(naq_sum~k2_elevado==2, design= dsgn_BD_05_02)
rbind.data.frame(
cbind("Acoso Laboral, Ocupación",paste0("t (",
svyttest(naq_sum~ocuprev_nocalif, design= dsgn_BD_05_02)[["parameter"]], ")= ",
round(svyttest(naq_sum~ocuprev_nocalif, design= dsgn_BD_05_02)[["statistic"]],2), ", ",
data.frame(p=svyttest(naq_sum~ocuprev_nocalif, design= dsgn_BD_05_02)[["p.value"]]) %>% 
dplyr::mutate(p=dplyr::case_when(p<.001~"p<0.001",T~paste0("p= ",as.character(round(p,3))))))),

c("",paste0("w (Wilcoxon) (",
svyranktest(naq_sum~ocuprev_nocalif, design= dsgn_BD_05_02, test=c("wilcoxon"))[["parameter"]], ")= ",
round(svyranktest(naq_sum~ocuprev_nocalif, design= dsgn_BD_05_02, test=c("wilcoxon"))[["statistic"]],2), ", ",
data.frame(p=svyranktest(naq_sum~ocuprev_nocalif, design= dsgn_BD_05_02, test=c("wilcoxon"))[["p.value"]]) %>% 
dplyr::mutate(p=dplyr::case_when(p<.001~"p<0.001",T~paste0("p= ",as.character(round(p,3))))))),

c("",paste0("w (Median) (",
svyranktest(naq_sum~ocuprev_nocalif, design= dsgn_BD_05_02, test=c("median"))[["parameter"]], ")= ",
round(svyranktest(naq_sum~ocuprev_nocalif, design= dsgn_BD_05_02, test=c("median"))[["statistic"]],2), ", ",
data.frame(p=svyranktest(naq_sum~ocuprev_nocalif, design= dsgn_BD_05_02, test=c("median"))[["p.value"]]) %>% 
dplyr::mutate(p=dplyr::case_when(p<.001~"p<0.001",T~paste0("p= ",as.character(round(p,3))))))),

c("",paste0("w (Van der Waerden) (",
svyranktest(naq_sum~ocuprev_nocalif, design= dsgn_BD_05_02, test=c("vanderWaerden"))[["parameter"]], ")= ",
round(svyranktest(naq_sum~ocuprev_nocalif, design= dsgn_BD_05_02, test=c("vanderWaerden"))[["statistic"]],2), ", ",
data.frame(p=svyranktest(naq_sum~ocuprev_nocalif, design= dsgn_BD_05_02, test=c("vanderWaerden"))[["p.value"]]) %>% 
dplyr::mutate(p=dplyr::case_when(p<.001~"p<0.001",T~paste0("p= ",as.character(round(p,3))))))),

cbind("Liderazgo destructivo, Ocupación",paste0("t (",
svyttest(lid_des_sum~ocuprev_nocalif, design= dsgn_BD_05_02)[["parameter"]], ")= ",
round(svyttest(naq_sum~ocuprev_nocalif, design= dsgn_BD_05_02)[["statistic"]],2), ", ",
data.frame(p=svyttest(naq_sum~ocuprev_nocalif, design= dsgn_BD_05_02)[["p.value"]]) %>% 
dplyr::mutate(p=dplyr::case_when(p<.001~"p<0.001",T~paste0("p= ",as.character(round(p,3))))))),

c("",paste0("w (Wilcoxon) (",
svyranktest(lid_des_sum~ocuprev_nocalif, design= dsgn_BD_05_02, test=c("wilcoxon"))[["parameter"]], ")= ",
round(svyranktest(naq_sum~ocuprev_nocalif, design= dsgn_BD_05_02, test=c("wilcoxon"))[["statistic"]],2), ", ",
data.frame(p=svyranktest(naq_sum~ocuprev_nocalif, design= dsgn_BD_05_02, test=c("wilcoxon"))[["p.value"]]) %>% 
dplyr::mutate(p=dplyr::case_when(p<.001~"p<0.001",T~paste0("p= ",as.character(round(p,3))))))),

c("",paste0("w (Median) (",
svyranktest(lid_des_sum~ocuprev_nocalif, design= dsgn_BD_05_02, test=c("median"))[["parameter"]], ")= ",
round(svyranktest(naq_sum~ocuprev_nocalif, design= dsgn_BD_05_02, test=c("median"))[["statistic"]],2), ", ",
data.frame(p=svyranktest(naq_sum~ocuprev_nocalif, design= dsgn_BD_05_02, test=c("median"))[["p.value"]]) %>% 
dplyr::mutate(p=dplyr::case_when(p<.001~"p<0.001",T~paste0("p= ",as.character(round(p,3))))))),

c("",paste0("w (Van der Waerden) (",
svyranktest(lid_des_sum~ocuprev_nocalif, design= dsgn_BD_05_02, test=c("vanderWaerden"))[["parameter"]], ")= ",
round(svyranktest(naq_sum~ocuprev_nocalif, design= dsgn_BD_05_02, test=c("vanderWaerden"))[["statistic"]],2), ", ",
data.frame(p=svyranktest(naq_sum~ocuprev_nocalif, design= dsgn_BD_05_02, test=c("vanderWaerden"))[["p.value"]]) %>% 
dplyr::mutate(p=dplyr::case_when(p<.001~"p<0.001",T~paste0("p= ",as.character(round(p,3))))))),


c("Acoso Laboral, Autocategorización",paste0("t (",
svyttest(naq_sum~autonaq, design= dsgn_BD_05_02)[["parameter"]], ")= ",
round(svyttest(naq_sum~autonaq, design= dsgn_BD_05_02)[["statistic"]],2), ", ",
data.frame(p=svyttest(naq_sum~autonaq, design= dsgn_BD_05_02)[["p.value"]]) %>% 
dplyr::mutate(p=dplyr::case_when(p<.001~"p<0.001",T~paste0("p= ",as.character(round(p,3))))))),

c("",paste0("w (Wilcoxon) (",
svyranktest(naq_sum~autonaq, design= dsgn_BD_05_02, test=c("wilcoxon"))[["parameter"]], ")= ",
round(svyranktest(naq_sum~autonaq, design= dsgn_BD_05_02, test=c("wilcoxon"))[["statistic"]],2), ", ",
data.frame(p=svyranktest(autonaq~k2_elevado, design= dsgn_BD_05_02, test=c("wilcoxon"))[["p.value"]]) %>% 
dplyr::mutate(p=dplyr::case_when(p<.001~"p<0.001",T~paste0("p= ",as.character(round(p,3))))))),

c("",paste0("w (Median) (",
svyranktest(naq_sum~autonaq, design= dsgn_BD_05_02, test=c("median"))[["parameter"]], ")= ",
round(svyranktest(naq_sum~autonaq, design= dsgn_BD_05_02, test=c("median"))[["statistic"]],2), ", ",
data.frame(p=svyranktest(naq_sum~autonaq, design= dsgn_BD_05_02, test=c("median"))[["p.value"]]) %>% 
dplyr::mutate(p=dplyr::case_when(p<.001~"p<0.001",T~paste0("p= ",as.character(round(p,3))))))),

c("",paste0("w (Van der Waerden) (",
svyranktest(naq_sum~autonaq, design= dsgn_BD_05_02, test=c("vanderWaerden"))[["parameter"]], ")= ",
round(svyranktest(naq_sum~autonaq, design= dsgn_BD_05_02, test=c("vanderWaerden"))[["statistic"]],2), ", ",
data.frame(p=svyranktest(naq_sum~autonaq, design= dsgn_BD_05_02, test=c("vanderWaerden"))[["p.value"]]) %>% 
dplyr::mutate(p=dplyr::case_when(p<.001~"p<0.001",T~paste0("p= ",as.character(round(p,3))))))),

c("Acoso Laboral, Distrés",paste0("t (",
svyttest(naq_sum~k2_elevado, design= dsgn_BD_05_02)[["parameter"]], ")= ",
round(svyttest(naq_sum~k2_elevado, design= dsgn_BD_05_02)[["statistic"]],2), ", ",
data.frame(p=svyttest(naq_sum~k2_elevado, design= dsgn_BD_05_02)[["p.value"]]) %>% 
dplyr::mutate(p=dplyr::case_when(p<.001~"p<0.001",T~paste0("p= ",as.character(round(p,3))))))),

c("",paste0("w (Wilcoxon) (",
svyranktest(naq_sum~k2_elevado, design= dsgn_BD_05_02, test=c("wilcoxon"))[["parameter"]], ")= ",
round(svyranktest(naq_sum~k2_elevado, design= dsgn_BD_05_02, test=c("wilcoxon"))[["statistic"]],2), ", ",
data.frame(p=svyranktest(naq_sum~k2_elevado, design= dsgn_BD_05_02, test=c("wilcoxon"))[["p.value"]]) %>% 
dplyr::mutate(p=dplyr::case_when(p<.001~"p<0.001",T~paste0("p= ",as.character(round(p,3))))))),

c("",paste0("w (Median) (",
svyranktest(naq_sum~k2_elevado, design= dsgn_BD_05_02, test=c("median"))[["parameter"]], ")= ",
round(svyranktest(naq_sum~k2_elevado, design= dsgn_BD_05_02, test=c("median"))[["statistic"]],2), ", ",
data.frame(p=svyranktest(naq_sum~k2_elevado, design= dsgn_BD_05_02, test=c("median"))[["p.value"]]) %>% 
dplyr::mutate(p=dplyr::case_when(p<.001~"p<0.001",T~paste0("p= ",as.character(round(p,3))))))),

c("",paste0("w (Van der Waerden) (",
svyranktest(naq_sum~k2_elevado, design= dsgn_BD_05_02, test=c("vanderWaerden"))[["parameter"]], ")= ",
round(svyranktest(naq_sum~k2_elevado, design= dsgn_BD_05_02, test=c("vanderWaerden"))[["statistic"]],2), ", ",
data.frame(p=svyranktest(naq_sum~k2_elevado, design= dsgn_BD_05_02, test=c("vanderWaerden"))[["p.value"]]) %>% 
dplyr::mutate(p=dplyr::case_when(p<.001~"p<0.001",T~paste0("p= ",as.character(round(p,3))))))),

c("Liderazgo destructivo, Distrés",paste0("t (",
svyttest(lid_des_sum~k2_elevado, design= dsgn_BD_05_02)[["parameter"]], ")= ",
round(svyttest(naq_sum~k2_elevado, design= dsgn_BD_05_02)[["statistic"]],2), ", ",
data.frame(p=svyttest(naq_sum~k2_elevado, design= dsgn_BD_05_02)[["p.value"]]) %>% 
dplyr::mutate(p=dplyr::case_when(p<.001~"p<0.001",T~paste0("p= ",as.character(round(p,3))))))),

c("",paste0("w (Wilcoxon) (",
svyranktest(lid_des_sum~k2_elevado, design= dsgn_BD_05_02, test=c("wilcoxon"))[["parameter"]], ")= ",
round(svyranktest(naq_sum~k2_elevado, design= dsgn_BD_05_02, test=c("wilcoxon"))[["statistic"]],2), ", ",
data.frame(p=svyranktest(naq_sum~k2_elevado, design= dsgn_BD_05_02, test=c("wilcoxon"))[["p.value"]]) %>% 
dplyr::mutate(p=dplyr::case_when(p<.001~"p<0.001",T~paste0("p= ",as.character(round(p,3))))))),

c("",paste0("w (Median) (",
svyranktest(lid_des_sum~k2_elevado, design= dsgn_BD_05_02, test=c("median"))[["parameter"]], ")= ",
round(svyranktest(naq_sum~k2_elevado, design= dsgn_BD_05_02, test=c("median"))[["statistic"]],2), ", ",
data.frame(p=svyranktest(naq_sum~k2_elevado, design= dsgn_BD_05_02, test=c("median"))[["p.value"]]) %>% 
dplyr::mutate(p=dplyr::case_when(p<.001~"p<0.001",T~paste0("p= ",as.character(round(p,3))))))),

c("",paste0("w (Van der Waerden) (",
svyranktest(lid_des_sum~k2_elevado, design= dsgn_BD_05_02, test=c("vanderWaerden"))[["parameter"]], ")= ",
round(svyranktest(naq_sum~k2_elevado, design= dsgn_BD_05_02, test=c("vanderWaerden"))[["statistic"]],2), ", ",
data.frame(p=svyranktest(naq_sum~k2_elevado, design= dsgn_BD_05_02, test=c("vanderWaerden"))[["p.value"]]) %>% 
dplyr::mutate(p=dplyr::case_when(p<.001~"p<0.001",T~paste0("p= ",as.character(round(p,3)))))))
) %>% 
  
  knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
    caption = paste0("Tabla S40. Relaciones bivariadas"),
    col.names=c("Constructo","Prueba"),
    align =c('l',rep('l', 101)),
    escape=T)%>%
    kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 12) %>%
    kableExtra::scroll_box(width = "100%", height = "375px")
```

<br>

# SEM (standard error of measurement)

```{r paso3_sem,eval=T, echo=T, paged.print=TRUE, eval=T, include=T, error=T}
#https://www.uwo.ca/fhs/tc/labs/07.Reliability.pdf
invisible("Obtener la confiabilidad")
rxx_naq_fa<-data.table(t(semTools::reliability(naq_fa, c("omega"),return.total=T)),keep.rownames = T)[4,2]
rxx_lc<-data.table(t(semTools::reliability(lid_des_fa_2f_sin3, c("omega"),return.total=T)),keep.rownames = T)[1,2]
rxx_ld<-data.table(t(semTools::reliability(lid_des_fa_2f_sin3, c("omega"),return.total=T)),keep.rownames = T)[2,2]

invisible("Computar el error estándar de medición")

rbind.data.frame(
c("Suma puntajes Acoso Laboral",round(as.numeric(psychometric::SE.Meas(s=as.numeric(jtools::svysd(~naq_sum,design=dsgn_BD_05_02,na.rm = FALSE, digits = getOption("jtools-digits", default = 3))), rxx=rxx_naq_fa)),3)),
c("Suma de Liderazgos Constructivos",round(as.numeric(psychometric::SE.Meas(s=as.numeric(jtools::svysd(~lc,design=dsgn_BD_05_02,na.rm = FALSE, digits = getOption("jtools-digits", default = 3))), rxx=rxx_lc)),3)),
c("Suma de Liderazgos Destructivos",round(as.numeric(psychometric::SE.Meas(s=as.numeric(jtools::svysd(~lid_des_sum,design=dsgn_BD_05_02,na.rm = FALSE, digits = getOption("jtools-digits", default = 3))), rxx=rxx_ld)),3))
        ) %>% 
    knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
    caption = paste0("Tabla S41. Error estándar de medición"),
    col.names=c("Constructo","Prueba"),
    align =c('l',rep('l', 101)),
    escape=T)%>%
    kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 12) %>%
    kableExtra::scroll_box(width = "100%", height = "375px")

```

<br>

# ESEM


<div style="border: 1px solid #ddd; padding: 5px; overflow-y: scroll; height:500px; overflow-x: scroll; width:100%;">

```{r paso4_esem,eval=T, echo=T, paged.print=TRUE, eval=T, include=T, error=T}
#5,7,9,1,4,8,10      paste0("naq",1:22)
#BD_2020_input_num[paste0("lid_des",c(16,11,12,14))]

# nfX= The number of factors to extract for the X variables
# nfY= The number of factors to extract for the Y variables

esem1<-
psych::esem(r= BD_2020_input_num[,c(paste0("naq",c(1:22)),paste0("lid_des",c(5,7,9,1,4,8,10,2,6,11,12,13,14)))], varsX=23:35, varsY=1:22, nfX=2, 
            nfY=1, n.obs= 1995, plot=T, use="complete", weight= BD_2020_input_num$weight, correct=T, rotate= "oblimin", 
            cor="poly" ,fm="wls")

esem1
#fit= sum of squared residuals versus sum of squared original values
# Empirical BIC =  178.53
# ESABIC =  1744.82
# The root mean square of the residuals (RMSR) is  0.04 
# The df corrected root mean square of the residuals is  0.04 


#Phi	= the correlations of the X and Y factors within the selves and across sets.
#esem1$Phi
```
</div>


```{r fig10_paso4_esem, echo=T, fig.align='center', fig.pos='H', fig.cap= "Figura S10. Modelo Exploratorio SEM con Variables de Liderazgo Destructivo y Conductas Negativas", message=FALSE, error=F, fig.retina=2, fig.height=14}
esem.diagram(esem=esem1,labels=NULL,cut=.3,errors=FALSE,simple=TRUE,
regression=FALSE,lr=TRUE, digits=1,e.size=.1,adj=2,
     main=NULL)
```

<br>

# Referencias

<div id="refs"></div>

# Información de la Sesión

```{r}
save.image(paste0(getwd(),"/rep_validacion_naq_2021_postrev.RData"))
#load("C:/Users/andre/Google Drive/DOCUMENTOS/6.TESIS 2018/_BASE DEF_FINAL/BASDEF_FINAL/01_02_19/Validacion/rep_validacion_naq_2020.RData")
#xaringan::inf_mr()
sessionInfo()

sesion_info <- devtools::session_info()
dplyr::select(
  tibble::as_tibble(sesion_info$packages),
  c(package, loadedversion, source)
) %>% 
  DT::datatable(filter = 'top', colnames = c('Row number' =1,'Variable' = 2, 'Percentage'= 3),
              caption = htmltools::tags$caption(
        style = 'caption-side: top; text-align: left;',
        '', htmltools::em('Paquetes estadísticos utilizados')),
      options=list(
initComplete = htmlwidgets::JS(
      "function(settings, json) {",
      "$(this.api().tables().body()).css({'font-size': '80%'});",
      "}")))
```